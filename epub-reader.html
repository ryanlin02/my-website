<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB é›»å­æ›¸é–±è®€å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 20px;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .book-selector {
            padding: 20px;
            background: #2a2a2a;
            border-radius: 10px;
            margin: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .book-selector h2 {
            margin-bottom: 15px;
            color: #3498db;
            font-size: 18px;
        }

        .book-list {
            display: grid;
            gap: 10px;
        }

        .book-item {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .book-item:hover {
            transform: translateY(-2px);
            border-color: #3498db;
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.3);
        }

        .book-item h3 {
            font-size: 16px;
            color: #ecf0f1;
            margin-bottom: 5px;
        }

        .book-item p {
            font-size: 14px;
            color: #bdc3c7;
        }

        .reader-container {
            display: none;
            flex: 1;
            flex-direction: column;
            height: calc(100vh - 80px);
        }

        .reader-header {
            background: #2a2a2a;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .back-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: #c0392b;
        }

        .book-title {
            flex: 1;
            text-align: center;
            font-size: 16px;
            color: #ecf0f1;
            margin: 0 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
            line-height: 1.8;
            font-size: 16px;
        }

        .content-area h1, .content-area h2, .content-area h3 {
            color: #2c3e50;
            margin: 20px 0 15px 0;
        }

        .content-area p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .navigation {
            background: #2a2a2a;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            flex: 1;
            margin: 0 5px;
            max-width: 100px;
        }

        .nav-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .nav-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
        }

        .chapter-info {
            font-size: 14px;
            color: #bdc3c7;
            text-align: center;
            flex: 1;
            margin: 0 10px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #3498db;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            text-align: center;
        }

        /* æ‰‹æ©Ÿå„ªåŒ– */
        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
            }

            .header h1 {
                font-size: 18px;
            }

            .book-selector {
                margin: 15px;
                padding: 15px;
            }

            .content-area {
                padding: 15px;
                font-size: 15px;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 12px;
                max-width: 80px;
            }

            .chapter-info {
                font-size: 12px;
            }

            .reader-header {
                padding: 10px 15px;
            }

            .book-title {
                font-size: 14px;
            }
        }

        /* æ²å‹•æ¢å„ªåŒ– */
        .content-area::-webkit-scrollbar {
            width: 6px;
        }

        .content-area::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .content-area::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .content-area::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“š EPUB é›»å­æ›¸é–±è®€å™¨</h1>
    </div>

    <div id="book-selector" class="book-selector">
        <h2>é¸æ“‡æ›¸ç±</h2>
        <div id="book-list" class="book-list">
            <div class="loading">æ­£åœ¨è¼‰å…¥æ›¸ç±åˆ—è¡¨...</div>
        </div>
    </div>

    <div id="reader-container" class="reader-container">
        <div class="reader-header">
            <button class="back-btn" onclick="goBack()">â† è¿”å›</button>
            <div id="book-title" class="book-title">è¼‰å…¥ä¸­...</div>
            <div></div>
        </div>
        
        <div id="content-area" class="content-area">
            <div class="loading">æ­£åœ¨è¼‰å…¥å…§å®¹...</div>
        </div>

        <div class="navigation">
            <button id="prev-btn" class="nav-btn" onclick="previousChapter()">ä¸Šä¸€ç« </button>
            <div id="chapter-info" class="chapter-info">è¼‰å…¥ä¸­...</div>
            <button id="next-btn" class="nav-btn" onclick="nextChapter()">ä¸‹ä¸€ç« </button>
        </div>
    </div>

    <script>
        let currentBook = null;
        let chapters = [];
        let currentChapterIndex = 0;

        // è¼‰å…¥æ›¸ç±åˆ—è¡¨
        async function loadBookList() {
            try {
                const response = await fetch('books/');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = doc.querySelectorAll('a[href$=".epub"]');
                
                const bookList = document.getElementById('book-list');
                
                if (links.length === 0) {
                    bookList.innerHTML = `
                        <div class="error">
                            æœªæ‰¾åˆ° EPUB æª”æ¡ˆã€‚è«‹ç¢ºä¿åœ¨ books ç›®éŒ„ä¸­æ”¾ç½®äº† .epub æ ¼å¼çš„é›»å­æ›¸æª”æ¡ˆã€‚
                        </div>
                    `;
                    return;
                }

                bookList.innerHTML = '';
                links.forEach(link => {
                    const fileName = link.getAttribute('href');
                    const bookName = fileName.replace('.epub', '').replace(/%20/g, ' ');
                    
                    const bookItem = document.createElement('div');
                    bookItem.className = 'book-item';
                    bookItem.innerHTML = `
                        <h3>${bookName}</h3>
                        <p>é»æ“Šé–‹å§‹é–±è®€</p>
                    `;
                    bookItem.onclick = () => loadBook(`books/${fileName}`);
                    bookList.appendChild(bookItem);
                });
            } catch (error) {
                document.getElementById('book-list').innerHTML = `
                    <div class="error">
                        è¼‰å…¥æ›¸ç±åˆ—è¡¨å¤±æ•—ï¼š${error.message}
                        <br><br>
                        è«‹ç¢ºä¿æ‚¨çš„ books ç›®éŒ„å¯ä»¥è¢«è¨ªå•ï¼Œæˆ–è€…æ‰‹å‹•è¼¸å…¥æ›¸ç±æª”æ¡ˆåç¨±ã€‚
                    </div>
                `;
            }
        }

        // è¼‰å…¥ EPUB æ›¸ç±
        async function loadBook(bookPath) {
            try {
                document.getElementById('content-area').innerHTML = '<div class="loading">æ­£åœ¨è¼‰å…¥æ›¸ç±...</div>';
                document.getElementById('book-selector').style.display = 'none';
                document.getElementById('reader-container').style.display = 'flex';

                const response = await fetch(bookPath);
                const arrayBuffer = await response.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);

                // è§£æ EPUB çµæ§‹
                const containerXml = await zip.file('META-INF/container.xml').async('text');
                const containerDoc = new DOMParser().parseFromString(containerXml, 'text/xml');
                const opfPath = containerDoc.querySelector('rootfile').getAttribute('full-path');
                
                const opfContent = await zip.file(opfPath).async('text');
                const opfDoc = new DOMParser().parseFromString(opfContent, 'text/xml');
                
                // ç²å–æ›¸ç±æ¨™é¡Œ
                const title = opfDoc.querySelector('title')?.textContent || 'æœªçŸ¥æ›¸ç±';
                document.getElementById('book-title').textContent = title;

                // ç²å–ç« ç¯€é †åº
                const spine = opfDoc.querySelectorAll('spine itemref');
                const manifest = opfDoc.querySelectorAll('manifest item');
                
                chapters = [];
                for (const itemref of spine) {
                    const idref = itemref.getAttribute('idref');
                    const manifestItem = Array.from(manifest).find(item => item.getAttribute('id') === idref);
                    if (manifestItem) {
                        const href = manifestItem.getAttribute('href');
                        const fullPath = opfPath.substring(0, opfPath.lastIndexOf('/') + 1) + href;
                        
                        const chapterContent = await zip.file(fullPath).async('text');
                        chapters.push({
                            title: href,
                            content: chapterContent
                        });
                    }
                }

                currentChapterIndex = 0;
                displayChapter();
                updateNavigation();
                
            } catch (error) {
                document.getElementById('content-area').innerHTML = `
                    <div class="error">è¼‰å…¥æ›¸ç±å¤±æ•—ï¼š${error.message}</div>
                `;
            }
        }

        // é¡¯ç¤ºç« ç¯€å…§å®¹
        function displayChapter() {
            if (chapters.length === 0) return;

            const chapter = chapters[currentChapterIndex];
            const contentArea = document.getElementById('content-area');
            
            // è§£æ HTML å…§å®¹ä¸¦æ¸…ç†
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = chapter.content;
            
            // ç§»é™¤ä¸éœ€è¦çš„æ¨™ç±¤
            const scripts = tempDiv.querySelectorAll('script');
            scripts.forEach(script => script.remove());
            
            const styles = tempDiv.querySelectorAll('style');
            styles.forEach(style => style.remove());
            
            // ç²å–ä¸»è¦å…§å®¹
            const body = tempDiv.querySelector('body') || tempDiv;
            contentArea.innerHTML = body.innerHTML || chapter.content;
            
            // æ²å‹•åˆ°é ‚éƒ¨
            contentArea.scrollTop = 0;
            
            updateNavigation();
        }

        // æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹
        function updateNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const chapterInfo = document.getElementById('chapter-info');
            
            prevBtn.disabled = currentChapterIndex === 0;
            nextBtn.disabled = currentChapterIndex === chapters.length - 1;
            
            chapterInfo.textContent = `${currentChapterIndex + 1} / ${chapters.length}`;
        }

        // ä¸Šä¸€ç« 
        function previousChapter() {
            if (currentChapterIndex > 0) {
                currentChapterIndex--;
                displayChapter();
            }
        }

        // ä¸‹ä¸€ç« 
        function nextChapter() {
            if (currentChapterIndex < chapters.length - 1) {
                currentChapterIndex++;
                displayChapter();
            }
        }

        // è¿”å›æ›¸ç±é¸æ“‡
        function goBack() {
            document.getElementById('reader-container').style.display = 'none';
            document.getElementById('book-selector').style.display = 'block';
            currentBook = null;
            chapters = [];
            currentChapterIndex = 0;
        }

        // è§¸æ§æ‰‹å‹¢æ”¯æ´
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // å·¦æ»‘ - ä¸‹ä¸€ç« 
                    nextChapter();
                } else {
                    // å³æ»‘ - ä¸Šä¸€ç« 
                    previousChapter();
                }
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadBookList();
        });
    </script>
</body>
</html>
