<!DOCTYPE html>
<html lang="zh-TW">
<head>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XE5XMQR0Z1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XE5XMQR0Z1');
    </script>

    <!-- 在 <head> 標籤內添加以下內容 -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#333333">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="雞肉飯">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <meta charset="UTF-8">
	<meta name="viewport" content="width=400, user-scalable=no">

    <!-- 在現有的 meta 標籤下方添加 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>小朋友計算機</title>
    <style>

    /* 默認主題：暗夜橘焰 */
    :root {
        /* 基本色調 */
        --primary-color: #333333;
        --secondary-color: #4a4a4a;
        --text-color: #ffffff;
        --border-color: #555555;
        --hover-color: #666666;
        --shadow-color: rgba(0, 0, 0, 0.3);
        
        /* 強調色 */
        --accent-color: #ff9c33;       /* 橙色重點色 */
        --accent-color-light: rgba(255, 156, 51, 0.2); /* 淡橙色 */
        --accent-color-dark: #e88a22;  /* 深橙色 */
        
        /* 功能色 */
        --success-color: #33b5e5;      /* 藍色成功色 */
        --warning-color: #ff9c33;      /* 橙色警告色 */
        --error-color: #e74c3c;        /* 紅色錯誤色 */
        --info-color: #3498db;         /* 藍色資訊色 */
        
        /* 特殊元件顏色 */
        --button-primary: #ff9c33;     /* 主按鈕顏色 */
        --button-secondary: #4a4a4a;   /* 副按鈕顏色 */
        --input-bg: #222222;           /* 輸入框背景色 */
        --input-border: #555555;       /* 輸入框邊框 */
        --input-focus-border: #ff9c33; /* 輸入框焦點邊框 */
        --card-bg: #333333;            /* 卡片背景色 */
        
        /* 文字強調色 */
        --text-highlight: #ff9c33;     /* 文字強調色 */
        --text-muted: #999999;         /* 文字淡色 */
        
        /* 與舊代碼兼容的變數 */
        --button-orange: #ff9c33;
        --button-blue: #33b5e5;
        --button-grey: #333333;
    }

    /* 極簡黑白主題 */
    :root[data-theme="white"] {
        /* 基本色調 */
        --primary-color: #fafafa;
        --secondary-color: #ffffff;
        --text-color: #222222;
        --border-color: #cccccc;
        --hover-color: #f5f5f5;
        --shadow-color: rgba(0, 0, 0, 0.15);
        
        /* 強調色 */
        --accent-color: #555555;        /* 灰色重點色 */
        --accent-color-light: rgba(85, 85, 85, 0.15); /* 淡灰色 */
        --accent-color-dark: #333333;   /* 深灰色 */
        
        /* 功能色 */
        --success-color: #777777;       /* 灰色成功色 */
        --warning-color: #555555;       /* 灰色警告色 */
        --error-color: #777777;         /* 灰色錯誤色 */
        --info-color: #555555;          /* 灰色資訊色 */
        
        /* 特殊元件顏色 */
        --button-primary: #555555;      /* 主按鈕顏色 */
        --button-secondary: #e0e0e0;    /* 副按鈕顏色 */
        --input-bg: #ffffff;            /* 輸入框背景色 */
        --input-border: #aaaaaa;        /* 輸入框邊框 */
        --input-focus-border: #555555;  /* 輸入框焦點邊框 */
        --card-bg: #ffffff;             /* 卡片背景色 */
        
        /* 文字強調色 */
        --text-highlight: #333333;      /* 文字強調色 */
        --text-muted: #777777;          /* 文字淡色 */
        
        /* 與舊代碼兼容的變數 */
        --button-orange: #555555;
        --button-blue: #777777;
        --button-grey: #e0e0e0;
        
        background-color: #fafafa;
    }

    /* 櫻花雪主題 */
    :root[data-theme="pink"] {
        /* 基本色調 */
        --primary-color: #fff0f5;       /* 粉色背景 */
        --secondary-color: #ffffff;     /* 白色次背景 */
        --text-color: #4a4a4a;          /* 深灰文字 */
        --border-color: #ffb6c1;        /* 粉色邊框 */
        --hover-color: #ffd1dc;         /* 淺粉色懸停 */
        --shadow-color: rgba(255, 182, 193, 0.3); /* 粉色陰影 */
        
        /* 強調色 */
        --accent-color: #ff80ab;        /* 粉紅重點色 */
        --accent-color-light: rgba(255, 128, 171, 0.2); /* 淡粉紅 */
        --accent-color-dark: #e6366e;   /* 深粉紅 */
        
        /* 功能色 */
        --success-color: #81c784;       /* 綠色成功色 */
        --warning-color: #ff9e80;       /* 橙色警告色 */
        --error-color: #ff8a80;         /* 紅色錯誤色 */
        --info-color: #80d8ff;          /* 藍色資訊色 */
        
        /* 特殊元件顏色 */
        --button-primary: #ff80ab;      /* 主按鈕顏色 */
        --button-secondary: #fce4ec;    /* 副按鈕顏色 */
        --input-bg: #ffffff;            /* 輸入框背景色 */
        --input-border: #ffb6c1;        /* 輸入框邊框 */
        --input-focus-border: #ff80ab;  /* 輸入框焦點邊框 */
        --card-bg: #ffffff;             /* 卡片背景色 */
        
        /* 文字強調色 */
        --text-highlight: #ff4081;      /* 文字強調色 */
        --text-muted: #9e9e9e;          /* 文字淡色 */
        
        /* 與舊代碼兼容的變數 */
        --button-orange: #ff80ab;
        --button-blue: #80d8ff;
        --button-grey: #fce4ec;
    }

    /* 暗夜烈焰主題 */
    :root[data-theme="red"] {
        /* 基本色調 */
        --primary-color: #1a1a1a;       /* 暗黑背景 */
        --secondary-color: #2c2c2c;     /* 稍亮黑色次背景 */
        --text-color: #ffffff;          /* 白色文字 */
        --border-color: #c62828;        /* 深紅邊框 */
        --hover-color: #3d2828;         /* 紅黑色懸停 */
        --shadow-color: rgba(198, 40, 40, 0.3); /* 紅色陰影 */
        
        /* 強調色 */
        --accent-color: #f44336;        /* 紅色重點色 */
        --accent-color-light: rgba(244, 67, 54, 0.2); /* 淡紅色 */
        --accent-color-dark: #c62828;   /* 深紅色 */
        
        /* 功能色 */
        --success-color: #4caf50;       /* 綠色成功色 */
        --warning-color: #ff9800;       /* 橙色警告色 */
        --error-color: #f44336;         /* 紅色錯誤色 */
        --info-color: #2196f3;          /* 藍色資訊色 */
        
        /* 特殊元件顏色 */
        --button-primary: #f44336;      /* 主按鈕顏色 */
        --button-secondary: #424242;    /* 副按鈕顏色 */
        --input-bg: #212121;            /* 輸入框背景色 */
        --input-border: #424242;        /* 輸入框邊框 */
        --input-focus-border: #f44336;  /* 輸入框焦點邊框 */
        --card-bg: #2c2c2c;             /* 卡片背景色 */
        
        /* 文字強調色 */
        --text-highlight: #f44336;      /* 文字強調色 */
        --text-muted: #9e9e9e;          /* 文字淡色 */
        
        /* 與舊代碼兼容的變數 */
        --button-orange: #f44336;
        --button-blue: #2196f3;
        --button-grey: #424242;
    }

    /* 暮光星塵主題 */
    :root[data-theme="blue-purple"] {
        /* 基本色調 */
        --primary-color: #1a1a2e;      /* 深藍紫背景 */
        --secondary-color: #2f2f49;    /* 藍紫次背景 */
        --text-color: #e6e6ff;         /* 淺藍紫文字 */
        --border-color: #7b68ee;       /* 薰衣草邊框 */
        --hover-color: #3f3f66;        /* 藍紫懸停 */
        --shadow-color: rgba(123, 104, 238, 0.3); /* 紫色陰影 */
        
        /* 強調色 */
        --accent-color: #9370db;       /* 紫色重點色 */
        --accent-color-light: rgba(147, 112, 219, 0.2); /* 淡紫色 */
        --accent-color-dark: #6a3ece;  /* 深紫色 */
        
        /* 功能色 */
        --success-color: #00bfa5;      /* 松石綠成功色 */
        --warning-color: #fed330;      /* 金黃警告色 */
        --error-color: #ff4757;        /* 粉紅錯誤色 */
        --info-color: #00cec9;         /* 藍綠資訊色 */
        
        /* 特殊元件顏色 */
        --button-primary: #9370db;     /* 主按鈕顏色 */
        --button-secondary: #3d3d64;   /* 副按鈕顏色 */
        --input-bg: #232342;           /* 輸入框背景色 */
        --input-border: #4b4b80;       /* 輸入框邊框 */
        --input-focus-border: #9370db; /* 輸入框焦點邊框 */
        --card-bg: #2f2f49;            /* 卡片背景色 */
        
        /* 文字強調色 */
        --text-highlight: #9370db;     /* 文字強調色 */
        --text-muted: #a0a0c8;         /* 文字淡色 */
        
        /* 與舊代碼兼容的變數 */
        --button-orange: #9370db;
        --button-blue: #00cec9;
        --button-grey: #3d3d64;
    }

    /* 翠玉清風主題 */
    :root[data-theme="green"] {
        /* 基本色調 */
        --primary-color: #f1f8e9;      /* 淺綠背景 */
        --secondary-color: #ffffff;    /* 白色次背景 */
        --text-color: #2e7d32;         /* 綠色文字 */
        --border-color: #81c784;       /* 綠色邊框 */
        --hover-color: #e8f5e9;        /* 更淺綠懸停 */
        --shadow-color: rgba(129, 199, 132, 0.3); /* 綠色陰影 */
        
        /* 強調色 */
        --accent-color: #4caf50;       /* 綠色重點色 */
        --accent-color-light: rgba(76, 175, 80, 0.2); /* 淡綠色 */
        --accent-color-dark: #2e7d32;  /* 深綠色 */
        
        /* 功能色 */
        --success-color: #4caf50;      /* 綠色成功色 */
        --warning-color: #ff9800;      /* 橙色警告色 */
        --error-color: #f44336;        /* 紅色錯誤色 */
        --info-color: #2196f3;         /* 藍色資訊色 */
        
        /* 特殊元件顏色 */
        --button-primary: #4caf50;     /* 主按鈕顏色 */
        --button-secondary: #e8f5e9;   /* 副按鈕顏色 */
        --input-bg: #ffffff;           /* 輸入框背景色 */
        --input-border: #81c784;       /* 輸入框邊框 */
        --input-focus-border: #4caf50; /* 輸入框焦點邊框 */
        --card-bg: #ffffff;            /* 卡片背景色 */
        
        /* 文字強調色 */
        --text-highlight: #2e7d32;     /* 文字強調色 */
        --text-muted: #757575;         /* 文字淡色 */
        
        /* 與舊代碼兼容的變數 */
        --button-orange: #4caf50;
        --button-blue: #2196f3;
        --button-grey: #e8f5e9;
    }

    /* 科技藍調主題 */
    :root[data-theme="blue"] {
        /* 基本色調 */
        --primary-color: #1a2639;      /* 深藍背景 */
        --secondary-color: #2e4059;    /* 中藍次背景 */
        --text-color: #e5e5e5;         /* 淺灰文字 */
        --border-color: #4d8cc4;       /* 藍色邊框 */
        --hover-color: #395981;        /* 懸停色 */
        --shadow-color: rgba(77, 140, 196, 0.3); /* 藍色陰影 */
        
        /* 強調色 */
        --accent-color: #3498db;       /* 藍色重點色 */
        --accent-color-light: rgba(52, 152, 219, 0.2); /* 淡藍色 */
        --accent-color-dark: #2980b9;  /* 深藍色 */
        
        /* 功能色 */
        --success-color: #2ecc71;      /* 綠色成功色 */
        --warning-color: #f39c12;      /* 橙色警告色 */
        --error-color: #e74c3c;        /* 紅色錯誤色 */
        --info-color: #3498db;         /* 藍色資訊色 */
        
        /* 特殊元件顏色 */
        --button-primary: #3498db;     /* 主按鈕顏色 */
        --button-secondary: #34495e;   /* 副按鈕顏色 */
        --input-bg: #223347;           /* 輸入框背景色 */
        --input-border: #4d8cc4;       /* 輸入框邊框 */
        --input-focus-border: #3498db; /* 輸入框焦點邊框 */
        --card-bg: #2e4059;            /* 卡片背景色 */
        
        /* 文字強調色 */
        --text-highlight: #3498db;     /* 文字強調色 */
        --text-muted: #95a5a6;         /* 文字淡色 */
        
        /* 與舊代碼兼容的變數 */
        --button-orange: #3498db;
        --button-blue: #3498db;
        --button-grey: #34495e;
    }

    /* 皇家紫韻主題 */
    :root[data-theme="royal"] {
        /* 基本色調 */
        --primary-color: #2c003e;      /* 深紫背景 */
        --secondary-color: #3e0054;    /* 中紫次背景 */
        --text-color: #f2e6ff;         /* 淺紫文字 */
        --border-color: #9c27b0;       /* 紫色邊框 */
        --hover-color: #450063;        /* 懸停色 */
        --shadow-color: rgba(156, 39, 176, 0.3); /* 紫色陰影 */
        
        /* 強調色 */
        --accent-color: #9c27b0;       /* 紫色重點色 */
        --accent-color-light: rgba(156, 39, 176, 0.2); /* 淡紫色 */
        --accent-color-dark: #7b1fa2;  /* 深紫色 */
        
        /* 功能色 */
        --success-color: #00c853;      /* 綠色成功色 */
        --warning-color: #ffab00;      /* 橙色警告色 */
        --error-color: #d50000;        /* 紅色錯誤色 */
        --info-color: #2196f3;         /* 藍色資訊色 */
        
        /* 特殊元件顏色 */
        --button-primary: #9c27b0;     /* 主按鈕顏色 */
        --button-secondary: #4a0072;   /* 副按鈕顏色 */
        --input-bg: #3e0054;           /* 輸入框背景色 */
        --input-border: #9c27b0;       /* 輸入框邊框 */
        --input-focus-border: #9c27b0; /* 輸入框焦點邊框 */
        --card-bg: #3e0054;            /* 卡片背景色 */
        
        /* 文字強調色 */
        --text-highlight: #ba68c8;     /* 文字強調色 */
        --text-muted: #c9a0dc;         /* 文字淡色 */
        
        /* 與舊代碼兼容的變數 */
        --button-orange: #9c27b0;
        --button-blue: #2196f3;
        --button-grey: #4a0072;
    }

    /* 修改現有的基礎樣式，添加動畫效果 */

    html, body {
        width: 100%;           /* 改為100%寬度 */
        max-width: 400px;      /* 設定最大寬度 */
        margin: 0 auto;
        position: relative; /* 添加这行 */
        overflow-x: hidden;
        -webkit-text-size-adjust: 100%;
        padding: 0 3px;       /* 增加左右padding */
        background-color: var(--primary-color);
        color: var(--text-color);
        font-family: "Microsoft JhengHei", Arial, sans-serif;
        box-sizing: border-box; /* 添加這行 */
    }

    h1 {
        color: var(--text-color);
        font-size: 22px;
        margin-bottom: 0px;
        border-bottom: 2px solid var(--button-orange);
        padding: 0 24px 5px; /* 添加左右內邊距，保留底部內邊距 */
        position: relative;
        transition: all 0.3s ease;
    }

    h1:hover {
        transform: translateY(-2px);
        text-shadow: 0 2px 4px rgba(255, 156, 51, 0.3);
    }

    h1::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--button-orange);
        transform: scaleX(0);
        transform-origin: right;
        transition: transform 0.6s ease-out;
    }

    h1:hover::after {
        transform: scaleX(1);
        transform-origin: left;
    }

    .row {
        margin: 4px 0;
        display: flex;
        align-items: center;
        background: var(--secondary-color);
        padding: 3px;
        border-radius: 4px;
        box-shadow: 0 4px 8px var(--shadow-color);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        transform-origin: left;
        will-change: transform; 
    }

	.row:hover {
        transform: translateX(5px);
        box-shadow: 0 6px 12px var(--shadow-color);
    }

    .row:hover::before {
        content: '';
        position: absolute;
        left: -5px;
        top: 50%;
        width: 3px;
        height: 0;
        background: var(--button-orange);
        animation: expandHeight 0.3s forwards;
    }

    /* 創建輸入框與按鍵的視覺分組 */
    .input-button-group {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin: 4px 0;
        padding: 1px; /* 減少整體內邊距 */
        background: var(--secondary-color);
        box-shadow: 0 4px 8px var(--shadow-color);
        position: relative;
        overflow: hidden;
    }

    .input-button-group .row {
        background: transparent;
        box-shadow: none;
        margin: 2px 0;  /* 減少上下間距 */
        padding-top: 1px; /* 減少上部內邊距 */
        padding-bottom: 1px; /* 減少下部內邊距 */
    }

    .input-button-group .row:hover {
        transform: translateX(2px);
        box-shadow: none;
    }

    .input-button-group .row:hover::before {
        display: none;
    }

    /* 按鍵容器樣式調整 */
    .input-button-group div[id$="Buttons"] {
        margin: 0;
        padding-top: 0;
        padding-bottom: 2px; /* 減少下部內邊距 */
        border-top: none; /* 移除虛線邊框 */
    }

    @keyframes expandHeight {
        to {
            height: 100%;
            top: 0;
        }
    }

    .label {
        width: 120px;
        margin-right: 15px;
        text-align: right;
        font-weight: 600;
        color: var(--text-color);
        position: relative;
        overflow: hidden;
    }

    input {
        width: 95px;
        padding: 5px 12px;
        margin-right: 10px;
        background-color: #222222;
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 16px;
        transition: all 0.3s ease;
    }

    input:focus {
		outline: none;
		border-color: var(--button-orange);
		box-shadow: 0 0 0 3px rgba(255, 156, 51, 0.2);
		transform: scale(1.07);
	}

    .value-changed {
        animation: valueChange 0.5s ease-out;
        will-change: background-color;
    }

    @keyframes valueChange {
        0% { 
            background-color: rgba(255, 156, 51, 0.2);
            transform: scale(1.02);
        }
        100% { 
            background-color: transparent;
            transform: scale(1);
        }
    }


    button {
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 3px 8px;
        margin: 0 5px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 16px;
    }

    button:hover {
        background-color: var(--hover-color);
		transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
	button:active {
        transform: scale(0.95) translateY(1px);
    	transition: transform 0.1s;
    }
	
	.row button {
        background-color: var(--secondary-color);
        color: #888888; /* 降低文字亮度 */
        border: 1px solid #444444; /* 更深的邊框顏色 */
        padding: 3px 8px;
        margin: 0 5px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 15px;
        opacity: 0.8;
    }

    #periodButtons button, 
    #rateButtons button, 
    #principalButtons button, 
    #commissionButtons button, 
    #PaymentduringButtons button,
    #commissionPercentButtons button {
        min-width: 50px;       /* 設置最小寬度 */
        text-align: center;    /* 文字居中 */
        flex: 1;               /* 平均分配空間 */
        max-width: 80px;       /* 限制最大寬度 */
        margin: 0 2px;         /* 調整邊距 */
        height: 28px;          /* 統一高度 */
        padding: 0 5px;        /* 調整內距 */
        display: flex;         /* 使用flex佈局 */
        align-items: center;   /* 垂直居中 */
        justify-content: center; /* 水平居中 */
        white-space: nowrap;   /* 防止文字換行 */
        overflow: hidden;      /* 隱藏溢出內容 */
        text-overflow: ellipsis; /* 超出部分使用省略號 */
    }

    /* 針對按鈕數量多的兩個組別進行特殊調整 */
    #periodButtons button, 
    #rateButtons button {
        min-width: 35px;      /* 減小最小寬度 */
        max-width: 50px;      /* 減小最大寬度 */
        padding: 0 3px;       /* 減小內部間距 */
        font-size: 15px;      /* 稍微減小字體大小 */
    }

    /* 減小這兩個按鈕組的按鈕間距 */
    #periodButtons, 
    #rateButtons {
        gap: 2px;             /* 減小按鈕之間的間距 */
    }

    .row button:hover {
        background-color: #4a4a4a; /* 稍微亮一點的灰色 */
        color: #cccccc; /* 亮一點的文字，但不是純白 */
        border-color: #555555;
        opacity: 0.9;
    }

    .row button:active {
        background-color: var(--secondary-color);  /* 點擊時恢復原本顏色 */
        color: var(--text-color);
        border-color: var(--button-grey);
    }
	.row button::after {
		content: '';
		position: absolute;
		top: 50%;
		left: 50%;
		width: 0;
		height: 0;
		background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
		transition: width 0.3s ease-out, height 0.3s ease-out;
		transform: translate(-50%, -50%);
		border-radius: 50%;
	}

	.row button:active::after {
		width: 150px;
		height: 150px;
	}

    /* 當滑鼠懸停在按鍵組上時的效果 */
    .input-button-group div[id$="Buttons"]:hover {
        background-color: rgba(255, 156, 51, 0.05);
        border-radius: 4px;
    }

    /* 將組內的按鍵輕微突出顯示 */
    .input-button-group div[id$="Buttons"] button {
        position: relative;
        z-index: 2;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    /* 改進按鍵點擊反饋 */
    .input-button-group div[id$="Buttons"] button:active {
        transform: scale(0.95);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        transition: transform 0.1s, box-shadow 0.1s;
    }

    /* 添加輕微的懸停效果 */
    .input-button-group div[id$="Buttons"] button:hover {
        border-color: var(--button-orange);
    }

    div[id$="Buttons"] button {
        background-color: var(--secondary-color);
        color: #bcbcbc; /* 提高文字明度 */
        border: 1px solid var(--button-orange); /* 使用橘色外框 */
        padding: 4px 9px;
        margin: 0 4px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 15px;
        opacity: 0.95; /* 提高不透明度 */
    }

    div[id$="Buttons"] button:hover {
        background-color: rgba(255, 156, 51, 0.15); /* 淡橘色背景 */
        color: #ffffff;
        border-color: var(--button-orange);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(255, 156, 51, 0.2);
    }

	div[id$="Buttons"] button:active {
        transform: translateY(1px);
        background-color: rgba(255, 156, 51, 0.3); /* 點擊時只改變當前按鈕的背景 */
        box-shadow: 0 0 5px rgba(255, 156, 51, 0.5) inset; /* 內陰影效果 */
        transition: all 0.1s ease;
    }

    .readonly {
        background-color: #222222;
        animation: breathe 4s ease-in-out infinite;
    }

    @keyframes breathe {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    /* 包装容器样式 */
    /* 修改 wrapper 样式 */
    .time-display-wrapper {
        position: relative;
        height: auto;
        margin: 3px 0;
        z-index: 1000; /* 提高 z-index */
    }

    /* 修改原有的timeDisplay样式 */
    .sticky-header {
        position: -webkit-sticky !important; /* 添加 !important */ /* Safari支持 */
        position: sticky!important;         /* 添加 !important */
        top: 0;
        background: var(--secondary-color);
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 4px var(--shadow-color);
        animation: fadeIn 0.8s ease-out;
        transition: all 0.3s ease;
        z-index: 999;
        width: calc(100% - 16px); /* 考虑内边距 */
        margin: 0 auto;
    }

    /* 添加固定状态的样式 */
    .sticky-header.is-sticky {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        border-radius: 0 0 4px 4px;
    }

    #timeDisplay {
        margin: 3px 0;
        font-size: 15px;
        background: var(--secondary-color);
        color: var(--text-color);
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 4px var(--shadow-color);
		animation: fadeIn 0.8s ease-out;
        transition: all 0.3s ease;
		position: relative;
    	overflow: hidden;
    }

	#timeDisplay:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 12px var(--shadow-color);
    }

	#timeDisplay::before {
		content: '';
		position: absolute;
		top: 0;
		left: -100%;
		width: 100%;
		height: 2px;
		background: linear-gradient(90deg, transparent, var(--button-orange), transparent);
		animation: timelineSlide 3s linear infinite;
	}
	@keyframes timelineSlide {
		0% { left: -100%; }
		100% { left: 100%; }
    }

    .time-label {
        font-weight: bold;
        margin-right: 10px;
        color: var(--button-orange);
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* 添加滚动时的效果 */
    .sticky-header.is-sticky {
        border-radius: 0 0 4px 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transform: translateY(0);
    }

    #periodButtons, #rateButtons, #principalButtons, #commissionButtons, #PaymentduringButtons, #commissionPercentButtons {
        margin: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 3px;
        width: 100%;
        justify-content: center;
        padding: 0 5px;
        box-sizing: border-box;
        min-height: 32px;
        align-items: center;
    }

    button {
        flex-shrink: 0;
    }

    /* 新的按鈕組樣式 */
    .function-buttons {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin: 4px 0;
        padding: 0;  /* 移除左右內邊距 */
        width: 100%; /* 確保寬度與其他欄位一致 */
    }

    .function-buttons .button-row {
        display: flex;
        justify-content: space-between;
        gap: 4px;  /* 縮小按鈕之間的間距 */
        width: 100%;
    }

    /* 調整頂部按鈕組 */
    .top-buttons .button-row button {
        flex: 1;
        min-width: 0;
    }

    /* 調整底部按鈕組 */
    .bottom-buttons .button-row button {
        flex: 1;
        min-width: 0;
    }

    .function-buttons .top-row,
    .function-buttons .bottom-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    .function-buttons .top-row button {
        flex: 1;
        min-width: 0;
        margin: 0;  /* 確保沒有額外的外邊距 */
    }

    .function-buttons .bottom-row button {
        flex: 1;
        min-width: 0;
        margin: 0;  /* 確保沒有額外的外邊距 */
    }

    /* 統一所有功能按鈕的基礎樣式 */
    .function-buttons button {
        background-color: var(--secondary-color);
        color: #ffffff; /* 使用白色文字而非橙色 */
        border: 1px solid var(--button-orange);
        border-radius: 6px; /* 統一圓角 */
        padding: 8px 0;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        text-align: center;
        position: relative;
        overflow: hidden;
        flex: 1;  /* 確保按鈕平均分配空間 */
        min-width: 0;  /* 允許按鈕變窄 */
        margin: 0;  /* 移除按鈕外邊距 */
    }

    .function-buttons button::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to right, rgba(255, 156, 51, 0.1), transparent);
        z-index: -1;
        transform: translateX(-100%);
        transition: transform 0.6s ease;
    }

    /* 統一所有按鈕的懸停效果 */
    .function-buttons button:hover {
        background-color: var(--button-orange);
        color: #ffffff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .function-buttons button:hover::before {
        transform: translateX(0);
    }

    /* 統一所有按鈕的點擊效果 */
    .function-buttons button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        transition: all 0.1s;
    }

    /* 主要操作按鈕樣式 */
    /* 移除main-action-btn特殊樣式，保持統一 */
    .function-buttons .main-action-btn {
        /* 移除差異化樣式，保持與其他按鈕一致 */
        background-color: var(--secondary-color);
        color: #ffffff;
        padding: 8px 0;
        border: 1px solid var(--button-orange);
    }

    .function-buttons .main-action-btn::before {
        background: linear-gradient(to right, rgba(255, 255, 255, 0.05), transparent);  /* 降低漸變亮度 */
    }

    .function-buttons .main-action-btn:hover {
        background-color: var(--button-orange);  /* 懸停時改為橙色 */
        box-shadow: 0 7px 14px rgba(255, 156, 51, 0.4);
        transform: translateY(-3px);
    }

    .function-buttons .main-action-btn:active {
        transform: translateY(1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* 在 style 標籤中修改或新增以下 CSS */
	.quote-table {
		width: 100%;
		border-collapse: separate;
		border-spacing: 0;
		margin: 10px 0;
		background: var(--primary-color);
		border-radius: 12px;
		overflow: hidden;
		box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
	}

	.quote-table tr {
		background: var(--secondary-color);
		transition: background-color 0.3s ease;
	}

	.quote-table tr:hover {
		background: var(--hover-color);
	}

	.quote-table td {
		padding: 10px 10px; /* 增加內邊距 */
		border-bottom: 1px solid var(--border-color);
		color: var(--text-color);
		font-size: 16px; /* 增加字體大小 */
		line-height: 1.2; /* 增加行高 */
	}

	.quote-table td:first-child {
		width: 140px; /* 增加標籤欄寬度 */
		white-space: nowrap;
		color: var(--button-orange);
		font-weight: 700; /* 加粗 */
		text-align: right;
		padding-right: 10px;
		font-size: 16px; /* 標籤文字更大 */
	}

	.quote-table td:last-child {
		text-align: right;
		font-family: monospace;
		font-size: 16px; /* 數值更大 */
		letter-spacing: 0px; /* 增加字距 */
	}

	/* 新增容器樣式 */

	#quoteContainer {
		padding: 24px;
		background: #333333;
		border-radius: 16px;
		box-shadow: 0 12px 24px rgba(0, 0, 0, 0.5);
		margin: 20px;
	}

    .function-buttons button::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: var(--button-orange);
        z-index: -1;
        border-radius: 6px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .function-buttons button:hover::before {
        opacity: 0.2;
        animation: pulseGlow 1.5s infinite;
    }

    @keyframes pulseGlow {
        0% { transform: scale(1); opacity: 0.2; }
        50% { transform: scale(1.05); opacity: 0.3; }
        100% { transform: scale(1); opacity: 0.2; }
    }
    
	.function-buttons button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.1);
        transform: translate(-50%, -50%) scale(0);
        border-radius: 50%;
        transition: transform 0.5s;
    }

	.function-buttons button:hover {
		background-color: var(--button-orange);
		color: var(--text-color);
		border-color: var(--button-orange);
	}

	.function-buttons button:hover::after {
        transform: translate(-50%, -50%) scale(2);
    }

	.function-buttons button:active {
		background-color: var(--secondary-color);
		color: var(--button-orange);
		border-color: var(--button-orange);
	}

	.footer-message {
        background-color: var(--primary-color);
        color: var(--text-color);
        padding: 15px;
        text-align: center;
        margin-top: 15px;
        border-radius: 4px;
        transform: scale(1.05);
        text-shadow: 0 0 10px var(--button-orange);
        transition: all 0.3s ease;
        position: relative;
    }

	.footer-spacing {
        background-color: var(--primary-color);
        height: 50px;
        margin-top: 0px;
    }

	.footer-message::before {
		content: '🍚';
		margin-right: 8px;
		display: inline-block;
		transition: transform 0.3s ease;
	}

	.footer-message:hover::before {
		transform: rotate(360deg);
	}

	@keyframes glowBorder {
		0%, 100% { box-shadow: 0 0 5px var(--button-orange); }
		50% { box-shadow: 0 0 15px var(--button-orange), 0 0 30px rgba(255, 156, 51, 0.3); }
    }
	.warning-text {
		color: #ff0000 !important;
		font-weight: bold !important;
		animation: pulse 1s infinite, shake 0.5s ease-in-out; 
        will-change: transform; 
	}

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-1px); }
        40%, 80% { transform: translateX(1px); }
    }


    /* 1. 流光分隔線 */
    .divider-flow {
            position: relative;
            height: 2px;
            background: linear-gradient(90deg, 
                var(--secondary-color) 0%,
                var(--button-orange) 50%,
                var(--secondary-color) 100%);
            margin: 4px 0;
            overflow: hidden;
        }

        .divider-flow::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 156, 51, 0.8),
                transparent);
            animation: flowLight 3s ease-in-out infinite;
        }

        @keyframes flowLight {
            0% { transform: translateX(0); }
            100% { transform: translateX(200%); }
        }

    /* 分隔線淡入動畫 */
    @keyframes dividerFadeIn {
        from {
            opacity: 0;
            transform: scaleX(0.8);
        }
        to {
            opacity: 1;
            transform: scaleX(1);
        }
    }

    /* 發光效果動畫 */
    @keyframes dividerGlow {
        0% {
            left: -100%;
        }
        50% {
            left: 100%;
        }
        100% {
            left: 100%;
        }
    }

    /* 強調重要欄位 */
    .emphasized-row {
        border-left: 3px solid var(--button-orange);
        background: linear-gradient(90deg, rgba(255, 156, 51, 0.1), transparent);
        transform: scale(1.01);
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .emphasized-row .label {
        color: var(--button-orange);
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .emphasized-row input {
        font-weight: bold;
        color: #ffffff;
        font-size: 17px;
        border-color: var(--button-orange);
    }

    .emphasized-row:hover {
        transform: scale(1.02) translateX(5px);
        box-shadow: 0 7px 20px rgba(0, 0, 0, 0.25);
    }

    /* 歷史記錄面板樣式 */
    /* 重新设计历史记录面板样式 */
    .history-panel {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95); /* 深色背景增加对比度 */
        z-index: 1000;
        overflow-y: auto;
        animation: fadeIn 0.3s ease-out;
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: var(--primary-color);
        position: sticky;
        top: 0;
        z-index: 1001;
        border-bottom: 2px solid var(--button-orange);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    .header-left {
        flex: 1;
    }

    .header-right {
        margin-right: 10px;
    }

    .history-header h2 {
        margin: 0;
        color: var(--button-orange);
        font-size: 20px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .close-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 5px 10px;
        border-radius: 50%;
        margin-left: 10px;
        background-color: rgba(255, 255, 255, 0.1);
    }

    .close-btn:hover {
        color: var(--button-orange);
        transform: scale(1.1);
        background-color: rgba(255, 255, 255, 0.2);
    }

    .history-content {
        padding: 8px; /* 從 10px 減少到 8px */
        max-width: 400px;
        margin: 0 auto;
    }

    /* 改进历史记录列表 */
    .history-list {
        display: flex;
        flex-direction: column;
        gap: 10px; /* 從 12px 減少到 10px */
        padding: 3px; /* 從 5px 減少到 3px */
        margin-bottom: 10px; /* 增加底部間距 */
    }

    /* 重新设计历史项目卡片 */
    /* 位置: .history-item 樣式 (約在 CSS 第 1010 行附近) */
    .history-item {
        background-color: var(--secondary-color);
        padding: 8px; /* 從 12px 減少到 8px */
        border-radius: 8px; /* 從 10px 減少到 8px */
        position: relative;
        transition: all 0.3s ease;
        border-left: 3px solid var(--button-orange);
        display: flex;
        flex-direction: column;
        gap: 6px; /* 從 8px 減少到 6px */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* 稍微降低陰影 */
        margin-bottom: 10px; /* 增加卡片間的間距 */
    }

    .history-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    }

    /* 历史记录顶部区域 - 日期和按钮 */
    /* 修改历史记录卡片头部布局样式 */
    .history-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding-bottom: 2px; /* 增加底部一點間距 */
    }

    .history-date {
        font-weight: bold;
        color: var(--button-orange);
        font-size: 14px; /* 從 15px 減少到 14px */
        padding: 2px 0; /* 從 3px 減少到 2px */
    }

    /* 将税佣后利率移到头部右侧 */
    .history-header-rate {
        font-weight: bold;
        color: #ffffff;
        font-size: 16px; /* 從 16px 減少到 14px */
        background-color: rgba(255, 156, 51, 0.2);
        padding: 2px 6px; /* 從 3px 8px 改為 2px 6px */
        border-radius: 4px;
    }


    /* 历史详情展示区 */
    .history-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 6px; /* 從 10px 減少到 6px */
        background-color: rgba(0, 0, 0, 0.15);
        padding: 6px; /* 從 10px 減少到 6px */
        border-radius: 4px; /* 從 6px 減少到 4px */
    }

    .history-detail-item {
        display: flex;
        flex-direction: column;
        gap: 1px; /* 從 3px 減少到 1px */
    }

    .detail-label {
        font-size: 12px; /* 從 13px 減少到 12px */
        color: #aaaaaa;
    }

    /* 增大字体大小 */
    .detail-value {
        font-size: 18px; /* 從 18px 減少到 16px */
        font-weight: bold;
        color: #ffffff;
        line-height: 1.2; /* 添加行高控制 */
    }

    /* 适配移动设备 */
    @media screen and (max-width: 360px) {
        .history-item {
            padding: 6px;
            gap: 4px;
        }
        
        .history-header-rate {
            font-size: 13px;
            padding: 2px 5px;
        }
        
        .history-date {
            font-size: 13px;
        }
        
        .detail-value {
            font-size: 15px;
        }
        
        .history-details {
            padding: 5px;
            gap: 5px;
        }
        
        .delete-btn, .detail-btn {
            padding: 5px 10px;
            font-size: 12px;
            min-width: 65px;
        }
    }


    /* 按钮区域 */
    .history-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px; /* 從 10px 減少到 8px */
        margin-top: 3px; /* 從 5px 減少到 3px */
    }

    .delete-btn, .detail-btn {
        padding: 6px 12px; /* 從 8px 15px 改為 6px 12px */
        border-radius: 4px; /* 從 6px 減少到 4px */
        font-size: 13px; /* 從 14px 減少到 13px */
        font-weight: bold;
        transition: all 0.25s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        min-width: 70px; /* 增加最小寬度確保可點擊區域 */
    }

    .delete-btn {
        background-color: rgba(231, 76, 60, 0.25); /* 增加背景不透明度 */
        color: #ffffff; /* 改為白色文字 */
        border: 1px solid rgba(231, 76, 60, 0.5); /* 增加邊框 */
    }

    .delete-btn:hover {
        background-color: #e74c3c;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 3px 5px rgba(231, 76, 60, 0.4);
    }

    .delete-btn:active {
        transform: translateY(1px);
    }

    .detail-btn {
        background-color: rgba(51, 181, 229, 0.25); /* 增加背景不透明度 */
        color: #ffffff; /* 改為白色文字 */
        border: 1px solid rgba(51, 181, 229, 0.5); /* 增加邊框 */
    }

    .detail-btn:hover {
        background-color: var(--button-blue);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 3px 5px rgba(51, 181, 229, 0.4);
    }

    .detail-btn:active {
        transform: translateY(1px);
    }

    .no-data {
        text-align: center;
        color: #cccccc;
        font-style: italic;
        padding: 30px 0;
        font-size: 16px;
    }

    /* 全部删除按钮改进 */
    .delete-all-btn {
        background: rgba(231, 76, 60, 0.15);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        font-size: 14px;
        padding: 6px 14px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
    }

    .delete-all-btn:hover {
        background-color: #e74c3c;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 3px 5px rgba(231, 76, 60, 0.4);
    }

    .delete-all-btn:active {
        transform: translateY(1px);
        box-shadow: none;
    }

    /* 模態框樣式 */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-out;
    }

    .modal-container {
        background-color: var(--primary-color);
        border-radius: 10px;
        width: 90%;
        max-width: 350px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        animation: modalSlideIn 0.3s ease-out;
        overflow: hidden;
    }

    @keyframes modalSlideIn {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--secondary-color);
    }

    .modal-header h3 {
        margin: 0;
        color: var(--button-orange);
        font-size: 18px;
    }

    .modal-content {
        padding: 20px 15px;
        color: var(--text-color);
        max-height: 70vh;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 10px 15px 15px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid var(--border-color);
        background-color: var(--secondary-color);
    }

    .modal-btn {
        padding: 8px 15px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 15px;
        transition: all 0.3s ease;
        border: none;
    }

    .modal-btn-primary {
        background-color: var(--button-orange);
        color: white;
    }

    .modal-btn-primary:hover {
        background-color: #e88a22;
        transform: translateY(-2px);
    }

    .modal-btn-secondary {
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .modal-btn-secondary:hover {
        background-color: var(--hover-color);
        transform: translateY(-2px);
    }

    /* 提示框樣式 */
    .toast-message {
        position: fixed;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(51, 181, 229, 0.9);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 9999;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        opacity: 1;
        transition: opacity 0.5s ease;
    }

    /* 讓「稅佣後利率」輸入框更明顯但不突兀 */
    #afterCommissionRate {
        font-weight: bold;
        color: #ffffff;
        background-color: rgba(255, 156, 51, 0.08); /* 更淡的橘色背景 */
        border: 1px solid rgba(255, 156, 51, 0.6); /* 半透明橘色邊框 */
        box-shadow: 0 0 4px rgba(255, 156, 51, 0.15); /* 微弱的發光效果 */
    }

    #afterCommissionRate.value-changed {
        animation: afterRateChange 0.8s ease-out;
    }

    @keyframes afterRateChange {
        0% { 
            background-color: rgba(255, 156, 51, 0.3);
            transform: scale(1.02);
        }
        100% { 
            background-color: rgba(255, 156, 51, 0.08);
            transform: scale(1);
        }
    }

    /* Number Input Modal */
    .number-input-modal {
        background-color: var(--primary-color);
        border-radius: 12px;
        width: 95%;
        max-width: 350px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        animation: modalSlideIn 0.3s ease-out;
    }

    .calculator-display {
        background-color: #222222;
        color: var(--text-color);
        font-size: 32px;
        padding: 10px 15px;
        text-align: right;
        margin: 10px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        height: 46px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .calculator-display-container {
        display: flex;
        flex-direction: column;
        background-color: #1a1a1a;
        margin: 10px;
        border-radius: 10px;
        border: 1px solid #444444;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        height: 110px; /* 固定高度 */
        position: relative;
    }

    .calculator-history {
        color: #9e9e9e;
        font-size: 16px;
        padding: 8px 15px;
        text-align: right;
        height: 40px; /* 固定高度 */
        overflow-y: hidden;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        line-height: 1.3;
        word-break: break-all;
        font-family: 'Consolas', monospace;
        position: relative;
        background: linear-gradient(to bottom, #1e1e1e, #2a2a2a);
    }

    .calculator-history::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 1px;
        background: linear-gradient(to right, transparent, rgba(255, 156, 51, 0.4), transparent);
    }

    .calculator-display {
        background-color: #2a2a2a;
        color: white;
        font-size: 36px;
        padding: 10px 15px;
        text-align: right;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        overflow: hidden;
        margin: 0;
        border: none;
        box-shadow: none;
        font-family: 'Consolas', monospace;
        font-weight: bold;
        letter-spacing: 1px;
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
        position: relative;
        background: linear-gradient(to bottom, #2a2a2a, #222222);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .calculator-scroll-indicator {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 12px;
        height: 12px;
        background-color: rgba(255, 156, 51, 0.7);
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 10;
    }

    .has-overflow .calculator-scroll-indicator {
        opacity: 1;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.7; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.1); }
    }

    .calculator-buttons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(5, auto);
        gap: 6px;
        padding: 10px;
    }

    .calculator-buttons button {
        padding: 10px 0;
        font-size: 20px;
        border-radius: 10px;
        background-color: #3a3a3a;
        color: var(--text-color);
        border: none;
        transition: all 0.2s ease;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 48px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
    }

    .calculator-buttons button:hover {
        background-color: #464646;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .calculator-buttons button:active {
        transform: scale(0.95);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* 數字按鈕樣式 */
    /* 數字按鈕樣式 - 水平排列 */
    .calculator-buttons .number-btn {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        padding: 5px 2px;
        position: relative;
    }

    .calculator-buttons .arabic-number {
        font-size: 28px;
        font-weight: bold;
        line-height: 1;
        margin-right: 3px;
        flex-grow: 0;
    }

    .calculator-buttons .financial-char {
        font-size: 18px;
        color: var(--button-orange);
        line-height: 1;
        position: absolute;
        right: 6px;
        opacity: 0.9;
    }

    /* 調整數字按鈕（包括零鍵）的樣式 */
    .calculator-buttons .number-btn {
        position: relative;
    }

    .calculator-buttons .number-btn .arabic-number {
        margin-right: 3px;
    }

    .calculator-buttons .number-btn .financial-char {
        right: 6px;
        font-size: 18px;
        color: var(--button-orange);
        position: absolute;
        opacity: 0.9;
    }

    /* 當數字按鈕被點擊時，改變數字和大寫的顏色 */
    .calculator-buttons .number-btn:active .arabic-number,
    .calculator-buttons .number-btn:active .financial-char {
        color: white;
    }

    /* 調整零鍵的寬度樣式，確保適應新的佈局 */
    .calculator-buttons .zero {
        background-color: #3a3a3a;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    /* 減小等號和運算符的字體大小，使布局更平衡 */
    .calculator-buttons .operator,
    .calculator-buttons .equals {
        font-size: 22px;
        font-weight: bold;
    }

    /* 調整清除和退格鍵的字體大小 */
    .calculator-buttons .clear,
    .calculator-buttons .function {
        font-size: 20px;
        font-weight: bold;
    }

    /* 按鈕按下後產生波紋效果 */
    .calculator-buttons button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%, -50%);
        transform-origin: 50% 50%;
    }

    .calculator-buttons button:active::after {
        animation: ripple 0.4s ease-out;
    }

    @keyframes ripple {
        0% {
            transform: scale(0, 0) translate(-50%, -50%);
            opacity: 0.5;
        }
        100% {
            transform: scale(20, 20) translate(-50%, -50%);
            opacity: 0;
        }
    }

    /* 功能鍵樣式 */
    .calculator-buttons .function {
        background-color: #4d4d4d;
        color: #eee;
        font-weight: bold;
    }

    /* 運算符號樣式 */
    .calculator-buttons .operator {
        background-color: rgba(255, 156, 51, 0.9);
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(255, 156, 51, 0.4);
    }

    /* 清除鍵樣式 */
    .calculator-buttons .clear {
        background-color: rgba(231, 76, 60, 0.9);
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(231, 76, 60, 0.4);
    }

    /* 等號鍵樣式 */
    .calculator-buttons .equals {
        background-color: rgba(52, 152, 219, 0.9);
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(52, 152, 219, 0.4);
    }

    /* 零鍵佔據兩欄 */
    .calculator-buttons .zero {
        grid-column: span 2;
        background-color: #3a3a3a;
    }

    /* 提交按鈕佔據兩欄 */
    .calculator-buttons .submit {
        grid-column: span 2;
        background-color: var(--button-orange);
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(255, 156, 51, 0.4);
    }

    .toast-error {
        background-color: rgba(231, 76, 60, 0.9);
    }

    /* 添加箭頭旋轉動畫 */
    #toggleIcon {
        display: inline-block;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #toggleIcon.icon-rotate-up {
        transform: rotate(180deg);
    }

    .icon-rotate-up {
        transform: rotate(180deg);
    }

    /* 用於隱藏元素的類 */
    .hidden-element {
        display: none !important;
    }

    /* 添加在現有 CSS 中 */
    .input-button-group {
        transition: all 0.3s ease-in-out;
        overflow: hidden;
    }

    .input-button-group div[id$="Buttons"] {
        transition: all 0.3s ease-in-out, max-height 0.3s ease-in-out;
        max-height: 100px; /* 預設最大高度 */
        opacity: 1;
    }

    .input-button-group div[id$="Buttons"].hidden-element {
        max-height: 0;
        opacity: 0;
        padding: 0;
        margin: 0;
        overflow: hidden;
    }

    .hidden-element {
        max-height: 0 !important;
        opacity: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        transition: all 0.3s ease-in-out;
        overflow: hidden !important;
    }

    /* 標題容器 - 添加獨立的z-index確保正確的層疊關係 */
    .header-container {
        text-align: center;
        position: relative;
        margin-bottom: 0px;
        z-index: 5; /* 添加明確的z-index */
    }

    /* 標題樣式 - 確保懸停效果不會影響按鈕 */
    h1 {
        color: var(--text-color);
        font-size: 22px;
        margin-bottom: 0px;
        border-bottom: 2px solid var(--button-orange);
        padding-bottom: 5px;
        position: relative;
        z-index: 1; /* 使h1位於較低層級 */
    }

    /* 移除h1懸停時的變形效果，防止影響按鈕 */
    h1:hover {
        text-shadow: 0 2px 4px rgba(255, 156, 51, 0.3);
        /* 移除transform以防止影響按鈕位置 */
    }

    /* 標題下方橙色線條效果 */
    h1::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--button-orange);
        transform: scaleX(0);
        transform-origin: right;
        transition: transform 0.6s ease-out;
        z-index: 1; /* 確保在h1下方 */
    }

    h1:hover::after {
        transform: scaleX(1);
        transform-origin: left;
    }

    /* 徹底重寫標題按鈕樣式，確保完全獨立 */
    .header-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: transparent;
        color: #666666;
        border: none;
        width: 22px;
        height: 22px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10; /* 提高z-index使按鈕始終位於最上層 */
        padding: 0;
        transition: color 0.2s ease;
        outline: none;
        
        /* 明確禁止所有可能的變形和動畫 */
        transform: translateY(-50%) !important;
        animation: none !important;
        box-shadow: none !important;
    }

    /* 固定懸停效果僅改變顏色 */
    .header-btn:hover {
        color: #999999;
        /* 明確禁止任何位置或大小變化 */
        transform: translateY(-50%) !important;
    }

    /* 固定點擊效果僅改變顏色 */
    .header-btn:active {
        color: var(--button-orange);
        /* 明確禁止任何位置或大小變化 */
        transform: translateY(-50%) !important;
    }

    /* 左右按鈕位置 */
    .header-btn-left {
        left: 5px;
    }

    .header-btn-right {
        right: 5px;
    }

    /* 清除可能影響到按鈕的其他CSS規則 */
    .header-btn * {
        transition: none !important;
        animation: none !important;
        transform: none !important;
    }

    /* 禁用任何可能影響按鈕的全局懸停效果 */
    *:hover .header-btn {
        transform: translateY(-50%) !important;
        position: absolute !important;
    }

    /* 添加縮放和淡入淡出效果 */
    @keyframes smoothFadeIn {
        from {
            opacity: 0;
            transform: scaleY(0.8);
        }
        to {
            opacity: 1;
            transform: scaleY(1);
        }
    }

    @keyframes smoothFadeOut {
        from {
            opacity: 1;
            transform: scaleY(1);
        }
        to {
            opacity: 0;
            transform: scaleY(0.8);
        }
    }

    .history-note-container {
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        margin: 6px 0;
        padding: 6px;
    }

    .history-item-footer {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .history-note-preview {
        color: #bcbcbc;
        font-size: 14px;
        min-height: 20px;
        padding: 4px;
        border: 1px solid transparent;
        transition: all 0.3s ease;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-grow: 1;
        max-width: 170px; /* 縮小寬度 */
    }

    .history-actions {
        display: flex;
        gap: 4px;
        margin-left: auto; /* 將按鈕推到右側 */
    }

    .history-note-preview:hover {
        background-color: rgba(255, 156, 51, 0.1);
        border-color: rgba(255, 156, 51, 0.3);
    }

    .note-editor-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;  /* 水平置中 */
        align-items: flex-start;  /* 垂直從頂部開始，但不是頂部對齊 */
        padding-top: 160px;  /* 增加頂部間距，避免太貼近頂部 */
    }

    .note-editor-content {
        background-color: var(--primary-color);
        border-radius: 12px;
        width: 80%;  /* 改為80%寬度 */
        max-width: 320px;  /* 減小最大寬度 */
        padding: 15px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        border: 1px solid var(--button-orange);
        animation: slideDown 0.3s ease-out;
        margin: 0 auto;  /* 確保水平置中 */
    }

    @keyframes slideDown {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .note-editor-input {
        width: calc(100% - 24px);  /* 減去padding寬度，避免溢出 */
        padding: 12px;
        margin: 12px 0;
        background-color: #222222;
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        min-height: 100px;
        resize: none;
        font-size: 16px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        box-sizing: border-box;  /* 確保寬度計算包含padding */
    }

    .note-editor-input:focus {
        border-color: var(--button-orange);
        box-shadow: 0 0 0 2px rgba(255, 156, 51, 0.2);
        outline: none;
    }

    .note-editor-buttons {
        display: flex;
        justify-content: flex-end;  /* 按鈕靠右對齊 */
        gap: 8px;  /* 減少按鈕間隙 */
        margin-top: 8px;
    }

    .note-editor-content h3 {
        color: var(--button-orange);
        font-size: 18px;
        margin: 0 0 8px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255, 156, 51, 0.3);
    }

    /* 新增截圖加載提示樣式 */
    /* 新增截圖加載提示樣式 */
    #screenshot-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-content {
        background-color: rgba(51, 181, 229, 0.9);
        color: white;
        padding: 15px 25px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        animation: pulseLoading 1.5s infinite;
    }

    @keyframes pulseLoading {
        0%, 100% { opacity: 0.9; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.05); }
    }

    /* 分享模態框樣式 */
    #shareModalOverlay .modal-container {
        width: 95%;
        max-width: 370px;
        padding-bottom: 15px;
        background-color: #333333;
    }

    #shareQuoteCard {
        border-radius: 12px;
        overflow: hidden;
        background-color: #333333;
        margin: 10px auto;
        max-width: 340px;
    }

    #shareOptions button {
        flex: 1;
        padding: 10px 15px;
        font-size: 15px;
        transition: all 0.3s ease;
    }

    #shareOptions button:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #shareStatus {
        height: 20px;
        font-style: italic;
    }

    /* 報價卡片圖片樣式 */
    #shareQuoteCard img {
        width: 100%;
        max-width: 380px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        display: block;
        margin: 0 auto;
    }

    /* 調整分享模態框內容區域 */
    #shareModalOverlay .modal-content {
        padding: 10px !important;
        overflow: visible !important;
    }

    /* 優化手機版報價卡片樣式 */
    @media screen and (max-width: 480px) {
        #shareQuoteCard {
            width: 95%;
            max-width: 340px;
            margin: 0 auto;
        }
        
        #shareQuoteCard img {
            width: 100%;
            max-width: 340px;
        }
        
        .modal-container {
            width: 95%;
            max-width: 350px;
        }
        
        .modal-content {
            padding: 5px !important;
        }
        
        #shareOptions {
            gap: 8px;
        }
        
        #shareOptions button {
            font-size: 14px;
            padding: 8px 12px;
        }
    }

    /* 選單容器樣式 */
    .menu-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2500;
        display: none;
        justify-content: flex-start;
        align-items: flex-start;
    }

    .menu-content {
        background-color: var(--primary-color);
        width: 75%;
        max-width: 300px;
        height: 100%;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        animation: slideInMenuFromLeft 0.25s ease-out;
        display: flex;
        flex-direction: column;
        transform-origin: left;
    }

    @keyframes slideInMenuFromLeft {
        from { 
            transform: translateX(-100%); 
            opacity: 0.5; 
        }
        to { 
            transform: translateX(0); 
            opacity: 1; 
        }
    }

    @keyframes slideOutMenuToLeft {
        from { 
            transform: translateX(0); 
            opacity: 1; 
        }
        to { 
            transform: translateX(-100%); 
            opacity: 0; 
        }
    }

    .menu-header {
        background-color: var(--secondary-color);
        border-bottom: 1px solid var(--border-color);
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .menu-header h3 {
        margin: 0;
        color: var(--button-orange);
        font-size: 18px;
    }

    .menu-close-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .menu-close-btn:hover {
        color: var(--button-orange);
        transform: scale(1.1);
    }

    .menu-list {
        flex: 1;
        overflow-y: auto;
        margin: 0;
        padding: 0;
        list-style: none;
    }

    .menu-item {
        padding: 16px 20px; /* 增加內邊距 */
        border-bottom: 1px solid var(--border-color);
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 18px; /* 增加字體大小 */
    }

    .menu-item:hover {
        background-color: rgba(255, 156, 51, 0.1);
    }

    .menu-item:active {
        background-color: rgba(255, 156, 51, 0.2);
    }

    .menu-item-arrow {
        font-size: 12px;
        transition: transform 0.3s ease;
    }

    /* 添加分隔線效果 */
    .menu-item, .submenu-item {
        position: relative;
    }

    .menu-item:after, .submenu-item:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 15px;
        right: 15px;
        height: 1px;
        background: linear-gradient(to right, transparent, var(--border-color), transparent);
    }

    /* 子選單樣式 */
    .submenu-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2600;
        display: none;
        justify-content: flex-start;
        align-items: flex-start;
    }

    .submenu-content {
        background-color: var(--primary-color);
        width: 75%;
        max-width: 300px;
        height: 100%;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        animation: slideInMenuFromLeft 0.25s ease-out;
        display: flex;
        flex-direction: column;
        transform-origin: left;
    }

    .menu-closing {
        animation: slideOutMenuToLeft 0.2s ease-out forwards;
    }

    .submenu-closing {
        animation: slideOutMenuToLeft 0.2s ease-out forwards;
    }

    .submenu-header {
        background-color: var(--secondary-color);
        border-bottom: 1px solid var(--border-color);
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .submenu-header h3 {
        margin: 0;
        color: var(--button-orange);
        font-size: 22px; /* 增加字體大小 */
        font-weight: bold; /* 增加字體粗細 */
    }

    .menu-header h3 {
        margin: 0;
        color: var(--button-orange);
        font-size: 22px; /* 增加字體大小 */
        font-weight: bold; /* 增加字體粗細 */
    }

    .submenu-back-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
    }

    .submenu-back-btn:hover {
        color: var(--button-orange);
    }

    .submenu-list {
        flex: 1;
        overflow-y: auto;
        margin: 0;
        padding: 0;
        list-style: none;
    }

    .submenu-item {
        padding: 16px 20px; /* 增加內邊距 */
        border-bottom: 1px solid var(--border-color);
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 18px; /* 增加字體大小 */
    }

    .submenu-item:hover {
        background-color: rgba(255, 156, 51, 0.1);
    }

    .submenu-item:active {
        background-color: rgba(255, 156, 51, 0.2);
    }

    .version-info {
        padding: 15px;
        font-size: 14px;
        color: #666666;
        text-align: center;
        border-top: 1px solid var(--border-color);
        background-color: rgba(0, 0, 0, 0.1);
        margin-top: auto; /* 將版本信息推到底部 */
    }

    /* 響應式設計 */
    @media screen and (min-width: 768px) {
        /* 平板及以上設備 */
        .menu-content, .submenu-content {
            width: 320px; /* 固定寬度 */
        }
    }

    @media screen and (min-width: 1024px) {
    /* 桌面設備 */
        .menu-btn {
            width: 24px; /* 保持一致的大小 */
            height: 24px;
            font-size: 18px; /* 稍微大一點的字體 */
            left: 12px; /* 調整位置 */
        }
        
        .menu-item, .submenu-item {
            padding: 14px 18px; /* 調整內邊距 */
        }
        
        .menu-header h3, .submenu-header h3 {
            font-size: 20px; /* 調整標題大小 */
        }
    }

    @media screen and (max-width: 480px) {
        /* 小型手機 */
        .menu-content, .submenu-content {
            width: 85%; /* 更寬的比例 */
        }
    }

    /* 添加在CSS的最後，在最後的樣式規則之後（約在1860行左右） */

    /* 極簡黑白主題特定調整 */
    :root[data-theme="white"] .row {
        background: var(--secondary-color);
        box-shadow: 0 2px 5px var(--shadow-color);
    }

    :root[data-theme="white"] .input-button-group {
        background: var(--secondary-color);
        border: 1px solid var(--border-color);
    }

    :root[data-theme="white"] input {
        background-color: #ffffff;
        border: 1px solid #dddddd;
        color: #333333;
    }

    :root[data-theme="white"] .time-display-wrapper,
    :root[data-theme="white"] #timeDisplay,
    :root[data-theme="white"] .footer-message {
        background-color: var(--secondary-color);
        color: var(--text-color);
    }

    :root[data-theme="white"] .sticky-header {
        background: var(--secondary-color);
    }

    :root[data-theme="white"] .time-label {
        color: var(--button-orange);
    }

    :root[data-theme="white"] .function-buttons button {
        background-color: #ffffff;
        color: #333333;
        border-color: var(--button-orange);
    }

    :root[data-theme="white"] button {
        background-color: #ffffff;
        color: #555555;
    }

    :root[data-theme="white"] body {
        background-color: #f5f5f5;
    }

    :root[data-theme="white"] h1 {
        color: #333333;
    }

    :root[data-theme="white"] .toast-message {
        background-color: rgba(51, 181, 229, 0.9);
        color: white;
    }

    :root[data-theme="white"] .toast-error {
        background-color: rgba(231, 76, 60, 0.9);
        color: white;
    }

    :root[data-theme="white"] .readonly {
        background-color: #f0f0f0;
    }

    :root[data-theme="white"] .warning-text {
        color: #d9534f !important;
    }

    /* 調整模態框在極簡黑白主題下的樣式 */
    :root[data-theme="white"] .modal-container,
    :root[data-theme="white"] .modal-header,
    :root[data-theme="white"] .modal-content,
    :root[data-theme="white"] .modal-footer {
        background-color: #ffffff;
        color: #333333;
    }

    :root[data-theme="white"] .modal-btn-secondary {
        background-color: #f0f0f0;
        color: #333333;
    }

    /* 調整計算器在極簡黑白主題下的樣式 */
    :root[data-theme="white"] .calculator-display-container {
        background-color: #f9f9f9;
        border: 1px solid #dddddd;
    }

    :root[data-theme="white"] .calculator-history {
        color: #333333; /* 更深的文字顏色 */
        background: linear-gradient(to bottom, #ffffff, #f5f5f5); /* 更淺的背景 */
        border-bottom: 1px solid #cccccc;
    }

    :root[data-theme="white"] .calculator-display {
        background-color: #ffffff; /* 保持純白背景 */
        color: #000000; /* 改為純黑色文字，增加對比度 */
        border: 1px solid #cccccc;
        font-weight: bold; /* 加粗文字增加可讀性 */
    }

    :root[data-theme="white"] .calculator-buttons button {
        background-color: #f5f5f5;
        color: #333333;
        border: 1px solid #dddddd;
    }

    :root[data-theme="white"] .calculator-buttons .number-btn .arabic-number {
        color: #333333;
    }

    :root[data-theme="white"] .calculator-buttons .operator {
        background-color: var(--button-orange);
        color: white;
    }

    :root[data-theme="white"] .calculator-buttons .clear {
        background-color: #d9534f;
        color: white;
    }

    :root[data-theme="white"] .calculator-buttons .equals {
        background-color: var(--button-blue);
        color: white;
    }

    /* 調整歷史記錄面板在極簡黑白主題下的樣式 */
    :root[data-theme="white"] .history-panel {
        background-color: rgba(255, 255, 255, 0.95);
    }

    :root[data-theme="white"] .history-header {
        background-color: #ffffff;
        border-bottom: 2px solid var(--button-orange);
    }

    :root[data-theme="white"] .history-header h2 {
        color: var(--button-orange);
    }

    :root[data-theme="white"] .history-item {
        background-color: #ffffff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    :root[data-theme="white"] .history-details {
        background-color: #f9f9f9;
    }

    :root[data-theme="white"] .detail-label {
        color: #666666;
    }

    :root[data-theme="white"] .detail-value {
        color: #333333;
    }

    :root[data-theme="white"] .history-date {
        color: var(--button-orange);
    }

    :root[data-theme="white"] .menu-container,
    :root[data-theme="white"] .menu-content,
    :root[data-theme="white"] .submenu-container,
    :root[data-theme="white"] .submenu-content {
        background-color: #ffffff;
    }

    :root[data-theme="white"] .menu-item,
    :root[data-theme="white"] .submenu-item {
        color: #333333;
        border-bottom: 1px solid #eeeeee;
    }

    :root[data-theme="white"] .menu-header h3,
    :root[data-theme="white"] .submenu-header h3 {
        color: var(--button-orange);
    }

    :root[data-theme="white"] .version-info {
        color: #999999;
        background-color: #f5f5f5;
    }

    /* 極簡黑白主題特定調整 */
    :root[data-theme="white"] .row {
        background: var(--secondary-color);
        box-shadow: 0 2px 5px var(--shadow-color);
    }

    :root[data-theme="white"] .input-button-group {
        background: var(--secondary-color);
        border: 1px solid var(--border-color);
    }

    :root[data-theme="white"] input {
        background-color: #ffffff;
        border: 1px solid #cccccc;
        color: #222222;
    }

    :root[data-theme="white"] .time-display-wrapper,
    :root[data-theme="white"] #timeDisplay,
    :root[data-theme="white"] .footer-message {
        background-color: var(--secondary-color);
        color: var(--text-color);
    }

    :root[data-theme="white"] .sticky-header {
        background: var(--secondary-color);
    }

    :root[data-theme="white"] .time-label {
        color: #555555; /* 改為深灰而非橙色 */
    }

    :root[data-theme="white"] .function-buttons button {
        background-color: #ffffff;
        color: #222222;
        border-color: #555555; /* 改為深灰而非橙色 */
    }

    :root[data-theme="white"] button {
        background-color: #ffffff;
        color: #444444;
    }

    :root[data-theme="white"] body {
        background-color: #fafafa;
    }

    :root[data-theme="white"] h1 {
        color: #222222;
        border-bottom: 2px solid #555555; /* 改為深灰而非橙色 */
    }

    :root[data-theme="white"] h1::after {
        background: #555555; /* 改為深灰而非橙色 */
    }

    :root[data-theme="white"] .toast-message {
        background-color: rgba(85, 85, 85, 0.9); /* 改為深灰而非藍色 */
        color: white;
    }

    :root[data-theme="white"] .toast-error {
        background-color: rgba(85, 85, 85, 0.9); /* 改為深灰而非紅色 */
        color: white;
    }

    :root[data-theme="white"] .readonly {
        background-color: #f0f0f0;
    }

    :root[data-theme="white"] .warning-text {
        color: #555555 !important; /* 改為深灰而非紅色 */
        font-weight: bold !important;
    }

    /* 調整按鈕懸停效果 */
    :root[data-theme="white"] .function-buttons button:hover,
    :root[data-theme="white"] button:hover {
        background-color: #e0e0e0;
        border-color: #333333;
        color: #111111;
    }

    /* 調整分隔線 */
    :root[data-theme="white"] .divider-flow {
        background: linear-gradient(90deg, 
            var(--secondary-color) 0%,
            #555555 50%, /* 改為深灰而非橙色 */
            var(--secondary-color) 100%);
    }

    :root[data-theme="white"] .divider-flow::after {
        background: linear-gradient(90deg,
            transparent,
            rgba(85, 85, 85, 0.8), /* 改為深灰而非橙色 */
            transparent);
    }

    /* 調整模態框 */
    :root[data-theme="white"] .modal-container,
    :root[data-theme="white"] .modal-header,
    :root[data-theme="white"] .modal-content,
    :root[data-theme="white"] .modal-footer {
        background-color: #ffffff;
        color: #222222;
        border-color: #cccccc;
    }

    :root[data-theme="white"] .modal-btn-primary {
        background-color: #555555; /* 改為深灰而非橙色 */
        color: white;
    }

    :root[data-theme="white"] .history-header h2,
    :root[data-theme="white"] .history-date,
    :root[data-theme="white"] .menu-header h3,
    :root[data-theme="white"] .submenu-header h3 {
        color: #555555; /* 改為深灰而非橙色 */
    }

    :root[data-theme="white"] .history-item {
        border-left: 3px solid #555555; /* 改為深灰而非橙色 */
    }

    /* 調整歷史記錄標題 */
    :root[data-theme="white"] .history-header-rate {
        background-color: rgba(85, 85, 85, 0.2); /* 改為深灰色半透明背景 */
    }

    /* 極簡黑白主題下的計算器樣式 */
    :root[data-theme="white"] .calculator-display-container {
        background-color: #f5f5f5;
        border: 1px solid #cccccc;
    }

    :root[data-theme="white"] .calculator-history {
        color: #555555;
        background: linear-gradient(to bottom, #f5f5f5, #eeeeee);
        border-bottom: 1px solid #cccccc;
    }

    :root[data-theme="white"] .calculator-display {
        background-color: #ffffff;
        color: #222222;
        border: 1px solid #cccccc;
    }

    :root[data-theme="white"] .calculator-buttons button {
        background-color: #f5f5f5;
        color: #333333;
        border: 1px solid #cccccc;
    }

    :root[data-theme="white"] .calculator-buttons .function {
        background-color: #e0e0e0;
    }

    :root[data-theme="white"] .calculator-buttons .operator {
        background-color: #555555; /* 改為深灰而非橙色 */
        color: white;
    }

    :root[data-theme="white"] .calculator-buttons .clear {
        background-color: #777777; /* 改為中灰而非紅色 */
        color: white;
    }

    :root[data-theme="white"] .calculator-buttons .equals {
        background-color: #444444; /* 改為更深灰而非藍色 */
        color: white;
    }

    :root[data-theme="white"] .calculator-buttons .submit {
        background-color: #555555; /* 改為深灰而非橙色 */
        color: white;
    }

    :root[data-theme="white"] .calculator-buttons button:hover {
        background-color: #e0e0e0;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    :root[data-theme="white"] .calculator-buttons .number-btn .financial-char {
        color: #555555; /* 改為深灰而非橙色 */
    }

    /* 極簡黑白主題下的表單元素 */
    :root[data-theme="white"] .label {
        color: #333333;
        font-weight: 600;
    }

    :root[data-theme="white"] input:focus {
        outline: none;
        border-color: #555555; /* 改為深灰而非橙色 */
        box-shadow: 0 0 0 3px rgba(85, 85, 85, 0.2); /* 改為深灰半透明 */
        transform: scale(1.05);
    }

    :root[data-theme="white"] .value-changed {
        animation: valueChangeWhite 0.5s ease-out;
    }

    @keyframes valueChangeWhite {
        0% { 
            background-color: rgba(85, 85, 85, 0.2); /* 改為深灰半透明 */
            transform: scale(1.02);
        }
        100% { 
            background-color: transparent;
            transform: scale(1);
        }
    }

    :root[data-theme="white"] #afterCommissionRate {
        font-weight: bold;
        color: #222222;
        background-color: rgba(85, 85, 85, 0.05); /* 改為深灰半透明 */
        border: 1px solid rgba(85, 85, 85, 0.4); /* 改為深灰半透明 */
        box-shadow: 0 0 4px rgba(85, 85, 85, 0.1); /* 微弱的發光效果 */
    }

    /* 極簡黑白主題下的強調行 */
    :root[data-theme="white"] .emphasized-row {
        border-left: 3px solid #555555; /* 改為深灰而非橙色 */
        background: linear-gradient(90deg, rgba(85, 85, 85, 0.1), transparent); /* 改為深灰半透明漸變 */
    }

    :root[data-theme="white"] .emphasized-row .label {
        color: #333333; /* 改為深灰而非橙色 */
        font-weight: 700;
    }

    :root[data-theme="white"] .emphasized-row input {
        font-weight: bold;
        color: #222222;
        border-color: #555555; /* 改為深灰而非橙色 */
    }

    /* 備註顯示區域樣式調整 */
    :root[data-theme="white"] .history-note-container {
        background-color: #f0f0f0; /* 稍微深一點的背景 */
        border: 1px solid #dddddd; /* 添加邊框增加區分度 */
    }

    :root[data-theme="white"] .history-note-preview {
        color: #222222; /* 更深的文字顏色 */
        font-weight: normal; /* 正常粗細 */
    }

    :root[data-theme="white"] .history-note-preview:hover {
        background-color: rgba(85, 85, 85, 0.15); /* 懸停時顯示深灰色背景 */
        border-color: rgba(85, 85, 85, 0.3); /* 懸停時顯示深灰色邊框 */
        color: #000000; /* 懸停時文字變為純黑 */
    }

    /* 備註編輯器樣式調整 */
    :root[data-theme="white"] .note-editor-content {
        background-color: #ffffff;
        border: 1px solid #555555; /* 使用深灰色邊框 */
    }

    :root[data-theme="white"] .note-editor-input {
        background-color: #ffffff;
        color: #000000; /* 純黑文字 */
        border: 1px solid #cccccc;
    }

    :root[data-theme="white"] .note-editor-input:focus {
        border-color: #555555; /* 深灰色邊框 */
        box-shadow: 0 0 0 2px rgba(85, 85, 85, 0.2); /* 深灰色陰影 */
    }

    /* 提高文字對比度的一般調整 */
    :root[data-theme="white"] .row .label {
        color: #000000; /* 標籤文字改為純黑 */
        font-weight: 600; /* 加粗標籤文字 */
    }

    :root[data-theme="white"] input {
        color: #000000; /* 輸入框文字改為純黑 */
        background-color: #ffffff; /* 輸入框背景為純白 */
        border: 1px solid #aaaaaa; /* 更明顯的邊框 */
    }

    :root[data-theme="white"] .detail-label {
        color: #333333; /* 詳情標籤深色 */
    }

    :root[data-theme="white"] .detail-value {
        color: #000000; /* 詳情值純黑 */
        font-weight: bold; /* 加粗 */
    }

    /* 提升歷史記錄項目的可讀性 */
    :root[data-theme="white"] .history-item {
        background-color: #ffffff; /* 純白背景 */
        border-left: 3px solid #555555; /* 保持深灰色邊框 */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); /* 稍微加強陰影 */
    }

    :root[data-theme="white"] .history-details {
        background-color: #f5f5f5; /* 淺灰背景 */
        border: 1px solid #dddddd; /* 加上邊框增加分隔 */
    }

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>
<body>

	<div class="header-container">
        <button id="menuBtn" class="header-btn header-btn-left" aria-label="選單">
            <span id="menuIcon">≡</span>
        </button>
        <h1>小朋友專用計算機</h1>
        <button id="toggleViewBtn" class="header-btn header-btn-right" aria-label="切換視圖">
            <span id="toggleIcon">▼</span>
        </button>
    </div>
	
    <div class="time-display-wrapper">
        <div id="timeDisplay" class="sticky-header">
            <div style="display: flex; justify-content: center; width: 100%;">
                <span class="time-label">報價時間：</span>
                <span id="currentTime"></span>
            </div>
        </div>
    </div>
    
    <div class="input-button-group">
        <div class="row">
            <span class="label">期數</span>
            <input type="text" id="period" step="0.1" readonly>
            <button onclick="calculatePeriod()">算</button>
            <button onclick="clearField('period')">清</button>
        </div>
    
        <div id="periodButtons">
            <button onclick="adjustPeriod(-1)">-1</button>
            <button onclick="setPeriod(13)">底</button>
            <button onclick="setPeriod(24)">2</button>
            <button onclick="setPeriod(36)">3</button>
            <button onclick="setPeriod(48)">4</button>
            <button onclick="setPeriod(60)">5</button>
            <button onclick="setPeriod(72)">6</button>
            <button onclick="adjustPeriod(1)">+1</button>
        </div>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">稅前利率</span>
            <input type="text" id="rate" step="0.001" readonly>
            <button onclick="calculateRate()">算</button>
            <button onclick="clearField('rate')">清</button>
        </div>

        <div id="rateButtons">
            <button onclick="adjustRate(-0.2)">-0.2</button>
            <button onclick="setRate(4)">4</button>
            <button onclick="setRate(6)">6</button>
            <button onclick="setRate(8)">8</button>
            <button onclick="setRate(10)">10</button>
            <button onclick="setRate(13)">13</button>
            <button onclick="adjustRate(0.2)">+0.2</button>
        </div>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">本金</span>
            <input type="text" id="principal" min="0" readonly>
            <button onclick="calculatePrincipal()">算</button>
            <button onclick="clearField('principal')">清</button>
        </div>

        <div id="principalButtons">
            <button onclick="adjustPrincipal(-1000000)">-100</button>
            <button onclick="adjustPrincipal(-100000)">-10</button>
            <button onclick="adjustPrincipal(-10000)">-1</button>
            <button onclick="adjustPrincipal(10000)">+1</button>
            <button onclick="adjustPrincipal(100000)">+10</button>
            <button onclick="adjustPrincipal(1000000)">+100</button>
        </div>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">期繳</span>
            <input type="text" id="payment" step="0.01" readonly>
            <button onclick="calculatePayment()">算</button>
            <button onclick="clearField('payment')">清</button>
        </div>

        <div id="PaymentduringButtons">
            <button onclick="adjustPayment(-100)">-100</button>
            <button onclick="adjustPayment(-50)">-50</button>
            <button onclick="roundPayment('down', 100)">捨百</button>
            <button onclick="roundPayment('up', 100)">進百</button>
            <button onclick="adjustPayment(50)">+50</button>
            <button onclick="adjustPayment(100)">+100</button>
        </div>
    </div>

	<div class="row">
        <span class="label">總利息</span>
        <input type="text" id="totalInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">稅金</span>
        <input type="text" id="tax" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">稅後利率</span>
        <input type="text" id="afterTaxRate" step="0.001" class="readonly" readonly>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">推廣</span>
            <input type="text" id="commission" min="0" step="1" readonly>
            <button onclick="calculateAfterCommissionRate()">算</button>
            <button onclick="clearCommission()">清</button>
        </div>

        <div id="commissionButtons">
            <button onclick="adjustCommission(-10000)">-萬</button>
            <button onclick="adjustCommission(-1000)">-千</button>
            <button onclick="adjustCommission(-100)">-百</button>
            <button onclick="adjustCommission(100)">+百</button>
            <button onclick="adjustCommission(1000)">+千</button>
            <button onclick="adjustCommission(10000)">+萬</button>
        </div>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">推廣比例</span>
            <input type="text" id="commissionRatio" class="readonly" readonly>
        </div>
    
        <div id="commissionPercentButtons">
            <button onclick="setCommissionPercent(1)">1%</button>
            <button onclick="setCommissionPercent(2)">2%</button>
            <button onclick="setCommissionPercent(3)">3%</button>
            <button onclick="setCommissionPercent(4)">4%</button>
            <button onclick="setCommissionPercent(5)">5%</button>
        </div>
    </div>

    <div class="row">
        <span class="label">稅佣後利率</span>
        <input type="text" id="afterCommissionRate" class="readonly" readonly>
    </div>

    <div class="divider-flow"></div>

    <div class="row">
        <span class="label">百萬每年利息</span>
        <input type="text" id="annualMillionInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">百萬每月利息</span>
        <input type="text" id="monthlyMillionInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">一萬每年利息</span>
        <input type="text" id="annualTenThousandInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">一萬每月利息</span>
        <input type="text" id="monthlyTenThousandInterest" class="readonly" readonly>
    </div>

    <div class="divider-flow"></div>

    <div class="row">
        <span class="label">本月資金成本</span>
        <input type="text" id="monthlyCost" value="2.2427" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">Spread</span>
        <input type="text" id="spread" class="readonly" readonly>
    </div>
	
    <div class="row">
        <span class="label">NPV</span>
        <input type="text" id="fundingCost" class="readonly" readonly>
        <span style="margin-left: 0px; color: var(--text-color);">修正中</span>
    </div>

	<!-- 按鈕區域重新組織 -->
    <div class="divider-flow"></div>

    <div class="function-buttons top-buttons">
        <div class="button-row">
            <button onclick="saveLoanData()" >保存計算</button>
            <button onclick="toggleHistoryPanel()" >歷史記錄</button>
        </div>
    </div>

    <div class="divider-flow"></div>

    <div class="function-buttons bottom-buttons">
        <div class="button-row">
            <button onclick="window.open('https://travel.chiayi.gov.tw/Folder/TurkeyRice', '_blank')">雞肉飯</button>
            <button onclick="clearAllFieldsExceptMonthlyCost()">清除</button>
            <button onclick="generateQuote()">截圖</button>
        </div>
    </div>

    <div class="footer-message">報價後記得吃碗火雞肉飯唷！</div>

    <div class="divider-flow"></div>

    <!-- 添加歷史記錄面板 -->
    <!-- 重新设计的历史记录面板 -->
    <div id="historyPanel" class="history-panel">
        <div class="history-header">
            <div class="header-left">
                <h2>貸款計算歷史記錄</h2>
            </div>
            <div class="header-right">
                <button class="delete-all-btn" onclick="confirmDeleteAll()">全部刪除</button>
            </div>
            <button class="close-btn" onclick="toggleHistoryPanel()">×</button>
        </div>
        <div id="historyContent" class="history-content"></div>
    </div>

    <!-- 普通提示模態框 -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalTitle">提示</h3>
                <button class="close-btn" onclick="hideModal()">×</button>
            </div>
            <div id="modalContent" class="modal-content"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="hideModal()">確定</button>
            </div>
        </div>
    </div>

    <!-- 確認模態框 -->
    <div id="confirmModalOverlay" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="confirmModalTitle">確認</h3>
                <button class="close-btn" onclick="hideConfirmModal()">×</button>
            </div>
            <div id="confirmModalContent" class="modal-content"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="hideConfirmModal()">取消</button>
                <button id="confirmModalOk" class="modal-btn modal-btn-primary">確定</button>
            </div>
        </div>
    </div>

    <div class="footer-spacing"></div>

<script>

    window.onload = function() {
        // 僅初始化時間顯示
        updateTime();
    }

    // 獲取裝置類型
    function getDeviceType() {
        const ua = navigator.userAgent;
        if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
            return "tablet";
        }
        if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
            return "mobile";
        }
        return "desktop";
    }

    // 獲取瀏覽器資訊
    function getBrowserInfo() {
        const ua = navigator.userAgent;
        let browser = "Unknown";
        if (ua.indexOf("Chrome") > -1) browser = "Chrome";
        else if (ua.indexOf("Safari") > -1) browser = "Safari";
        else if (ua.indexOf("Firefox") > -1) browser = "Firefox";
        else if (ua.indexOf("Edge") > -1) browser = "Edge";
        else if (ua.indexOf("Opera") > -1) browser = "Opera";
        else if (ua.indexOf("MSIE") > -1 || ua.indexOf("Trident/") > -1) browser = "Internet Explorer";
        
        return `${browser} ${navigator.platform}`;
    }

	// 添加震動函數
	function vibrate() {
		if (navigator.vibrate) {
		navigator.vibrate(30); // 震動30毫秒
		}
	}

    // 添加這個新函數到第一個 script 標籤內，updateTime 函數之前
    function calculateNPV(payment, period, principal, monthlyCost) {
        try {
            // 檢查輸入值是否有效
            if (!payment || !period || !principal || !monthlyCost || 
                isNaN(payment) || isNaN(period) || isNaN(principal) || isNaN(monthlyCost)) {
                return 0;
            }
            
            // 檢查極端值
            if (period > 1200) { // 100年
                console.warn('NPV計算: 期數過大可能導致計算不準確');
                period = 1200; // 限制最大期數
            }
            
            // 將年利率轉換為月利率
            const monthlyRate = monthlyCost / 100 / 12;
            
            // 處理利率接近0的情況
            if (Math.abs(monthlyRate) < 1e-10) {
                // 如果利率接近0，使用簡化公式計算現值
                const expectedPresentValue = payment * period;
                return Math.round(expectedPresentValue - principal);
            }
            
            // 處理極端的負期數
            if (period < -1000) {
                console.warn('NPV計算: 極端負期數可能導致計算不準確');
                return 0;
            }
            
            // 標準NPV計算
            const expectedPresentValue = payment * (1 - Math.pow(1 + monthlyRate, -period)) / monthlyRate;
            
            // 檢查計算結果是否有效
            if (!isFinite(expectedPresentValue) || isNaN(expectedPresentValue)) {
                console.error('NPV計算結果無效');
                return 0;
            }
            
            // 計算與實際本金的差額
            return Math.round(expectedPresentValue - principal);
        } catch (error) {
            console.error('NPV 計算錯誤:', error);
            return 0;
        }
    }

    // 添加更新時間的函數
    function updateTime() {
        const now = new Date();
        const days = ['日', '一', '二', '三', '四', '五', '六'];
        
        // 調整為台北時間 (GMT+8)
        const taipeiTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        
        const year = taipeiTime.getUTCFullYear();
        const month = String(taipeiTime.getUTCMonth() + 1).padStart(2, '0');
        const date = String(taipeiTime.getUTCDate()).padStart(2, '0');
        const day = days[taipeiTime.getUTCDay()];
        const hours = String(taipeiTime.getUTCHours()).padStart(2, '0');
        const minutes = String(taipeiTime.getUTCMinutes()).padStart(2, '0');
        const seconds = String(taipeiTime.getUTCSeconds()).padStart(2, '0');
        
        const timeString = `${year}年${month}月${date}日
            星期${day} ${hours}:${minutes}:${seconds}`;
        document.getElementById('currentTime').textContent = timeString;
    }

    // 每秒更新一次時間
    setInterval(updateTime, 1000);
    updateTime(); // 初始化顯示

    // 原始的JavaScript函數保持不變
    function PMT(rate, nper, pv) {
        // 參數驗證
        if (!nper || nper <= 0) {
            showToast('錯誤：期數必須為正數', true);
            return 0;
        }
        
        if (!pv || pv <= 0) {
            showToast('錯誤：本金必須為正數', true);
            return 0;
        }
        
        // 轉換利率為月利率
        rate = rate / 100 / 12;
        
        try {
            // 特殊情況：利率為0或接近0
            if (Math.abs(rate) < 1e-10) {
                return pv / nper; // 如果利率接近0，簡單地將本金除以期數
            }
            
            // 標準等額本息公式
            return (pv * rate * Math.pow(1 + rate, nper)) / (Math.pow(1 + rate, nper) - 1);
        } catch (error) {
            console.error('PMT 計算錯誤:', error);
            showToast('期繳金額計算出錯，請檢查輸入值', true);
            return 0;
        }
    }
        
    function RATE(nper, pmt, pv) {
        // 參數驗證
        if (!nper || nper <= 0) {
            showToast('錯誤：期數必須為正數', true);
            return 0;
        }
        
        if (!pmt || pmt <= 0) {
            showToast('錯誤：期繳金額必須為正數', true);
            return 0;
        }
        
        if (!pv || pv <= 0) {
            showToast('錯誤：本金必須為正數', true);
            return 0;
        }
        
        // 基本檢查：如果期繳總額小於本金，無法計算有效利率
        if (pmt * nper <= pv) {
            showToast('錯誤：期繳總額必須大於本金才能計算利率', true);
            return 0;
        }
        
        let rate = 0.1; // 初始猜測值，10%
        let step = 0.05;
        let tolerance = 0.0001;
        let maxIterations = 100;
        let iteration = 0;
        
        try {
            while (iteration < maxIterations) {
                let monthlyRate = rate / 12;
                
                // 避免除零錯誤
                let denominator = Math.pow(1 + monthlyRate, nper) - 1;
                if (Math.abs(denominator) < 1e-10) { // 接近零的情況
                    rate += step; // 調整並繼續迭代
                    step *= 0.5;
                    iteration++;
                    continue;
                }
                
                let calculated = pv * monthlyRate * Math.pow(1 + monthlyRate, nper) / denominator;
                
                if (Math.abs(calculated - pmt) < tolerance) {
                    return Math.max(0, rate * 100); // 確保不返回負利率
                }
                
                if (calculated > pmt) {
                    rate -= step;
                } else {
                    rate += step;
                }
                
                // 確保利率不會變為負數
                rate = Math.max(0.0001, rate);
                
                step *= 0.5;
                iteration++;
            }
            
            // 如果達到最大迭代次數仍未收斂
            console.warn('RATE 計算未收斂，返回最佳近似值');
            return Math.max(0, rate * 100);
        } catch (error) {
            console.error('RATE 計算錯誤:', error);
            showToast('利率計算出錯，請檢查輸入值', true);
            return 0;
        }
    }

    function calculatePeriod() {
        const rate = parseFloat(document.getElementById('rate').value);
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, ''));
        const payment = parseFloat(document.getElementById('payment').value.replace(/,/g, ''));
        
        // TODO: Implement period calculation
        updateAllFields();
    }

    function calculateRate() {
        const period = parseFloat(document.getElementById('period').value);
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, ''));
        const payment = parseFloat(document.getElementById('payment').value.replace(/,/g, ''));
        
        // 只有當至少三個欄位已填寫時才顯示警告
        const filledFields = countFilledFields();
        const shouldWarn = filledFields >= 3;
        
        // 輸入驗證
        if (shouldWarn) {
            if (isNaN(period) || period <= 0) {
                showToast('請輸入有效的期數', true);
                return;
            }
            
            if (isNaN(principal) || principal <= 0) {
                showToast('請輸入有效的本金', true);
                return;
            }
            
            if (isNaN(payment) || payment <= 0) {
                showToast('請輸入有效的期繳金額', true);
                return;
            }
            
            // 基本財務檢查：總還款應超過本金
            if (payment * period <= principal) {
                showToast('期繳總額必須大於本金才能計算有效利率', true);
                return;
            }
        } else {
            // 如果欄位數不足，但輸入無效，直接返回
            if (isNaN(period) || isNaN(principal) || isNaN(payment) || 
                period <= 0 || principal <= 0 || payment <= 0 ||
                payment * period <= principal) {
                return;
            }
        }
        
        try {
            const rate = RATE(period, payment, principal);
            
            // 檢查計算結果是否有效
            if (isNaN(rate) || !isFinite(rate) || rate < 0) {
                if (shouldWarn) {
                    showToast('利率計算結果無效，請檢查輸入值', true);
                }
                return;
            }
            
            // 檢查利率是否超過20%
            if (rate > 20) {
                showToast('警告：計算結果顯示利率超過20%，可能不符合一般貸款條件', true);
            }
            
            // 限制利率顯示的小數位數並更新界面，不截斷超過20%的數值
            document.getElementById('rate').value = rate.toFixed(4);
            updateAllFields();
        } catch (error) {
            console.error('利率計算錯誤:', error);
            if (shouldWarn) {
                showToast('計算利率時出錯', true);
            }
        }
    }

    function calculatePrincipal() {
        const period = parseFloat(document.getElementById('period').value);
        const rate = parseFloat(document.getElementById('rate').value);
        const payment = parseFloat(document.getElementById('payment').value.replace(/,/g, ''));
        
        // TODO: Implement principal calculation
        updateAllFields();
    }

    function calculatePayment() {
        const period = parseFloat(document.getElementById('period').value);
        const rate = parseFloat(document.getElementById('rate').value);
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, ''));
        
        // 只有當至少三個欄位已填寫時才顯示警告
        const filledFields = countFilledFields();
        const shouldWarn = filledFields >= 3;
        
        // 檢查所有輸入並提供具體錯誤訊息
        if (shouldWarn) {
            if (isNaN(period) || period <= 0) {
                showToast('請輸入有效的期數', true);
                return;
            }
            
            if (isNaN(rate) || rate <= 0) {
                showToast('請輸入有效的利率', true);
                return;
            }
            
            if (isNaN(principal) || principal <= 0) {
                showToast('請輸入有效的本金', true);
                return;
            }
        } else {
            // 如果欄位數不足，但輸入無效，直接返回
            if (isNaN(period) || isNaN(rate) || isNaN(principal) || 
                period <= 0 || rate <= 0 || principal <= 0) {
                return;
            }
        }
        
        try {
            // 限制極端值
            const safeRate = Math.min(Math.max(rate, 0.0001), 50); // 限制利率在合理範圍內
            const safePeriod = Math.min(Math.max(period, 1), 999); // 限制期數不超過999期
            
            const payment = PMT(safeRate, safePeriod, principal);
            
            // 檢查計算結果是否有效
            if (isNaN(payment) || !isFinite(payment) || payment <= 0) {
                if (shouldWarn) {
                    showToast('計算結果無效，請檢查輸入值', true);
                }
                return;
            }
            
            // 四捨五入為整數並格式化
            document.getElementById('payment').value = formatNumberWithCommas(Math.round(payment));
            updateAllFields();
        } catch (error) {
            console.error('期繳金額計算錯誤:', error);
            if (shouldWarn) {
                showToast('計算期繳金額時出錯', true);
            }
        }
    }


    function updateAllFields() {
        // 獲取基本值 - 需要先移除千位分隔符再轉換為數字
        const period = parseFloat(document.getElementById('period').value);
        const rate = parseFloat(document.getElementById('rate').value);
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, '')) || 0;
        const payment = parseFloat(document.getElementById('payment').value.replace(/,/g, '')) || 0;
        const monthlyCost = parseFloat(document.getElementById('monthlyCost').value);

        // 期數檢查
        const periodInput = document.getElementById('period');
        if (period <= 12) {
            periodInput.classList.add('warning-text');
        } else {
            periodInput.classList.remove('warning-text');
        }

        // 檢查四個基本輸入框是否都有值
        const hasAllRequiredValues = period && rate && principal && payment && 
                                    !isNaN(period) && !isNaN(rate) && !isNaN(principal) && !isNaN(payment);

        // 計算並顯示總利息
        const totalInterestField = document.getElementById('totalInterest');
        if (hasAllRequiredValues) {
            // 計算總利息
            const totalInterest = (payment * period) - principal;
            // 總利息格式化帶千位分隔符
            totalInterestField.value = formatNumberWithCommas(totalInterest.toFixed(2));
        } else {
            // 如果缺少任何必要值，清空總利息輸入框
            totalInterestField.value = '';
        }

        // 計算稅金 - 同樣需要檢查總利息是否已計算
        const taxField = document.getElementById('tax');
        if (hasAllRequiredValues) {
            const totalInterest = (payment * period) - principal;
            const tax = totalInterest / 21;
            taxField.value = formatNumberWithCommas(tax.toFixed(2));
        } else {
            taxField.value = '';
        }

        // 計算稅後利率 - 同樣需要檢查必要值
        const afterTaxRateInput = document.getElementById('afterTaxRate');
        if (hasAllRequiredValues) {
            const totalInterest = (payment * period) - principal;
            const tax = totalInterest / 21;
            const afterTaxRate = RATE(period, payment, principal + tax);
            afterTaxRateInput.value = afterTaxRate.toFixed(4);
            
            // 檢查稅後利率是否超過20%
            if (afterTaxRate > 20) {
                afterTaxRateInput.classList.add('warning-text');
                if (countFilledFields() >= 3) {
                    showToast('警告：稅後利率超過20%，可能不符合一般貸款條件', true);
                }
            } else if (afterTaxRate <= 2.5) {
                afterTaxRateInput.classList.add('warning-text');
            } else {
                afterTaxRateInput.classList.remove('warning-text');
            }
        } else {
            afterTaxRateInput.value = '';
            afterTaxRateInput.classList.remove('warning-text');
        }

        // 佣金格式化為整數並帶千位分隔符
        const commission = parseFloat(document.getElementById('commission').value.replace(/,/g, '')) || 0;
        document.getElementById('commission').value = formatNumberWithCommas(Math.round(commission));
        
        // 檢查佣金是否超過總利息的45%
        const commissionInput = document.getElementById('commission');
        if (hasAllRequiredValues) {
            const totalInterest = (payment * period) - principal;
            if (commission >= totalInterest * 0.45) {
                commissionInput.classList.add('warning-text');
                // 新增警告提示
                showToast('請注意推廣費與總利息比例！', true);
            } else {
                commissionInput.classList.remove('warning-text');
            }
        } else {
            commissionInput.classList.remove('warning-text');
        }

        // 計算並更新推廣費比例
        const commissionRatioInput = document.getElementById('commissionRatio');
        if (principal > 0 && commission > 0) {
            const commissionRatio = commission / principal * 100;
            commissionRatioInput.value = commissionRatio.toFixed(2);
            
            // 檢查推廣費比例是否超過5%
            if (commissionRatio > 5) {
                commissionRatioInput.classList.add('warning-text');
            } else {
                commissionRatioInput.classList.remove('warning-text');
            }
        } else {
            commissionRatioInput.value = '';
            commissionRatioInput.classList.remove('warning-text');
        }

        // 計算稅佣後利率
        // 計算稅佣後利率
        const afterCommissionRateInput = document.getElementById('afterCommissionRate');
        if (hasAllRequiredValues) {
            try {
                const totalInterest = (payment * period) - principal;
                const tax = totalInterest / 21;
                
                // 檢查計算是否合理
                const totalCost = principal + tax + commission;
                if (totalCost >= payment * period) {
                    // 如果成本超過總還款額，無法計算有效利率
                    afterCommissionRateInput.value = "N/A";
                    afterCommissionRateInput.classList.add('warning-text');
                    
                    // 同時更新 Spread
                    const spreadInput = document.getElementById('spread');
                    spreadInput.value = "N/A";
                    spreadInput.classList.add('warning-text');
                } else {
                    // 正常計算
                    const afterCommissionRate = RATE(period, payment, principal + tax + commission);
                    
                    // 檢查結果是否有效
                    if (isNaN(afterCommissionRate) || !isFinite(afterCommissionRate)) {
                        afterCommissionRateInput.value = "計算錯誤";
                        afterCommissionRateInput.classList.add('warning-text');
                    } else {
                        // 稅佣後利率不需要千位分隔符
                        afterCommissionRateInput.value = afterCommissionRate.toFixed(4);
                        if (afterCommissionRate <= 2.5) {
                            afterCommissionRateInput.classList.add('warning-text');
                        } else {
                            afterCommissionRateInput.classList.remove('warning-text');
                        }
                        
                        // 計算 Spread
                        const spread = afterCommissionRate - monthlyCost;
                        // Spread 不需要千位分隔符
                        const spreadInput = document.getElementById('spread');
                        spreadInput.value = spread.toFixed(4);
                        if (spread <= 0) {
                            spreadInput.classList.add('warning-text');
                        } else {
                            spreadInput.classList.remove('warning-text');
                        }
                    }
                }
            } catch (error) {
                console.error('稅佣後利率計算錯誤:', error);
                afterCommissionRateInput.value = "計算錯誤";
                afterCommissionRateInput.classList.add('warning-text');
                
                document.getElementById('spread').value = '';
                document.getElementById('spread').classList.remove('warning-text');
            }
        } else {
            afterCommissionRateInput.value = '';
            afterCommissionRateInput.classList.remove('warning-text');
            
            document.getElementById('spread').value = '';
            document.getElementById('spread').classList.remove('warning-text');
        }
        
        // 計算百萬利息相關
        if (rate > 0) {
            // 百萬利息計算
            const millionPayment = PMT(rate, 12, 1000000);
            const annualMillionInterest = (millionPayment * 12) - 1000000;
            
            // 百萬每年利息格式化為整數帶千位分隔符
            document.getElementById('annualMillionInterest').value = formatNumberWithCommas(Math.round(annualMillionInterest));
            // 百萬每月利息格式化為整數帶千位分隔符
            document.getElementById('monthlyMillionInterest').value = formatNumberWithCommas(Math.round(annualMillionInterest / 12));
            
            // 一萬利息
            const tenThousandPayment = PMT(rate, 12, 10000);
            const annualTenThousandInterest = (tenThousandPayment * 12) - 10000;
            
            // 一萬每年利息格式化為整數帶千位分隔符
            document.getElementById('annualTenThousandInterest').value = formatNumberWithCommas(Math.round(annualTenThousandInterest));
            // 一萬每月利息格式化為整數帶千位分隔符
            document.getElementById('monthlyTenThousandInterest').value = formatNumberWithCommas(Math.round(annualTenThousandInterest / 12));
        } else {
            document.getElementById('annualMillionInterest').value = '';
            document.getElementById('monthlyMillionInterest').value = '';
            document.getElementById('annualTenThousandInterest').value = '';
            document.getElementById('monthlyTenThousandInterest').value = '';
        }
        
        // 計算 NPV
        const npvValue = calculateNPV(
            payment,
            period,
            principal,
            monthlyCost
        );
        
        // 更新 NPV 顯示，帶千位分隔符
        const fundingCostInput = document.getElementById('fundingCost');
        if (hasAllRequiredValues) {
            fundingCostInput.value = formatNumberWithCommas(npvValue);
            
            // 更新警告樣式
            if (npvValue < 0) {
                fundingCostInput.classList.add('warning-text');
            } else {
                fundingCostInput.classList.remove('warning-text');
            }
        } else {
            fundingCostInput.value = '';
            fundingCostInput.classList.remove('warning-text');
        }

        // 在更新值之前保存舊值
        const oldValues = {};
        const fieldsToTrack = ['totalInterest', 'afterTaxRate', 'spread'];
        fieldsToTrack.forEach(field => {
            oldValues[field] = document.getElementById(field).value;
        });

        // 在更新後檢查變化
        fieldsToTrack.forEach(field => {
            const newValue = document.getElementById(field).value;
            if (oldValues[field] !== newValue) {
                animateValueChange(field);
            }
        });
    }

    // 在 clearField 函數之前添加這個新函數
    // 修改 validatePrincipalInput 函数
    function validatePrincipalInput(input) {
        // 移除负号，确保为正整数
        let value = Math.floor(Math.abs(parseFloat(input.value))) || 0;
        
        // 如果输入为0，设置为最小值1
        if (value <= 0) {
            value = 1;
        }
        
        // 更新输入框值并格式化
        input.value = formatNumberWithCommas(value);
        
        // 更新相关计算
        updateAllFields();
    }

    function clearField(fieldId) {
        vibrate();
        document.getElementById(fieldId).value = '';
    }

    function clearCommission() {
        vibrate();
        document.getElementById('commission').value = '';
        updateAllFields(); // 更新所有欄位
    }

    function adjustPeriod(delta) {
        vibrate();
        const periodField = document.getElementById('period');
        const currentValue = parseFloat(periodField.value) || 0;
        periodField.value = currentValue + delta;
        calculatePayment();
    }

    function setPeriod(value) {
        vibrate();
        document.getElementById('period').value = value;
        
        // 檢查其他必要輸入是否已有值
        const rate = parseFloat(document.getElementById('rate').value);
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, ''));
        
        if (!isNaN(rate) && !isNaN(principal) && rate > 0 && principal > 0) {
            calculatePayment(); // 只有當其他必要值都存在時才計算
        }
    }

    function adjustRate(delta) {
        vibrate();
        const rateField = document.getElementById('rate');
        const currentValue = parseFloat(rateField.value) || 0;
        const newRate = currentValue + delta;
        
        // 檢查新利率是否超過20%
        if (newRate > 20) {
            showToast('警告：利率超過20%，可能不符合一般貸款條件', true);
        }
        
        rateField.value = newRate.toFixed(4);
        calculatePayment();
    }

    function setRate(value) {
        vibrate();
        // 檢查新利率是否超過20%
        if (value > 20) {
            showToast('警告：利率超過20%，可能不符合一般貸款條件', true);
        }
        
        document.getElementById('rate').value = value;
        calculatePayment();
    }

    function validateCommissionInput(input) {
        // 移除小數點
        let value = parseInt(input.value) || 0;
        
        // 如果是負數，設為0
        if (value < 0) {
            value = 0;
        }
        
        // 更新輸入框的值為整數
        input.value = Math.floor(value);
        
        // 更新相關計算
        updateAllFields();
    }

    function adjustCommission(delta) {
        vibrate();
        const commissionField = document.getElementById('commission');
        
        // 獲取當前值，如果為空則預設為0，移除千位分隔符
        const currentValue = parseFloat(commissionField.value.replace(/,/g, '')) || 0;
        
        // 計算新值
        const newValue = Math.max(0, currentValue + delta);
        
        // 更新輸入框的值，使用 Math.floor 取整數並添加千位分隔符
        commissionField.value = formatNumberWithCommas(Math.floor(newValue));
        
        // 更新所有相關欄位的計算
        updateAllFields();
    }

    function setCommissionPercent(percent) {
        vibrate(); // 觸發震動
        
        // 獲取本金值（移除千位分隔符）
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, '')) || 0;
        
        if (principal <= 0) {
            showToast('請先輸入有效的本金金額', true);
            return;
        }
        
        // 計算對應百分比的金額，並無條件捨去至整數
        const commissionAmount = Math.floor(principal * (percent / 100));
        
        // 更新推廣輸入框的值，並添加千位分隔符
        document.getElementById('commission').value = formatNumberWithCommas(commissionAmount);
        
        // 更新相關欄位的計算
        updateAllFields();
    }

    // 修改 adjustPrincipal 函数
    function adjustPrincipal(delta) {
        vibrate();
        const principalField = document.getElementById('principal');
        // 移除千位分隔符后再转换为数字
        const currentValue = parseFloat(principalField.value.replace(/,/g, '')) || 0;
        // 计算新值，确保是正整数
        const newValue = Math.max(1, Math.floor(currentValue + delta)); // 确保最小值为1且为整数
        // 添加千位分隔符显示
        principalField.value = formatNumberWithCommas(newValue);
        calculatePayment();
        updateAllFields();
    }

    function calculateAfterCommissionRate() {
        const period = parseFloat(document.getElementById('period').value);
        const payment = parseFloat(document.getElementById('payment').value.replace(/,/g, ''));
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, ''));
        const tax = parseFloat(document.getElementById('tax').value.replace(/,/g, ''));
        const commission = parseFloat(document.getElementById('commission').value.replace(/,/g, '')) || 0;

        updateAllFields(); // 更新所有欄位
    }

    // 修改 roundPayment 函数以保持正数限制
    function roundPayment(direction, base) {
        vibrate();
        const paymentField = document.getElementById('payment');
        // 移除千位分隔符后再转换为数字
        let value = parseFloat(paymentField.value.replace(/,/g, '')) || 0;
        
        if (direction === 'down') {
            value = Math.floor(value / base) * base;
        } else {
            value = Math.ceil(value / base) * base;
        }
        
        // 确保值为正整数
        value = Math.max(1, Math.round(value));
        
        // 添加千位分隔符显示，不再保留小數位
        paymentField.value = formatNumberWithCommas(value);
        calculateRate(); // 确保这个调用能正确计算税前利率
    }

    // 修改 adjustPayment 函数
    function adjustPayment(delta) {
        vibrate();
        const paymentField = document.getElementById('payment');
        // 移除千位分隔符后再转换为数字
        const currentValue = parseFloat(paymentField.value.replace(/,/g, '')) || 0;
        // 计算新值，确保是正整数
        const newValue = Math.max(1, Math.round(currentValue + delta)); // 使用Math.round確保是整數
        // 添加千位分隔符显示，不再保留小數
        paymentField.value = formatNumberWithCommas(newValue);
        calculateRate(); // 确保这个调用能正确计算税前利率
    }

    function saveData() {
        const dataToSave = {
        period: document.getElementById('period').value,
        rate: document.getElementById('rate').value,
        principal: document.getElementById('principal').value,
        payment: document.getElementById('payment').value,
        commission: document.getElementById('commission').value
        };
        localStorage.setItem('loanCalculatorData', JSON.stringify(dataToSave));
        alert('資料已暫存！');
    }

    function generateQuote() {
        // 觸發振動反饋
        vibrate();
        
        // 檢查表單是否有必要數據
        const requiredFields = ['period', 'rate', 'principal', 'payment'];
        const missingFields = requiredFields.filter(fieldId => !document.getElementById(fieldId).value);
        
        if (missingFields.length > 0) {
            showToast('請先完成必要欄位（期數、利率、本金、期繳）的計算！');
            return;
        }
        
        // 顯示加載提示
        const loadingToast = document.createElement('div');
        loadingToast.id = 'screenshot-loading';
        loadingToast.innerHTML = '<div class="loading-content">正在生成報價卡片...</div>';
        document.body.appendChild(loadingToast);
        
        // 檢測是否為移動設備
        const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // 延遲一點時間以確保加載提示顯示
        setTimeout(() => {
            try {
                // 創建一個簡單的報價卡片 HTML
                const quoteHtml = generateQuoteCardHtml();
                
                // 創建一個用於顯示的報價卡片
                const shareQuoteCard = document.getElementById('shareQuoteCard');
                if (shareQuoteCard) {
                    shareQuoteCard.innerHTML = quoteHtml;
                }
                
                // 如果是移動設備，嘗試使用備用方法
                if (isMobileDevice) {
                    // 移動設備上使用備用方案：直接使用HTML版本
                    if (document.getElementById('screenshot-loading')) {
                        document.body.removeChild(document.getElementById('screenshot-loading'));
                    }
                    
                    document.getElementById('shareModalOverlay').style.display = 'flex';
                    
                    // 調整下載按鈕功能 - 在移動設備上提示用戶截圖
                    const downloadBtn = document.getElementById('downloadBtn');
                    if (downloadBtn) {
                        downloadBtn.textContent = '手動截圖';
                        downloadBtn.onclick = function() {
                            showToast('請使用系統截圖功能保存圖片', false, 3000);
                        };
                    }
                    
                    // 隱藏分享按鈕，因為沒有圖片
                    const shareBtn = document.getElementById('shareBtn');
                    if (shareBtn) {
                        shareBtn.style.display = 'none';
                    }
                    
                    const shareStatus = document.getElementById('shareStatus');
                    if (shareStatus) {
                        shareStatus.textContent = '請使用系統截圖功能保存此報價';
                        shareStatus.style.color = '#ff9c33';
                    }
                    
                    return;
                }
                
                // 以下是桌面版的處理邏輯
                // 創建一個臨時的容器來渲染報價卡片
                const tempContainer = document.createElement('div');
                tempContainer.id = 'tempQuoteContainer';
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.zIndex = '-1000';
                tempContainer.style.background = '#333333';
                tempContainer.style.width = '380px';
                tempContainer.style.padding = '10px';
                tempContainer.innerHTML = quoteHtml;
                document.body.appendChild(tempContainer);
                
                // 使用html2canvas將臨時容器轉為圖片
                html2canvas(tempContainer, {
                    backgroundColor: '#333333',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    width: 380,
                    height: 520
                }).then(canvas => {
                    // 生成圖片URL
                    const imageDataUrl = canvas.toDataURL('image/png');
                    
                    // 更新分享模態框中的內容為圖片
                    if (shareQuoteCard) {
                        shareQuoteCard.innerHTML = `<img src="${imageDataUrl}" style="width: 100%; max-width: 340px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">`;
                    }
                    
                    // 設置下載按鈕功能
                    const downloadBtn = document.getElementById('downloadBtn');
                    if (downloadBtn) {
                        downloadBtn.textContent = '💾 下載圖片';
                        downloadBtn.onclick = function() {
                            const link = document.createElement('a');
                            const dateTime = new Date().toISOString().replace(/[^0-9]/g, '').slice(0, 14);
                            link.download = `貸款計算報價_${dateTime}.png`;
                            link.href = imageDataUrl;
                            link.click();
                            showToast('圖片已保存至您的設備！');
                        };
                    }
                    
                    // 設置分享按鈕功能
                    const shareBtn = document.getElementById('shareBtn');
                    if (shareBtn) {
                        shareBtn.style.display = 'inline-block';
                        shareBtn.onclick = function() {
                            shareQuoteImage(imageDataUrl);
                        };
                    }
                    
                    // 移除加載提示並顯示分享模態框
                    if (document.getElementById('screenshot-loading')) {
                        document.body.removeChild(document.getElementById('screenshot-loading'));
                    }
                    
                    // 移除臨時容器
                    document.body.removeChild(tempContainer);
                    
                    // 顯示分享模態框
                    document.getElementById('shareModalOverlay').style.display = 'flex';
                    
                    // 重置狀態訊息
                    const shareStatus = document.getElementById('shareStatus');
                    if (shareStatus) {
                        shareStatus.textContent = '';
                    }
                    
                }).catch(error => {
                    console.error('生成報價卡片圖片時出錯:', error);
                    // 錯誤時的備用方案
                    handleGenerateError(shareQuoteCard, quoteHtml);
                });
            } catch (error) {
                console.error('準備報價卡片時出錯:', error);
                
                // 移除加載提示
                if (document.getElementById('screenshot-loading')) {
                    document.body.removeChild(document.getElementById('screenshot-loading'));
                }
                
                showToast('生成報價卡片時出錯，請稍後再試', true);
            }
        }, 100);
    }

    // 添加一個新的錯誤處理函數
    function handleGenerateError(shareQuoteCard, quoteHtml) {
        // 移除加載提示
        if (document.getElementById('screenshot-loading')) {
            document.body.removeChild(document.getElementById('screenshot-loading'));
        }
        
        // 回退到純HTML方式顯示
        if (shareQuoteCard) {
            shareQuoteCard.innerHTML = quoteHtml;
        }
        
        // 設置下載按鈕功能
        const downloadBtn = document.getElementById('downloadBtn');
        if (downloadBtn) {
            downloadBtn.textContent = '手動截圖';
            downloadBtn.onclick = function() {
                showToast('請使用系統截圖功能保存圖片', false, 3000);
            };
        }
        
        // 隱藏分享按鈕，因為沒有圖片
        const shareBtn = document.getElementById('shareBtn');
        if (shareBtn) {
            shareBtn.style.display = 'none';
        }
        
        // 顯示分享模態框
        document.getElementById('shareModalOverlay').style.display = 'flex';
        
        // 更新狀態訊息
        const shareStatus = document.getElementById('shareStatus');
        if (shareStatus) {
            shareStatus.textContent = '請使用系統截圖功能保存此報價';
            shareStatus.style.color = '#ff9c33';
        }
    }

    // 生成報價卡片 HTML
    function generateQuoteCardHtml() {
        // 獲取數據
        const period = document.getElementById('period').value;
        const rate = document.getElementById('rate').value;
        const principal = document.getElementById('principal').value;
        const payment = document.getElementById('payment').value;
        const totalInterest = document.getElementById('totalInterest').value;
        const afterTaxRate = document.getElementById('afterTaxRate').value;
        const commission = document.getElementById('commission').value;
        const afterCommissionRate = document.getElementById('afterCommissionRate').value;
        const currentTime = document.getElementById('currentTime').textContent;
        
        // 是否顯示推廣費用
        const showCommission = commission && commission !== "0";
        
        return `
            <div style="width: 90%; max-width: 340px; margin: 0 auto; background-color: #333333; padding: 20px; border-radius: 15px; font-family: 'Microsoft JhengHei', Arial, sans-serif; color: #ffffff; border: 2px solid #ff9c33; box-sizing: border-box;">
                <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #ff9c33; padding-bottom: 10px;">
                    <div style="margin: 0; font-size: 22px; color: #ff9c33; font-weight: bold;">貸款計算報價單</div>
                    <div style="font-size: 14px; margin-top: 8px;">${currentTime}</div>
                </div>
                
                <table style="width: 100%; border-collapse: separate; border-spacing: 0 10px; font-size: 16px;">
                    <tr>
                        <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">期數:</td>
                        <td style="text-align: left; font-weight: bold;">${period} 期</td>
                    </tr>
                    <tr>
                        <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">稅前利率:</td>
                        <td style="text-align: left; font-weight: bold;">${rate}%</td>
                    </tr>
                    <tr>
                        <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">本金:</td>
                        <td style="text-align: left; font-weight: bold;">${principal} 元</td>
                    </tr>
                    <tr>
                        <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">期繳:</td>
                        <td style="text-align: left; font-weight: bold;">${payment} 元/期</td>
                    </tr>
                    <tr>
                        <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">總利息:</td>
                        <td style="text-align: left; font-weight: bold;">${totalInterest} 元</td>
                    </tr>
                    <tr>
                        <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">稅後利率:</td>
                        <td style="text-align: left; font-weight: bold;">${afterTaxRate}%</td>
                    </tr>
                    ${showCommission ? `
                    <tr>
                        <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">推廣:</td>
                        <td style="text-align: left; font-weight: bold;">${commission} 元</td>
                    </tr>
                    ` : ''}
                    <tr>
                        <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">稅佣後利率:</td>
                        <td style="text-align: left; font-weight: bold;">${afterCommissionRate}%</td>
                    </tr>
                </table>
                
                <div style="text-align: center; margin-top: 15px; font-size: 14px; color: #cccccc; border-top: 1px dashed #555555; padding-top: 12px;">
                    報價後記得吃碗火雞肉飯唷！
                </div>
            </div>
        `;
    }

    // 隱藏分享模態框
    function hideShareModal() {
        const overlay = document.getElementById('shareModalOverlay');
        if (overlay) {
            overlay.style.display = 'none';
            
            // 重置內容，以便下次打開時重新生成
            const shareQuoteCard = document.getElementById('shareQuoteCard');
            if (shareQuoteCard) {
                shareQuoteCard.innerHTML = '';
            }
            
            // 重置狀態訊息
            const shareStatus = document.getElementById('shareStatus');
            if (shareStatus) {
                shareStatus.textContent = '';
            }
            
            // 重設按鈕文字
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
                downloadBtn.textContent = '💾 下載圖片';
            }
            
            // 重設分享按鈕顯示
            const shareBtn = document.getElementById('shareBtn');
            if (shareBtn) {
                shareBtn.style.display = 'inline-block';
            }
        }
    }

    // 分享報價圖片
    function shareQuoteImage(imageDataUrl) {
        const shareStatusElement = document.getElementById('shareStatus');
        
        // 檢查瀏覽器是否支持網頁分享API
        if (navigator.share) {
            try {
                // 首先嘗試分享URL
                navigator.share({
                    title: '貸款計算報價',
                    text: '這是我的貸款計算報價結果',
                    url: location.href
                })
                .then(() => {
                    shareStatusElement.textContent = '分享連結成功！';
                    setTimeout(() => {
                        shareStatusElement.textContent = '';
                    }, 2000);
                })
                .catch(err => {
                    console.error('分享連結失敗:', err);
                    
                    // 失敗後嘗試分享文件
                    shareQuoteImageAsFile(imageDataUrl, shareStatusElement);
                });
            } catch (error) {
                console.error('準備分享時出錯:', error);
                shareStatusElement.textContent = '分享過程中出錯，請使用下載選項。';
            }
        } else {
            // 如果瀏覽器不支持，顯示提示
            shareStatusElement.textContent = '您的設備不支持直接分享功能。請使用下載選項。';
        }
    }

    function shareQuoteImageAsFile(imageDataUrl, statusElement) {
        try {
            // 創建一個 Blob 對象
            fetch(imageDataUrl)
                .then(res => res.blob())
                .then(blob => {
                    // 創建文件對象
                    const dateTime = new Date().toISOString().replace(/[^0-9]/g, '').slice(0, 14);
                    const fileName = `貸款計算報價_${dateTime}.png`;
                    const file = new File([blob], fileName, { type: 'image/png' });
                    
                    // 使用 Web Share API 分享文件
                    navigator.share({
                        title: '貸款計算報價',
                        files: [file]
                    })
                    .then(() => {
                        statusElement.textContent = '分享圖片成功！';
                        setTimeout(() => {
                            statusElement.textContent = '';
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('分享圖片失敗:', err);
                        statusElement.textContent = '分享圖片失敗，請使用下載選項。';
                    });
                })
                .catch(err => {
                    console.error('處理圖片失敗:', err);
                    statusElement.textContent = '處理圖片時出錯，請使用下載選項。';
                });
        } catch (error) {
            console.error('分享圖片出錯:', error);
            statusElement.textContent = '分享圖片失敗，請使用下載選項。';
        }
    }

    // 嘗試將圖片作為文件分享
    function shareQuoteImageAsFile(imageDataUrl, statusElement) {
        try {
            // 創建一個 Blob 對象
            fetch(imageDataUrl)
                .then(res => res.blob())
                .then(blob => {
                    // 創建文件對象
                    const dateTime = document.getElementById('currentTime').textContent.replace(/[^0-9]/g, '');
                    const fileName = `貸款計算報價_${dateTime}.png`;
                    const file = new File([blob], fileName, { type: 'image/png' });
                    
                    // 使用 Web Share API 分享文件
                    navigator.share({
                        title: '貸款計算報價',
                        files: [file]
                    })
                    .then(() => {
                        statusElement.textContent = '分享圖片成功！';
                        setTimeout(() => {
                            statusElement.textContent = '';
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('分享圖片失敗:', err);
                        statusElement.textContent = '分享圖片失敗，請使用下載選項。';
                    });
                })
                .catch(err => {
                    console.error('處理圖片失敗:', err);
                    statusElement.textContent = '處理圖片時出錯，請使用下載選項。';
                });
        } catch (error) {
            console.error('分享圖片出錯:', error);
            statusElement.textContent = '分享圖片失敗，請使用下載選項。';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 為相關輸入欄位添加事件監聽
        const inputIds = ['period', 'payment', 'principal', 'monthlyCost'];
        inputIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateAllFields);
                element.addEventListener('change', updateAllFields);
            }
        });
    });

    // 添加數值變化動畫
        function animateValueChange(elementId) {
        const element = document.getElementById(elementId);
        element.classList.remove('value-changed');
        void element.offsetWidth; // 觸發重繪
        element.classList.add('value-changed');
    }

    

    // 保存貸款計算結果
    // 修改 saveLoanData 函数来确保保存的数据是干净的数字值
    function saveLoanData() {
        const period = document.getElementById('period').value;
        const rate = document.getElementById('rate').value;
        // 移除千位分隔符以保存干净的数值
        const principal = document.getElementById('principal').value.replace(/,/g, '');
        const payment = document.getElementById('payment').value.replace(/,/g, '');
        const afterTaxRate = document.getElementById('afterTaxRate').value;
        const commission = document.getElementById('commission').value.replace(/,/g, '');
        const afterCommissionRate = document.getElementById('afterCommissionRate').value;
        
        // 检查必要字段是否填写
        if (!period || !rate || !principal || !payment) {
            showToast('請先完成必要欄位（期數、利率、本金、期繳）的計算！');
            return;
        }
        
        const loanDate = new Date();
        const year = loanDate.getFullYear();
        const month = String(loanDate.getMonth() + 1).padStart(2, '0');
        const date = String(loanDate.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${date}`;
        
        const loanData = {
            id: new Date().getTime(),
            date: formattedDate,
            period: period,
            rate: rate,
            principal: principal,
            payment: payment,
            afterTaxRate: afterTaxRate,
            commission: commission || '0',
            afterCommissionRate: afterCommissionRate,
            totalInterest: document.getElementById('totalInterest').value.replace(/,/g, ''),
            timestamp: new Date().toISOString(),
            note: '' // 初始備註為空
        };
        
        // 获取已存储的贷款记录
        let loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        loanHistory.push(loanData);
        
        // 保存到 localStorage
        localStorage.setItem('loanHistory', JSON.stringify(loanHistory));
        
        // 显示成功提示
        showToast('貸款計算結果已保存！');
        
        // 触觉反馈（如果设备支持）
        if (navigator.vibrate) {
            navigator.vibrate(70);
        }
    }

    // 顯示/隱藏歷史記錄面板
    function toggleHistoryPanel() {
        const panel = document.getElementById('historyPanel');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'block';
            loadHistoryData();
            
            // 添加一次性背景点击关闭事件
            panel.onclick = function(event) {
                if (event.target === this) {
                    this.style.display = 'none';
                }
            };
        }
    }

    // 載入歷史記錄
    // 修改 loadHistoryData 函数以使用新的设计
    function loadHistoryData() {
        const historyContent = document.getElementById('historyContent');
        const loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        
        if (loanHistory.length === 0) {
            historyContent.innerHTML = '<p class="no-data">尚無貸款計算記錄</p>';
            return;
        }
        
        // 按日期排序，最新的在前面
        loanHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        let html = '<div class="history-list">';
        loanHistory.forEach(loan => {
            // 确保数值正确显示，移除千位分隔符后再格式化
            const principalDisplay = formatNumber(loan.principal);
            const paymentDisplay = formatNumber(loan.payment);
            const commissionDisplay = formatNumber(loan.commission);
            
            html += `
                <div class="history-item">
                    <div class="history-item-header">
                        <div class="history-date">${formatDate(loan.date)}</div>
                        <div class="history-header-rate">稅佣後利率: ${parseFloat(loan.afterCommissionRate).toFixed(4)}%</div>
                    </div>
                    
                    <div class="history-details">
                        <div class="history-detail-item">
                            <span class="detail-label">期數</span>
                            <span class="detail-value">${loan.period}</span>
                        </div>
                        <div class="history-detail-item">
                            <span class="detail-label">推廣</span>
                            <span class="detail-value">${commissionDisplay}</span>
                        </div>
                        <div class="history-detail-item">
                            <span class="detail-label">本金</span>
                            <span class="detail-value">${principalDisplay}</span>
                        </div>
                        <div class="history-detail-item">
                            <span class="detail-label">期繳</span>
                            <span class="detail-value">${paymentDisplay}</span>
                        </div>
                    </div>

                    <div class="history-note-container">
                        <div class="history-item-footer">
                            <div class="history-note-preview" onclick="openNoteEditor(${loan.id}, '${loan.note || ''}')">
                                ${loan.note ? loan.note : '點擊添加備註'}
                            </div>
                            <div class="history-actions">
                                <button class="detail-btn" onclick="loadLoanToForm(${loan.id})">載入計算</button>
                                <button class="delete-btn" onclick="deleteLoan(${loan.id})">刪除</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        historyContent.innerHTML = html;
    }

    function openNoteEditor(loanId, existingNote = '') {
        // 創建備註編輯器模態框
        const noteEditorModal = document.createElement('div');
        noteEditorModal.className = 'note-editor-modal';
        noteEditorModal.id = 'noteEditorModal';
        noteEditorModal.innerHTML = `
            <div class="note-editor-content">
                <h3>備註編輯</h3>
                <textarea id="noteEditorInput" class="note-editor-input" placeholder="請輸入備註內容...">${existingNote}</textarea>
                <div class="note-editor-buttons">
                    <button onclick="closeNoteEditor(false)" class="modal-btn modal-btn-secondary">取消</button>
                    <button onclick="saveNote(${loanId})" class="modal-btn modal-btn-primary">儲存</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(noteEditorModal);
        
        // 顯示模態框
        noteEditorModal.style.display = 'flex';
        
        // 自動聚焦到輸入框並調出鍵盤
        const noteInput = document.getElementById('noteEditorInput');
        noteInput.focus();
        
        // 添加點擊空白處關閉功能
        noteEditorModal.addEventListener('click', function(event) {
            if (event.target === this) {
                closeNoteEditor();
            }
        });
        
        // 監聽鍵盤彈出事件，進一步調整位置
        window.addEventListener('resize', adjustNoteEditorPosition);
        
        // 初始調整位置
        adjustNoteEditorPosition();
    }

    // 新增函數：調整備註編輯器位置
    function adjustNoteEditorPosition() {
        const modal = document.getElementById('noteEditorModal');
        if (!modal) return;
        
        // 偵測視窗高度變化來推測鍵盤是否彈出
        const windowHeight = window.innerHeight;
        const viewportHeight = window.visualViewport ? window.visualViewport.height : windowHeight;
        
        // 鍵盤彈出時會減少視口高度
        if (viewportHeight < windowHeight * 0.8) {
            // 鍵盤已彈出，將編輯器移至更靠頂部的位置
            modal.style.paddingTop = '180px';
            modal.style.justifyContent = 'center'; // 保持水平置中
        } else {
            // 鍵盤收起，恢復原本位置
            modal.style.paddingTop = '180px';
            modal.style.justifyContent = 'center'; // 保持水平置中
        }
    }

    function closeNoteEditor(isCancelled = true) {
        const noteEditorModal = document.getElementById('noteEditorModal');
        if (noteEditorModal) {
            document.body.removeChild(noteEditorModal);
        }
        
        // 移除事件監聽器
        window.removeEventListener('resize', adjustNoteEditorPosition);
    }

    function saveNote(loanId) {
        const noteInput = document.getElementById('noteEditorInput');
        const newNote = noteInput.value.trim();
        
        // 獲取當前的歷史記錄
        let loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        
        // 找到對應的貸款記錄並更新備註
        const updatedHistory = loanHistory.map(loan => {
            if (loan.id === loanId) {
                return { ...loan, note: newNote };
            }
            return loan;
        });
        
        // 儲存更新後的歷史記錄
        localStorage.setItem('loanHistory', JSON.stringify(updatedHistory));
        
        // 關閉備註編輯器
        closeNoteEditor();
        
        // 重新載入歷史記錄
        loadHistoryData();
        
        // 顯示成功提示
        showToast('備註已儲存');
    }

    // 格式化日期顯示
    function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}/${month}/${day}`;
    }

    // 修改 formatNumber 函数
    function formatNumber(num) {
        if (!num) return '0';
        
        // 如果是字符串且包含逗号，先去除千位分隔符
        if (typeof num === 'string') {
            num = num.replace(/,/g, '');
        }
        
        // 确保是数字，然后格式化
        return parseFloat(num).toLocaleString();
    }

    // 載入貸款記錄到表單
    function loadLoanToForm(id) {
        const loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        const loan = loanHistory.find(item => item.id === id);
        
        if (loan) {
            // 除了原有的載入邏輯外，不要重置備註
            document.getElementById('period').value = loan.period;
            document.getElementById('rate').value = loan.rate;
            
            document.getElementById('principal').value = formatNumberWithCommas(Math.round(parseFloat(loan.principal)));
            document.getElementById('payment').value = formatNumberWithCommas(Math.round(parseFloat(loan.payment)));
            document.getElementById('commission').value = formatNumberWithCommas(Math.round(parseFloat(loan.commission)));
            
            calculatePayment();
            updateAllFields();
            
            document.getElementById('historyPanel').style.display = 'none';
            
            showToast('已載入貸款計算資料');
            
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
    }

    // 刪除貸款記錄
    function deleteLoan(id) {
        let loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        loanHistory = loanHistory.filter(loan => loan.id !== id);
        localStorage.setItem('loanHistory', JSON.stringify(loanHistory));
        loadHistoryData(); // 重新載入歷史記錄
        showToast('貸款記錄已刪除！');
        
        // 觸覺反饋
        if (navigator.vibrate) {
            navigator.vibrate([30, 20, 30]);
        }
    }

    // 確認是否刪除所有貸款記錄
    function confirmDeleteAll() {
        showConfirmModal('確認刪除', '確定要刪除所有貸款計算記錄嗎？此操作無法撤銷。', deleteAllLoans);
    }

    // 刪除所有貸款記錄
    function deleteAllLoans() {
        localStorage.removeItem('loanHistory');
        loadHistoryData(); // 重新載入歷史記錄（會顯示無記錄）
        showToast('所有貸款記錄已刪除！');
        
        // 觸覺反饋
        if (navigator.vibrate) {
            navigator.vibrate([50, 30, 50, 30, 50]);
        }
    }

    // 顯示一般模態框
    function showModal(title, content) {
        document.getElementById('modalTitle').textContent = title || '提示';
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modalOverlay').style.display = 'flex';
        
        // 添加背景點擊關閉功能
        document.getElementById('modalOverlay').onclick = function(event) {
            if (event.target === this) {
                hideModal();
            }
        };
    }

    // 隱藏一般模態框
    function hideModal() {
        document.getElementById('modalOverlay').style.display = 'none';
    }

    // 顯示確認模態框
    function showConfirmModal(title, content, confirmCallback) {
        document.getElementById('confirmModalTitle').textContent = title || '確認';
        document.getElementById('confirmModalContent').innerHTML = content;
        document.getElementById('confirmModalOverlay').style.display = 'flex';
        
        // 設定確認按鈕點擊事件
        const confirmButton = document.getElementById('confirmModalOk');
        
        // 移除舊的事件監聽器（如果有的話）
        const newConfirmButton = confirmButton.cloneNode(true);
        confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
        
        // 添加新的事件監聽器
        newConfirmButton.addEventListener('click', function() {
            hideConfirmModal();
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
        });
        
        // 添加背景點擊關閉功能
        document.getElementById('confirmModalOverlay').onclick = function(event) {
            if (event.target === this) {
                hideConfirmModal();
            }
        };
    }

    // 隱藏確認模態框
    function hideConfirmModal() {
        document.getElementById('confirmModalOverlay').style.display = 'none';
    }

    // 顯示輕量級的提示訊息
    function showToast(message, isError = false, duration = 2000) {
        // 檢查是否已有 toast 存在
        const existingToast = document.querySelector('.toast-message');
        if (existingToast) {
            document.body.removeChild(existingToast);
        }
        
        // 創建一個新的 toast 元素
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        if (isError) {
            toast.classList.add('toast-error');
        }
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // 指定時間後自動消失
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 500);
        }, duration);
    }

    // 清空所有欄位除了本月資金成本
    function clearAllFieldsExceptMonthlyCost() {
        // 震動效果
        vibrate();
        
        // 要清空的欄位ID列表
        const fieldsToReset = [
            'period', 'rate', 'principal', 'payment', 
            'totalInterest', 'tax', 'afterTaxRate', 
            'commission', 'commissionRatio', 'afterCommissionRate',
            'annualMillionInterest', 'monthlyMillionInterest',
            'annualTenThousandInterest', 'monthlyTenThousandInterest',
            'spread', 'fundingCost'
        ];
        
        // 清空每個欄位
        fieldsToReset.forEach(fieldId => {
            document.getElementById(fieldId).value = '';
            // 移除任何警告樣式
            document.getElementById(fieldId).classList.remove('warning-text');
        });
        
        // 顯示提示訊息
        showToast('已清空所有欄位');
    }

    // 全局變量
    let currentInputField = null;
    let calculatorValue = "0";
    let calculatorOperator = null;
    let calculatorFirstValue = null;
    let calculatorWaitingForSecondValue = false;
    let calculatorHistory = ""; // 新增：計算過程記錄

    // 開啟計算機輸入器
    function openCalculator(inputId, title) {
        currentInputField = inputId;
        document.getElementById('inputModalTitle').textContent = title;
        
        // 獲取當前輸入框的值
        const currentValue = document.getElementById(inputId).value;
        
        if (currentValue && currentValue !== '') {
            // 如果輸入框有值，使用該值初始化計算器
            calculatorValue = currentValue.replace(/,/g, ''); // 移除千位分隔符
            document.getElementById('calculatorDisplay').textContent = calculatorValue;
        } else {
            // 如果輸入框沒有值，使用 "0"
            calculatorValue = "0";
            document.getElementById('calculatorDisplay').textContent = calculatorValue;
        }
        
        calculatorOperator = null;
        calculatorFirstValue = null;
        calculatorWaitingForSecondValue = false;
        calculatorHistory = ""; // 清空計算歷史
        document.getElementById('calculatorHistory').textContent = ""; // 清空歷史顯示
        document.getElementById('historyScrollIndicator').style.opacity = '0'; // 隱藏滾動指示器
        
        document.getElementById('numberInputModal').style.display = 'flex';
        
        // 添加震動效果
        vibrate();
    }

    // 關閉模態框
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        
        // 添加震動效果
        vibrate();
    }

    // 計算機數字輸入
    function calculatorInput(num) {
        if (calculatorWaitingForSecondValue) {
            calculatorValue = num.toString();
            calculatorWaitingForSecondValue = false;
        } else {
            calculatorValue = calculatorValue === '0' ? num.toString() : calculatorValue + num.toString();
        }
        document.getElementById('calculatorDisplay').textContent = calculatorValue;
        
        // 添加震動效果
        vibrate();
    }

    // 計算機小數點輸入
    function calculatorDecimal() {
        // 如果正在等待第二個值，重置顯示
        if (calculatorWaitingForSecondValue) {
            calculatorValue = '0';
            calculatorWaitingForSecondValue = false;
        }
        
        // 如果當前值不包含小數點，則添加
        if (!calculatorValue.includes('.')) {
            calculatorValue += '.';
        }
        
        document.getElementById('calculatorDisplay').textContent = calculatorValue;
        
        // 添加震動效果
        vibrate();
    }

    // 計算機清除
    function calculatorClear() {
        calculatorValue = '0';
        calculatorOperator = null;
        calculatorFirstValue = null;
        calculatorWaitingForSecondValue = false;
        calculatorHistory = ""; // 清空計算歷史
        document.getElementById('calculatorDisplay').textContent = calculatorValue;
        document.getElementById('calculatorHistory').textContent = ""; // 清空歷史顯示
        document.getElementById('historyScrollIndicator').style.opacity = '0'; // 隱藏滾動指示器
        
        // 添加震動效果
        vibrate();
    }

    // 計算機退格
    function calculatorBackspace() {
        if (calculatorValue.length > 1) {
            calculatorValue = calculatorValue.slice(0, -1);
        } else {
            calculatorValue = '0';
        }
        document.getElementById('calculatorDisplay').textContent = calculatorValue;
        
        // 添加震動效果
        vibrate();
    }

    // 計算機運算符
    function calculatorOperation(op) {
        // 如果已經有運算符在等待，先進行計算
        if (calculatorFirstValue !== null && calculatorOperator !== null) {
            calculatorEquals();
        }
        
        calculatorFirstValue = parseFloat(calculatorValue);
        calculatorOperator = op;
        calculatorWaitingForSecondValue = true;
        
        // 更新計算歷史
        let opSymbol = op;
        switch(op) {
            case '+': opSymbol = ' + '; break;
            case '-': opSymbol = ' - '; break;
            case '*': opSymbol = ' × '; break;
            case '/': opSymbol = ' ÷ '; break;
        }
        
        // 添加當前數字和運算符到歷史記錄
        if (calculatorHistory === "") {
            calculatorHistory = calculatorValue + opSymbol;
        } else {
            // 檢查是否需要換行
            if (calculatorHistory.length > 20) {
                calculatorHistory += "\n" + calculatorValue + opSymbol;
            } else {
                calculatorHistory += calculatorValue + opSymbol;
            }
        }
        
        // 顯示計算歷史並檢查是否需要顯示滾動指示器
        updateCalculatorHistory();
        
        // 添加震動效果
        vibrate();
    }

    // 計算機等號
    function calculatorEquals() {
        if (calculatorFirstValue === null || calculatorOperator === null) return;
        
        const secondValue = parseFloat(calculatorValue);
        let result;
        
        // 完成歷史記錄的運算式
        let completeExpression = calculatorHistory + calculatorValue + " = ";
        
        switch (calculatorOperator) {
            case '+':
                result = calculatorFirstValue + secondValue;
                break;
            case '-':
                result = calculatorFirstValue - secondValue;
                break;
            case '*':
                result = calculatorFirstValue * secondValue;
                break;
            case '/':
                // 增加除零檢查
                if (secondValue === 0) {
                    showToast('錯誤：不能除以零', true);
                    calculatorClear();
                    return;
                }
                result = calculatorFirstValue / secondValue;
                break;
            default:
                return;
        }
        
        // 限制小數點位數，但保留有意義的數字
        calculatorValue = result.toString();
        if (calculatorValue.includes('.')) {
            // 如果是小數，限制最多顯示8位，但去除尾部無意義的零
            calculatorValue = parseFloat(result.toFixed(8)).toString();
        }
        
        // 更新顯示
        document.getElementById('calculatorDisplay').textContent = calculatorValue;
        
        // 更新歷史記錄，保持較短的顯示
        if (completeExpression.length > 30) {
            // 如果表達式太長，只顯示最後的等號部分
            calculatorHistory = calculatorValue;
        } else {
            // 如果表達式不太長，顯示完整表達式
            calculatorHistory = completeExpression;
        }
        
        // 顯示計算歷史並檢查是否需要顯示滾動指示器
        updateCalculatorHistory();
        
        // 為下一次計算準備
        calculatorOperator = null;
        calculatorFirstValue = parseFloat(calculatorValue);
        calculatorWaitingForSecondValue = true;
        
        // 添加震動效果
        vibrate();
    }

    // 修改 submitCalculatorValue 函数
    function submitCalculatorValue() {
        if (!currentInputField) return;
        
        let value = parseFloat(calculatorValue);
        if (isNaN(value)) value = 0;
        
        // 根据不同输入框进行验证
        switch (currentInputField) {
            case 'period':
                // 期数不需要千位分隔符
                value = Math.floor(value);
                if (value < 0) {
                    showToast('錯誤：期數不能為負數', true);
                    return;
                }
                if (value > 999) {
                    showToast('錯誤：期數不能超過3位數', true);
                    return;
                }
                document.getElementById(currentInputField).value = value;
                break;
                
                case 'rate':
                    // 利率不需要千位分隔符
                    if (value < 0) {
                        showToast('錯誤：利率不能為負數', true);
                        return;
                    }
                    if (value > 20) {
                        showToast('警告：利率超過20%，可能不符合一般貸款條件', true);
                        // 允許超過20%的利率，但顯示警告
                    }
                    document.getElementById(currentInputField).value = value.toFixed(4);
                    break;
                
            case 'principal':
                // 本金需要千位分隔符并且只能是正整数
                value = Math.floor(value); // 确保是整数
                if (value <= 0) {
                    showToast('錯誤：本金必須是正整數', true);
                    return;
                }
                if (value > 999999999) {
                    showToast('錯誤：本金不能超過9位數', true);
                    return;
                }
                document.getElementById(currentInputField).value = formatNumberWithCommas(value);
                break;
                
            case 'payment':
                // 期繳必须是正整数
                value = Math.max(1, Math.round(value)); // 改為取整數
                if (value > 999999) {
                    showToast('錯誤：期繳款金額不能超過6位數', true);
                    return;
                }
                document.getElementById(currentInputField).value = formatNumberWithCommas(value);
                break;
                
            case 'commission':
                // 推廣需要千位分隔符
                value = Math.floor(value);
                if (value < 0) {
                    showToast('錯誤：推廣費必須為正整數', true);
                    return;
                }
                if (value > 999999) {
                    showToast('錯誤：推廣費不能超過6位數', true);
                    return;
                }
                document.getElementById(currentInputField).value = formatNumberWithCommas(value);
                break;
        }
        
        // 触发 change 事件以更新相关计算
        const event = new Event('change');
        document.getElementById(currentInputField).dispatchEvent(event);
        
        // 关闭模态框
        closeModal('numberInputModal');
        
        // 根据字段执行相应的计算函数
        if (currentInputField === 'period' || currentInputField === 'rate' || currentInputField === 'principal') {
            calculatePayment();
        } else if (currentInputField === 'payment') {
            calculateRate();
        } else if (currentInputField === 'commission') {
            calculateAfterCommissionRate();
        }
        
        // 添加震动效果
        vibrate();
    }

    // 顯示提示訊息（可重用現有的 showToast 函數，如果沒有的話添加這個）
    function showToast(message, isError = false) {
        // 檢查是否已有 toast
        const existingToast = document.querySelector('.toast-message');
        if (existingToast) {
            document.body.removeChild(existingToast);
        }
        
        // 創建新的 toast
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        if (isError) {
            toast.classList.add('toast-error');
        }
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // 2秒後自動消失
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 500);
        }, 2000);
    }

    // 格式化數字 - 添加千位分隔符
    function formatNumberWithCommas(num) {
        if (!num && num !== 0) return '';
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // 更新計算歷史顯示，並檢查是否需要顯示滾動指示器
    function updateCalculatorHistory() {
        const historyElement = document.getElementById('calculatorHistory');
        const indicatorElement = document.getElementById('historyScrollIndicator');
        
        // 更新歷史內容
        historyElement.textContent = calculatorHistory;
        
        // 檢查是否內容溢出需要顯示滾動指示器
        const isOverflowing = historyElement.scrollWidth > historyElement.clientWidth || 
                            historyElement.scrollHeight > historyElement.clientHeight;
        
        if (isOverflowing) {
            historyElement.classList.add('has-overflow');
        } else {
            historyElement.classList.remove('has-overflow');
        }
    }

    function countFilledFields() {
        const period = document.getElementById('period').value;
        const rate = document.getElementById('rate').value;
        const principal = document.getElementById('principal').value;
        const payment = document.getElementById('payment').value;
        
        let count = 0;
        if (period && period !== '0') count++;
        if (rate && rate !== '0') count++;
        if (principal && principal !== '0') count++;
        if (payment && payment !== '0') count++;
        
        return count;
    }

    </script>
	
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('loaded');
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const header = document.querySelector('.sticky-header');
    const h1Element = document.querySelector('h1');
    
    if (!header || !h1Element) return; // 添加检查

    window.addEventListener('scroll', function() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const headerRect = header.getBoundingClientRect();
        const h1Rect = h1Element.getBoundingClientRect();
        
        // 使用更精确的条件判断
        if (scrollTop > header.offsetTop) {
            header.classList.add('is-sticky');
            if (h1Rect.bottom > 0) {
                header.classList.remove('is-sticky');
            }
        } else {
            header.classList.remove('is-sticky');
        }
    });
    });
    </script>

    <script>
        if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
            .then(registration => {
                console.log('ServiceWorker registration successful');
            })
            .catch(err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
        }

        // 在所有 JavaScript 函數定義之後添加
        document.addEventListener('DOMContentLoaded', function() {
            // 設置輸入框點擊事件
            document.getElementById('period').addEventListener('click', function() {
                openCalculator('period', '請輸入【期數】');
            });
            
            document.getElementById('rate').addEventListener('click', function() {
                openCalculator('rate', '請輸入【稅前利率】');
            });
            
            document.getElementById('principal').addEventListener('click', function() {
                openCalculator('principal', '請輸入【本金】');
            });
            
            document.getElementById('payment').addEventListener('click', function() {
                openCalculator('payment', '請輸入【期繳】');
            });
            
            document.getElementById('commission').addEventListener('click', function() {
                openCalculator('commission', '請輸入【推廣】');
            });
            
            // 點擊模態框背景關閉模態框
            document.getElementById('numberInputModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeModal('numberInputModal');
                }
            });

            // 在这里添加历史记录面板背景点击关闭功能
            document.getElementById('historyPanel').addEventListener('click', function(event) {
                if (event.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // 添加計算歷史的滾動功能
            const historyElement = document.getElementById('calculatorHistory');
            let isScrolling = false;
            let startX;
            let scrollLeft;

            historyElement.addEventListener('mousedown', (e) => {
                isScrolling = true;
                startX = e.pageX - historyElement.offsetLeft;
                scrollLeft = historyElement.scrollLeft;
            });

            historyElement.addEventListener('mouseleave', () => {
                isScrolling = false;
            });

            historyElement.addEventListener('mouseup', () => {
                isScrolling = false;
            });

            historyElement.addEventListener('mousemove', (e) => {
                if (!isScrolling) return;
                e.preventDefault();
                const x = e.pageX - historyElement.offsetLeft;
                const walk = (x - startX) * 2; // 滾動速度
                historyElement.scrollLeft = scrollLeft - walk;
            });

            // 添加觸摸事件支持
            historyElement.addEventListener('touchstart', (e) => {
                isScrolling = true;
                startX = e.touches[0].pageX - historyElement.offsetLeft;
                scrollLeft = historyElement.scrollLeft;
            });

            historyElement.addEventListener('touchend', () => {
                isScrolling = false;
            });

            historyElement.addEventListener('touchmove', (e) => {
                if (!isScrolling) return;
                const x = e.touches[0].pageX - historyElement.offsetLeft;
                const walk = (x - startX) * 2;
                historyElement.scrollLeft = scrollLeft - walk;
            });

        });
    </script>

    <!-- 數字輸入器模態框 -->
    <div id="numberInputModal" class="modal-overlay">
        <div class="number-input-modal">
            <div class="modal-header">
                <h3 id="inputModalTitle">數字輸入器</h3>
                <button class="close-btn" onclick="closeModal('numberInputModal')">×</button>
            </div>

            <div class="calculator-display-container">
                <div class="calculator-scroll-indicator" id="historyScrollIndicator"></div>
                <div class="calculator-history" id="calculatorHistory"></div>
                <div class="calculator-display" id="calculatorDisplay">0</div>
            </div>

            <div class="calculator-buttons">
                <!-- 第一行：功能鍵 -->
                <button onclick="calculatorClear()" class="clear">C</button>
                <button onclick="calculatorBackspace()" class="function">⌫</button>
                <button onclick="calculatorOperation('/')" class="operator">÷</button>
                <button onclick="calculatorOperation('*')" class="operator">×</button>
                
                <!-- 第二行：數字和減號 -->
                <button onclick="calculatorInput(7)" class="number-btn">
                    <div class="arabic-number">7</div>
                    <div class="financial-char">柒</div>
                </button>
                <button onclick="calculatorInput(8)" class="number-btn">
                    <div class="arabic-number">8</div>
                    <div class="financial-char">捌</div>
                </button>
                <button onclick="calculatorInput(9)" class="number-btn">
                    <div class="arabic-number">9</div>
                    <div class="financial-char">玖</div>
                </button>
                <button onclick="calculatorOperation('-')" class="operator">−</button>
                
                <!-- 第三行：數字和加號 -->
                <button onclick="calculatorInput(4)" class="number-btn">
                    <div class="arabic-number">4</div>
                    <div class="financial-char">肆</div>
                </button>
                <button onclick="calculatorInput(5)" class="number-btn">
                    <div class="arabic-number">5</div>
                    <div class="financial-char">伍</div>
                </button>
                <button onclick="calculatorInput(6)" class="number-btn">
                    <div class="arabic-number">6</div>
                    <div class="financial-char">陸</div>
                </button>
                <button onclick="calculatorOperation('+')" class="operator">+</button>
                
                <!-- 第四行：底部數字和等號 -->
                <button onclick="calculatorInput(1)" class="number-btn">
                    <div class="arabic-number">1</div>
                    <div class="financial-char">壹</div>
                </button>
                <button onclick="calculatorInput(2)" class="number-btn">
                    <div class="arabic-number">2</div>
                    <div class="financial-char">貳</div>
                </button>
                <button onclick="calculatorInput(3)" class="number-btn">
                    <div class="arabic-number">3</div>
                    <div class="financial-char">參</div>
                </button>
                <button onclick="calculatorEquals()" class="equals">=</button>
                
                <!-- 第五行：零、小數點和確認鍵 -->
                <button onclick="calculatorInput(0)" class="number-btn">
                    <div class="arabic-number">0</div>
                    <div class="financial-char">零</div>
                </button>
                <button onclick="calculatorDecimal()" class="function">.</button>
                <button onclick="submitCalculatorValue()" class="submit">確認輸入</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggleViewBtn');
            const toggleIcon = document.getElementById('toggleIcon');
            
            // 需要切換顯示的元素
            const buttonGroups = [
                'periodButtons',
                'rateButtons',
                'principalButtons',
                'PaymentduringButtons',
                'commissionButtons',
                'commissionPercentButtons'
            ];
            
            // 需要隱藏的整行元素
            const hideRows = [
                document.querySelector('.row:has(#tax)'), // 稅金欄位
            ];
            
            // 需要隱藏的區段（百萬每年利息到NPV）
            const hideSection = document.querySelectorAll('.row:has(#annualMillionInterest), .row:has(#monthlyMillionInterest), .row:has(#annualTenThousandInterest), .row:has(#monthlyTenThousandInterest), .row:has(#monthlyCost), .row:has(#spread), .row:has(#fundingCost)');
            
            let isSimpleView = false;
            
            toggleBtn.addEventListener('click', function() {
                isSimpleView = !isSimpleView;
                
                // 更改圖標並添加旋轉動畫
                if (isSimpleView) {
                    toggleIcon.classList.add('icon-rotate-up');
                } else {
                    toggleIcon.classList.remove('icon-rotate-up');
                }
                
                // 定義統一的動畫效果
                const animationOptions = {
                    duration: 300,
                    easing: 'cubic-bezier(0.4, 0, 0.2, 1)'
                };
                
                // 切換按鈕組的顯示
                buttonGroups.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (isSimpleView) {
                            // 使用 Web Animations API 實現統一的動畫
                            element.animate([
                                { opacity: 1, transform: 'scaleY(1)' },
                                { opacity: 0, transform: 'scaleY(0.8)' }
                            ], animationOptions).onfinish = () => {
                                element.classList.add('hidden-element');
                            };
                        } else {
                            element.classList.remove('hidden-element');
                            element.animate([
                                { opacity: 0, transform: 'scaleY(0.8)' },
                                { opacity: 1, transform: 'scaleY(1)' }
                            ], animationOptions);
                        }
                    }
                });
                
                // 切換稅金欄位的顯示
                hideRows.forEach(row => {
                    if (row) {
                        if (isSimpleView) {
                            row.animate([
                                { opacity: 1, transform: 'scaleY(1)' },
                                { opacity: 0, transform: 'scaleY(0.8)' }
                            ], animationOptions).onfinish = () => {
                                row.classList.add('hidden-element');
                            };
                        } else {
                            row.classList.remove('hidden-element');
                            row.animate([
                                { opacity: 0, transform: 'scaleY(0.8)' },
                                { opacity: 1, transform: 'scaleY(1)' }
                            ], animationOptions);
                        }
                    }
                });
                
                // 切換百萬每年利息到NPV區段的顯示
                hideSection.forEach(row => {
                    if (row) {
                        if (isSimpleView) {
                            row.animate([
                                { opacity: 1, transform: 'scaleY(1)' },
                                { opacity: 0, transform: 'scaleY(0.8)' }
                            ], animationOptions).onfinish = () => {
                                row.classList.add('hidden-element');
                            };
                        } else {
                            row.classList.remove('hidden-element');
                            row.animate([
                                { opacity: 0, transform: 'scaleY(0.8)' },
                                { opacity: 1, transform: 'scaleY(1)' }
                            ], animationOptions);
                        }
                    }
                });
                
                // 處理分隔線
                const dividers = document.querySelectorAll('.divider-flow');
                
                if (isSimpleView) {
                    if (dividers.length >= 3) {
                        dividers[0].animate([
                            { opacity: 1, transform: 'scaleX(1)' },
                            { opacity: 0, transform: 'scaleX(0.8)' }
                        ], animationOptions).onfinish = () => {
                            dividers[0].classList.add('hidden-element');
                        };
                        
                        for (let i = 1; i < dividers.length - 1; i++) {
                            dividers[i].animate([
                                { opacity: 1, transform: 'scaleX(1)' },
                                { opacity: 0, transform: 'scaleX(0.8)' }
                            ], animationOptions).onfinish = () => {
                                dividers[i].classList.add('hidden-element');
                            };
                        }
                        
                        dividers[dividers.length - 1].classList.remove('hidden-element');
                    }
                } else {
                    dividers.forEach(divider => {
                        divider.classList.remove('hidden-element');
                        divider.animate([
                            { opacity: 0, transform: 'scaleX(0.8)' },
                            { opacity: 1, transform: 'scaleX(1)' }
                        ], animationOptions);
                    });
                }
                
                // 觸發震動效果
                vibrate();
            });
        });
    </script>

    <script>
        // 選單功能控制
        document.addEventListener('DOMContentLoaded', function() {
            // 綁定選單按鈕事件
            const menuBtn = document.getElementById('menuBtn');
            menuBtn.addEventListener('click', function() {
                // 移除任何影響按鈕位置的代碼
                openMainMenu();
                vibrate();
            });
            
            // 點擊背景關閉選單
            const mainMenuContainer = document.getElementById('mainMenuContainer');
            mainMenuContainer.addEventListener('click', function(event) {
                if (event.target === this) {
                    closeMainMenu();
                }
            });
            
            // 點擊背景關閉子選單
            const submenus = document.querySelectorAll('.submenu-container');
            submenus.forEach(function(submenu) {
                submenu.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeSubmenu(this.id);
                    }
                });
            });
        });
        
        // 打開主選單
        function openMainMenu() {
            const mainMenuContainer = document.getElementById('mainMenuContainer');
            mainMenuContainer.style.display = 'flex';
        }
        
        // 關閉主選單
        function closeMainMenu() {
            const mainMenuContainer = document.getElementById('mainMenuContainer');
            const menuContent = mainMenuContainer.querySelector('.menu-content');
            
            // 添加關閉動畫
            menuContent.classList.add('menu-closing');
            
            // 動畫結束後隱藏選單
            setTimeout(function() {
                mainMenuContainer.style.display = 'none';
                menuContent.classList.remove('menu-closing');
                
                // 同時確保所有子選單也關閉
                const submenus = document.querySelectorAll('.submenu-container');
                submenus.forEach(function(submenu) {
                    submenu.style.display = 'none';
                    submenu.querySelector('.submenu-content').classList.remove('submenu-closing');
                });
            }, 200); // 與動畫時長相匹配
            
            vibrate(); // 使用現有的震動函數
        }

        // 打開子選單
        function openSubmenu(submenuId) {
            // 先關閉主選單 (無動畫)
            document.getElementById('mainMenuContainer').style.display = 'none';
            
            // 打開指定的子選單
            const submenu = document.getElementById(submenuId);
            submenu.style.display = 'flex';
            
            vibrate(); // 使用現有的震動函數
        }

        // 返回主選單
        function backToMainMenu(submenuId) {
            // 關閉當前子選單
            const submenu = document.getElementById(submenuId);
            const submenuContent = submenu.querySelector('.submenu-content');
            
            // 添加關閉動畫
            submenuContent.classList.add('submenu-closing');
            
            // 動畫結束後隱藏子選單，顯示主選單
            setTimeout(function() {
                submenu.style.display = 'none';
                submenuContent.classList.remove('submenu-closing');
                document.getElementById('mainMenuContainer').style.display = 'flex';
            }, 200); // 與動畫時長相匹配
            
            vibrate(); // 使用現有的震動函數
        }

        // 關閉子選單
        function closeSubmenu(submenuId) {
            const submenu = document.getElementById(submenuId);
            const submenuContent = submenu.querySelector('.submenu-content');
            
            // 添加關閉動畫
            submenuContent.classList.add('submenu-closing');
            
            // 動畫結束後隱藏子選單
            setTimeout(function() {
                submenu.style.display = 'none';
                submenuContent.classList.remove('submenu-closing');
            }, 200); // 與動畫時長相匹配
            
            vibrate(); // 使用現有的震動函數
        }

        // 顯示功能開發中提示
        function showDevelopingToast() {
            // 使用現有的 showToast 函數
            showToast('功能開發中');
            vibrate(); // 觸發震動
        }

        function switchTheme(themeName) {
            // 先移除舊有任何主題數據
            document.documentElement.removeAttribute('data-theme');
            
            // 如果選擇的不是預設主題，則設定新主題
            if (themeName !== 'default') {
                document.documentElement.setAttribute('data-theme', themeName);
            }
            
            // 保存主題設置到localStorage
            localStorage.setItem('selectedTheme', themeName);
            
            // 提供反饋
            showToast('已套用「' + getThemeName(themeName) + '」主題');
            
            // 觸發震動反饋
            vibrate();
        }

        function getThemeName(themeCode) {
            switch(themeCode) {
                case 'default': return '暗夜橘焰';
                case 'white': return '極簡黑白';
                case 'pink': return '櫻花雪';
                case 'red': return '暗夜烈焰';
                case 'blue-purple': return '暮光星塵';
                case 'green': return '翠玉清風';
                case 'blue': return '科技藍調';
                case 'royal': return '皇家紫韻';
                default: return themeCode;
            }
        }

        // 根據主題代碼返回顯示名稱
        function getThemeName(themeCode) {
            switch(themeCode) {
                case 'default': return '暗夜橘焰';
                case 'white': return '極簡黑白';
                case 'pink': return '櫻花雪';
                case 'red': return '暗夜烈焰';
                case 'blue-purple': return '暮光星塵';
                case 'green': return '翠玉清風';
                case 'blue': return '科技藍調';
                case 'royal': return '皇家紫韻';
                default: return themeCode;
            }
        }

        // 頁面加載時恢復保存的主題
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme) {
                switchTheme(savedTheme);
            }
        });

    </script>

    <!-- 報價卡片模板 -->
    <div id="quoteCardTemplate" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; background-color: #333333; padding: 20px; box-sizing: border-box;">
        <div id="quoteCard" style="width: 100%; max-width: 380px; margin: 0 auto; background-color: #333333; padding: 20px; border-radius: 15px; font-family: 'Microsoft JhengHei', Arial, sans-serif; color: #ffffff; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); border: 2px solid #ff9c33;">
            <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #ff9c33; padding-bottom: 10px;">
                <h2 style="margin: 0; font-size: 20px; color: #ff9c33;">貸款計算報價單</h2>
                <div style="font-size: 14px; margin-top: 5px;" id="quoteDate"></div>
            </div>
            
            <table style="width: 100%; border-collapse: separate; border-spacing: 0 8px;">
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">期數:</td>
                    <td style="text-align: left; font-weight: bold;" id="quotePeriod"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">稅前利率:</td>
                    <td style="text-align: left; font-weight: bold;" id="quoteRate"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">本金:</td>
                    <td style="text-align: left; font-weight: bold;" id="quotePrincipal"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">期繳:</td>
                    <td style="text-align: left; font-weight: bold;" id="quotePayment"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">總利息:</td>
                    <td style="text-align: left; font-weight: bold;" id="quoteTotalInterest"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">稅後利率:</td>
                    <td style="text-align: left; font-weight: bold;" id="quoteAfterTaxRate"></td>
                </tr>
                <tr id="quoteCommissionRow">
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">推廣:</td>
                    <td style="text-align: left; font-weight: bold;" id="quoteCommission"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: #ff9c33; font-weight: bold;">稅佣後利率:</td>
                    <td style="text-align: left; font-weight: bold;" id="quoteAfterCommissionRate"></td>
                </tr>
            </table>
            
            <div style="text-align: center; margin-top: 15px; font-size: 14px; color: #cccccc; border-top: 1px dashed #555555; padding-top: 10px;">
                報價後記得吃碗火雞肉飯唷！
            </div>
        </div>
    </div>

    <!-- 分享模態框 -->
    <!-- 分享模態框 -->
    <div id="shareModalOverlay" class="modal-overlay">
        <div class="modal-container" style="max-width: 400px;">
            <div class="modal-header">
                <h3>分享貸款計算結果</h3>
                <button class="close-btn" onclick="hideShareModal()">×</button>
            </div>
            <div class="modal-content" style="text-align: center; padding: 10px;">
                <div id="shareQuoteCard" style="margin: 0 auto; max-width: 380px; padding: 0;"></div>
                <div style="margin: 15px 0;">
                    <div id="shareOptions" style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">
                        <button id="downloadBtn" class="modal-btn modal-btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <span style="font-size: 18px;">💾</span> 下載圖片
                        </button>
                        <button id="shareBtn" class="modal-btn modal-btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <span style="font-size: 18px;">🔗</span> 直接分享
                        </button>
                    </div>
                    <div id="shareStatus" style="margin-top: 15px; color: #ff9c33; font-size: 14px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主選單 -->
    <div id="mainMenuContainer" class="menu-container">
        <div class="menu-content">
            <div class="menu-header">
                <h3>主選單</h3>
                <button class="menu-close-btn" onclick="closeMainMenu()">×</button>
            </div>
            <ul class="menu-list" style="flex: 1; overflow-y: auto;">
                <li class="menu-item" onclick="openSubmenu('advancedSubmenu')">
                    進階 <span class="menu-item-arrow">▶</span>
                </li>
                <li class="menu-item" onclick="openSubmenu('themeSubmenu')">
                    外觀 <span class="menu-item-arrow">▶</span>
                </li>
                <li class="menu-item" onclick="openSubmenu('languageSubmenu')">
                    語言 <span class="menu-item-arrow">▶</span>
                </li>
            </ul>
            <div class="version-info">v2.36</div>
        </div>
    </div>

    <!-- 進階子選單 -->
    <div id="advancedSubmenu" class="submenu-container">
        <div class="submenu-content">
            <div class="submenu-header">
                <button class="submenu-back-btn" onclick="backToMainMenu('advancedSubmenu')">
                    ◀ 返回
                </button>
                <h3>進階</h3>
            </div>
            <ul class="submenu-list" style="flex: 1; overflow-y: auto;">
                <li class="submenu-item" onclick="showDevelopingToast()">開發中</li>
            </ul>
        </div>
    </div>

    <!-- 外觀子選單 -->
    <div id="themeSubmenu" class="submenu-container">
        <div class="submenu-content">
            <div class="submenu-header">
                <button class="submenu-back-btn" onclick="backToMainMenu('themeSubmenu')">
                    ◀ 返回
                </button>
                <h3>外觀</h3>
            </div>
            <ul class="submenu-list" style="flex: 1; overflow-y: auto;">
                <li class="submenu-item" onclick="switchTheme('default')">暗夜橘焰</li>
                <li class="submenu-item" onclick="switchTheme('white')">極簡黑白</li> 
                <li class="submenu-item" onclick="switchTheme('pink')">櫻花雪</li>
                <li class="submenu-item" onclick="switchTheme('red')">暗夜烈焰</li>
                <li class="submenu-item" onclick="switchTheme('blue-purple')">暮光星塵</li>
                <li class="submenu-item" onclick="switchTheme('green')">翠玉清風</li>
                <li class="submenu-item" onclick="switchTheme('blue')">科技藍調</li>
                <li class="submenu-item" onclick="switchTheme('royal')">皇家紫韻</li>
            </ul>
        </div>
    </div>

    <!-- 語言子選單 -->
    <div id="languageSubmenu" class="submenu-container">
        <div class="submenu-content">
            <div class="submenu-header">
                <button class="submenu-back-btn" onclick="backToMainMenu('languageSubmenu')">
                    ◀ 返回
                </button>
                <h3>語言</h3>
            </div>
            <ul class="submenu-list" style="flex: 1; overflow-y: auto;">
                <li class="submenu-item" onclick="showDevelopingToast()">中文</li>
                <li class="submenu-item" onclick="showDevelopingToast()">英文</li>
                <li class="submenu-item" onclick="showDevelopingToast()">菲律賓</li>
                <li class="submenu-item" onclick="showDevelopingToast()">日文</li>
            </ul>
        </div>
    </div>

</body>
</html>
