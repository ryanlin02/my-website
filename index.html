<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=400, user-scalable=no">
    <title>雞肉飯要每天吃</title>
    <style>
    :root {
        --primary-color: #333333;
        --secondary-color: #4a4a4a;
        --text-color: #ffffff;
        --border-color: #555555;
        --hover-color: #666666;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --button-orange: #ff9c33;
        --button-blue: #33b5e5;
		--button-grey: #333333;
    }

    html, body {
    	width: 100%;           /* 改為100%寬度 */
    	max-width: 400px;      /* 設定最大寬度 */
    	margin: 0 auto;
    	overflow-x: hidden;
    	-webkit-text-size-adjust: 100%;
    	padding: 0 3px;       /* 增加左右padding */
    	background-color: #333333;
    	color: var(--text-color);
    	font-family: "Microsoft JhengHei", Arial, sans-serif;
    	box-sizing: border-box; /* 添加這行 */
	}

    h1 {
        color: var(--text-color);
        font-size: 22px;
        margin-bottom: 0px;
        border-bottom: 2px solid var(--button-orange);
        padding-bottom: 5px;
    }

    .row {
        margin: 4px 0;
        display: flex;
        align-items: center;
        background: var(--secondary-color);
        padding: 3px;
        border-radius: 4px;
        box-shadow: 0 4px 8px var(--shadow-color);
    }

    .label {
        width: 120px;
        margin-right: 15px;
        text-align: right;
        font-weight: 600;
        color: var(--text-color);
    }

    input {
        width: 120px;
        padding: 5px 12px;
        margin-right: 15px;
        background-color: #222222;
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 15px;
        transition: border-color 0.3s ease;
    }

    input:focus {
        outline: none;
        border-color: var(--button-blue);
        box-shadow: 0 0 0 2px rgba(51, 181, 229, 0.2);
    }

    button {
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 3px 8px;
        margin: 0 5px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        font-size: 15px;
    }

    button:hover {
        background-color: var(--hover-color);
    }
	
	.row button {
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: 1px solid var(--button-grey);  /* 使用深灰色邊框 */
        padding: 3px 8px;
        margin: 0 5px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;  /* 添加 all 以實現完整的過渡效果 */
        font-size: 15px;
    }

    .row button:hover {
        background-color: var(--button-orange);  /* 懸停時變為橙色背景 */
        color: var(--text-color);
        border-color: var(--button-orange);  /* 邊框也變為橙色 */
    }

    .row button:active {
        background-color: var(--secondary-color);  /* 點擊時恢復原本顏色 */
        color: var(--text-color);
        border-color: var(--button-grey);
    }

    div[id$="Buttons"] button {
        background-color: var(--secondary-color);
        color: var(--button-orange);
        border: 1px solid var(--button-orange);
        transition: all 0.3s ease;
    }

    div[id$="Buttons"] button:hover {
        background-color: var(--button-orange);
        color: var(--text-color);
    }

    .readonly {
        background-color: #222222;
    }

    #timeDisplay {
        margin: 5px 0;
        font-size: 15px;
        background: var(--secondary-color);
        color: var(--text-color);
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 2px 4px var(--shadow-color);
    }

    .time-label {
        font-weight: bold;
        margin-right: 10px;
        color: var(--button-orange);
    }

    #periodButtons, #rateButtons, #principalButtons, #commissionButtons, #PaymentduringButtons {
    	margin: 2px 0 5px 0;    /* 修改邊距 */
    	display: flex;
    	flex-wrap: wrap;        /* 允許按鈕換行 */
    	gap: 8px;
    	width: 100%;            /* 修改寬度設定 */
    	justify-content: flex-end;
    	padding-right: 5px;     /* 添加右側padding */
    	box-sizing: border-box; /* 添加這行 */
	}

    button {
        flex-shrink: 0;
    }

    .divider {
        border-top: 2px solid var(--border-color);
        margin: 10px 0;
    }

    .function-buttons {
        display: flex;
        justify-content: space-around;
        margin: 10px 0;
    }

    .quote-table {
    	width: 100%;
    	border-collapse: separate;
    	border-spacing: 0;
		margin: 20px 0;
		background: var(--primary-color);
		border-radius: 8px;
		overflow: hidden;
		box-shadow: 0 4px 12px var(--shadow-color);
	}

	.quote-table tr {
		background: var(--secondary-color);
		transition: background-color 0.3s ease;
	}

	.quote-table tr:hover {
		background: var(--hover-color);
	}

	.quote-table td {
		padding: 16px 20px;
		border-bottom: 1px solid var(--border-color);
		color: var(--text-color);
	}

	.quote-table td:first-child {
		width: 120px;
		white-space: nowrap;
		color: var(--button-orange);
		font-weight: 600;
	}

	.quote-table td:last-child {
		text-align: right;
		font-family: monospace;
		font-size: 1.1em;
	}

	.quote-table tr:last-child td {
		border-bottom: none;
	}

    .function-buttons button {
    background-color: var(--secondary-color);
    color: var(--button-orange);      /* 改為橘色文字 */
    border: 1px solid var(--button-orange);  /* 改為橘色邊框 */
    padding: 3px 8px;
    margin: 0 5px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 15px;
}

.function-buttons button:hover {
    background-color: var(--button-orange);
    color: var(--text-color);
    border-color: var(--button-orange);
}

.function-buttons button:active {
    background-color: var(--secondary-color);
    color: var(--button-orange);
    border-color: var(--button-orange);
}
</style>
</head>
<body>
	<div style="text-align: center;">
     <h1>小朋友專用計算機</h1>
	</div>
	
    <div id="timeDisplay" style="display: flex; justify-content: center;">
        <span class="time-label">報價時間：</span><span id="currentTime"></span>
    </div>
    
<div class="row">
        <span class="label">期數</span>
        <input type="number" id="period" step="0.1">
        <button onclick="calculatePeriod()">算</button>
        <button onclick="clearField('period')">清</button>
    </div>

    <div id="periodButtons" style="display: flex; justify-content: flex-end;">
		<button onclick="adjustPeriod(-1)">-1</button>
		<button onclick="setPeriod(12)">1</button>
        <button onclick="setPeriod(24)">2</button>
        <button onclick="setPeriod(36)">3</button>
        <button onclick="setPeriod(48)">4</button>
        <button onclick="setPeriod(60)">5</button>
      <button onclick="adjustPeriod(1)">+1</button>
	</div>
    <div class="row">
        <span class="label">稅前利率</span>
        <input type="number" id="rate" step="0.01">
        <button onclick="calculateRate()">算</button>
        <button onclick="clearField('rate')">清</button>
    </div>

    <div id="rateButtons" style="display: flex; justify-content: flex-end;">
        <button onclick="adjustRate(-0.2)">-0.2</button>
        <button onclick="setRate(4)">4</button>
        <button onclick="setRate(6)">6</button>
		<button onclick="setRate(8)">8</button>
        <button onclick="setRate(10)">10</button>
        <button onclick="setRate(13)">13</button>
        <button onclick="adjustRate(0.2)">+0.2</button>
    </div>
    <div class="row">
        <span class="label">本金</span>
        <input type="number" id="principal">
        <button onclick="calculatePrincipal()">算</button>
        <button onclick="clearField('principal')">清</button>
    </div>
    <div id="principalButtons" style="display: flex; justify-content: flex-end;">
		<button onclick="adjustPrincipal(-1000000)">-100</button>
		<button onclick="adjustPrincipal(-100000)">-10</button>
		<button onclick="adjustPrincipal(-10000)">-1</button>
        <button onclick="adjustPrincipal(10000)">+1</button>
		<button onclick="adjustPrincipal(100000)">+10</button>
		<button onclick="adjustPrincipal(1000000)">+100</button>
    </div>
    <div class="row">
        <span class="label">期繳</span>
        <input type="number" id="payment" step="0.01">
        <button onclick="calculatePayment()">算</button>
        <button onclick="clearField('payment')">清</button>
    </div>
	 <div id="PaymentduringButtons" style="display: flex; justify-content: flex-end;">
        <button onclick="adjustPayment(-100)">-100</button>
		 <button onclick="adjustPayment(-50)">-50</button>
        <button onclick="roundPayment('down', 100)">捨百</button>
        <button onclick="roundPayment('up', 100)">進百</button>
		 <button onclick="adjustPayment(50)">+50</button>
        <button onclick="adjustPayment(100)">+100</button>
    </div>
	<div class="row">
        <span class="label">總利息</span>
        <input type="number" id="totalInterest" class="readonly" readonly>
    </div>
    <div class="row">
        <span class="label">等於幾碗雞肉飯</span>
        <input type="number" id="chickenRice" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">稅金</span>
        <input type="number" id="tax" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">稅後利率</span>
        <input type="number" id="afterTaxRate" class="readonly" readonly>
    </div>

     <div class="row">
        <span class="label">佣金</span>
        <input type="number" id="commission">
        <button onclick="calculateAfterCommissionRate()">算</button>
        <button onclick="clearCommission()">清</button>
    </div>

    <div id="commissionButtons" style="display: flex; justify-content: flex-end;">
        <button onclick="setCommissionPercentage(1)">1</button>
        <button onclick="setCommissionPercentage(2)">2</button>
        <button onclick="setCommissionPercentage(3)">3</button>
        <button onclick="setCommissionPercentage(4)">4</button>
        <button onclick="setCommissionPercentage(5)">5</button>
    </div>
    <div class="row">
        <span class="label">稅佣後利率</span>
        <input type="number" id="afterCommissionRate" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">百萬每年利息</span>
        <input type="number" id="annualMillionInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">百萬每月利息</span>
        <input type="number" id="monthlyMillionInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">一萬每年利息</span>
        <input type="number" id="annualTenThousandInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">一萬每月利息</span>
        <input type="number" id="monthlyTenThousandInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">本月資金成本</span>
        <input type="number" id="monthlyCost" value="2.0951" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">Spread</span>
        <input type="number" id="spread" class="readonly" readonly>
    </div>
	<!-- 在最後一個 .row div 後面添加 -->
	<div class="divider"></div>
	<div class="function-buttons">
    	<button onclick="window.open('https://travel.chiayi.gov.tw/Folder/TurkeyRice', '_blank')">雞肉飯</button>
		<button onclick="location.reload()">全清</button>
    	<button onclick="generateQuote()">截圖</button>
	</div>
<script>
	     // 添加更新時間的函數
        function updateTime() {
            const now = new Date();
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            
            // 調整為台北時間 (GMT+8)
            const taipeiTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
            
            const year = taipeiTime.getUTCFullYear();
            const month = String(taipeiTime.getUTCMonth() + 1).padStart(2, '0');
            const date = String(taipeiTime.getUTCDate()).padStart(2, '0');
            const day = days[taipeiTime.getUTCDay()];
            const hours = String(taipeiTime.getUTCHours()).padStart(2, '0');
            const minutes = String(taipeiTime.getUTCMinutes()).padStart(2, '0');
            const seconds = String(taipeiTime.getUTCSeconds()).padStart(2, '0');
            
            const timeString = `${year}年${month}月${date}日，星期${day}，${hours}:${minutes}:${seconds}`;
            document.getElementById('currentTime').textContent = timeString;
        }

        // 每秒更新一次時間
        setInterval(updateTime, 1000);
        updateTime(); // 初始化顯示

        // 原始的JavaScript函數保持不變
        function PMT(rate, nper, pv) {
            rate = rate / 100 / 12;
            return (pv * rate * Math.pow(1 + rate, nper)) / (Math.pow(1 + rate, nper) - 1);
        }
        function PMT(rate, nper, pv) {
            rate = rate / 100 / 12;
            return (pv * rate * Math.pow(1 + rate, nper)) / (Math.pow(1 + rate, nper) - 1);
        }

        function RATE(nper, pmt, pv) {
            let rate = 0.1;
            let step = 0.05;
            let tolerance = 0.0001;
            let maxIterations = 100;
            let iteration = 0;

            while (iteration < maxIterations) {
                let monthlyRate = rate / 12;
                let calculated = pv * monthlyRate * Math.pow(1 + monthlyRate, nper) / 
                               (Math.pow(1 + monthlyRate, nper) - 1);
                
                if (Math.abs(calculated - pmt) < tolerance) {
                    return rate * 100;
                }

                if (calculated > pmt) {
                    rate -= step;
                } else {
                    rate += step;
                }
                
                step *= 0.5;
                iteration++;
            }
            
            return rate * 100;
        }

        function calculatePeriod() {
            const rate = parseFloat(document.getElementById('rate').value);
            const principal = parseFloat(document.getElementById('principal').value);
            const payment = parseFloat(document.getElementById('payment').value);
            
            // TODO: Implement period calculation
            updateAllFields();
        }

        function calculateRate() {
            const period = parseFloat(document.getElementById('period').value);
            const principal = parseFloat(document.getElementById('principal').value);
            const payment = parseFloat(document.getElementById('payment').value);
            
            const rate = RATE(period, payment, principal);
            document.getElementById('rate').value = rate.toFixed(2);
            
            updateAllFields();
        }

        function calculatePrincipal() {
            const period = parseFloat(document.getElementById('period').value);
            const rate = parseFloat(document.getElementById('rate').value);
            const payment = parseFloat(document.getElementById('payment').value);
            
            // TODO: Implement principal calculation
            updateAllFields();
        }

        function calculatePayment() {
            const period = parseFloat(document.getElementById('period').value);
            const rate = parseFloat(document.getElementById('rate').value);
            const principal = parseFloat(document.getElementById('principal').value);
            
            const payment = PMT(rate, period, principal);
            document.getElementById('payment').value = payment.toFixed(2);
            
            updateAllFields();
        }

        function updateAllFields() {
            const period = parseFloat(document.getElementById('period').value);
            const rate = parseFloat(document.getElementById('rate').value);
            const principal = parseFloat(document.getElementById('principal').value);
            const payment = parseFloat(document.getElementById('payment').value);

            // Calculate total interest
            const totalInterest = (payment * period) - principal;
            document.getElementById('totalInterest').value = totalInterest.toFixed(2);

            // Calculate tax
            const tax = totalInterest / 21;
            document.getElementById('tax').value = tax.toFixed(2);

            // Calculate after-tax rate
            const afterTaxRate = RATE(period, payment, principal + tax);
            document.getElementById('afterTaxRate').value = afterTaxRate.toFixed(3);

            // Calculate after-commission rate
            calculateAfterCommissionRate();

            // Calculate million interest
            const millionPayment = PMT(rate, 12, 1000000);
            const annualMillionInterest = (millionPayment * 12) - 1000000;
            document.getElementById('annualMillionInterest').value = annualMillionInterest.toFixed(2);
            document.getElementById('monthlyMillionInterest').value = (annualMillionInterest / 12).toFixed(2);

            // Calculate ten thousand interest
            const tenThousandPayment = PMT(rate, 12, 10000);
            const annualTenThousandInterest = (tenThousandPayment * 12) - 10000;
            document.getElementById('annualTenThousandInterest').value = annualTenThousandInterest.toFixed(2);
            document.getElementById('monthlyTenThousandInterest').value = (annualTenThousandInterest / 12).toFixed(2);

            // Calculate spread
            const monthlyCost = parseFloat(document.getElementById('monthlyCost').value);
            const afterCommissionRate = parseFloat(document.getElementById('afterCommissionRate').value);
            document.getElementById('spread').value = (afterCommissionRate - monthlyCost).toFixed(3);

            // Calculate chicken rice bowls
            document.getElementById('chickenRice').value = Math.floor(totalInterest / 35);
        }

        function clearField(fieldId) {
            document.getElementById(fieldId).value = '';
        }
	
		function clearCommission() {
        	document.getElementById('commission').value = '';
        	calculateAfterCommissionRate(); // 清除後重新計算稅佣後利率
    	}

        function adjustPeriod(delta) {
            const periodField = document.getElementById('period');
            const currentValue = parseFloat(periodField.value) || 0;
            periodField.value = currentValue + delta;
            calculatePayment();
        }

        function setPeriod(value) {
            document.getElementById('period').value = value;
            calculatePayment();
        }

        function adjustRate(delta) {
            const rateField = document.getElementById('rate');
            const currentValue = parseFloat(rateField.value) || 0;
            rateField.value = (currentValue + delta).toFixed(2);
            calculatePayment();
        }

        function setRate(value) {
            document.getElementById('rate').value = value;
            calculatePayment();
        }

        function adjustPrincipal(delta) {
            const principalField = document.getElementById('principal');
            const currentValue = parseFloat(principalField.value) || 0;
            principalField.value = currentValue + delta;
            calculatePayment();
        }

        function setCommissionPercentage(percentage) {
            const principal = parseFloat(document.getElementById('principal').value);
            document.getElementById('commission').value = (principal * percentage / 100).toFixed(2);
            calculateAfterCommissionRate();
        }

        function calculateAfterCommissionRate() {
            const period = parseFloat(document.getElementById('period').value);
            const payment = parseFloat(document.getElementById('payment').value);
            const principal = parseFloat(document.getElementById('principal').value);
            const tax = parseFloat(document.getElementById('tax').value);
            const commission = parseFloat(document.getElementById('commission').value) || 0;

            const afterCommissionRate = RATE(period, payment, principal + tax + commission);
            document.getElementById('afterCommissionRate').value = afterCommissionRate.toFixed(3);
            
            // Update spread
            const monthlyCost = parseFloat(document.getElementById('monthlyCost').value);
            document.getElementById('spread').value = (afterCommissionRate - monthlyCost).toFixed(3);
        }
	 function roundPayment(direction, base) {
            const paymentField = document.getElementById('payment');
            let value = parseFloat(paymentField.value) || 0;
            
            if (direction === 'down') {
                value = Math.floor(value / base) * base;
            } else {
                value = Math.ceil(value / base) * base;
            }
            
            paymentField.value = value.toFixed(2);
            calculateRate(); // Recalculate the rate
        }
	function adjustPayment(delta) {
    	const paymentField = document.getElementById('payment');
    	const currentValue = parseFloat(paymentField.value) || 0;
    	paymentField.value = (currentValue + delta).toFixed(2);
    	calculateRate(); // 重新計算利率
		}
	function saveData() {
    const dataToSave = {
        period: document.getElementById('period').value,
        rate: document.getElementById('rate').value,
        principal: document.getElementById('principal').value,
        payment: document.getElementById('payment').value,
        commission: document.getElementById('commission').value
    };
    localStorage.setItem('loanCalculatorData', JSON.stringify(dataToSave));
    alert('資料已暫存！');
}

	function generateQuote() {
		console.log('開始生成報價...'); // 新增偵錯訊息

    // 創建報價表格
    const table = document.createElement('table');
    table.className = 'quote-table';
    
    // 添加表格內容
    const rows = [
        ['報價時間', document.getElementById('currentTime').textContent],
        ['期數', document.getElementById('period').value || ''],
        ['稅前利率', (document.getElementById('rate').value || '') + '%'],
        ['本金', document.getElementById('principal').value || ''],
        ['期繳', document.getElementById('payment').value || ''],
        ['稅後利率', (document.getElementById('afterTaxRate').value || '') + '%'],
        ['佣金', document.getElementById('commission').value || ''],
        ['稅佣後利率', (document.getElementById('afterCommissionRate').value || '') + '%'],
        ['雞肉飯', document.getElementById('chickenRice').value + ' 碗']
    ];

    // 建立表格內容
    rows.forEach(([label, value]) => {
        const tr = table.insertRow();
        tr.insertCell().textContent = label;
        tr.insertCell().textContent = value;
    });

    // 創建臨時容器
    const container = document.createElement('div');
	container.style.padding = '20px';
	container.style.background = '#333333';
	container.style.borderRadius = '12px';
    container.appendChild(table);
    document.body.appendChild(container);

    console.log('準備進行截圖...'); // 新增偵錯訊息

    // 使用 html2canvas 轉換為圖片
    html2canvas(container).then(canvas => {
        console.log('Canvas 已生成'); // 新增偵錯訊息
        
        // 移除臨時容器
        document.body.removeChild(container);

        // 下載圖片
        const link = document.createElement('a');
        link.download = `報價_${document.getElementById('currentTime').textContent.replace(/[^0-9]/g, '')}.png`;
        link.href = canvas.toDataURL();
        console.log('準備下載...'); // 新增偵錯訊息
        link.click();
    }).catch(error => {
        console.error('截圖過程發生錯誤:', error); // 新增錯誤處理
        document.body.removeChild(container); // 確保清理臨時容器
    });
}
    </script>
	<!-- 在 </body> 標籤前添加 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
