<!DOCTYPE html>
<html lang="zh-TW">
<head>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XE5XMQR0Z1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XE5XMQR0Z1');

    // 在檔案開頭的 <script> 標籤內加入
    let titleClickCount = 0;

    function handleTitleClick() {
        titleClickCount++;
        if (titleClickCount >= 3) {
            document.getElementById('ageModal').style.display = 'none';
            checkInstallAvailable();
            titleClickCount = 0; // 重置計數器
        }
    }

    </script>

    <!-- 在 <head> 標籤內添加以下內容 -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#333333">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="雞肉飯">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <meta charset="UTF-8">
	<meta name="viewport" content="width=400, user-scalable=no">

    <!-- 在現有的 meta 標籤下方添加 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>小朋友計算機</title>

    <style>

        /* ============================================
        * CSS 變數定義區域 - 統一管理所有外觀相關變數
        * ============================================ */

        /* 基礎全域變數定義 */
        :root {
            /* ========== 尺寸相關變數 ========== */
            /* 圓角尺寸 */
            --border-radius-sm: 4px;              /* 小型元素圓角（按鈕、輸入框） */
            --border-radius-md: 8px;              /* 中型元素圓角（卡片） */
            --border-radius-lg: 12px;             /* 大型元素圓角（模態框） */
            
            /* 間距尺寸 */
            --spacing-xs: 2px;                    /* 極小間距 */
            --spacing-sm: 4px;                    /* 小間距 */
            --spacing-md: 8px;                    /* 中間距 */
            --spacing-lg: 15px;                   /* 大間距 */
            
            /* 字體大小 */
            --font-size-xs: 12px;                 /* 極小字體（標籤說明） */
            --font-size-sm: 14px;                 /* 小字體（次要文字） */
            --font-size-md: 16px;                 /* 中字體（一般內容） */
            --font-size-lg: 18px;                 /* 大字體（重要內容） */
            --font-size-xl: 22px;                 /* 特大字體（標題） */
            
            /* 特殊元素字體大小 */
            --input-font-size: 16px;              /* 輸入框文字大小 */
            --label-font-size: 16px;              /* 標籤文字大小 */
            
            /* 輸入框特殊設定 */
            --input-padding-lr: 5px;              /* 輸入框左右內邊距 */
            
            /* 動畫時間 */
            --transition-fast: 0.2s;              /* 快速過渡動畫 */
            --transition-normal: 0.3s;            /* 標準過渡動畫 */
            --transition-slow: 0.5s;              /* 慢速過渡動畫 */
            
            /* 陰影效果 */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);    /* 淺層陰影 */
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);    /* 中層陰影 */
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);   /* 深層陰影 */
        }

        /* ========== 主題色彩定義 ========== */
        /* 預設主題：暗夜橘焰 */
        :root {
            /* RGB 色彩值（用於透明度調整） */
            --primary-color-rgb: 51, 51, 51;              /* 主背景色 RGB */
            --secondary-color-rgb: 74, 74, 74;            /* 次背景色 RGB */
            --accent-color-rgb: 255, 156, 51;             /* 強調色 RGB */
            --input-bg-rgb: 34, 34, 34;                   /* 輸入框背景 RGB */
            --error-color-rgb: 231, 76, 60;               /* 錯誤色 RGB */
            --info-color-rgb: 52, 152, 219;               /* 資訊色 RGB */
            
            /* 基本色彩 */
            --primary-color: #333333;                      /* 主要背景色 */
            --secondary-color: #4a4a4a;                    /* 次要背景色 */
            --text-color: #ffffff;                         /* 文字顏色 */
            --text-muted: #999999;                         /* 淡化文字顏色 */
            --border-color: #555555;                       /* 邊框顏色 */
            --hover-color: #666666;                        /* 懸停背景色 */
            --shadow-color: rgba(0, 0, 0, 0.3);           /* 陰影顏色 */
            
            /* 功能色彩 */
            --accent-color: #ff9c33;                       /* 強調色（橘色） */
            --accent-color-light: rgba(255, 156, 51, 0.2); /* 淡強調色 */
            --accent-color-dark: #e88a22;                  /* 深強調色 */
            --success-color: #33b5e5;                      /* 成功色（藍色） */
            --warning-color: #ff9c33;                      /* 警告色（橘色） */
            --error-color: #e74c3c;                        /* 錯誤色（紅色） */
            --info-color: #3498db;                         /* 資訊色（藍色） */
            
            /* 元件專用色彩 */
            --button-primary: #ff9c33;                     /* 主要按鈕色 */
            --button-secondary: #4a4a4a;                   /* 次要按鈕色 */
            --button-orange: #ff9c33;                      /* 橘色按鈕（兼容舊代碼） */
            --button-blue: #33b5e5;                        /* 藍色按鈕（兼容舊代碼） */
            --button-grey: #333333;                        /* 灰色按鈕（兼容舊代碼） */
            
            /* 輸入框色彩 */
            --input-bg: #222222;                           /* 輸入框背景色 */
            --input-border: #555555;                       /* 輸入框邊框色 */
            --input-focus-border: #ff9c33;                 /* 輸入框焦點邊框色 */
            
            /* 其他元件色彩 */
            --card-bg: #333333;                            /* 卡片背景色 */
            --text-highlight: #ff9c33;                     /* 文字強調色 */
            --helper-text-color: #999999;                  /* 輔助文字顏色 */
            --note-text-color: #e0e0e0;                    /* 備註文字顏色 */
            --note-text-empty: #888888;                    /* 空備註提示文字顏色 */
        }

        /* 極簡黑白主題 */
        :root[data-theme="white"] {
            /* RGB 色彩值 */
            --primary-color-rgb: 250, 250, 250;
            --secondary-color-rgb: 255, 255, 255;
            --accent-color-rgb: 85, 85, 85;
            --input-bg-rgb: 255, 255, 255;
            --error-color-rgb: 85, 85, 85;
            --info-color-rgb: 85, 85, 85;
            
            /* 基本色彩 */
            --primary-color: #fafafa;
            --secondary-color: #ffffff;
            --text-color: #222222;
            --text-muted: #777777;
            --border-color: #cccccc;
            --hover-color: #f5f5f5;
            --shadow-color: rgba(0, 0, 0, 0.15);
            
            /* 功能色彩 */
            --accent-color: #555555;
            --accent-color-light: rgba(85, 85, 85, 0.15);
            --accent-color-dark: #333333;
            --success-color: #777777;
            --warning-color: #555555;
            --error-color: #777777;
            --info-color: #555555;
            
            /* 元件色彩 */
            --button-primary: #555555;
            --button-secondary: #e0e0e0;
            --button-orange: #555555;
            --button-blue: #777777;
            --button-grey: #e0e0e0;
            --input-bg: #ffffff;
            --input-border: #aaaaaa;
            --input-focus-border: #555555;
            --card-bg: #ffffff;
            --text-highlight: #333333;
            --helper-text-color: #999999;
            --note-text-color: #333333;
            --note-text-empty: #999999;
            
            background-color: #fafafa;
        }

        /* 櫻花雪主題 */
        :root[data-theme="pink"] {
            /* RGB 色彩值 */
            --primary-color-rgb: 255, 240, 245;
            --secondary-color-rgb: 255, 248, 252;
            --accent-color-rgb: 219, 56, 108;
            --input-bg-rgb: 255, 250, 252;
            --error-color-rgb: 220, 53, 69;
            --info-color-rgb: 255, 182, 193;
            
            /* 基本色彩 */
            --primary-color: #fff0f5;
            --secondary-color: #fff8fc;
            --text-color: #b8306a;
            --text-muted: #d68fa3;
            --border-color: #ffb6c1;
            --hover-color: #ffd1dc;
            --shadow-color: rgba(255, 182, 193, 0.3);
            
            /* 功能色彩 */
            --accent-color: #db386c;
            --accent-color-light: rgba(219, 56, 108, 0.1);
            --accent-color-dark: #b92d59;
            --success-color: #ff69b4;
            --warning-color: #ff9e80;
            --error-color: #dc3545;
            --info-color: #ffb6c1;
            
            /* 元件色彩 */
            --button-primary: #db386c;
            --button-secondary: #fce4ec;
            --button-orange: #db386c;
            --button-blue: #ff69b4;
            --button-grey: #fce4ec;
            --input-bg: #fffafc;
            --input-border: #ffb6c1;
            --input-focus-border: #db386c;
            --card-bg: #fff8fc;
            --text-highlight: #db386c;
            --helper-text-color: #d68fa3;
            --note-text-color: #8b2050;
            --note-text-empty: #d68fa3;
        }

        /* 暗夜烈焰主題 */
        :root[data-theme="red"] {
            /* RGB 色彩值 */
            --primary-color-rgb: 26, 26, 26;
            --secondary-color-rgb: 44, 44, 44;
            --accent-color-rgb: 244, 67, 54;
            --input-bg-rgb: 33, 33, 33;
            --error-color-rgb: 244, 67, 54;
            --info-color-rgb: 33, 150, 243;
            
            /* 基本色彩 */
            --primary-color: #1a1a1a;
            --secondary-color: #2c2c2c;
            --text-color: #ffffff;
            --text-muted: #9e9e9e;
            --border-color: #c62828;
            --hover-color: #3d2828;
            --shadow-color: rgba(198, 40, 40, 0.3);
            
            /* 功能色彩 */
            --accent-color: #f44336;
            --accent-color-light: rgba(244, 67, 54, 0.2);
            --accent-color-dark: #c62828;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --info-color: #2196f3;
            
            /* 元件色彩 */
            --button-primary: #f44336;
            --button-secondary: #424242;
            --button-orange: #f44336;
            --button-blue: #2196f3;
            --button-grey: #424242;
            --input-bg: #212121;
            --input-border: #424242;
            --input-focus-border: #f44336;
            --card-bg: #2c2c2c;
            --text-highlight: #f44336;
            --note-text-color: #ffffff;
            --note-text-empty: #999999;
        }

        /* 暮光星塵主題 */
        :root[data-theme="blue-purple"] {
            /* RGB 色彩值 */
            --primary-color-rgb: 26, 26, 46;
            --secondary-color-rgb: 47, 47, 73;
            --accent-color-rgb: 147, 112, 219;
            --input-bg-rgb: 35, 35, 66;
            --error-color-rgb: 255, 71, 87;
            --info-color-rgb: 0, 206, 201;
            
            /* 基本色彩 */
            --primary-color: #1a1a2e;
            --secondary-color: #2f2f49;
            --text-color: #e6e6ff;
            --text-muted: #a0a0c8;
            --border-color: #7b68ee;
            --hover-color: #3f3f66;
            --shadow-color: rgba(123, 104, 238, 0.3);
            
            /* 功能色彩 */
            --accent-color: #9370db;
            --accent-color-light: rgba(147, 112, 219, 0.2);
            --accent-color-dark: #6a3ece;
            --success-color: #00bfa5;
            --warning-color: #fed330;
            --error-color: #ff4757;
            --info-color: #00cec9;
            
            /* 元件色彩 */
            --button-primary: #9370db;
            --button-secondary: #3d3d64;
            --button-orange: #9370db;
            --button-blue: #00cec9;
            --button-grey: #3d3d64;
            --input-bg: #232342;
            --input-border: #4b4b80;
            --input-focus-border: #9370db;
            --card-bg: #2f2f49;
            --text-highlight: #9370db;
            --note-text-color: #e6e6ff;
            --note-text-empty: #a0a0c8;
        }

        /* 翠玉清風主題 */
        :root[data-theme="green"] {
            /* RGB 色彩值 */
            --primary-color-rgb: 241, 248, 233;
            --secondary-color-rgb: 255, 255, 255;
            --accent-color-rgb: 76, 175, 80;
            --input-bg-rgb: 255, 255, 255;
            --error-color-rgb: 244, 67, 54;
            --info-color-rgb: 33, 150, 243;
            
            /* 基本色彩 */
            --primary-color: #f1f8e9;
            --secondary-color: #ffffff;
            --text-color: #2e7d32;
            --text-muted: #757575;
            --border-color: #81c784;
            --hover-color: #e8f5e9;
            --shadow-color: rgba(129, 199, 132, 0.3);
            
            /* 功能色彩 */
            --accent-color: #4caf50;
            --accent-color-light: rgba(76, 175, 80, 0.2);
            --accent-color-dark: #2e7d32;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --info-color: #2196f3;
            
            /* 元件色彩 */
            --button-primary: #4caf50;
            --button-secondary: #e8f5e9;
            --button-orange: #4caf50;
            --button-blue: #2196f3;
            --button-grey: #e8f5e9;
            --input-bg: #ffffff;
            --input-border: #81c784;
            --input-focus-border: #4caf50;
            --card-bg: #ffffff;
            --text-highlight: #2e7d32;
            --note-text-color: #1b5e20;
            --note-text-empty: #757575;
        }

        /* 科技藍調主題 */
        :root[data-theme="blue"] {
            /* RGB 色彩值 */
            --primary-color-rgb: 26, 38, 57;
            --secondary-color-rgb: 46, 64, 89;
            --accent-color-rgb: 52, 152, 219;
            --input-bg-rgb: 34, 51, 71;
            --error-color-rgb: 231, 76, 60;
            --info-color-rgb: 52, 152, 219;
            
            /* 基本色彩 */
            --primary-color: #1a2639;
            --secondary-color: #2e4059;
            --text-color: #e5e5e5;
            --text-muted: #95a5a6;
            --border-color: #4d8cc4;
            --hover-color: #395981;
            --shadow-color: rgba(77, 140, 196, 0.3);
            
            /* 功能色彩 */
            --accent-color: #3498db;
            --accent-color-light: rgba(52, 152, 219, 0.2);
            --accent-color-dark: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --info-color: #3498db;
            
            /* 元件色彩 */
            --button-primary: #3498db;
            --button-secondary: #34495e;
            --button-orange: #3498db;
            --button-blue: #3498db;
            --button-grey: #34495e;
            --input-bg: #223347;
            --input-border: #4d8cc4;
            --input-focus-border: #3498db;
            --card-bg: #2e4059;
            --text-highlight: #3498db;
            --note-text-color: #e5e5e5;
            --note-text-empty: #95a5a6;
        }

        /* 皇家紫韻主題 */
        :root[data-theme="royal"] {
            /* RGB 色彩值 */
            --primary-color-rgb: 49, 27, 77;
            --secondary-color-rgb: 69, 39, 107;
            --accent-color-rgb: 212, 175, 55;
            --input-bg-rgb: 40, 23, 60;
            --error-color-rgb: 179, 51, 51;
            --info-color-rgb: 66, 133, 244;
            
            /* 基本色彩 */
            --primary-color: #311b4d;
            --secondary-color: #45276b;
            --text-color: #f8f0e3;
            --text-muted: #c0a9e0;
            --border-color: #8a56ac;
            --hover-color: #513082;
            --shadow-color: rgba(49, 27, 77, 0.5);
            
            /* 功能色彩 */
            --accent-color: #d4af37;
            --accent-color-light: rgba(212, 175, 55, 0.2);
            --accent-color-dark: #b8860b;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #b33333;
            --info-color: #4285f4;
            
            /* 元件色彩 */
            --button-primary: #d4af37;
            --button-secondary: #513082;
            --button-orange: #d4af37;
            --button-blue: #4285f4;
            --button-grey: #513082;
            --input-bg: #28173c;
            --input-border: #8a56ac;
            --input-focus-border: #d4af37;
            --card-bg: #45276b;
            --text-highlight: #dfc15e;
            --note-text-color: #f8f0e3;
            --note-text-empty: #c0a9e0;
        }

        /* ============================================
        * 2. 基礎元素樣式
        * ============================================ */

        /* 基本頁面樣式 */
        html, body {
            width: 100%;                          /* 使用100%寬度 */
            max-width: 400px;                     /* 設定最大寬度 */
            margin: 0 auto;                       /* 居中顯示 */
            position: relative;                   /* 相對定位用於子元素絕對定位 */
            overflow-x: hidden;                   /* 防止水平滾動 */
            -webkit-text-size-adjust: 100%;       /* 確保字體大小不自動調整 */
            padding: 0 3px;                       /* 為頁面添加左右間距 */
            background-color: var(--primary-color); /* 使用主題背景色 */
            color: var(--text-color);             /* 使用主題文字色 */
            font-family: "Microsoft JhengHei", Arial, sans-serif; /* 設定字體 */
            box-sizing: border-box;               /* 盒模型計算包含邊框和內邊距 */

            padding-top: 23px;                       /* 為固定header預留空間 */

        }

        /* 頁面標題樣式 */
        h1 {
            color: var(--text-color);             /* 使用主題文字色 */
            font-size: 22px;                      /* 設定字體大小 */
            margin-bottom: 0px;                   /* 移除底部邊距 */
            border-bottom: 2px solid var(--accent-color); /* 底部邊框 */
            padding: 0 24px 5px;                  /* 添加內邊距 */
            position: relative;                   /* 相對定位用於偽元素 */
            transition: all 0.3s ease;            /* 平滑過渡效果 */
        }

        /* 標題懸停效果 */
        h1:hover {
            transform: translateY(-2px);          /* 懸停時稍微上移 */
            text-shadow: 0 2px 4px rgba(255, 156, 51, 0.3); /* 懸停時添加文字陰影 */
        }

        /* 標題底部線條動畫效果 */
        h1::after {
            content: '';                          /* 創建空內容 */
            position: absolute;                   /* 絕對定位 */
            bottom: 0;                            /* 固定在底部 */
            left: 0;                              /* 左邊對齊 */
            width: 100%;                          /* 寬度100% */
            height: 2px;                          /* 高度2px */
            background: var(--accent-color);      /* 使用強調色 */
            transform: scaleX(0);                 /* 初始寬度為0 */
            transform-origin: right;              /* 變換起點為右側 */
            transition: transform 0.6s ease-out;  /* 平滑過渡效果 */
        }

        /* 標題懸停時底部線條動畫 */
        h1:hover::after {
            transform: scaleX(1);                 /* 懸停時寬度擴展至100% */
            transform-origin: left;               /* 變換起點改為左側 */
        }

        /* 標題容器 - 添加獨立的z-index確保正確的層疊關係 */
        /* 標題容器樣式 */
        .header-container {
            text-align: center;                   /* 文字居中 */
            position: fixed;                      /* 固定定位 */
            top: 0;                              /* 貼齊頂部 */
            left: 0;                             /* 貼齊左側 */
            right: 0;                            /* 貼齊右側 */
            margin-bottom: 0px;                   /* 移除底部邊距 */
            z-index: 1100;                       /* 設置更高層級 */
            background-color: var(--primary-color); /* 添加背景色 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* 添加陰影 */
            padding: 1px 0;                      /* 添加上下內邊距 */
        }

        /* 標題樣式 - 確保懸停效果不會影響按鈕 */
        h1 {
            color: var(--text-color);             /* 使用主題文字色 */
            font-size: 22px;                      /* 設定字體大小 */
            margin-bottom: 0px;                   /* 移除底部邊距 */
            border-bottom: 2px solid var(--accent-color); /* 底部邊框 */
            padding-bottom: 5px;                  /* 底部內邊距 */
            position: relative;                   /* 相對定位 */
            z-index: 1;                           /* 設置層級 */
        }

        /* 移除h1懸停時的變形效果，防止影響按鈕 */
        h1:hover {
            text-shadow: 0 2px 4px rgba(255, 156, 51, 0.3);
            /* 移除transform以防止影響按鈕位置 */
        }

        /* 標題下方橙色線條效果 */
        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--button-orange);
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.6s ease-out;
            z-index: 1; /* 確保在h1下方 */
        }

        h1:hover::after {
            transform: scaleX(1);
            transform-origin: left;
        }

        /* 標題按鈕樣式 */
        .header-btn {
            position: absolute;                   /* 絕對定位 */
            top: 50%;                             /* 垂直置中 */
            transform: translateY(-50%);          /* 精確垂直置中 */
            background-color: transparent;        /* 透明背景 */
            color: #666666;                       /* 設置文字顏色 */
            border: none;                         /* 移除邊框 */
            width: 20px;                          /* 設置寬度 */
            height: 20px;                         /* 設置高度 */
            font-size: 14px;                      /* 設置字體大小 */
            display: flex;                        /* 使用flex佈局 */
            align-items: center;                  /* 垂直居中 */
            justify-content: center;              /* 水平居中 */
            cursor: pointer;                      /* 設置游標樣式 */
            z-index: 10;                          /* 確保按鈕在最上層 */
            padding: 0;                           /* 移除內邊距 */
            transition: color 0.2s ease;          /* 平滑過渡效果 */
            outline: none;                        /* 移除點擊輪廓 */
            
            /* 禁止所有變形和動畫 */
            transform: translateY(-50%) !important; /* 強制保持垂直居中 */
            animation: none !important;            /* 禁止動畫 */
            box-shadow: none !important;           /* 禁止陰影 */
        }

        /* 增加按鈕的可點擊區域 */
        .header-btn::before {
            content: '';
            position: absolute;
            top: -15px;
            bottom: -15px;
            left: -15px;
            right: -15px;
        }

        /* 標題按鈕懸停效果 */
        .header-btn:hover {
            color: #999999;                       /* 懸停時改變顏色 */
            /* 禁止任何位置或大小變化 */
            transform: translateY(-50%) !important; /* 強制保持垂直居中 */
        }

        /* 標題按鈕點擊效果 */
        .header-btn:active {
            color: var(--button-orange);          /* 點擊時變為強調色 */
            /* 禁止任何位置或大小變化 */
            transform: translateY(-50%) !important; /* 強制保持垂直居中 */
        }

        /* 左右按鈕位置 */
        .header-btn-left {
            left: 5px;                           /* 左邊按鈕位置 */
        }

        .header-btn-right {
            right: 5px;                          /* 右邊按鈕位置 */
        }

        /* 增加左右按鈕的可點擊區域不同程度 */
        .header-btn-left::before {
            left: -20px;                         /* 左側更大的可點擊區域 */
        }

        .header-btn-right::before {
            right: -20px;                       /* 右側更大的可點擊區域 */
        }

        /* 清除可能影響按鈕的其他樣式規則 */
        .header-btn * {
            transition: none !important;          /* 禁止過渡效果 */
            animation: none !important;           /* 禁止動畫 */
            transform: none !important;           /* 禁止變形 */
        }

        /* 防止全局懸停效果影響按鈕 */
        *:hover .header-btn {
            transform: translateY(-50%) !important; /* 強制保持垂直居中 */
            position: absolute !important;         /* 強制保持絕對定位 */
        }

        /* ============================================
        * 3. 佈局與容器
        * ============================================ */

        /* 行容器樣式 - 用於資料輸入區域 */
        .row {
            margin: 4px 0;
            display: flex;
            align-items: center;
            background: var(--secondary-color);
            padding: 3px;
            border-radius: 4px;
            box-shadow: 0 4px 8px var(--shadow-color);
            /* 移除 transition 以去除動畫效果 */
            position: relative;
            transform-origin: left;
            /* 移除 will-change 因為不再需要動畫優化 */
        }

        /* 行懸停效果 - 移除右移效果，只保留陰影變化 */
        .row:hover {
            /* transform: translateX(5px); 已移除右移效果 */
            box-shadow: 0 6px 12px var(--shadow-color); /* 增強陰影 */
        }

        /* 行懸停時的左側邊框動畫 */
        .row:hover::before {
            content: '';                         /* 創建空內容 */
            position: absolute;                  /* 絕對定位 */
            left: -5px;                          /* 位於左側 */
            top: 50%;                            /* 垂直居中 */
            width: 3px;                          /* 寬度 */
            height: 0;                           /* 初始高度為0 */
            background: var(--button-orange);    /* 使用橙色 */
            animation: expandHeight 0.3s forwards; /* 執行高度擴展動畫 */
        }

        /* 高度擴展動畫 */
        @keyframes expandHeight {
            to {
                height: 100%;                    /* 最終高度為100% */
                top: 0;                          /* 從頂部開始 */
            }
        }

        /* 標籤樣式 */
        .label {
            width: 120px;                        /* 固定寬度 */
            margin-right: 8px;                   /* 右側邊距 - 從15px減少到8px讓標籤更靠近輸入框 */
            text-align: right;                   /* 文字右對齊 */
            font-weight: normal;                 /* 字體粗細 - 改為正常粗細（不是粗體） */
            color: var(--text-color);            /* 文字顏色 */
            position: relative;                  /* 相對定位 */
            overflow: hidden;                    /* 隱藏溢出內容 */
            font-size: var(--label-font-size);   /* 使用變數控制字體大小 */
        }

        /* 輸入框與按鍵的視覺分組 */
        .input-button-group {
            border: 1px solid var(--border-color); /* 添加邊框 */
            border-radius: 8px;                    /* 圓角 */
            margin: 4px 0;                         /* 上下邊距 */
            padding: 1px;                          /* 內邊距 */
            background: var(--secondary-color);    /* 使用次背景色 */
            box-shadow: 0 4px 8px var(--shadow-color); /* 陰影效果 */
            position: relative;                     /* 相對定位 */
            overflow: hidden;                       /* 隱藏溢出內容 */
            transition: all 0.3s ease-in-out;       /* 過渡效果 */
        }

        /* 分組內的行容器 */
        .input-button-group .row {
            background: transparent;              /* 透明背景 */
            box-shadow: none;                     /* 移除陰影 */
            margin: 2px 0;                        /* 上下邊距 */
            padding-top: 1px;                     /* 上部內邊距 */
            padding-bottom: 1px;                  /* 下部內邊距 */
        }

        /* 分組內行容器的懸停效果 */
        .input-button-group .row:hover {
            transform: translateX(2px);            /* 懸停時稍微右移 */
            box-shadow: none;                      /* 無陰影 */
        }

        /* 禁用分組內行容器的左側邊框動畫 */
        .input-button-group .row:hover::before {
            display: none;                         /* 隱藏偽元素 */
        }

        /* 按鍵容器樣式調整 - 已移除動畫效果 */
        .input-button-group div[id$="Buttons"] {
            margin: 0;
            padding-top: 0;
            padding-bottom: 2px;
            border-top: none;
            /* 確保沒有 transition 屬性 */
            max-height: 100px;
            opacity: 1;
        }
        
        /* 當滑鼠懸停在按鍵組上時的效果 */
        .input-button-group div[id$="Buttons"]:hover {
            background-color: rgba(255, 156, 51, 0.05); /* 添加淡橙色背景 */
            border-radius: 4px;                          /* 圓角 */
        }

        /* 隱藏狀態的按鈕組 */
        .input-button-group div[id$="Buttons"] {
            max-height: 0;                         /* 高度為0 */
            opacity: 0;                            /* 完全透明 */
            padding: 0;                            /* 移除內邊距 */
            margin: 0;                             /* 移除邊距 */
            overflow: hidden;                      /* 隱藏溢出內容 */
        }

        /* 時間顯示包裝容器 */
        .time-display-wrapper {
            position: relative;                    /* 相對定位 */
            height: auto;                          /* 自動高度 */
            margin: 3px 0;                         /* 上下邊距 */
            z-index: 1000;                         /* 層級 */
            margin-top: 10px;                      /* 增加頂部邊距 */
        }

        /* 固定頂部的時間顯示 */
        .sticky-header {
            position: -webkit-sticky !important;   /* Safari支持 */
            position: sticky !important;           /* 黏性定位 */
            top: 0;                                /* 貼齊頂部 */
            background: var(--secondary-color);    /* 使用次背景色 */
            padding: 8px;                          /* 內邊距 */
            border-radius: 4px;                    /* 圓角 */
            box-shadow: 0 2px 4px var(--shadow-color); /* 陰影效果 */
            animation: fadeIn 0.8s ease-out;       /* 淡入動畫 */
            transition: all 0.3s ease;             /* 過渡效果 */
            z-index: 999;                          /* 層級 */
            width: calc(100% - 16px);              /* 寬度考慮內邊距 */
            margin: 0 auto;                        /* 居中 */
        }

        /* 固定狀態的樣式 */
        .sticky-header.is-sticky {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); /* 增強陰影 */
            border-radius: 0 0 4px 4px;              /* 只保留底部圓角 */
            transform: translateY(0);                 /* 重置Y軸位置 */
        }

        /* 時間顯示樣式 */
        #timeDisplay {
            margin: 3px 0;                          /* 上下邊距 */
            font-size: 15px;                        /* 字體大小 */
            background: var(--secondary-color);     /* 背景色 */
            color: var(--text-color);               /* 文字顏色 */
            padding: 8px;                           /* 內邊距 */
            border-radius: 4px;                     /* 圓角 */
            box-shadow: 0 2px 4px var(--shadow-color); /* 陰影 */
            animation: fadeIn 0.8s ease-out;        /* 淡入動畫 */
            transition: all 0.3s ease;              /* 過渡效果 */
            position: relative;                     /* 相對定位 */
            overflow: hidden;                       /* 隱藏溢出內容 */
        }

        /* 時間顯示懸停效果 */
        #timeDisplay:hover {
            transform: scale(1.02);                 /* 放大效果 */
            box-shadow: 0 6px 12px var(--shadow-color); /* 增強陰影 */
        }

        /* 時間顯示頂部線條動畫 */
        #timeDisplay::before {
            content: '';                           /* 創建空內容 */
            position: absolute;                    /* 絕對定位 */
            top: 0;                                /* 貼齊頂部 */
            left: -100%;                           /* 初始位置在左外側 */
            width: 100%;                           /* 寬度100% */
            height: 2px;                           /* 高度2px */
            background: linear-gradient(90deg, transparent, var(--accent-color), transparent); /* 漸變背景 */
            animation: timelineSlide 3s linear infinite; /* 滑動動畫 */
        }

        /* 時間線滑動動畫 */
        @keyframes timelineSlide {
            0% { left: -100%; }                   /* 開始時在左外側 */
            100% { left: 100%; }                  /* 結束時在右外側 */
        }

        /* 時間標籤樣式 */
        .time-label {
            font-weight: normal;                     /* 粗體 */
            margin-right: 8px;                    /* 右側邊距 */
            color: var(--accent-color);            /* 使用強調色 */
        }

        /* 淡入動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); } /* 開始時透明且下移 */
            to { opacity: 1; transform: translateY(0); }      /* 結束時不透明且回到原位 */
        }

        /* 1. 流光分隔線 */
        .divider-flow {
            position: relative;                    /* 相對定位 */
            height: 2px;                           /* 高度2px */
            background: linear-gradient(90deg, 
                var(--secondary-color) 0%,
                var(--accent-color) 50%,
                var(--secondary-color) 100%);      /* 漸變背景 */
            margin: 4px 0;                         /* 上下邊距 */
            overflow: hidden;                      /* 隱藏溢出內容 */
            animation: dividerFadeIn 0.5s ease-out; /* 淡入動畫 */
        }

        /* 分隔線流光效果 */
        .divider-flow::after {
            content: '';                           /* 創建空內容 */
            position: absolute;                    /* 絕對定位 */
            top: 0;                                /* 貼齊頂部 */
            left: -100%;                           /* 初始位置在左外側 */
            width: 100%;                           /* 寬度100% */
            height: 100%;                          /* 高度100% */
            background: linear-gradient(90deg,
                transparent,
                var(--accent-color),
                transparent);                      /* 漸變背景 */
            animation: flowLight 3s ease-in-out infinite; /* 流光動畫 */
        }

        /* 流光動畫 */
        @keyframes flowLight {
            0% { transform: translateX(0); }       /* 開始位置 */
            100% { transform: translateX(200%); }  /* 結束位置 */
        }

        /* 分隔線淡入動畫 */
        @keyframes dividerFadeIn {
            from {
                opacity: 0;                        /* 開始時透明 */
                transform: scaleX(0.8);            /* 開始時寬度為80% */
            }
            to {
                opacity: 1;                        /* 結束時不透明 */
                transform: scaleX(1);              /* 結束時寬度為100% */
            }
        }

        /* 輔助說明文字樣式 - 用於欄位右側的說明文字 */
        .helper-text {
            margin-left: 0px;                    /* 左側邊距 */
            color: var(--helper-text-color);     /* 使用變數控制文字顏色 */
            font-size: 16px;                     /* 保持原始字體大小 */
        }

        /* 強調重要欄位 */
        .emphasized-row {
            border-left: 3px solid var(--accent-color); /* 左側邊框 */
            background: linear-gradient(90deg, var(--accent-color-light), transparent); /* 漸變背景 */
            transform: scale(1.01);                /* 稍微放大 */
            transition: all 0.3s ease;             /* 過渡效果 */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* 陰影效果 */
        }

        /* 強調欄位標籤 */
        .emphasized-row .label {
            color: var(--accent-color);           /* 使用強調色 */
            font-weight: 700;                     /* 粗體 */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); /* 文字陰影 */
        }

        /* 強調欄位輸入框 */
        .emphasized-row input {
            font-weight: bold;                    /* 粗體 */
            color: #ffffff;                       /* 白色文字 */
            font-size: 17px;                      /* 字體大小 */
            border-color: var(--accent-color);    /* 使用強調色邊框 */
        }

        /* 強調欄位懸停效果 - 移除右移效果 */
        .emphasized-row:hover {
            transform: scale(1.02); /* 只保留放大效果，移除右移 */
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.25); /* 增強陰影 */
        }

        /* 修正精簡顯示模式下的間距問題 */
        /* 當分隔線被隱藏時，確保不佔用任何空間 */
        .divider-flow.hidden-element {
            display: none !important;     /* 完全不顯示 */
            margin: 0 !important;         /* 移除所有邊距 */
            padding: 0 !important;        /* 移除所有內距 */
            height: 0 !important;         /* 高度設為0 */
        }

        /* 確保行與行之間的間距一致 */
        .row + .row {
            margin-top: 4px;              /* 統一行與行之間的間距 */
        }

        /* 當分隔線被隱藏時，下一個元素不需要額外的頂部間距 */
        .divider-flow + .row {
            margin-top: 4px !important;   /* 保持與其他行相同的間距 */
        }

        /* 頁腳訊息 */
        .footer-message {
            background-color: var(--primary-color); /* 使用主背景色 */
            color: var(--text-color);              /* 使用文字色 */
            padding: 15px;                         /* 內邊距 */
            text-align: center;                    /* 文字居中 */
            margin-top: 15px;                      /* 頂部邊距 */
            border-radius: 4px;                    /* 圓角 */
            transform: scale(1.05);                /* 稍微放大 */
            text-shadow: 0 0 10px var(--accent-color); /* 文字陰影 */
            transition: all 0.3s ease;              /* 過渡效果 */
            position: relative;                     /* 相對定位 */
        }

        /* 頁腳訊息前的emoji */
        .footer-message::before {
            content: '🍚';                         /* 顯示飯emoji */
            margin-right: 8px;                     /* 右側邊距 */
            display: inline-block;                 /* 行內塊顯示 */
            transition: transform 0.3s ease;        /* 過渡效果 */
        }

        /* 頁腳訊息懸停時emoji旋轉效果 */
        .footer-message:hover::before {
            transform: rotate(360deg);             /* 旋轉360度 */
        }

        /* 頁腳間距 */
        .footer-spacing {
            background-color: var(--primary-color); /* 使用主背景色 */
            height: 50px;                          /* 高度 */
            margin-top: 0px;                       /* 頂部邊距 */
        }

        /* ============================================
        * 4. 輸入元素與表單
        * ============================================ */

        /* 輸入框基本樣式 */
        input {
            width: 95px;                           /* 固定寬度 */
            padding: 5px var(--input-padding-lr);  /* 內邊距 - 使用變數控制左右間距 */
            margin-right: 10px;                    /* 右側邊距 */
            background-color: var(--input-bg);     /* 使用主題輸入框背景色 */
            color: var(--text-color);              /* 使用主題文字色 */
            border: 1px solid var(--border-color); /* 邊框 */
            border-radius: 4px;                    /* 圓角 */
            font-size: var(--input-font-size);     /* 使用變數控制字體大小 */
            transition: all 0.3s ease;             /* 過渡效果 */
            text-align: right;                     /* 文字靠右對齊 */
        }

        /* 輸入框聚焦效果 */
        input:focus {
            outline: none;                         /* 移除預設焦點外框 */
            border-color: var(--accent-color);     /* 使用強調色邊框 */
            box-shadow: 0 0 0 3px var(--accent-color-light); /* 添加亮色陰影 */
            transform: scale(1.07);                /* 稍微放大 */
        }

        /* 只讀輸入框樣式 */
        .readonly {
            background-color: var(--input-bg);     /* 使用主題輸入框背景色 */
            animation: breathe 4s ease-in-out infinite; /* 呼吸動畫 */
        }

        /* 呼吸動畫 - 透明度變化 */
        @keyframes breathe {
            0%, 100% { opacity: 1; }              /* 開始和結束時完全不透明 */
            50% { opacity: 0.8; }                 /* 中間時稍微透明 */
        }

        /* 值變化動畫 */
        .value-changed {
            animation: valueChange 0.5s ease-out;  /* 值變化動畫 */
            will-change: background-color;         /* 優化渲染性能 */
        }

        /* 值變化動畫 - 背景色和大小變化 */
        @keyframes valueChange {
            0% { 
                background-color: var(--accent-color-light); /* 初始用強調色 */
                transform: scale(1.02);            /* 稍微放大 */
            }
            100% { 
                background-color: transparent;     /* 恢復透明背景 */
                transform: scale(1);               /* 恢復原始大小 */
            }
        }

        /* 警告文字樣式 */
        .warning-text {
            color: var(--error-color) !important;    /* 使用錯誤色 */
            font-weight: bold !important;            /* 粗體 */
            animation: pulse 1s infinite, shake 0.5s ease-in-out; /* 脈動和震動動畫 */
            will-change: transform;                  /* 優化渲染性能 */
        }

        /* 震動動畫 */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }   /* 開始和結束位置 */
            20%, 60% { transform: translateX(-1px); } /* 向左移動 */
            40%, 80% { transform: translateX(1px); }  /* 向右移動 */
        }

        /* 脈動動畫 - 定義元素的透明度和縮放變化 */
        @keyframes pulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }   /* 開始和結束狀態：輕微透明和原始大小 */
            50% { opacity: 1; transform: scale(1.1); }        /* 中間狀態：完全不透明和放大10% */
        }

        /* 按鈕基本樣式 - 所有基本按鈕的共同樣式 */
        button {
            background-color: var(--secondary-color);    /* 使用次要背景色 */
            color: var(--text-color);                   /* 使用主要文字顏色 */
            border: 1px solid var(--border-color);      /* 使用標準邊框色 */
            padding: 3px 8px;                          /* 內部間距 */
            margin: 0 5px;                             /* 左右外部間距 */
            border-radius: 4px;                        /* 圓角效果 */
            cursor: pointer;                           /* 滑鼠指標變為手型 */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* 平滑過渡效果 */
            font-size: 16px;                           /* 文字大小 */
        }

        /* 按鈕懸停效果 - 鼠標懸停在按鈕上的視覺變化 */
        button:hover {
            background-color: var(--hover-color);      /* 使用懸停背景色 */
            transform: translateY(-2px);               /* 上移2像素 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);  /* 增加陰影效果 */
        }

        /* 按鈕點擊效果 - 點擊按鈕時的視覺反饋 */
        button:active {
            transform: scale(0.95) translateY(1px);    /* 縮小並輕微下移 */
            transition: transform 0.1s;                /* 僅對變形應用快速過渡 */
        }

        /* 行容器中的按鈕樣式 - 調整在行容器內的按鈕外觀 */
        .row button {
            background-color: var(--secondary-color);   /* 使用次要背景色 */
            color: #888888;                            /* 使用暗灰色文字 */
            border: 1px solid #444444;                /* 深色邊框 */
            padding: 3px 8px;                         /* 內部間距 */
            margin: 0 5px;                            /* 左右外部間距 */
            border-radius: 4px;                       /* 圓角效果 */
            cursor: pointer;                          /* 滑鼠指標變為手型 */
            transition: all 0.3s ease;                /* 平滑過渡效果 */
            font-size: 15px;                          /* 文字大小 */
            opacity: 0.8;                             /* 輕微透明效果 */
        }

        /* 特定按鈕組內按鈕的樣式 - 統一各種類型按鈕的顯示 */
        #periodButtons button, 
        #rateButtons button, 
        #principalButtons button, 
        #commissionButtons button, 
        #PaymentduringButtons button,
        #commissionPercentButtons button {
            min-width: 50px;       /* 最小寬度 */
            text-align: center;    /* 文字居中 */
            flex: 1;               /* 平均分配空間 */
            max-width: 80px;       /* 最大寬度限制 */
            margin: 0 2px;         /* 左右外部間距 */
            height: 28px;          /* 固定高度 */
            padding: 0 5px;        /* 內部間距 */
            display: flex;         /* 使用彈性布局 */
            align-items: center;   /* 垂直居中 */
            justify-content: center; /* 水平居中 */
            white-space: nowrap;   /* 防止文字換行 */
            overflow: hidden;      /* 隱藏溢出內容 */
            text-overflow: ellipsis; /* 文字溢出時顯示省略號 */
        }

        /* 針對按鈕數量多的兩個組別進行特殊調整 - 確保布局美觀 */
        #periodButtons button, 
        #rateButtons button {
            min-width: 35px;      /* 減小最小寬度 */
            max-width: 50px;      /* 減小最大寬度 */
            padding: 0 3px;       /* 減小內部間距 */
            font-size: 15px;      /* 稍微減小字體大小 */
        }

        /* 減小這兩個按鈕組的按鈕間距 - 使更多按鈕能適應寬度 */
        #periodButtons, 
        #rateButtons {
            gap: 2px;             /* 減小按鈕之間的間距 */
        }

        /* 行容器中按鈕的懸停效果 - 提供視覺反饋 */
        .row button:hover {
            background-color: #4a4a4a; /* 稍微亮一點的灰色 */
            color: #cccccc;           /* 亮一點的文字顏色 */
            border-color: #555555;    /* 亮一點的邊框顏色 */
            opacity: 0.9;             /* 提高不透明度 */
        }

        /* 行容器中按鈕的點擊效果 - 點擊時的視覺反饋 */
        .row button:active {
            background-color: var(--secondary-color);  /* 恢復原本背景顏色 */
            color: var(--text-color);                 /* 恢復原本文字顏色 */
            border-color: var(--button-grey);         /* 使用灰色按鈕邊框 */
        }

        /* 行容器中按鈕點擊後的波紋效果 - 創建點擊漣漪效果 */
        .row button::after {
            content: '';                             /* 創建空內容 */
            position: absolute;                      /* 絕對定位 */
            top: 50%;                               /* 從中間開始 */
            left: 50%;                              /* 從中間開始 */
            width: 0;                               /* 初始寬度為0 */
            height: 0;                              /* 初始高度為0 */
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%); /* 漸變背景 */
            transition: width 0.3s ease-out, height 0.3s ease-out; /* 平滑過渡效果 */
            transform: translate(-50%, -50%);       /* 確保居中 */
            border-radius: 50%;                     /* 圓形效果 */
        }

        /* 行容器中按鈕點擊時的波紋動畫 - 擴展漣漪效果 */
        .row button:active::after {
            width: 150px;                          /* 擴展寬度 */
            height: 150px;                         /* 擴展高度 */
        }

        /* 將組內的按鍵輕微突出顯示 - 增加視覺層次感 */
        .input-button-group div[id$="Buttons"] button {
            position: relative;                    /* 相對定位 */
            z-index: 2;                           /* 提高層級 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15); /* 輕微陰影 */
        }

        /* 改進按鍵點擊反饋 - 提供更明顯的點擊視覺效果 */
        .input-button-group div[id$="Buttons"] button:active {
            transform: scale(0.95);               /* 縮小效果 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); /* 減小陰影 */
            transition: transform 0.1s, box-shadow 0.1s; /* 快速過渡效果 */
        }

        /* 添加輕微的懸停效果 - 鼠標懸停時的邊框變化 */
        .input-button-group div[id$="Buttons"] button:hover {
            border-color: var(--button-orange);   /* 使用橙色邊框 */
        }

        /* 特定ID結尾的按鈕組樣式 - 為這些按鈕組設置統一樣式 */
        div[id$="Buttons"] button {
            background-color: var(--secondary-color); /* 使用次要背景色 */
            color: #bcbcbc;                         /* 亮灰色文字 */
            border: 1px solid var(--button-orange);  /* 使用橙色外框 */
            padding: 4px 9px;                       /* 內部間距 */
            margin: 0 4px;                          /* 左右外部間距 */
            border-radius: 4px;                     /* 圓角效果 */
            cursor: pointer;                        /* 滑鼠指標變為手型 */
            transition: all 0.3s ease;              /* 平滑過渡效果 */
            font-size: 15px;                        /* 文字大小 */
            opacity: 0.95;                          /* 較高不透明度 */
        }

        /* 特定ID結尾的按鈕組懸停效果 - 鼠標懸停時的視覺變化 */
        div[id$="Buttons"] button:hover {
            background-color: rgba(255, 156, 51, 0.15); /* 淡橘色背景 */
            color: #ffffff;                           /* 白色文字 */
            border-color: var(--button-orange);       /* 橙色邊框 */
            transform: translateY(-1px);              /* 輕微上移 */
            box-shadow: 0 2px 4px rgba(255, 156, 51, 0.2); /* 橙色陰影 */
        }

        /* 特定ID結尾的按鈕組點擊效果 - 點擊時的視覺反饋 */
        div[id$="Buttons"] button:active {
            transform: translateY(1px);              /* 輕微下移 */
            background-color: rgba(255, 156, 51, 0.3); /* 較深橙色背景 */
            box-shadow: 0 0 5px rgba(255, 156, 51, 0.5) inset; /* 內陰影效果 */
            transition: all 0.1s ease;               /* 快速過渡效果 */
        }

        /* 添加滚动时的效果 - 頭部固定區域樣式 */
        .sticky-header.is-sticky {
            border-radius: 0 0 4px 4px;              /* 底部圓角 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); /* 增強陰影 */
            transform: translateY(0);                /* 重置Y軸位置 */
        }

        /* 各種按鈕組的布局 - 創建彈性布局容器 */
        #periodButtons, #rateButtons, #principalButtons, #commissionButtons, #PaymentduringButtons, #commissionPercentButtons {
            margin: 0;                              /* 移除外部間距 */
            display: flex;                          /* 使用彈性布局 */
            flex-wrap: wrap;                        /* 允許換行 */
            gap: 3px;                               /* 項目間距 */
            width: 100%;                            /* 占滿容器寬度 */
            justify-content: center;                /* 水平居中 */
            padding: 0 5px;                         /* 左右內部間距 */
            box-sizing: border-box;                 /* 盒模型計算方式 */
            min-height: 32px;                       /* 最小高度 */
            align-items: center;                    /* 垂直居中 */
        }

        /* 按鈕基本特性 - 防止按鈕在彈性布局中被拉伸 */
        button {
            flex-shrink: 0;                         /* 禁止按鈕縮小 */
        }

        /* 新的按鈕組樣式 - 功能按鈕組的容器 */
        .function-buttons {
            display: flex;                          /* 使用彈性布局 */
            flex-direction: column;                 /* 垂直排列 */
            gap: 4px;                               /* 項目間距 */
            margin: 4px 0;                          /* 上下外部間距 */
            padding: 0;                             /* 移除內部間距 */
            width: 100%;                            /* 占滿容器寬度 */
        }

        /* 功能按鈕行容器 - 水平排列的按鈕 */
        .function-buttons .button-row {
            display: flex;                          /* 使用彈性布局 */
            justify-content: space-between;         /* 兩端對齊 */
            gap: 4px;                               /* 減小按鈕間距 */
            width: 100%;                            /* 占滿容器寬度 */
        }

        /* 調整頂部按鈕組 - 頂部功能按鈕的布局 */
        .top-buttons .button-row button {
            flex: 1;                                /* 平均分配空間 */
            min-width: 0;                           /* 允許按鈕變窄 */
        }

        /* 調整底部按鈕組 - 底部功能按鈕的布局 */
        .bottom-buttons .button-row button {
            flex: 1;                                /* 平均分配空間 */
            min-width: 0;                           /* 允許按鈕變窄 */
        }

        /* 功能按鈕上下行樣式 - 確保統一布局 */
        .function-buttons .top-row,
        .function-buttons .bottom-row {
            display: flex;                          /* 使用彈性布局 */
            justify-content: space-between;         /* 兩端對齊 */
            gap: 10px;                              /* 項目間距 */
        }

        /* 頂部行按鈕樣式 - 確保按鈕平均分布 */
        .function-buttons .top-row button {
            flex: 1;                                /* 平均分配空間 */
            min-width: 0;                           /* 允許按鈕變窄 */
            margin: 0;                              /* 移除外部間距 */
        }

        /* 底部行按鈕樣式 - 確保按鈕平均分布 */
        .function-buttons .bottom-row button {
            flex: 1;                                /* 平均分配空間 */
            min-width: 0;                           /* 允許按鈕變窄 */
            margin: 0;                              /* 移除外部間距 */
        }

        /* 統一所有功能按鈕的基礎樣式 - 創建視覺一致的按鈕 */
        .function-buttons button {
            background-color: var(--secondary-color); /* 使用次要背景色 */
            color: #ffffff;                         /* 白色文字 */
            border: 1px solid var(--button-orange);  /* 橙色邊框 */
            border-radius: 6px;                     /* 圓角效果 */
            padding: 8px 0;                         /* 上下內部間距 */
            font-size: 16px;                        /* 文字大小 */
            font-weight: 600;                       /* 文字粗細 */
            cursor: pointer;                        /* 滑鼠指標變為手型 */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* 平滑過渡效果 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* 陰影效果 */
            text-align: center;                     /* 文字居中 */
            position: relative;                     /* 相對定位 */
            overflow: hidden;                      /* 隱藏溢出內容 */
            flex: 1;                                /* 平均分配空間 */
            min-width: 0;                           /* 允許按鈕變窄 */
            margin: 0;                              /* 移除外部間距 */
        }

        /* 功能按鈕偽元素 - 創建懸停時的漸變效果 */
        .function-buttons button::before {
            content: '';                            /* 創建空內容 */
            position: absolute;                     /* 絕對定位 */
            top: 0;                                /* 從頂部開始 */
            left: 0;                               /* 從左側開始 */
            width: 100%;                           /* 寬度100% */
            height: 100%;                          /* 高度100% */
            background: linear-gradient(to right, rgba(255, 156, 51, 0.1), transparent); /* 漸變背景 */
            z-index: -1;                           /* 置於按鈕下層 */
            transform: translateX(-100%);          /* 初始位置在左側外 */
            transition: transform 0.6s ease;       /* 平滑過渡效果 */
        }

        /* 統一所有按鈕的懸停效果 - 鼠標懸停時的視覺變化 */
        .function-buttons button:hover {
            background-color: var(--button-orange); /* 橙色背景 */
            color: #ffffff;                        /* 白色文字 */
            transform: translateY(-2px);           /* 上移效果 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* 增強陰影 */
        }

        /* 功能按鈕懸停時偽元素效果 - 顯示滑入效果 */
        .function-buttons button:hover::before {
            transform: translateX(0);              /* 滑入至可見區域 */
        }

        /* 統一所有按鈕的點擊效果 - 按下時的視覺反饋 */
        .function-buttons button:active {
            transform: translateY(1px);            /* 下移效果 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); /* 減弱陰影 */
            transition: all 0.1s;                  /* 快速過渡效果 */
        }

        /* 主要操作按鈕樣式 - 與一般功能按鈕一致 */
        .function-buttons .main-action-btn {
            background-color: var(--secondary-color); /* 使用次要背景色 */
            color: #ffffff;                        /* 白色文字 */
            padding: 8px 0;                        /* 上下內部間距 */
            border: 1px solid var(--button-orange); /* 橙色邊框 */
        }

        /* 主要操作按鈕偽元素 - 降低漸變亮度 */
        .function-buttons .main-action-btn::before {
            background: linear-gradient(to right, rgba(255, 255, 255, 0.05), transparent); /* 較淡的漸變 */
        }

        /* 主要操作按鈕懸停效果 - 更明顯的懸停樣式 */
        .function-buttons .main-action-btn:hover {
            background-color: var(--button-orange); /* 橙色背景 */
            box-shadow: 0 7px 14px rgba(255, 156, 51, 0.4); /* 橙色陰影 */
            transform: translateY(-3px);           /* 更明顯的上移 */
        }

        /* 主要操作按鈕點擊效果 - 按下時的視覺反饋 */
        .function-buttons .main-action-btn:active {
            transform: translateY(1px);            /* 下移效果 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 輕微陰影 */
        }

        /* 報價表格樣式 - 顯示計算結果的表格 */
        .quote-table {
            width: 100%;                           /* 占滿容器寬度 */
            border-collapse: separate;             /* 分離邊框模型 */
            border-spacing: 0;                     /* 單元格間距 */
            margin: 10px 0;                        /* 上下外部間距 */
            background: var(--primary-color);      /* 使用主背景色 */
            border-radius: 12px;                   /* 圓角效果 */
            overflow: hidden;                      /* 隱藏溢出內容 */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4); /* 深色陰影 */
        }

        /* 報價表格行樣式 - 表格行的背景與過渡效果 */
        .quote-table tr {
            background: var(--secondary-color);    /* 使用次要背景色 */
            transition: background-color 0.3s ease; /* 背景色過渡效果 */
        }

        /* 報價表格行懸停效果 - 鼠標懸停時的背景變化 */
        .quote-table tr:hover {
            background: var(--hover-color);        /* 使用懸停背景色 */
        }

        /* 報價表格單元格樣式 - 調整單元格內部間距與外觀 */
        .quote-table td {
            padding: 10px 10px;                    /* 內部間距 */
            border-bottom: 1px solid var(--border-color); /* 底部邊框 */
            color: var(--text-color);              /* 使用文字顏色 */
            font-size: 16px;                       /* 文字大小 */
            line-height: 1.2;                      /* 行高 */
        }

        /* 報價表格第一列單元格樣式 - 標籤列的格式 */
        .quote-table td:first-child {
            width: 140px;                          /* 固定寬度 */
            white-space: nowrap;                   /* 禁止換行 */
            color: var(--button-orange);           /* 橙色文字 */
            font-weight: 700;                      /* 文字粗細 */
            text-align: right;                     /* 文字右對齊 */
            padding-right: 10px;                   /* 右側內部間距 */
            font-size: 16px;                       /* 文字大小 */
        }

        /* 報價表格最後一列單元格樣式 - 數值列的格式 */
        .quote-table td:last-child {
            text-align: right;                     /* 文字右對齊 */
            font-family: monospace;                /* 等寬字體 */
            font-size: 16px;                       /* 文字大小 */
            letter-spacing: 0px;                   /* 字符間距 */
        }

        /* 報價容器樣式 - 包含報價表格的容器 */
        #quoteContainer {
            padding: 24px;                         /* 內部間距 */
            background: #333333;                   /* 深灰背景 */
            border-radius: 16px;                   /* 圓角效果 */
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.5); /* 深色陰影 */
            margin: 20px;                          /* 外部間距 */
        }

        /* 功能按鈕偽元素 - 創建發光邊框效果 */
        .function-buttons button::before {
            content: '';                           /* 創建空內容 */
            position: absolute;                    /* 絕對定位 */
            top: -2px;                            /* 向上延伸 */
            left: -2px;                           /* 向左延伸 */
            right: -2px;                          /* 向右延伸 */
            bottom: -2px;                         /* 向下延伸 */
            background: var(--button-orange);      /* 橙色背景 */
            z-index: -1;                          /* 置於按鈕下層 */
            border-radius: 6px;                   /* 圓角效果 */
            opacity: 0;                           /* 初始透明 */
            transition: opacity 0.3s;             /* 透明度過渡效果 */
        }

        /* 功能按鈕懸停時偽元素效果 - 顯示脈動發光 */
        .function-buttons button:hover::before {
            opacity: 0.2;                         /* 半透明效果 */
            animation: pulseGlow 1.5s infinite;   /* 脈動發光動畫 */
        }

        /* 脈動發光動畫 - 定義按鈕背景的脈動效果 */
        @keyframes pulseGlow {
            0% { transform: scale(1); opacity: 0.2; }     /* 初始狀態 */
            50% { transform: scale(1.05); opacity: 0.3; } /* 放大並增加不透明度 */
            100% { transform: scale(1); opacity: 0.2; }   /* 返回初始狀態 */
        }

        /* 功能按鈕點擊後效果 - 創建點擊波紋效果 */
        .function-buttons button::after {
            content: '';                          /* 創建空內容 */
            position: absolute;                   /* 絕對定位 */
            top: 50%;                            /* 從中心開始 */
            left: 50%;                           /* 從中心開始 */
            width: 100%;                         /* 初始寬度 */
            height: 100%;                        /* 初始高度 */
            background: rgba(255, 255, 255, 0.1); /* 白色半透明背景 */
            transform: translate(-50%, -50%) scale(0); /* 初始縮放為0 */
            border-radius: 50%;                  /* 圓形效果 */
            transition: transform 0.5s;          /* 變形過渡效果 */
        }

        /* 功能按鈕懸停效果 - 改變按鈕顏色和文字 */
        .function-buttons button:hover {
            background-color: var(--button-orange); /* 橙色背景 */
            color: var(--text-color);               /* 使用主要文字顏色 */
            border-color: var(--button-orange);     /* 橙色邊框 */
        }

        /* 功能按鈕懸停時後效果的動畫 - 擴大波紋效果 */
        .function-buttons button:hover::after {
            transform: translate(-50%, -50%) scale(2); /* 放大波紋至2倍 */
        }

        /* 功能按鈕點擊效果 - 點擊時的顏色變化 */
        .function-buttons button:active {
            background-color: var(--secondary-color); /* 恢復次要背景色 */
            color: var(--button-orange);             /* 橙色文字 */
            border-color: var(--button-orange);      /* 橙色邊框 */
        }

        /* 發光邊框動畫 - 創建脈動的發光邊框效果 */
        @keyframes glowBorder {
            0%, 100% { box-shadow: 0 0 5px var(--accent-color); }        /* 初始和結束狀態的陰影 */
            50% { box-shadow: 0 0 15px var(--accent-color), 0 0 30px rgba(var(--accent-color-rgb), 0.3); } /* 中間狀態的增強陰影 */
        }

        /* 發光效果動畫 - 控制分隔線中的流光效果 */
        @keyframes dividerGlow {
            0% {
                left: -100%;      /* 開始在左側外部 */
            }
            50% {
                left: 100%;       /* 中間移動到右側 */
            }
            100% {
                left: 100%;       /* 結束於右側 */
            }
        }

        /* 歷史記錄面板樣式 - 顯示保存的貸款記錄 */
        .history-panel {
            display: none;                                        /* 初始隱藏 */
            position: fixed;                                      /* 固定定位 */
            top: 0;                                              /* 貼齊頂部 */
            left: 0;                                             /* 貼齊左側 */
            width: 100%;                                         /* 寬度100% */
            height: 100%;                                        /* 高度100% */
            background-color: rgba(var(--primary-color-rgb), 0.95); /* 半透明背景 */
            z-index: 1200;                                       /* 提高層級，高於header */
            overflow-y: auto;                                    /* 垂直滾動 */
            animation: fadeIn 0.3s ease-out;                     /* 淡入動畫 */
            padding-top: 0;                                      /* 移除頂部內邊距 */
        }

        /* 歷史記錄面板頭部樣式 - 包含標題和按鈕的頂部區域 */
        .history-header {
            display: flex;                                       /* 彈性布局 */
            justify-content: space-between;                      /* 兩端對齊 */
            align-items: center;                                 /* 垂直居中 */
            padding: 15px;                                       /* 內部間距 */
            background-color: var(--primary-color);              /* 主背景色 */
            position: sticky;                                    /* 粘性定位 */
            top: 0;                                             /* 貼齊頂部 */
            z-index: 1201;                                      /* 提高層級 */
            border-bottom: 2px solid var(--accent-color);        /* 底部邊框 */
            box-shadow: 0 2px 10px var(--shadow_color);          /* 陰影效果 */
            margin-top: 0;                                       /* 確保貼齊頂部 */
        }

        /* 歷史記錄面板頭部左側區域 - 用於標題 */
        .header-left {
            flex: 1;                                            /* 佔用剩餘空間 */
        }

        /* 歷史記錄面板頭部右側區域 - 用於功能按鈕 */
        .header-right {
            margin-right: 10px;                                 /* 右側外部間距 */
        }

        /* 歷史記錄面板標題樣式 - 頂部標題文字 */
        .history-header h2 {
            margin: 0;                                          /* 移除外部間距 */
            color: var(--accent-color);                         /* 強調色文字 */
            font-size: 20px;                                    /* 文字大小 */
            text-shadow: 0 1px 2px var(--shadow-color);         /* 文字陰影 */
        }

        /* 關閉按鈕樣式 - 用於關閉模態框 */
        .close-btn {
            background: none;                                   /* 無背景 */
            border: none;                                       /* 無邊框 */
            color: var(--text-color);                           /* 文字顏色 */
            font-size: 28px;                                    /* 文字大小 */
            cursor: pointer;                                    /* 滑鼠指標變為手型 */
            transition: color 0.3s ease;                        /* 只過渡顏色 */
            padding: 0;                                         /* 移除內部間距 */
            margin-left: 10px;                                  /* 左側外部間距 */
            line-height: 1;                                     /* 行高設為1 */
            width: auto;                                        /* 自動寬度 */
            height: auto;                                       /* 自動高度 */
        }

        /* 關閉按鈕懸停效果 - 鼠標懸停時的視覺變化 */
        .close-btn:hover {
            color: var(--accent-color);                         /* 強調色文字 */
        }

        /* 歷史記錄內容區域 - 顯示歷史記錄列表的容器 */
        .history-content {
            padding: 8px;                                       /* 內部間距 */
            max-width: 400px;                                   /* 最大寬度 */
            margin: 0 auto;                                     /* 水平居中 */
            padding-top: 20px;                                  /* 增加頂部間距 */
        }

        /* 歷史記錄列表樣式 - 所有歷史記錄項目的容器 */
        .history-list {
            display: flex;                                      /* 彈性布局 */
            flex-direction: column;                             /* 垂直排列 */
            gap: 10px;                                          /* 項目間距 */
            padding: 3px;                                       /* 內部間距 */
            margin-bottom: 10px;                                /* 底部外部間距 */
        }

        /* 歷史記錄項目樣式 - 單個歷史記錄的卡片 */
        .history-item {
            background-color: var(--secondary-color);           /* 次要背景色 */
            padding: 8px;                                       /* 內部間距 */
            border-radius: 8px;                                 /* 圓角效果 */
            position: relative;                                 /* 相對定位 */
            transition: all 0.3s ease;                          /* 過渡效果 */
            border-left: 3px solid var(--accent-color);         /* 左側邊框 */
            display: flex;                                      /* 彈性布局 */
            flex-direction: column;                             /* 垂直排列 */
            gap: 6px;                                           /* 項目間距 */
            box-shadow: 0 2px 4px var(--shadow-color);          /* 陰影效果 */
            margin-bottom: 10px;                                /* 底部外部間距 */
        }

        /* 歷史記錄項目懸停效果 - 移除右移效果 */
        .history-item:hover {
            /* transform: translateX(5px); 已移除右移效果 */
            box-shadow: 0 5px 15px var(--shadow-color);         /* 增強陰影 */
        }

        /* 歷史記錄項目頭部區域 - 顯示日期和稅佣後利率 */
        .history-item-header {
            display: flex;                                      /* 彈性布局 */
            justify-content: space-between;                     /* 兩端對齊 */
            align-items: center;                                /* 垂直居中 */
            width: 100%;                                        /* 寬度100% */
            padding-bottom: 2px;                                /* 底部內部間距 */
        }

        /* 歷史記錄日期樣式 - 顯示記錄保存的日期 */
        .history-date {
            font-weight: normal;                                  /* 文字粗細 */
            color: var(--accent-color);                         /* 強調色文字 */
            font-size: 14px;                                    /* 文字大小 */
            padding: 2px 0;                                     /* 上下內部間距 */
            margin-left: 5px;                                   /* 添加左側間距，進一步分隔勾選框和日期 */
        }

        /* 稅佣後利率樣式 - 在歷史記錄頭部顯示的利率 */
        .history-header-rate {
            font-weight: bold;                                  /* 文字粗細 */
            color: var(--text-color);                           /* 文字顏色 */
            font-size: 16px;                                    /* 文字大小 */
            background-color: var(--accent-color-light);        /* 淡色強調背景 */
            padding: 2px 6px;                                   /* 內部間距 */
            border-radius: 4px;                                 /* 圓角效果 */
        }

        /* 歷史詳情顯示區 - 顯示貸款參數的網格布局 */
        .history-details {
            display: grid;                                      /* 網格布局 */
            grid-template-columns: repeat(2, 1fr);              /* 兩列等寬 */
            gap: 6px;                                           /* 網格間距 */
            background-color: rgba(var(--primary-color-rgb), 0.15); /* 半透明背景 */
            padding: 6px;                                       /* 內部間距 */
            border-radius: 4px;                                 /* 圓角效果 */
        }

        /* 歷史詳情項目樣式 - 單個參數的顯示 */
        .history-detail-item {
            display: flex;                                      /* 彈性布局 */
            flex-direction: column;                             /* 垂直排列 */
            gap: 1px;                                           /* 項目間距 */
        }

        /* 詳情標籤樣式 - 參數名稱的顯示 */
        .detail-label {
            font-size: 12px;                                    /* 文字大小 */
            color: var(--text-muted);                           /* 淡色文字 */
        }

        /* 詳情數值樣式 - 參數值的顯示 */
        .detail-value {
            font-size: 18px;                                    /* 文字大小 */
            font-weight: bold;                                  /* 文字粗細 */
            color: var(--text-color);                           /* 文字顏色 */
            line-height: 1.2;                                   /* 行高 */
        }

        /* 移動設備適配 - 調整小屏幕下的顯示效果 */
        @media screen and (max-width: 360px) {
            .history-item {
                padding: 6px;                                   /* 減少內部間距 */
                gap: 4px;                                       /* 減少項目間距 */
            }
            
            .history-header-rate {
                font-size: 13px;                                /* 減小文字大小 */
                padding: 2px 5px;                               /* 減少內部間距 */
            }
            
            .history-date {
                font-size: 13px;                                /* 減小文字大小 */
            }
            
            .detail-value {
                font-size: 15px;                                /* 減小文字大小 */
            }
            
            .history-details {
                padding: 5px;                                   /* 減少內部間距 */
                gap: 5px;                                       /* 減少網格間距 */
            }
            
            .delete-btn, .detail-btn {
                padding: 5px 10px;                              /* 減少按鈕內部間距 */
                font-size: 12px;                                /* 減小按鈕文字大小 */
                min-width: 65px;                                /* 設置最小寬度 */
            }
        }

        /* 按鈕區域 - 歷史記錄項目底部的操作按鈕 */
        .history-actions {
            display: flex;                                      /* 彈性布局 */
            justify-content: flex-end;                          /* 右對齊 */
            gap: 8px;                                           /* 按鈕間距 */
            margin-top: 3px;                                    /* 頂部外部間距 */
        }

        /* 刪除按鈕和詳情按鈕共用樣式 - 操作按鈕的基本樣式 */
        .delete-btn, .detail-btn {
            padding: 6px 12px;                                  /* 內部間距 */
            border-radius: 4px;                                 /* 圓角效果 */
            font-size: 13px;                                    /* 文字大小 */
            font-weight: bold;                                  /* 文字粗細 */
            transition: all 0.25s ease;                         /* 過渡效果 */
            display: flex;                                      /* 彈性布局 */
            align-items: center;                                /* 垂直居中 */
            justify-content: center;                            /* 水平居中 */
            border: none;                                       /* 無邊框 */
            min-width: 70px;                                    /* 最小寬度 */
        }

        /* 刪除按鈕樣式 - 用紅色系表示刪除操作 */
        .delete-btn {
            background-color: rgba(var(--error-color-rgb), 0.15); /* 更淡的半透明紅色背景 */
            color: var(--text-muted);                            /* 使用淡色文字 */
            border: 1px solid rgba(var(--error-color-rgb), 0.3); /* 更淡的紅色邊框 */
            opacity: 0.7;                                        /* 降低透明度 */
            transform: scale(0.9);                               /* 縮小按鈕 */
        }

        /* 刪除按鈕懸停效果 - 鼠標懸停時的視覺變化 */
        .delete-btn:hover {
            background-color: var(--error-color);               /* 錯誤色背景 */
            color: white;                                       /* 白色文字 */
            transform: translateY(-2px);                        /* 上移效果 */
            box-shadow: 0 3px 5px rgba(var(--error-color-rgb), 0.4); /* 紅色陰影 */
        }

        /* 刪除按鈕點擊效果 - 點擊時的視覺反饋 */
        .delete-btn:active {
            transform: translateY(1px);                         /* 下移效果 */
        }

        /* 詳情按鈕樣式 - 用藍色系表示信息操作 */
        .detail-btn {
            background-color: rgba(var(--info-color-rgb), 0.25); /* 半透明藍色背景 */
            color: var(--text-color);                          /* 文字顏色 */
            border: 1px solid rgba(var(--info-color-rgb), 0.5); /* 藍色邊框 */
        }

        /* 詳情按鈕懸停效果 - 鼠標懸停時的視覺變化 */
        .detail-btn:hover {
            background-color: var(--info-color);               /* 信息色背景 */
            color: white;                                      /* 白色文字 */
            transform: translateY(-2px);                       /* 上移效果 */
            box-shadow: 0 3px 5px rgba(var(--info-color-rgb), 0.4); /* 藍色陰影 */
        }

        /* 詳情按鈕點擊效果 - 點擊時的視覺反饋 */
        .detail-btn:active {
            transform: translateY(1px);                        /* 下移效果 */
        }

        /* 無數據提示樣式 - 當沒有歷史記錄時顯示 */
        .no-data {
            text-align: center;                                /* 文字居中 */
            color: var(--text-muted);                          /* 淡色文字 */
            font-style: italic;                                /* 斜體文字 */
            padding: 30px 0;                                   /* 上下內部間距 */
            font-size: 16px;                                   /* 文字大小 */
        }

        /* 全部刪除按鈕改進 - 刪除所有歷史記錄的按鈕 */
        .delete-all-btn {
            background: rgba(var(--error-color-rgb), 0.15);    /* 淡紅色背景 */
            border: 1px solid var(--error-color);             /* 紅色邊框 */
            color: var(--error-color);                        /* 紅色文字 */
            font-size: 14px;                                  /* 文字大小 */
            padding: 6px 14px;                                /* 內部間距 */
            border-radius: 6px;                               /* 圓角效果 */
            cursor: pointer;                                  /* 滑鼠指標變為手型 */
            transition: all 0.3s ease;                        /* 過渡效果 */
            font-weight: bold;                                /* 文字粗細 */
        }

        /* 全部刪除按鈕懸停效果 - 鼠標懸停時的視覺變化 */
        .delete-all-btn:hover {
            background-color: var(--error-color);             /* 紅色背景 */
            color: white;                                     /* 白色文字 */
            transform: translateY(-2px);                      /* 上移效果 */
            box-shadow: 0 3px 5px rgba(var(--error-color-rgb), 0.4); /* 紅色陰影 */
        }

        /* 全部刪除按鈕點擊效果 - 點擊時的視覺反饋 */
        .delete-all-btn:active {
            transform: translateY(1px);                       /* 下移效果 */
            box-shadow: none;                                 /* 移除陰影 */
        }

        /* 同步按鈕樣式 */
        .sync-btn {
            background: rgba(var(--info-color-rgb), 0.15);
            border: 1px solid var(--info-color);
            color: var(--info-color);
            font-size: 14px;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            margin-right: 10px;
        }

        .sync-btn:hover {
            background-color: var(--info-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(var(--info-color-rgb), 0.4);
        }

        .sync-btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        /* 模態框背景樣式 - 覆蓋整個頁面的半透明背景 */
        .modal-overlay {
            display: none;                                    /* 初始隱藏 */
            position: fixed;                                  /* 固定定位 */
            top: 0;                                          /* 貼齊頂部 */
            left: 0;                                         /* 貼齊左側 */
            width: 100%;                                     /* 寬度100% */
            height: 100%;                                    /* 高度100% */
            background-color: rgba(var(--primary-color-rgb), 0.7); /* 半透明背景 */
            z-index: 2000;                                   /* 層級 */
            justify-content: center;                         /* 水平居中 */
            align-items: center;                             /* 垂直居中 */
            animation: fadeIn 0.3s ease-out;                 /* 淡入動畫 */
        }

        /* 模態框容器樣式 - 顯示內容的中心區域 */
        .modal-container {
            background-color: var(--primary-color);          /* 主背景色 */
            border-radius: 10px;                             /* 圓角效果 */
            width: 90%;                                      /* 容器寬度 */
            max-width: 350px;                                /* 最大寬度 */
            box-shadow: 0 10px 25px rgba(var(--shadow-color)); /* 陰影效果 */
            animation: modalSlideIn 0.3s ease-out;           /* 滑入動畫 */
            overflow: hidden;                                /* 隱藏溢出內容 */
        }

        /* 模態框滑入動畫 - 定義模態框進入畫面的效果 */
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px); } /* 初始在上方且透明 */
            to { opacity: 1; transform: translateY(0); }       /* 最終在正常位置且不透明 */
        }

        /* 模態框頭部樣式 - 包含標題和關閉按鈕的頂部區域 */
        .modal-header {
            display: flex;                                   /* 彈性布局 */
            justify-content: space-between;                  /* 兩端對齊 */
            align-items: center;                             /* 垂直居中 */
            padding: 15px;                                   /* 內部間距 */
            border-bottom: 1px solid var(--border-color);    /* 底部邊框 */
            background-color: var(--secondary-color);        /* 次要背景色 */
        }

        /* 貸款比較頁面的特殊標題樣式 */
        #multiLoanComparisonModal .modal-header {
            min-height: 56px; /* 確保有足夠高度容納按鈕 */
            padding: 12px 15px; /* 調整內距 */
        }

        /* 模態框標題樣式 - 頂部標題文字 */
        .modal-header h3 {
            margin: 0;                                       /* 移除外部間距 */
            color: var(--accent-color);                      /* 強調色文字 */
            font-size: 18px;                                 /* 文字大小 */
        }

        /* 模態框內容區域樣式 - 顯示主要內容的區域 */
        .modal-content {
            padding: 20px 15px;                              /* 內部間距 */
            color: var(--text-color);                        /* 文字顏色 */
            max-height: 100vh;                                /* 最大高度 */
            overflow-y: auto;                                /* 垂直滾動 */
        }

        /* 模態框底部區域樣式 - 包含操作按鈕的底部區域 */
        .modal-footer {
            padding: 10px 15px 15px;                         /* 內部間距 */
            display: flex;                                   /* 彈性布局 */
            justify-content: flex-end;                       /* 右對齊 */
            gap: 10px;                                       /* 按鈕間距 */
            border-top: 1px solid var(--border-color);       /* 頂部邊框 */
            background-color: var(--secondary-color);        /* 次要背景色 */
        }

        /* 模態框按鈕共用樣式 - 模態框中所有按鈕的基本樣式 */
        .modal-btn {
            padding: 8px 15px;                               /* 內部間距 */
            border-radius: 10px;                             /* 圓角效果 */
            cursor: pointer;                                 /* 滑鼠指標變為手型 */
            font-size: 15px;                                 /* 文字大小 */
            transition: all 0.3s ease;                       /* 過渡效果 */
            border: none;                                    /* 無邊框 */
        }

        /* 模態框主要按鈕樣式 - 用於確認、提交等主要操作 */
        .modal-btn-primary {
            background-color: var(--accent-color);           /* 強調色背景 */
            color: white;                                    /* 白色文字 */
        }

        /* 模態框主要按鈕懸停效果 - 鼠標懸停時的視覺變化 */
        .modal-btn-primary:hover {
            background-color: var(--accent-color-dark);      /* 深色強調背景 */
            transform: translateY(-2px);                     /* 上移效果 */
        }

        /* 模態框次要按鈕樣式 - 用於取消、返回等次要操作 */
        .modal-btn-secondary {
            background-color: var(--secondary-color);        /* 次要背景色 */
            color: var(--text-color);                        /* 文字顏色 */
            border: 1px solid var(--border-color);           /* 邊框 */
        }

        /* 模態框次要按鈕懸停效果 - 鼠標懸停時的視覺變化 */
        .modal-btn-secondary:hover {
            background-color: var(--hover-color);            /* 懸停背景色 */
            transform: translateY(-2px);                     /* 上移效果 */
        }

        /* 提示框樣式 - 顯示短暫消息的浮動提示 */
        .toast-message {
            position: fixed;                                 /* 固定定位 */
            bottom: 60px;                                    /* 距底部距離 */
            left: 50%;                                       /* 水平居中 */
            transform: translateX(-50%);                     /* 精確居中 */
            background-color: rgba(var(--info-color-rgb), 0.9); /* 半透明信息色背景 */
            color: white;                                    /* 白色文字 */
            padding: 10px 20px;                              /* 內部間距 */
            border-radius: 5px;                              /* 圓角效果 */
            z-index: 9999;                                   /* 最高層級 */
            font-weight: bold;                               /* 文字粗細 */
            box-shadow: 0 2px 10px var(--shadow-color);      /* 陰影效果 */
            opacity: 1;                                      /* 完全不透明 */
            transition: opacity 0.5s ease;                   /* 透明度過渡效果 */
        }

        /* 數字輸入模態框樣式 - 自定義計算器輸入界面 */
        .number-input-modal {
            background-color: var(--primary-color);          /* 主背景色 */
            border-radius: 12px;                             /* 圓角效果 */
            width: 95%;                                      /* 容器寬度 */
            max-width: 350px;                                /* 最大寬度 */
            box-shadow: 0 10px 25px var(--shadow-color);     /* 陰影效果 */
            overflow: hidden;                                /* 隱藏溢出內容 */
            animation: modalSlideIn 0.3s ease-out;           /* 滑入動畫 */
        }

        /* 計算器顯示區域 - 顯示計算輸入與結果的區域 */
        .calculator-display {
            background-color: var(--input-bg);               /* 輸入框背景色 */
            color: var(--text-color);                        /* 文字顏色 */
            font-size: 32px;                                 /* 文字大小 */
            padding: 10px 15px;                              /* 內部間距 */
            text-align: right;                               /* 文字右對齊 */
            margin: 10px;                                    /* 外部間距 */
            border-radius: 6px;                              /* 圓角效果 */
            border: 1px solid var(--border-color);           /* 邊框 */
            height: 46px;                                    /* 固定高度 */
            display: flex;                                   /* 彈性布局 */
            align-items: center;                             /* 垂直居中 */
            justify-content: flex-end;                       /* 右對齊 */
            overflow: hidden;                                /* 隱藏溢出內容 */
            box-shadow: inset 0 2px 4px var(--shadow-color); /* 內陰影效果 */
        }

        /* 計算器顯示容器 - 包含計算歷史和當前輸入的容器 */
        .calculator-display-container {
            display: flex;                                   /* 彈性布局 */
            flex-direction: column;                          /* 垂直排列 */
            background-color: var(--input-bg);               /* 輸入框背景色 */
            margin: 10px;                                    /* 外部間距 */
            border-radius: 10px;                             /* 圓角效果 */
            border: 1px solid var(--border-color);           /* 邊框 */
            box-shadow: inset 0 2px 8px var(--shadow-color); /* 內陰影效果 */
            overflow: hidden;                                /* 隱藏溢出內容 */
            height: 110px;                                   /* 固定高度 */
            position: relative;                              /* 相對定位 */
        }

        /* 計算器歷史記錄區域 - 顯示先前的計算步驟 */
        .calculator-history {
            color: var(--text-muted);                        /* 淡色文字 */
            font-size: 16px;                                 /* 文字大小 */
            padding: 8px 15px;                               /* 內部間距 */
            text-align: right;                               /* 文字右對齊 */
            height: 40px;                                    /* 固定高度 */
            overflow-y: hidden;                              /* 隱藏垂直溢出 */
            display: flex;                                   /* 彈性布局 */
            flex-direction: column;                          /* 垂直排列 */
            justify-content: flex-end;                       /* 底部對齊 */
            line-height: 1.3;                                /* 行高 */
            word-break: break-all;                           /* 允許單詞內換行 */
            font-family: 'Consolas', monospace;              /* 等寬字體 */
            position: relative;                              /* 相對定位 */
            background: linear-gradient(to bottom, 
                rgba(var(--input-bg-rgb), 0.8), 
                rgba(var(--secondary-color-rgb), 0.8));      /* 漸變背景 */
        }

        /* 計算器歷史記錄底部分隔線 - 創建視覺分隔 */
        .calculator-history::after {
            content: '';                                     /* 創建空內容 */
            position: absolute;                              /* 絕對定位 */
            left: 0;                                         /* 貼齊左側 */
            right: 0;                                        /* 貼齊右側 */
            bottom: 0;                                       /* 貼齊底部 */
            height: 1px;                                     /* 高度1像素 */
            background: linear-gradient(to right, transparent, 
                rgba(var(--accent-color-rgb), 0.4), transparent); /* 漸變背景 */
        }

        /* 計算器顯示區域增強樣式 - 主顯示區的視覺效果 */
        .calculator-display {
            background-color: var(--input-bg);               /* 輸入框背景色 */
            color: var(--text-color);                        /* 文字顏色 */
            font-size: 36px;                                 /* 較大文字大小 */
            padding: 10px 15px;                              /* 內部間距 */
            text-align: right;                               /* 文字右對齊 */
            flex: 1;                                         /* 佔用剩餘空間 */
            display: flex;                                   /* 彈性布局 */
            align-items: center;                             /* 垂直居中 */
            justify-content: flex-end;                       /* 右對齊 */
            overflow: hidden;                                /* 隱藏溢出內容 */
            margin: 0;                                       /* 移除外部間距 */
            border: none;                                    /* 移除邊框 */
            box-shadow: none;                                /* 移除陰影 */
            font-family: 'Consolas', monospace;              /* 等寬字體 */
            font-weight: bold;                               /* 文字粗細 */
            letter-spacing: 1px;                             /* 字符間距 */
            border-bottom-left-radius: 8px;                  /* 左下圓角 */
            border-bottom-right-radius: 8px;                 /* 右下圓角 */
            position: relative;                              /* 相對定位 */
            background: linear-gradient(to bottom, 
                rgba(var(--input-bg-rgb), 0.9), 
                rgba(var(--input-bg-rgb), 0.7));             /* 漸變背景 */
            text-shadow: 0 1px 2px var(--shadow-color);      /* 文字陰影 */
        }

        /* 計算器滾動指示器 - 顯示內容可滾動的提示 */
        .calculator-scroll-indicator {
            position: absolute;                              /* 絕對定位 */
            top: 5px;                                        /* 距頂部距離 */
            right: 5px;                                      /* 距右側距離 */
            width: 12px;                                     /* 寬度 */
            height: 12px;                                    /* 高度 */
            background-color: rgba(var(--accent-color-rgb), 0.7); /* 半透明強調色背景 */
            border-radius: 50%;                              /* 圓形效果 */
            opacity: 0;                                      /* 初始透明 */
            transition: opacity 0.3s ease;                   /* 透明度過渡效果 */
            z-index: 10;                                     /* 層級 */
        }

        /* 計算器按鈕區域 - 包含所有計算器按鈕的網格 */
        .calculator-buttons {
            display: grid;                                   /* 網格布局 */
            grid-template-columns: repeat(4, 1fr);           /* 四列等寬 */
            grid-template-rows: repeat(5, auto);             /* 五行自動高度 */
            gap: 6px;                                        /* 網格間距 */
            padding: 10px;                                   /* 內部間距 */
        }

        /* 計算器按鈕基本樣式 - 所有按鈕的共同樣式 */
        .calculator-buttons button {
            padding: 10px 0;                                 /* 上下內部間距 */
            font-size: 20px;                                 /* 文字大小 */
            border-radius: 10px;                             /* 圓角效果 */
            background-color: var(--secondary-color);        /* 次要背景色 */
            color: var(--text-color);                        /* 文字顏色 */
            border: none;                                    /* 移除邊框 */
            transition: all 0.2s ease;                       /* 過渡效果 */
            margin: 0;                                       /* 移除外部間距 */
            display: flex;                                   /* 彈性布局 */
            align-items: center;                             /* 垂直居中 */
            justify-content: center;                         /* 水平居中 */
            height: 48px;                                    /* 固定高度 */
            box-shadow: 0 2px 4px var(--shadow-color);       /* 陰影效果 */
            position: relative;                              /* 相對定位 */
            overflow: hidden;                                /* 隱藏溢出內容 */
        }

        /* 計算器按鈕懸停效果 - 鼠標懸停時的視覺變化 */
        .calculator-buttons button:hover {
            background-color: var(--hover-color);            /* 懸停背景色 */
            transform: translateY(-2px);                     /* 上移效果 */
            box-shadow: 0 4px 8px var(--shadow-color);       /* 增強陰影 */
        }

        /* 計算器按鈕點擊效果 - 點擊時的視覺反饋 */
        .calculator-buttons button:active {
            transform: scale(0.95);                          /* 縮小效果 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);        /* 減弱陰影 */
        }

        /* 數字按鈕樣式 */
        /* 數字按鈕樣式 - 水平排列數字和財務符號 */
        .calculator-buttons .number-btn {
            display: flex;                                   /* 彈性布局 */
            flex-direction: row;                             /* 水平排列 */
            align-items: center;                             /* 垂直居中 */
            justify-content: center;                         /* 水平居中 */
            padding: 5px 2px;                                /* 內部間距 */
            position: relative;                              /* 相對定位 */
        }

        /* 阿拉伯數字樣式 - 主要顯示的數字 */
        .calculator-buttons .arabic-number {
            font-size: 28px;                                 /* 較大文字大小 */
            font-weight: bold;                               /* 文字粗細 */
            line-height: 1;                                  /* 行高 */
            margin-right: 3px;                               /* 右側外部間距 */
            flex-grow: 0;                                    /* 禁止增長 */
        }

        /* 財務符號樣式 - 顯示在按鈕上的中文數字 */
        .calculator-buttons .financial-char {
            font-size: 18px;                                 /* 較小文字大小 */
            color: var(--button-orange);                     /* 橙色文字 */
            line-height: 1;                                  /* 行高 */
            position: absolute;                              /* 絕對定位 */
            right: 6px;                                      /* 距右側距離 */
            opacity: 0.9;                                    /* 輕微透明 */
        }

        /* 數字按鈕相對定位 - 確保內部元素的正確定位 */
        .calculator-buttons .number-btn {
            position: relative;                              /* 相對定位 */
        }

        /* 阿拉伯數字右側間距 - 為財務符號留出空間 */
        .calculator-buttons .number-btn .arabic-number {
            margin-right: 3px;                               /* 右側外部間距 */
        }

        /* 財務符號定位 - 固定在按鈕右側 */
        .calculator-buttons .number-btn .financial-char {
            right: 6px;                                      /* 距右側距離 */
            font-size: 18px;                                 /* 文字大小 */
            color: var(--accent-color);                      /* 強調色文字 */
            position: absolute;                              /* 絕對定位 */
            opacity: 0.9;                                    /* 輕微透明 */
        }

        /* 數字按鈕點擊時的文字顏色變化 - 提供視覺反饋 */
        .calculator-buttons .number-btn:active .arabic-number,
        .calculator-buttons .number-btn:active .financial-char {
            color: white;                                    /* 白色文字 */
        }

        /* 零鍵樣式 - 調整零按鈕的特殊布局 */
        .calculator-buttons .zero {
            background-color: #3a3a3a;                       /* 深灰背景 */
            flex-direction: column;                          /* 垂直排列 */
            align-items: center;                             /* 水平居中 */
            justify-content: center;                         /* 垂直居中 */
        }

        /* 運算符和等號文字大小 - 確保視覺平衡 */
        .calculator-buttons .operator,
        .calculator-buttons .equals {
            font-size: 22px;                                 /* 文字大小 */
            font-weight: bold;                               /* 文字粗細 */
        }

        /* 清除和功能鍵文字大小 - 統一特殊按鈕的文字大小 */
        .calculator-buttons .clear,
        .calculator-buttons .function {
            font-size: 20px;                                 /* 文字大小 */
            font-weight: bold;                               /* 文字粗細 */
        }

        /* 按鈕點擊波紋效果 - 創建點擊時的擴散效果 */
        .calculator-buttons button::after {
            content: '';                                     /* 創建空內容 */
            position: absolute;                              /* 絕對定位 */
            top: 50%;                                        /* 從中心開始 */
            left: 50%;                                       /* 從中心開始 */
            width: 5px;                                      /* 初始寬度 */
            height: 5px;                                     /* 初始高度 */
            background: rgba(255, 255, 255, 0.5);            /* 半透明白色背景 */
            opacity: 0;                                      /* 初始透明 */
            border-radius: 100%;                             /* 圓形效果 */
            transform: scale(1, 1) translate(-50%, -50%);    /* 初始變形 */
            transform-origin: 50% 50%;                       /* 變形原點 */
        }

        /* 按鈕點擊時的波紋動畫 - 點擊時觸發波紋擴散 */
        .calculator-buttons button:active::after {
            animation: ripple 0.4s ease-out;                 /* 波紋動畫 */
        }

        /* 波紋動畫定義 - 控制點擊波紋的擴散效果 */
        @keyframes ripple {
            0% {
                transform: scale(0, 0) translate(-50%, -50%); /* 初始為點 */
                opacity: 0.5;                                /* 半透明 */
            }
            100% {
                transform: scale(20, 20) translate(-50%, -50%); /* 擴散為大圓 */
                opacity: 0;                                  /* 完全透明 */
            }
        }

        /* 功能鍵樣式 - 特殊功能按鈕的顏色 */
        .calculator-buttons .function {
            background-color: #4d4d4d;                       /* 中灰色背景 */
            color: #eee;                                     /* 淺灰色文字 */
            font-weight: bold;                               /* 文字粗細 */
        }

        /* 運算符號樣式 - 數學運算符按鈕的顏色 */
        .calculator-buttons .operator {
            background-color: var(--accent-color);           /* 強調色背景 */
            color: white;                                    /* 白色文字 */
            font-weight: bold;                               /* 文字粗細 */
            box-shadow: 0 2px 6px rgba(var(--accent-color-rgb), 0.4); /* 強調色陰影 */
        }

        /* 清除鍵樣式 - 清除按鈕的顏色 */
        .calculator-buttons .clear {
            background-color: var(--error-color);            /* 錯誤色背景 */
            color: white;                                    /* 白色文字 */
            font-weight: bold;                               /* 文字粗細 */
            box-shadow: 0 2px 6px rgba(var(--error-color-rgb), 0.4); /* 錯誤色陰影 */
        }

        /* 等號鍵樣式 - 等號按鈕的顏色 */
        .calculator-buttons .equals {
            background-color: var(--info-color);             /* 信息色背景 */
            color: white;                                    /* 白色文字 */
            font-weight: bold;                               /* 文字粗細 */
            box-shadow: 0 2px 6px rgba(var(--info-color-rgb), 0.4); /* 信息色陰影 */
        }

        /* 零鍵佔據兩欄 - 擴展零按鈕的寬度 */
        .calculator-buttons .zero {
            grid-column: span 2;                            /* 佔據兩列 */
            background-color: #3a3a3a;                      /* 深灰色背景 */
        }

        /* 提交按鈕佔據兩欄 - 擴展確認按鈕的寬度 */
        .calculator-buttons .submit {
            grid-column: span 2;                            /* 佔據兩列 */
            background-color: var(--accent-color);          /* 強調色背景 */
            color: white;                                   /* 白色文字 */
            font-weight: bold;                              /* 文字粗細 */
            box-shadow: 0 2px 6px rgba(var(--accent-color-rgb), 0.4); /* 強調色陰影 */
        }

        /* 錯誤提示樣式 - 顯示錯誤信息的toast */
        .toast-error {
            background-color: rgba(var(--error-color-rgb), 0.9); /* 半透明錯誤色背景 */
        }

        /* 添加箭頭旋轉動畫 - 控制展開/收起指示器 */
        #toggleIcon {
            display: inline-block;                          /* 行內塊顯示 */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* 平滑過渡效果 */
        }

        /* 按鈕組的轉換效果 - 控制按鈕組的展開/收起 */
        .input-button-group div[id$="Buttons"] {
            max-height: 100px;                              /* 最大高度 */
            opacity: 1;                                     /* 完全不透明 */
        }

        /* 歷史記錄備註容器 - 包含備註的區域 */
        .history-note-container {
            background-color: rgba(var(--primary-color-rgb), 0.1); /* 半透明背景 */
            border-radius: 4px;                             /* 圓角效果 */
            margin: 6px 0;                                  /* 上下外部間距 */
            padding: 6px;                                   /* 內部間距 */
        }

        /* 歷史記錄項目底部 - 包含備註和按鈕的底部區域 */
        .history-item-footer {
            display: flex;                                  /* 彈性布局 */
            align-items: center;                            /* 垂直居中 */
            gap: 8px;                                       /* 項目間距 */
        }

        /* 歷史記錄備註預覽 - 顯示備註內容的預覽 */
        .history-note-preview {
            color: var(--note-text-color);         /* 使用專門的備註文字顏色變數 */
            font-size: 14px;                       /* 文字大小 */
            min-height: 20px;                      /* 最小高度 */
            padding: 6px 8px;                      /* 增加內邊距讓文字更易讀 */
            border: 1px solid transparent;         /* 透明邊框 */
            border-radius: 6px;                    /* 圓角效果 */
            background-color: rgba(var(--primary-color-rgb), 0.3); /* 半透明背景 */
            transition: all 0.3s ease;             /* 過渡效果 */
            cursor: pointer;                       /* 滑鼠指標變為手型 */
            white-space: nowrap;                   /* 禁止換行 */
            overflow: hidden;                      /* 隱藏溢出內容 */
            text-overflow: ellipsis;               /* 文字溢出顯示省略號 */
            flex-grow: 1;                          /* 佔用剩餘空間 */
            max-width: 170px;                      /* 最大寬度 */
            line-height: 1.4;                      /* 行高，讓文字更易讀 */
        }

        /* 空備註的特殊樣式 */
        .history-note-preview.empty-note {
            color: var(--note-text-empty);         /* 使用較淡的顏色 */
            font-style: italic;                    /* 斜體字 */
            background-color: transparent;         /* 透明背景 */
        }

        /* 歷史記錄操作按鈕區域 - 置於右側的按鈕組 */
        .history-actions {
            display: flex;                                  /* 彈性布局 */
            gap: 4px;                                       /* 按鈕間距 */
            margin-left: auto;                              /* 推到右側 */
        }

        /* 歷史記錄備註預覽懸停效果 - 鼠標懸停時的視覺變化 */
        .history-note-preview:hover {
            background-color: var(--accent-color-light);    /* 淡色強調背景 */
            border-color: rgba(var(--accent-color-rgb), 0.3); /* 半透明強調色邊框 */
        }

        /* 備註編輯器模態框 - 編輯備註的彈出窗口 */
        .note-editor-modal {
            display: none;                                  /* 初始隱藏 */
            position: fixed;                                /* 固定定位 */
            top: 0;                                         /* 貼齊頂部 */
            left: 0;                                        /* 貼齊左側 */
            width: 100%;                                    /* 寬度100% */
            height: 100%;                                   /* 高度100% */
            background-color: rgba(var(--primary-color-rgb), 0.7); /* 半透明背景 */
            z-index: 2000;                                  /* 層級 */
            justify-content: center;                        /* 水平居中 */
            align-items: flex-start;                        /* 頂部對齊 */
            padding-top: 160px;                             /* 頂部內部間距 */
        }

        /* 備註編輯器內容區域 - 包含輸入框和按鈕的主體 */
        .note-editor-content {
            background-color: var(--primary-color);         /* 主背景色 */
            border-radius: 12px;                            /* 圓角效果 */
            width: 80%;                                     /* 容器寬度 */
            max-width: 320px;                               /* 最大寬度 */
            padding: 15px;                                  /* 內部間距 */
            box-shadow: 0 10px 25px var(--shadow-color);    /* 陰影效果 */
            border: 1px solid var(--accent-color);          /* 強調色邊框 */
            animation: slideDown 0.3s ease-out;             /* 滑入動畫 */
            margin: 0 auto;                                 /* 水平居中 */
        }

        /* 向下滑入動畫 - 定義模態框進入畫面的效果 */
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; } /* 初始在上方且透明 */
            to { transform: translateY(0); opacity: 1; }       /* 最終在正常位置且不透明 */
        }

        /* 備註編輯器輸入框 - 多行文本輸入區域 */
        .note-editor-input {
            width: calc(100% - 24px);                       /* 計算寬度 */
            padding: 12px;                                  /* 內部間距 */
            margin: 12px 0;                                 /* 上下外部間距 */
            background-color: var(--input-bg);              /* 輸入框背景色 */
            color: var(--text-color);                       /* 文字顏色 */
            border: 1px solid var(--border-color);          /* 邊框 */
            border-radius: 8px;                             /* 圓角效果 */
            min-height: 100px;                              /* 最小高度 */
            resize: none;                                   /* 禁止調整大小 */
            font-size: 16px;                                /* 文字大小 */
            box-shadow: inset 0 2px 4px var(--shadow-color); /* 內陰影效果 */
            transition: all 0.3s ease;                      /* 過渡效果 */
            box-sizing: border-box;                         /* 盒模型計算方式 */
        }

        /* 備註編輯器輸入框聚焦效果 - 輸入時的視覺反饋 */
        .note-editor-input:focus {
            border-color: var(--accent-color);              /* 強調色邊框 */
            box-shadow: 0 0 0 2px var(--accent-color-light); /* 強調色陰影 */
            outline: none;                                  /* 移除默認輪廓 */
        }

        /* 備註編輯器按鈕區域 - 底部操作按鈕的容器 */
        .note-editor-buttons {
            display: flex;                                  /* 彈性布局 */
            justify-content: flex-end;                      /* 右對齊 */
            gap: 8px;                                       /* 按鈕間距 */
            margin-top: 8px;                                /* 頂部外部間距 */
        }

        /* 備註編輯器標題 - 頂部標題樣式 */
        .note-editor-content h3 {
            color: var(--accent-color);                     /* 強調色文字 */
            font-size: 18px;                                /* 文字大小 */
            margin: 0 0 8px 0;                              /* 外部間距 */
            padding-bottom: 8px;                            /* 底部內部間距 */
            border-bottom: 1px solid rgba(var(--accent-color-rgb), 0.3); /* 半透明強調色底部邊框 */
        }

        /* 截圖加載提示樣式 - 生成報價卡片時的加載提示 */
        #screenshot-loading {
            position: fixed;                                /* 固定定位 */
            top: 0;                                         /* 貼齊頂部 */
            left: 0;                                        /* 貼齊左側 */
            width: 100%;                                    /* 寬度100% */
            height: 100%;                                   /* 高度100% */
            background-color: rgba(var(--primary-color-rgb), 0.7); /* 半透明背景 */
            display: flex;                                  /* 彈性布局 */
            align-items: center;                            /* 垂直居中 */
            justify-content: center;                        /* 水平居中 */
            z-index: 9999;                                  /* 最高層級 */
        }

        /* 加載內容樣式 - 顯示加載提示的容器 */
        .loading-content {
            background-color: rgba(var(--info-color-rgb), 0.9); /* 半透明信息色背景 */
            color: white;                                   /* 白色文字 */
            padding: 15px 25px;                             /* 內部間距 */
            font-size: 16px;                                /* 文字大小 */
            font-weight: bold;                              /* 文字粗細 */
            border-radius: 8px;                             /* 圓角效果 */
            box-shadow: 0 4px 12px var(--shadow-color);     /* 陰影效果 */
            animation: pulseLoading 1.5s infinite;          /* 脈動動畫 */
        }

        /* 加載脈動動畫 - 定義加載提示的呼吸效果 */
        @keyframes pulseLoading {
            0%, 100% { opacity: 0.9; transform: scale(1); }   /* 初始和結束狀態 */
            50% { opacity: 1; transform: scale(1.05); }       /* 中間狀態 */
        }

        /* 分享模態框容器樣式 - 調整分享界面的容器 */
        #shareModalOverlay .modal-container {
            width: 95%;                                     /* 容器寬度 */
            max-width: 370px;                               /* 最大寬度 */
            padding-bottom: 15px;                           /* 底部內部間距 */
            background-color: var(--primary-color);         /* 主背景色 */
        }

        /* 分享報價卡片樣式 - 顯示要分享的報價卡片的容器 */
        #shareQuoteCard {
            border-radius: 12px;                            /* 圓角效果 */
            overflow: hidden;                               /* 隱藏溢出內容 */
            background-color: var(--primary-color);         /* 主背景色 */
            margin: 10px auto;                              /* 外部間距 */
            max-width: 340px;                               /* 最大寬度 */
        }

        /* 分享選項按鈕樣式 - 分享操作的按鈕 */
        #shareOptions button {
            flex: 1;                                        /* 平均分配空間 */
            padding: 10px 15px;                             /* 內部間距 */
            font-size: 15px;                                /* 文字大小 */
            transition: all 0.3s ease;                      /* 過渡效果 */
        }

        /* 分享選項按鈕懸停效果 - 鼠標懸停時的視覺變化 */
        #shareOptions button:hover {
            transform: translateY(-3px);                     /* 上移效果 */
            box-shadow: 0 5px 15px var(--shadow-color);      /* 增強陰影 */
        }

        /* 分享狀態信息 - 顯示分享操作結果的文本區域 */
        #shareStatus {
            height: 20px;                                    /* 固定高度 */
            font-style: italic;                              /* 斜體文字 */
            color: var(--accent-color);                      /* 強調色文字 */
        }

        /* 報價卡片圖片樣式 - 報價卡片截圖的樣式 */
        #shareQuoteCard img {
            width: 100%;                                     /* 寬度100% */
            max-width: 380px;                                /* 最大寬度 */
            border-radius: 12px;                             /* 圓角效果 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);          /* 陰影效果 */
            display: block;                                  /* 塊級顯示 */
            margin: 0 auto;                                  /* 水平居中 */
        }

        /* 調整分享模態框內容區域 - 優化顯示空間 */
        #shareModalOverlay .modal-content {
            padding: 10px !important;                        /* 強制內部間距 */
            overflow: visible !important;                    /* 強制顯示溢出內容 */
        }

        /* 優化手機版報價卡片樣式 - 在小屏幕上的適配 */
        @media screen and (max-width: 480px) {
            #shareQuoteCard {
                width: 95%;                                  /* 容器寬度 */
                max-width: 340px;                            /* 最大寬度 */
                margin: 0 auto;                              /* 水平居中 */
            }
            
            #shareQuoteCard img {
                width: 100%;                                 /* 寬度100% */
                max-width: 340px;                            /* 最大寬度 */
            }
            
            .modal-container {
                width: 95%;                                  /* 容器寬度 */
                max-width: 350px;                            /* 最大寬度 */
            }
            
            .modal-content {
                padding: 5px !important;                     /* 強制內部間距 */
            }
            
            #shareOptions {
                gap: 8px;                                    /* 按鈕間距 */
            }
            
            #shareOptions button {
                font-size: 14px;                             /* 文字大小 */
                padding: 8px 12px;                           /* 內部間距 */
            }
        }

        /* 選單容器樣式 - 側邊選單的全屏背景 */
        .menu-container {
            position: fixed;                                 /* 固定定位 */
            top: 0;                                          /* 貼齊頂部 */
            left: 0;                                         /* 貼齊左側 */
            width: 100%;                                     /* 寬度100% */
            height: 100%;                                    /* 高度100% */
            background-color: rgba(0, 0, 0, 0.7);            /* 深色半透明背景 */
            backdrop-filter: blur(10px);                     /* 背景模糊效果 */
            -webkit-backdrop-filter: blur(10px);             /* Safari支持 */
            z-index: 2500;                                   /* 層級 */
            display: none;                                   /* 初始隱藏 */
            justify-content: flex-start;                     /* 左對齊 */
            align-items: flex-start;                         /* 頂部對齊 */
            opacity: 0;                                      /* 初始透明 */
            transition: opacity 0.3s ease;                   /* 透明度過渡 */
        }

        .menu-container.show {
            opacity: 1;                                      /* 顯示時不透明 */
        }

        /* 選單內容樣式 - 側邊欄的主要內容區域 */
        .menu-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            width: 85%;                                      /* 容器寬度 */
            max-width: 320px;                                /* 最大寬度 */
            height: 100%;                                    /* 高度100% */
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.4);      /* 更深的陰影 */
            overflow: hidden;                                /* 隱藏溢出內容 */
            display: flex;                                   /* 彈性布局 */
            flex-direction: column;                          /* 垂直排列 */
            transform-origin: left;                          /* 變形原點 */
            transform: translateX(-100%);                    /* 初始位置在左側外 */
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* 平滑動畫 */
        }

        .menu-container.show .menu-content {
            transform: translateX(0);                        /* 顯示時移到正常位置 */
        }

        /* 選單頭部樣式 - 包含標題和關閉按鈕的頂部區域 */
        .menu-header {
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            border-bottom: none;                             /* 移除邊框 */
            padding: 20px;                                   /* 內部間距 */
            display: flex;                                   /* 彈性布局 */
            justify-content: space-between;                  /* 兩端對齊 */
            align-items: center;                             /* 垂直居中 */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);      /* 陰影效果 */
        }

        /* 選單標題樣式 - 頂部標題文字 */
        .menu-header h3 {
            margin: 0;                                       /* 移除外部間距 */
            color: white;                                    /* 白色文字 */
            font-size: 24px;                                 /* 文字大小 */
            font-weight: 300;                                /* 較細字體 */
            letter-spacing: 1px;                             /* 字母間距 */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);      /* 文字陰影 */
        }

        /* 選單關閉按鈕樣式 - 用於關閉側邊選單 */
        .menu-close-btn {
            background: none;                                /* 無背景 */
            border: none;                                    /* 無邊框 */
            color: var(--text-color);                        /* 文字顏色 */
            font-size: 24px;                                 /* 文字大小 */
            cursor: pointer;                                 /* 滑鼠指標變為手型 */
            transition: color 0.3s ease;                     /* 只過渡顏色 */
            padding: 0;                                      /* 移除內部間距 */
            line-height: 1;                                  /* 行高設為1 */
        }

        /* 選單關閉按鈕懸停效果 - 鼠標懸停時的視覺變化 */
        .menu-close-btn:hover {
            color: var(--button-orange);                     /* 橙色文字 */
        }

        /* 選單列表樣式 - 選單項目的列表容器 */
        .menu-list {
            flex: 1;                                         /* 佔用剩餘空間 */
            overflow-y: auto;                                /* 垂直滾動 */
            margin: 0;                                       /* 移除外部間距 */
            padding: 0;                                      /* 移除內部間距 */
            list-style: none;                                /* 移除列表樣式 */
        }

        /* 選單項目樣式 - 單個選單選項的樣式 */
        .menu-item {
            padding: 18px 24px;                              /* 內部間距 */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* 細微邊框 */
            color: var(--text-color);                        /* 文字顏色 */
            cursor: pointer;                                 /* 滑鼠指標變為手型 */
            transition: all 0.3s ease;                       /* 過渡效果 */
            display: flex;                                   /* 彈性布局 */
            justify-content: space-between;                  /* 兩端對齊 */
            align-items: center;                             /* 垂直居中 */
            font-size: 16px;                                 /* 文字大小 */
            font-weight: 400;                                /* 正常字重 */
            position: relative;                              /* 相對定位 */
            overflow: hidden;                                /* 隱藏溢出 */
        }

        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background-color: var(--accent-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        /* 選單項目懸停效果 - 鼠標懸停時的背景變化 */
        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.05);     /* 微透明白色背景 */
            padding-left: 32px;                              /* 增加左內距 */
            color: var(--accent-color);                      /* 強調色文字 */
        }

        .menu-item:hover::before {
            transform: translateX(0);                        /* 顯示左側條 */
        }

        /* 選單項目點擊效果 - 點擊時的背景變化 */
        .menu-item:active {
            background-color: rgba(255, 156, 51, 0.2);       /* 半透明橙色背景 */
        }

        /* 選單項目箭頭樣式 - 指示子選單的箭頭圖標 */
        .menu-item-arrow {
            font-size: 12px;                                 /* 文字大小 */
            transition: transform 0.3s ease;                 /* 過渡效果 */
        }

        /* 添加分隔線效果 - 為選單項目添加底部分隔線 */
        .menu-item, .submenu-item {
            position: relative;                              /* 相對定位 */
        }

        /* 選單項目分隔線 - 底部漸變分隔線效果 */
        .menu-item:after, .submenu-item:after {
            content: '';                                     /* 創建空內容 */
            position: absolute;                              /* 絕對定位 */
            bottom: 0;                                       /* 貼齊底部 */
            left: 15px;                                      /* 距左側距離 */
            right: 15px;                                     /* 距右側距離 */
            height: 1px;                                     /* 高度1像素 */
            background: linear-gradient(to right, transparent, var(--border-color), transparent); /* 漸變背景 */
        }

        /* 子選單容器樣式 - 與主選單類似的全屏背景 */
        .submenu-container {
            position: fixed;                                 /* 固定定位 */
            top: 0;                                          /* 貼齊頂部 */
            left: 0;                                         /* 貼齊左側 */
            width: 100%;                                     /* 寬度100% */
            height: 100%;                                    /* 高度100% */
            background-color: rgba(0, 0, 0, 0.7);            /* 深色半透明背景 */
            backdrop-filter: blur(10px);                     /* 背景模糊效果 */
            -webkit-backdrop-filter: blur(10px);             /* Safari支持 */
            z-index: 2600;                                   /* 層級 */
            display: none;                                   /* 初始隱藏 */
            justify-content: flex-start;                     /* 左對齊 */
            align-items: flex-start;                         /* 頂部對齊 */
            opacity: 0;                                      /* 初始透明 */
            transition: opacity 0.3s ease;                   /* 透明度過渡 */
        }

        .submenu-container.show {
            opacity: 1;                                      /* 顯示時不透明 */
        }

        /* 子選單內容樣式 - 與主選單類似的側邊欄 */
        .submenu-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            width: 85%;                                      /* 容器寬度 */
            max-width: 320px;                                /* 最大寬度 */
            height: 100%;                                    /* 高度100% */
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.4);      /* 更深的陰影 */
            overflow: hidden;                                /* 隱藏溢出內容 */
            display: flex;                                   /* 彈性布局 */
            flex-direction: column;                          /* 垂直排列 */
            transform-origin: left;                          /* 變形原點 */
            transform: translateX(-100%);                    /* 初始位置在左側外 */
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* 平滑動畫 */
        }

        .submenu-container.show .submenu-content {
            transform: translateX(0);                        /* 顯示時移到正常位置 */
        }

        /* 子選單頭部樣式 - 包含標題和返回按鈕的頂部區域 */
        .submenu-header {
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            border-bottom: none;                             /* 移除邊框 */
            padding: 20px;                                   /* 內部間距 */
            display: flex;                                   /* 彈性布局 */
            justify-content: space-between;                  /* 兩端對齊 */
            align-items: center;                             /* 垂直居中 */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);      /* 陰影效果 */
        }

        /* 子選單標題樣式 - 頂部標題文字 */
        .submenu-header h3 {
            margin: 0;                                       /* 移除外部間距 */
            color: white;                                    /* 白色文字 */
            font-size: 24px;                                 /* 文字大小 */
            font-weight: 300;                                /* 較細字體 */
            letter-spacing: 1px;                             /* 字母間距 */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);      /* 文字陰影 */
        }

        /* 子選單標題底部橘色線條 */
        .submenu-header h3::after {
            content: '';
            display: block;
            width: 50px;
            height: 3px;
            background-color: var(--accent-color);
            margin-top: 8px;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .submenu-header:hover h3::after {
            width: 80px;
        }

        /* 選單標題樣式 - 頂部標題文字 */
        .menu-header h3 {
            margin: 0;                                       /* 移除外部間距 */
            color: var(--accent-color);                      /* 強調色文字 */
            font-size: 22px;                                 /* 文字大小 */
            font-weight: bold;                               /* 文字粗細 */
        }

        /* 子選單返回按鈕樣式 - 返回主選單的按鈕 */
        .submenu-back-btn {
            background: none;                                /* 無背景 */
            border: none;                                    /* 無邊框 */
            color: rgba(255, 255, 255, 0.8);                /* 半透明白色 */
            font-size: 18px;                                 /* 文字大小 */
            cursor: pointer;                                 /* 滑鼠指標變為手型 */
            transition: all 0.3s ease;                       /* 過渡效果 */
            display: flex;                                   /* 彈性布局 */
            align-items: center;                             /* 垂直居中 */
            gap: 8px;                                        /* 間距 */
            padding: 0;                                      /* 移除內邊距 */
        }

        /* 子選單返回按鈕懸停效果 - 鼠標懸停時的視覺變化 */
        .submenu-back-btn:hover {
            color: var(--button-orange);                     /* 橙色文字 */
            transform: translateX(-3px);                     /* 輕微左移 */
        }

        /* 子選單列表樣式 - 子選單項目的列表容器 */
        .submenu-list {
            flex: 1;                                         /* 佔用剩餘空間 */
            overflow-y: auto;                                /* 垂直滾動 */
            margin: 0;                                       /* 移除外部間距 */
            padding: 0;                                      /* 移除內部間距 */
            list-style: none;                                /* 移除列表樣式 */
        }

        /* 子選單項目樣式 - 單個子選單選項的樣式 */
        .submenu-item {
            padding: 18px 24px;                              /* 內部間距 */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* 細微邊框 */
            color: var(--text-color);                        /* 文字顏色 */
            cursor: pointer;                                 /* 滑鼠指標變為手型 */
            transition: all 0.3s ease;                       /* 過渡效果 */
            font-size: 16px;                                 /* 文字大小 */
            font-weight: 400;                                /* 正常字重 */
            position: relative;                              /* 相對定位 */
            overflow: hidden;                                /* 隱藏溢出 */
        }

        .submenu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background-color: var(--accent-color);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        /* 子選單項目懸停效果 - 鼠標懸停時的背景變化 */
        .submenu-item:hover {
            background-color: rgba(255, 255, 255, 0.05);     /* 微透明白色背景 */
            padding-left: 32px;                              /* 增加左內距 */
            color: var(--accent-color);                      /* 強調色文字 */
        }

        .submenu-item:hover::before {
            transform: translateX(0);                        /* 顯示左側條 */
        }

        /* 子選單項目點擊效果 - 點擊時的背景變化 */
        .submenu-item:active {
            background-color: rgba(255, 156, 51, 0.2);       /* 半透明橙色背景 */
        }

        /* 版本信息樣式 - 顯示在選單底部的版本號 */
        .version-info {
            padding: 20px;                                   /* 內部間距 */
            font-size: 12px;                                 /* 文字大小 */
            color: rgba(255, 255, 255, 0.5);                /* 半透明白色文字 */
            text-align: center;                              /* 文字居中 */
            border-top: 1px solid rgba(255, 255, 255, 0.1); /* 頂部邊框 */
            background-color: rgba(0, 0, 0, 0.2);            /* 深色背景 */
            margin-top: auto;                                /* 推到底部 */
            font-weight: 300;                                /* 細字體 */
        }

        /* 響應式設計 - 平板及以上設備的適配 */
        @media screen and (min-width: 768px) {
            .menu-content, .submenu-content {
                width: 320px;                                /* 固定寬度 */
            }
        }

        /* 響應式設計 - 桌面設備的適配 */
        @media screen and (min-width: 1024px) {
            .menu-btn {
                width: 24px;                                 /* 按鈕寬度 */
                height: 24px;                                /* 按鈕高度 */
                font-size: 18px;                             /* 文字大小 */
                left: 12px;                                  /* 距左側距離 */
            }
            
            .menu-item, .submenu-item {
                padding: 14px 18px;                          /* 內部間距 */
            }
            
            .menu-header h3, .submenu-header h3 {
                font-size: 20px;                             /* 文字大小 */
            }
        }

        /* 響應式設計 - 小型手機的適配 */
        @media screen and (max-width: 480px) {
            .menu-content, .submenu-content {
                width: 85%;                                  /* 更寬的比例 */
            }
        }

        /* 主題相關元素樣式調整 - 確保元素使用主題變量 */
        .row {
            background-color: var(--secondary-color);        /* 使用次要背景色 */
            border-left: 3px solid transparent;              /* 透明左側邊框 */
            transition: all var(--transition-normal) ease;   /* 使用主題過渡時間 */
        }

        /* 行懸停效果 - 鼠標懸停時的視覺變化 */
        .row:hover {
            transform: translateX(5px);                      /* 右移效果 */
            box-shadow: 0 6px 12px var(--shadow-color);      /* 增強陰影 */
        }

        /* 行懸停時的左側邊框 - 鼠標懸停時顯示強調色邊框 */
        .row:hover::before {
            background: var(--accent-color);                 /* 使用強調色 */
        }

        /* 行標籤文字顏色 - 使用主題文字色 */
        .row .label {
            color: var(--text-color);                        /* 使用文字顏色 */
        }

        /* 強調行樣式 - 特殊突出顯示的行 */
        .emphasized-row {
            border-left: 3px solid var(--accent-color);      /* 強調色左側邊框 */
            background: linear-gradient(90deg, var(--accent-color-light), transparent); /* 漸變背景 */
        }

        /* 強調行標籤文字顏色 - 使用強調色 */
        .emphasized-row .label {
            color: var(--accent-color);                      /* 強調色文字 */
        }

        /* 強調行輸入框邊框 - 使用強調色邊框 */
        .emphasized-row input {
            border-color: var(--accent-color);               /* 強調色邊框 */
        }

        /* 輸入框樣式 - 應用主題變量 */
        input {
            background-color: var(--input-bg);               /* 使用輸入框背景色 */
            color: var(--text-color);                        /* 使用文字顏色 */
            border: 1px solid var(--input-border);           /* 使用輸入框邊框色 */
        }

        /* 輸入框聚焦效果 - 應用主題變量 */
        input:focus {
            border-color: var(--accent-color);               /* 強調色邊框 */
            box-shadow: 0 0 0 3px var(--accent-color-light); /* 淡色強調陰影 */
        }

        /* 按鈕樣式 - 應用主題變量 */
        button {
            background-color: var(--secondary-color);        /* 次要背景色 */
            color: var(--text-color);                        /* 文字顏色 */
            border: 1px solid var(--border-color);           /* 邊框色 */
        }

        /* 按鈕懸停效果 - 應用主題變量 */
        button:hover {
            background-color: var(--hover-color);            /* 懸停背景色 */
        }

        /* 功能按鈕樣式 - 應用主題變量 */
        .function-buttons button {
            background-color: var(--secondary-color);        /* 次要背景色 */
            color: var(--text-color);                        /* 文字顏色 */
            border: 1px solid var(--accent-color);           /* 強調色邊框 */
        }

        /* 功能按鈕懸停效果 - 應用主題變量 */
        .function-buttons button:hover {
            background-color: var(--accent-color);           /* 強調色背景 */
        }

        /* 提示訊息樣式 - 應用主題變量 */
        .toast-message {
            background-color: var(--info-color);             /* 信息色背景 */
        }

        /* 錯誤提示樣式 - 應用主題變量 */
        .toast-error {
            background-color: var(--error-color);            /* 錯誤色背景 */
        }

        /* 警告文字樣式 - 應用主題變量 */
        .warning-text {
            color: var(--error-color) !important;            /* 強制使用錯誤色文字 */
        }

        /* 歷史記錄項目左側邊框 - 應用主題變量 */
        .history-item {
            border-left: 3px solid var(--accent-color);      /* 強調色左側邊框 */
        }

        /* 歷史記錄日期文字顏色 - 應用主題變量 */
        .history-date {
            color: var(--accent-color);                      /* 強調色文字 */
        }

        /* 白色主題輸入框背景 - 為白色主題提供特定樣式 */
        :root[data-theme="white"] input,
        :root[data-theme="white"] .row,
        :root[data-theme="white"] #timeDisplay,
        :root[data-theme="white"] .sticky-header,
        :root[data-theme="white"] .modal-container {
            background-color: var(--secondary-color);        /* 使用次要背景色 */
        }

        /* 期數方案對比表格樣式 */
        .period-comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        .period-comparison-table th, 
        .period-comparison-table td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .period-comparison-table th {
            background-color: var(--secondary-color);
            font-weight: bold;
        }

        .period-comparison-table tr:nth-child(even) {
            background-color: var(--secondary-color);
        }

        .period-comparison-table tr:nth-child(odd) {
            background-color: var(--primary-color);
        }

        .period-comparison-table tr:hover {
            background-color: var(--hover-color);
        }

        .select-plan-btn {
            padding: 5px 8px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .select-plan-btn:hover {
            background-color: var(--accent-color-dark);
            transform: translateY(-2px);
        }

        .select-plan-btn:active {
            transform: translateY(0);
        }

        /* 添加到样式表的.history-item相关部分之后 */
        .checkbox-date-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-item-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s ease;
            margin: 0;
            flex-shrink: 0;
        }

        .history-item-checkbox:checked {
            accent-color: var(--accent-color);
        }

        .history-item-checkbox:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .compare-selected-btn {
            background: rgba(var(--accent-color-rgb), 0.15);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            font-size: 14px;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            margin-right: 10px;
        }

        .compare-selected-btn:hover:not(:disabled) {
            background-color: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(var(--accent-color-rgb), 0.4);
        }

        .compare-selected-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(150, 150, 150, 0.15);
            border: 1px solid #999;
            color: #999;
        }

        .comparison-highlight {
            border-left: 3px solid #33b5e5 !important;
            background: linear-gradient(90deg, rgba(51, 181, 229, 0.1), transparent) !important;
        }

        /* 提示視窗的背景遮罩 */
        .install-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* 提示視窗 */
        .install-modal {
            width: 90%;
            max-width: 350px;
            background-color: var(--secondary-color);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border: 3px solid #ff0000; /* 紅色外框 */
        }

        /* 提示視窗標題 */
        .install-modal-title {
            background-color: #ff0000; /* 紅色背景 */
            color: white;
            padding: 12px 15px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 0;
        }

        /* 提示視窗內容 */
        .install-modal-content {
            padding: 15px;
            color: var(--text-color);
            font-size: 13px;
            line-height: 1.4;
            text-align: center;
        }

        /* 提示視窗按鈕區域 */
        .install-modal-buttons {
            display: flex;
            padding: 10px 15px 15px;
            justify-content: center;
            gap: 15px;
        }

        /* 提示視窗按鈕 */
        .install-modal-btn {
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            text-align: center;
        }

        /* 確認按鈕 */
        .install-btn-confirm {
            background-color: var(--accent-color);
            color: white;
        }

        /* 取消按鈕 */
        .install-btn-cancel {
            background-color: #666;
            color: white;
        }

        /* 安裝提示區域 */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--secondary-color);
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            z-index: 9998;
        }

        /* 安裝提示文字 */
        .install-banner-text {
            flex: 1;
            font-size: 14px;
            color: var(--text-color);
        }

        /* 安裝按鈕 */
        .install-banner-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
        }

        /* 關閉安裝提示按鈕 */
        .install-banner-close {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            line-height: 1;
            padding: 0;
            margin-right: 5px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        /* 櫻花雪主題的輸入框樣式優化 */
        :root[data-theme="pink"] input {
            color: #b8306a !important;            /* 使用深櫻花色文字 */
            background-color: #fffafc !important; /* 使用極淡粉色背景 */
            border: 1px solid #ffb6c1 !important; /* 粉色邊框 */
        }

        /* 櫻花雪主題的輸入框聚焦效果優化 */
        :root[data-theme="pink"] input:focus {
            border-color: #db386c !important;      /* 深粉色邊框 */
            box-shadow: 0 0 0 3px rgba(219, 56, 108, 0.2) !important; /* 深粉色陰影 */
        }

        /* 櫻花雪主題下特殊輸入框優化 */
        :root[data-theme="pink"] #afterCommissionRate {
            color: #b8306a !important;             /* 使用深櫻花色文字 */
            background-color: rgba(219, 56, 108, 0.08) !important; /* 非常淡的粉色背景 */
            border: 1px solid rgba(219, 56, 108, 0.4) !important;  /* 半透明粉色邊框 */
        }

        /* 櫻花雪主題的按鈕樣式優化 */
        :root[data-theme="pink"] button {
            background-color: #fce4ec !important;  /* 淡粉色背景 */
            color: #b8306a !important;             /* 深櫻花色文字 */
            border: 1px solid #ffb6c1 !important;  /* 粉色邊框 */
        }

        :root[data-theme="pink"] button:hover {
            background-color: #ffd1dc !important;  /* 懸停時稍深的粉色 */
        }

        /* 櫻花雪主題的唯讀欄位 */
        :root[data-theme="pink"] .readonly {
            background-color: #fffafc !important;  /* 極淡粉色背景 */
            color: #b8306a !important;             /* 深櫻花色文字 */
        }

        /* 櫻花雪主題的分隔線 */
        :root[data-theme="pink"] .divider-flow {
            background: linear-gradient(90deg, 
                #fce4ec 0%,
                #ffb6c1 50%,
                #fce4ec 100%);                     /* 粉色漸變 */
        }

        /* 中文國字大寫欄位樣式 */
        .chinese-amount-row {
            margin: 4px 0;
            display: flex;
            align-items: center;
            background: var(--secondary-color);
            padding: 3px;
            border-radius: 4px;
            box-shadow: 0 4px 8px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            transform-origin: left;
            will-change: transform;
        }

        /* 中文大寫欄位懸停效果 - 移除右移效果 */
        .chinese-amount-row:hover {
            /* transform: translateX(5px); 已移除右移效果 */
            box-shadow: 0 6px 12px var(--shadow-color); /* 增強陰影 */
        }

        .chinese-amount-result {
            width: 100%;
            padding: 6px 8px;
            margin-bottom: 0;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 18px;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            min-height: 42px;
            max-height: 76px;
            overflow-y: auto;
            overflow-x: auto;
            white-space: normal;
            word-wrap: break-word;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            display: block;
            text-align: right;
            line-height: 1.2;
            flex: 1;                              /* 讓輸入框佔用剩餘空間 */
        }

        .chinese-amount-result::after {
            content: attr(data-placeholder);
            opacity: 0.5;
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            color: #888888;
            font-size: 16px;
            white-space: nowrap;
            pointer-events: none;
        }

        .chinese-amount-result:not(:empty)::after {
            display: none;
        }

        /* 專門為中文國字大寫添加的樣式 */
        .financial-digit {
            color: #FFBE7A;
            display: inline;
        }

        /* 總繳款中文國字大寫欄位樣式 */
        .total-payment-chinese-row {
            margin: 4px 0;
            display: flex;
            align-items: center;
            background: var(--secondary-color);
            padding: 3px;
            border-radius: 4px;
            box-shadow: 0 4px 8px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            transform-origin: left;
            will-change: transform;
        }

        /* 總繳款中文大寫欄位懸停效果 - 移除右移效果 */
        .total-payment-chinese-row:hover {
            /* transform: translateX(5px); 已移除右移效果 */
            box-shadow: 0 6px 12px var(--shadow-color); /* 增強陰影 */
        }

        .total-payment-chinese-result {
            width: 100%;
            padding: 6px 8px;
            margin-bottom: 0;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 18px;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            min-height: 42px;
            max-height: 76px;
            overflow-y: auto;
            overflow-x: auto;
            white-space: normal;
            word-wrap: break-word;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            display: block;
            text-align: right;
            line-height: 1.2;
            flex: 1;                              /* 讓輸入框佔用剩餘空間 */
        }

        .total-payment-chinese-result::after {
            content: attr(data-placeholder);
            opacity: 0.5;
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            color: #888888;
            font-size: 16px;
            white-space: nowrap;
            pointer-events: none;
        }

        .total-payment-chinese-result:not(:empty)::after {
            display: none;
        }

        /* 中文大寫欄位的特殊標籤樣式 - 讓發票和總繳的標籤靠左對齊 */
        .chinese-amount-row .label,
        .total-payment-chinese-row .label {
            margin-right: 3px;                  /* 標籤右側的間距 */
            text-align: left;                   /* 文字靠左對齊 */
            width: 35px;                        /* 縮小標籤寬度，讓輸入框有更多空間 */
            flex-shrink: 0;                     /* 防止標籤被壓縮 */
        }

        /* 期數方案對比全螢幕樣式 */
        #paymentComparisonModal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            background-color: var(--primary-color) !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        #paymentComparisonModal .modal-container {
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
        }

        #paymentComparisonModal .modal-header {
            flex-shrink: 0;
        }

        #paymentComparisonModal .modal-content {
            flex: 1;
            overflow-y: auto;
            background-color: var(--primary-color);
            padding: 15px;
            padding-bottom: 20px; /* 底部留一點空間 */
        }

        /* 確保表格能充分利用空間 */
        #paymentComparisonModal table {
            margin-bottom: 10px;
        }

        /* 調整標題區域樣式 */
        #paymentComparisonModal .modal-header {
            position: sticky;
            top: 0;
            background-color: var(--secondary-color);
            z-index: 100;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        #paymentComparisonModal .modal-footer {
            flex-shrink: 0;
        }

        /* 全螢幕比較貸款樣式 */
        #multiLoanComparisonModal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            background-color: var(--primary-color) !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        #multiLoanComparisonModal .modal-container {
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
        }

        #multiLoanComparisonModal .modal-header {
            flex-shrink: 0;
            position: sticky;
            top: 0;
            background-color: var(--secondary-color);
            z-index: 100;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        #multiLoanComparisonModal .modal-content {
            flex: 1;
            overflow-y: auto;
            background-color: var(--primary-color);
            padding-bottom: 20px; /* 底部留一點空間 */
        }

        /* 貸款選擇對話框全螢幕樣式 */
        #loanSelectionModal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            background-color: var(--primary-color) !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        #loanSelectionModal .modal-container {
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex !important;
            flex-direction: column !important;
        }

        #loanSelectionModal .modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* 同步旋轉動畫 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 同步狀態容器懸停效果 */
        #syncStatusContainer:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* 貸款比較選擇頁面樣式 */
        .loan-selection-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .current-loan-card {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-color-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .current-loan-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loan-card {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .loan-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-color);
        }

        .loan-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent-color);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .loan-card:hover::after {
            transform: scaleX(1);
        }

        .loan-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .loan-card-date {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .loan-card-rate {
            background: var(--accent-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .loan-card-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .loan-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .loan-detail-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .loan-detail-value {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
        }

        .select-loan-btn {
            /* 移除絕對定位，改為直接顯示在卡片底部 */
            /* position: absolute; -- 移除此行 */
            /* top: 50%; -- 移除此行 */
            /* right: 16px; -- 移除此行 */
            /* transform: translateY(-50%); -- 移除此行 */
            
            /* 按鈕基本樣式 */
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            
            /* 按鈕顯示在卡片底部 */
            margin-top: 12px;
            width: 100%;
            display: none; /* 預設隱藏 */
        }

        /* 當滑鼠懸停在卡片上時顯示按鈕 */
        .loan-card:hover .select-loan-btn {
            display: block; /* 改為顯示按鈕 */
        }

        .select-loan-btn:hover {
            background: var(--accent-color-dark);
            transform: translateY(-50%) scale(1.05);
        }

        .history-scroll-container {
            padding: 20px;
            padding-top: 0;
            height: calc(100vh - 300px);
            overflow-y: auto;
        }

        /* 捲軸樣式 */
        .history-scroll-container::-webkit-scrollbar {
            width: 6px;
        }

        .history-scroll-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .history-scroll-container::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 3px;
        }

        .history-scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color-dark);
        }

        /* ============================================
        * 底部固定利率顯示欄
        * ============================================ */

        /* 固定底部的利率顯示容器 */
        .fixed-rate-footer {
            position: fixed;                              /* 固定定位 */
            bottom: 0;                                    /* 貼齊底部 */
            left: 0;                                      /* 貼齊左側 */
            right: 0;                                     /* 貼齊右側 */
            background-color: var(--primary-color);     /* 使用次要背景色 */
            border-top: 2px solid var(--accent-color);    /* 頂部邊框使用強調色 */
            padding: 6px 10px 8px 10px;                   /* 內部間距 */
            display: flex;                                /* 使用彈性布局 */
            align-items: center;                          /* 垂直居中 */
            justify-content: center;                      /* 水平居中 */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);  /* 向上的陰影效果 */
            z-index: 900;                                 /* 層級設定，低於彈出視窗 */
            transition: all 0.3s ease;                    /* 平滑過渡效果 */
        }

        /* footer 中的利率顯示項目 */
        .rate-display-item {
            display: flex;                                /* 使用彈性布局 */
            align-items: center;                          /* 垂直居中 */
            gap: 4px;                                     /* 項目間距 */
        }

        /* footer 中的標題文字 - 佣後和稅佣後的標題 */
        .rate-footer-label {
            font-size: 18px;                              /* 文字大小 - 從16px增加到18px */
            color: var(--accent-color);                   /* 使用強調色（橘色） */
            font-weight: normal;                            /* 粗體文字 - 從normal改為bold讓文字更明顯 */
            white-space: nowrap;                          /* 防止文字換行 */
        }

        /* footer 中的利率輸入框 - 顯示佣後和稅佣後利率的數值框 */
        .rate-footer-input {
            width: 70px;                                  /* 固定寬度 - 從60px增加到70px以容納較大的文字 */
            padding: 5px 7px;                             /* 內部間距 - 稍微增加讓數字顯示更舒適 */
            background-color: var(--input-bg);            /* 使用輸入框背景色（深色背景） */
            color: var(--text-color);                     /* 使用文字顏色（白色或主題色） */
            border: 1px solid var(--border-color);        /* 邊框顏色 */
            border-radius: 4px;                           /* 圓角效果 */
            font-size: 18px;                              /* 文字大小 - 從16px增加到18px */
            text-align: right;                            /* 文字靠右對齊（數字通常靠右） */
            font-weight: normal;                            /* 粗體文字 - 從normal改為bold讓數字更明顯 */
            cursor: default;                              /* 預設游標（因為這是唯讀欄位） */
        }

        /* footer 中的百分比符號 - %符號的樣式 */
        .rate-footer-percent {
            font-size: 18px;                              /* 文字大小 - 從16px增加到18px配合數字大小 */
            color: var(--text-color);                     /* 使用主題文字顏色 */
            margin-left: -12px;                           /* 左側負間距 - 稍微調整以配合較大的輸入框 */
            font-weight: normal;                            /* 新增粗體效果讓%符號更明顯 */
        }

        /* 兩個利率顯示之間的分隔器 - 佣後和稅佣後之間的垂直分隔線 */
        .rate-footer-separator {
            width: 30px;                                  /* 分隔器寬度 - 稍微增加寬度 */
            height: 2px;                                  /* 高度 - 從1px增加到2px讓分隔線更明顯 */
            background-color: var(--border-color);        /* 使用邊框顏色（通常是灰色） */
            margin: 0 18px;                               /* 左右間距 - 稍微增加以配合較大的元素 */
            opacity: 0.7;                                 /* 新增透明度讓分隔線不會太突兀 */
        }

        /* 當頁面有底部 footer 時，調整主要內容的底部間距 */
        body.has-rate-footer {
            padding-bottom: 20px;                         /* 為 footer 預留空間 */
        }

        /* 隱藏 footer 的樣式類別 */
        .fixed-rate-footer.hidden {
            display: none !important;                     /* 強制隱藏 */
        }

        /* 加油卡計算器 iframe 響應式樣式 */
        @media screen and (max-height: 700px) {
            /* 在較矮的手機螢幕上減少 iframe 高度 */
            #gasPriceIframe {
                height: 300px !important;
            }
        }

        @media screen and (min-height: 800px) {
            /* 在較高的手機螢幕上增加 iframe 高度 */
            #gasPriceIframe {
                height: 500px !important;
            }
        }

        /* iframe 載入動畫 */
        #gasIframeLoader {
            animation: pulse 1.5s infinite;
        }

        /* 合併的每年/每月利息欄位的特殊樣式 */
        .combined-interest-row {
            display: flex !important;
            align-items: center !important;
            /* 確保欄位內容適當分佈 */
            justify-content: flex-start !important;
        }

        /* 第一個標籤的統一寬度 - 讓所有合併欄位的第一個標籤對齊 */
        .combined-interest-row .label:first-child {
            width: 75px !important;          /* 統一第一個標籤寬度 */
            font-size: 16px !important;      /* 保持字體大小 */
            margin-right: 4px !important;    /* 右側間距 */
            text-align: right !important;    /* 文字靠右對齊 */
            flex-shrink: 0;                 /* 防止標籤被壓縮 */
        }

        /* 第二個標籤的統一寬度 */
        .combined-interest-row .label:not(:first-child) {
            width: 65px !important;          /* 統一第二個標籤寬度 */
            font-size: 16px !important;      /* 保持字體大小 */
            margin-right: 4px !important;    /* 右側間距 */
            margin-left: 4px !important;     /* 左側間距 */
            text-align: right !important;    /* 文字靠右對齊 */
            flex-shrink: 0;                 /* 防止標籤被壓縮 */
        }

        /* 統一所有合併欄位的輸入框寬度 */
        .combined-interest-row input {
            width: 85px !important;          /* 增加輸入框寬度以顯示較大數值 */
            font-size: 16px !important;      /* 保持字體大小 */
            flex-shrink: 0;                 /* 防止輸入框被壓縮 */
        }

        /* 分隔符號的精確定位 */
        .interest-separator {
            color: var(--accent-color);
            margin: 0 8px;                   /* 左右間距各8px */
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;                 /* 防止分隔符被壓縮 */
            /* 設定固定位置以確保對齊 */
            position: relative;
            left: 0;
        }

        .interest-separator {
            color: var(--accent-color);
            margin: 0 8px;
            font-weight: bold;
            font-size: 18px;
        }

        /* 子標籤樣式（每年、每月） */
        .sub-label {
            
            font-size: 16px;  /* 稍微小一點的字體 */
            margin: 0 6px;  /* 左右間距 */
        }

        /* 特別針對百萬利息和一萬利息欄位的輸入框寬度調整 */
        /* 因為這兩個欄位的數值通常較小，所以縮減寬度 */
        .million-interest-row input,
        .ten-thousand-interest-row input {
            width: 64px !important;          /* 縮小輸入框寬度（原本是85px） */
            font-size: 16px !important;      /* 保持字體大小不變 */
        }

        /* 調整百萬利息和一萬利息欄位的子標籤（每年、每月）寬度 */
        .million-interest-row .sub-label,
        .ten-thousand-interest-row .sub-label {
            width: auto !important;          /* 自動寬度 */
            margin: 0 8px !important;        /* 減少左右間距 */
            font-size: 16px !important;      /* 稍微縮小字體 */
        }

        /* 調整百萬利息和一萬利息欄位的主標籤寬度 */
        .million-interest-row .label:first-child,
        .ten-thousand-interest-row .label:first-child {
            width: 76px !important;          /* 稍微縮小標籤寬度（原本是75px） */
        }

        /* ============================================
        * 顯示模式切換按鈕樣式
        * ============================================ */

        /* 模式圖標基礎樣式 */
        .mode-icon {
            font-size: 20px;                    /* 圖標大小 */
            line-height: 1;                     /* 行高 */
            display: inline-block;              /* 行內塊顯示 */
            transition: none;                   /* 無過渡效果 */
        }

        /* 圓形圖標 - 完整模式 */
        .mode-circle {
            font-size: 18px;                    /* 圓形稍小一點 */
        }

        /* 正方形圖標 - 計算模式 */
        .mode-square {
            font-size: 16px;                    /* 正方形適中大小 */
        }

        /* 三角形圖標 - 精簡模式 */
        .mode-triangle {
            font-size: 18px;                    /* 三角形稍小一點 */
        }

        /* 隱藏元素樣式 - 簡化版本 */
        .mode-hidden {
            display: none !important;           /* 強制隱藏 */
        }

    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // 檢測是否為獨立安裝的PWA應用
        function isInstalledPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }
    
        // 頁面加載時檢查
        document.addEventListener('DOMContentLoaded', function() {
            if (!isInstalledPWA()) {
                // 如果不是已安裝的PWA，顯示提示視窗
                showInstallPrompt();
            }
            // 如果是已安裝的PWA，不做任何事，直接顯示計算機
        });
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

</head>
<body class="has-rate-footer">

	<div class="header-container">
        <button id="menuBtn" class="header-btn header-btn-left" aria-label="選單">
            <span id="menuIcon">≡</span>
        </button>
        <h1>小朋友專用計算機</h1>
        <button id="toggleViewBtn" class="header-btn header-btn-right" aria-label="切換視圖">
            <span id="toggleIcon" class="mode-icon mode-circle">●</span>
        </button>
    </div>
	
    <div class="time-display-wrapper">
        <div id="timeDisplay" class="sticky-header">
            <div style="display: flex; justify-content: center; width: 100%;">
                <span class="time-label">報價時間</span>
                <span id="currentTime"></span>
            </div>
        </div>
    </div>
    
    <div class="input-button-group">
        <div class="row">
            <span class="label">期數</span>
            <input type="text" id="period" step="0.1" readonly>
            <button onclick="clearField('period')">清除</button>
        </div>
    
        <div id="periodButtons">
            <button onclick="adjustPeriod(-1)">-1</button>
            <button onclick="setPeriod(13)">底</button>
            <button onclick="setPeriod(24)">2</button>
            <button onclick="setPeriod(36)">3</button>
            <button onclick="setPeriod(48)">4</button>
            <button onclick="setPeriod(60)">5</button>
            <button onclick="setPeriod(72)">6</button>
            <button onclick="adjustPeriod(1)">+1</button>
        </div>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">稅前利率</span>
            <input type="text" id="rate" step="0.001" readonly>
            <button onclick="clearField('rate')">清除</button>
        </div>

        <div id="rateButtons">
            <button onclick="adjustRate(-0.2)">-0.2</button>
            <button onclick="setRate(4)">4</button>
            <button onclick="setRate(6)">6</button>
            <button onclick="setRate(8)">8</button>
            <button onclick="setRate(10)">10</button>
            <button onclick="setRate(13)">13</button>
            <button onclick="adjustRate(0.2)">+0.2</button>
        </div>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">本金</span>
            <input type="text" id="principal" min="0" readonly>
            <button onclick="clearField('principal')">清除</button>
        </div>

        <div id="principalButtons">
            <button onclick="adjustPrincipal(-1000000)">-100</button>
            <button onclick="adjustPrincipal(-100000)">-10</button>
            <button onclick="adjustPrincipal(-10000)">-1</button>
            <button onclick="adjustPrincipal(10000)">+1</button>
            <button onclick="adjustPrincipal(100000)">+10</button>
            <button onclick="adjustPrincipal(1000000)">+100</button>
        </div>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">期繳</span>
            <input type="text" id="payment" step="0.01" readonly>
            <button onclick="clearField('payment')">清除</button>
        </div>

        <div id="PaymentduringButtons">
            <button onclick="adjustPayment(-100)">-100</button>
            <button onclick="adjustPayment(-50)">-50</button>
            <button onclick="roundPayment('down', 100)">捨百</button>
            <button onclick="roundPayment('up', 100)">進百</button>
            <button onclick="adjustPayment(50)">+50</button>
            <button onclick="adjustPayment(100)">+100</button>
        </div>
    </div>

    <!-- 合併的總利息和總繳款欄位 -->
    <div class="row combined-interest-row total-payment-row">
        <!-- 總利息部分 -->
        <span class="label">總利息</span>
        <input type="text" id="totalInterest" class="readonly medium-input" readonly>
        
        <!-- 分隔符號 -->
        <span class="interest-separator">|</span>
        
        <!-- 總繳款部分 -->
        <span class="label">總繳款</span>
        <input type="text" id="totalPayment" class="readonly medium-input" readonly>
    </div>

    <!-- 合併的每年/每月利息欄位 -->
    <div class="row combined-interest-row">
        <!-- 每年利息部分 -->
        <span class="label">每年利息</span>
        <input type="text" id="yearlyInterest" class="readonly" readonly>
        
        <!-- 分隔符號 - 使用更美觀的設計 -->
        <span class="interest-separator">|</span>
        
        <!-- 每月利息部分 -->
        <span class="label">每月利息</span>
        <input type="text" id="monthlyInterest" class="readonly" readonly>
    </div>

    <div class="divider-flow"></div>

    <!-- 合併的稅金和稅後利率欄位 -->
    <div class="row combined-interest-row tax-rate-row">
        <!-- 稅金部分 -->
        <span class="label">稅金</span>
        <input type="text" id="tax" class="readonly medium-input" readonly>
        
        <!-- 分隔符號 -->
        <span class="interest-separator">|</span>
        
        <!-- 稅後利率部分 -->
        <span class="label">稅後利率</span>
        <input type="text" id="afterTaxRate" step="0.001" class="readonly medium-input" readonly>
    </div>

    <div class="divider-flow"></div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">推廣</span>
            <input type="text" id="commission" min="0" step="1" readonly>
            <button onclick="clearCommission()">清除</button>
        </div>

        <div id="commissionButtons">
            <button onclick="adjustCommission(-10000)">-萬</button>
            <button onclick="adjustCommission(-1000)">-千</button>
            <button onclick="adjustCommission(-100)">-百</button>
            <button onclick="adjustCommission(100)">+百</button>
            <button onclick="adjustCommission(1000)">+千</button>
            <button onclick="adjustCommission(10000)">+萬</button>
        </div>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">推廣比例</span>
            <input type="text" id="commissionRatio" class="readonly" readonly>
        </div>
    
        <div id="commissionPercentButtons">
            <button onclick="setCommissionPercent(1)">1%</button>
            <button onclick="setCommissionPercent(2)">2%</button>
            <button onclick="setCommissionPercent(3)">3%</button>
            <button onclick="setCommissionPercent(4)">4%</button>
            <button onclick="setCommissionPercent(5)">5%</button>
        </div>
    </div>

    <div class="row">
        <span class="label">佣後利率</span>
        <input type="text" id="afterCommissionOnlyRate" class="readonly" readonly>
        <span class="helper-text">資貸</span>
    </div>

    <div class="row">
        <span class="label">稅佣後利率</span>
        <input type="text" id="afterCommissionRate" class="readonly" readonly>
        <span class="helper-text">分期</span>
    </div>

    <div class="divider-flow"></div>

    <!-- 合併的百萬利息欄位 -->
    <div class="row combined-interest-row million-interest-row">
        <!-- 百萬利息標題 -->
        <span class="label">百萬利息</span>
        
        <!-- 每年部分 -->
        <span class="sub-label">每年</span>
        <input type="text" id="annualMillionInterest" class="readonly short-input" readonly>
        
        <!-- 分隔符號 -->
        <span class="interest-separator">|</span>
        
        <!-- 每月部分 -->
        <span class="sub-label">每月</span>
        <input type="text" id="monthlyMillionInterest" class="readonly short-input" readonly>
    </div>

    <!-- 合併的一萬利息欄位 -->
    <div class="row combined-interest-row ten-thousand-interest-row">
        <!-- 一萬利息標題 -->
        <span class="label">一萬利息</span>
        
        <!-- 每年部分 -->
        <span class="sub-label">每年</span>
        <input type="text" id="annualTenThousandInterest" class="readonly short-input" readonly>
        
        <!-- 分隔符號 -->
        <span class="interest-separator">|</span>
        
        <!-- 每月部分 -->
        <span class="sub-label">每月</span>
        <input type="text" id="monthlyTenThousandInterest" class="readonly short-input" readonly>
    </div>

    <div class="divider-flow"></div>

    <div class="row">
        <span class="label">資金成本</span>
        <input type="text" id="monthlyCost" value="2.2165" step="0.0001" readonly>
        <button onclick="resetMonthlyCost()">7月</button>
    </div>

    <div class="row">
        <span class="label">Spread</span>
        <input type="text" id="spread" class="readonly" readonly>
    </div>
	
    <div class="row">
        <span class="label">NPV</span>
        <input type="text" id="fundingCost" class="readonly" readonly>
        <span class="helper-text">稅佣後預估</span>
    </div>

    <div class="divider-flow"></div>

    <!-- 新增：客戶發票、營業稅、未稅金額欄位 -->
    <div class="row">
        <span class="label">客戶發票</span>
        <input type="text" id="customerInvoice" class="readonly" readonly>
    </div>
    <div class="row">
        <span class="label">營業稅</span>
        <input type="text" id="businessTax" class="readonly" readonly>
    </div>
    <div class="row">
        <span class="label">未稅金額</span>
        <input type="text" id="untaxedAmount" class="readonly" readonly>
    </div>

    <div class="row chinese-amount-row">
        <span class="label">發票</span>
        <div class="result chinese-amount-result" id="chineseAmount" data-placeholder="客戶發票金額的國字大寫"></div>
    </div>

    <div class="row total-payment-chinese-row">
        <span class="label">總繳</span>
        <div class="result total-payment-chinese-result" id="totalPaymentChinese" data-placeholder="總繳款金額的國字大寫"></div>
    </div>
    

    <!-- 按鈕區域重新組織 -->
    <div class="divider-flow"></div>

    <div class="function-buttons top-buttons">
        <div class="button-row">
            <button onclick="saveLoanData()" >保存計算</button>
            <button onclick="toggleHistoryPanel()" >歷史記錄</button>
            <button onclick="compareLoan()" >比較貸款</button>
        </div>
    </div>

    <div class="divider-flow"></div>

    <div class="function-buttons bottom-buttons">
        <div class="button-row">
            <button onclick="window.open('https://travel.chiayi.gov.tw/Folder/TurkeyRice', '_blank')">雞肉飯</button>
            <button onclick="clearAllFieldsExceptMonthlyCost()">清除</button>
            <button onclick="generateQuote()">截圖</button>
        </div>
    </div>

    <div class="footer-message">報價後記得吃碗火雞肉飯唷！</div>

    <!-- 添加歷史記錄面板 -->
    <!-- 重新设计的历史记录面板 -->
    <div id="historyPanel" class="history-panel">
        <div class="history-header">
            <div class="header-left">
                <h2>歷史記錄</h2>
            </div>
            <div class="header-right">
                <button id="compareSelectedBtn" class="compare-selected-btn" onclick="compareSelectedLoans()" disabled>比較</button>
                <button class="delete-all-btn" onclick="confirmDeleteAll()">全刪</button>
            </div>
            <button class="close-btn" onclick="toggleHistoryPanel()">×</button>
        </div>
        <div id="historyContent" class="history-content"></div>
    </div>

    <!-- 普通提示模態框 -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalTitle">提示</h3>
                <button class="close-btn" onclick="hideModal()">×</button>
            </div>
            <div id="modalContent" class="modal-content"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="hideModal()">確定</button>
            </div>
        </div>
    </div>

    <!-- 確認模態框 -->
    <div id="confirmModalOverlay" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="confirmModalTitle">確認</h3>
                <button class="close-btn" onclick="hideConfirmModal()">×</button>
            </div>
            <div id="confirmModalContent" class="modal-content"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="hideConfirmModal()">取消</button>
                <button id="confirmModalOk" class="modal-btn modal-btn-primary">確定</button>
            </div>
        </div>
    </div>

    <div class="footer-spacing"></div>

    <!-- 固定底部利率顯示欄 -->
    <div id="fixedRateFooter" class="fixed-rate-footer">
        <!-- 佣後利率顯示 -->
        <div class="rate-display-item">
            <span class="rate-footer-label">佣後</span>
            <input type="text" 
                id="footerAfterCommissionOnlyRate" 
                class="rate-footer-input" 
                readonly 
                disabled>
            <span class="rate-footer-percent">%</span>
        </div>
        
        <!-- 分隔器 -->
        <div class="rate-footer-separator"></div>
        
        <!-- 稅佣後利率顯示 -->
        <div class="rate-display-item">
            <span class="rate-footer-label">稅佣後</span>
            <input type="text" 
                id="footerAfterCommissionRate" 
                class="rate-footer-input" 
                readonly 
                disabled>
            <span class="rate-footer-percent">%</span>
        </div>
    </div>

<script>

    window.onload = function() {
        // 初始化時間顯示
        updateTime();
        
        // ========== 自動恢復上次的計算數據 ==========
        // 說明：頁面載入時，檢查是否有自動保存的數據，如果有就恢復
        try {
            // 從本地儲存讀取自動保存的數據
            const savedDataStr = localStorage.getItem('loanCalculatorAutoSave');
            
            if (savedDataStr) {
                // 解析保存的數據
                const savedData = JSON.parse(savedDataStr);
                
                // 檢查數據是否是最近24小時內的（避免恢復太舊的數據）
                const savedTime = new Date(savedData.timestamp);
                const now = new Date();
                const hoursDiff = (now - savedTime) / (1000 * 60 * 60); // 轉換為小時
                
                // 如果數據是24小時內的，則恢復
                if (hoursDiff < 24) {
                    // 恢復各個欄位的值
                    if (savedData.period) document.getElementById('period').value = savedData.period;
                    if (savedData.rate) document.getElementById('rate').value = savedData.rate;
                    if (savedData.principal) document.getElementById('principal').value = savedData.principal;
                    if (savedData.payment) document.getElementById('payment').value = savedData.payment;
                    if (savedData.commission) document.getElementById('commission').value = savedData.commission;
                    if (savedData.monthlyCost) document.getElementById('monthlyCost').value = savedData.monthlyCost;
                    
                    // 更新所有相關計算
                    updateAllFields();
                    
                    // 顯示恢復成功的提示
                    showToast('已恢復上次的計算數據');
                    
                    console.log('成功恢復自動保存的數據:', savedData);
                } else {
                    // 如果數據太舊，清除它
                    localStorage.removeItem('loanCalculatorAutoSave');
                    console.log('自動保存的數據已過期，已清除');
                }
            }
        } catch (error) {
            // 如果恢復失敗，記錄錯誤但不影響正常功能
            console.error('恢復自動保存數據失敗:', error);
        }
        // ========== 自動恢復結束 ==========
    }

    // 獲取裝置類型
    function getDeviceType() {
        const ua = navigator.userAgent;
        if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
            return "tablet";
        }
        if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
            return "mobile";
        }
        return "desktop";
    }

    // 獲取瀏覽器資訊
    function getBrowserInfo() {
        const ua = navigator.userAgent;
        let browser = "Unknown";
        if (ua.indexOf("Chrome") > -1) browser = "Chrome";
        else if (ua.indexOf("Safari") > -1) browser = "Safari";
        else if (ua.indexOf("Firefox") > -1) browser = "Firefox";
        else if (ua.indexOf("Edge") > -1) browser = "Edge";
        else if (ua.indexOf("Opera") > -1) browser = "Opera";
        else if (ua.indexOf("MSIE") > -1 || ua.indexOf("Trident/") > -1) browser = "Internet Explorer";
        
        return `${browser} ${navigator.platform}`;
    }

	// 添加震動函數
	function vibrate() {
		if (navigator.vibrate) {
		navigator.vibrate(30); // 震動30毫秒
		}
	}

    // 添加這個新函數到第一個 script 標籤內，updateTime 函數之前
    function calculateNPV(payment, period, principal, monthlyCost) {
        try {
            // 檢查輸入值是否有效
            if (!payment || !period || !principal || !monthlyCost || 
                isNaN(payment) || isNaN(period) || isNaN(principal) || isNaN(monthlyCost)) {
                return 0;
            }
            
            // 檢查極端值
            if (period > 1200) { // 100年
                console.warn('NPV計算: 期數過大可能導致計算不準確');
                period = 1200; // 限制最大期數
            }
            
            // 將年利率轉換為月利率
            const monthlyRate = monthlyCost / 100 / 12;
            
            // 處理利率接近0的情況
            if (Math.abs(monthlyRate) < 1e-10) {
                // 如果利率接近0，使用簡化公式計算現值
                return payment * period - principal;
            }
            
            // 計算貸款現值 (PV) - 使用本息平均攤還公式
            // PV = PMT × [(1 - (1 + r)^(-n)) / r]
            const presentValue = payment * (1 - Math.pow(1 + monthlyRate, -period)) / monthlyRate;
            
            // 獲取稅金和推廣費
            const taxElement = document.getElementById('tax');
            const commissionElement = document.getElementById('commission');
            
            // 解析稅金值（移除千位分隔符）
            let tax = 0;
            if (taxElement && taxElement.value) {
                tax = parseFloat(taxElement.value.replace(/,/g, '')) || 0;
            }
            
            // 解析推廣費值（移除千位分隔符）
            let commission = 0;
            if (commissionElement && commissionElement.value) {
                commission = parseFloat(commissionElement.value.replace(/,/g, '')) || 0;
            }
            
            // 計算最終NPV：貸款現值 - 稅金 - 推廣費 - 本金
            const npv = presentValue - tax - commission - principal;
            
            // 檢查計算結果是否有效
            if (!isFinite(npv) || isNaN(npv)) {
                console.error('NPV計算結果無效');
                return 0;
            }
            
            return Math.round(npv);
        } catch (error) {
            console.error('NPV 計算錯誤:', error);
            return 0;
        }
    }

    // 添加更新時間的函數
    function updateTime() {
        const now = new Date();
        const days = ['日', '一', '二', '三', '四', '五', '六'];
        
        // 調整為台北時間 (GMT+8)
        const taipeiTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        
        const year = taipeiTime.getUTCFullYear();
        const month = String(taipeiTime.getUTCMonth() + 1).padStart(2, '0');
        const date = String(taipeiTime.getUTCDate()).padStart(2, '0');
        const day = days[taipeiTime.getUTCDay()];
        const hours = String(taipeiTime.getUTCHours()).padStart(2, '0');
        const minutes = String(taipeiTime.getUTCMinutes()).padStart(2, '0');
        const seconds = String(taipeiTime.getUTCSeconds()).padStart(2, '0');
        
        const timeString = `${year}年${month}月${date}日
            星期${day} ${hours}:${minutes}:${seconds}`;
        document.getElementById('currentTime').textContent = timeString;
    }

    // 每秒更新一次時間
    setInterval(updateTime, 1000);
    updateTime(); // 初始化顯示

    // ========== 頁面可見性檢測 ==========
    // 說明：當使用者切換到其他應用或標籤頁時，自動保存數據
    // 當使用者回到頁面時，檢查並提示是否有新版本
    
    // 添加頁面可見性變化的監聽器
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // ===== 頁面被隱藏時（切換到其他應用） =====
            console.log('頁面已隱藏，執行自動保存...');
            
            // 執行一次完整的欄位更新，這會觸發自動保存
            updateAllFields();
            
            // 記錄頁面隱藏的時間
            localStorage.setItem('pageHiddenTime', new Date().toISOString());
            
        } else {
            // ===== 頁面重新顯示時（回到應用） =====
            console.log('頁面已顯示');
            
            // 檢查頁面隱藏了多久
            const hiddenTime = localStorage.getItem('pageHiddenTime');
            if (hiddenTime) {
                const hiddenDuration = new Date() - new Date(hiddenTime);
                const minutesHidden = Math.floor(hiddenDuration / 60000);
                
                // 如果頁面隱藏超過5分鐘，重新載入資料以確保資料是最新的
                if (minutesHidden >= 5) {
                    console.log(`頁面已隱藏 ${minutesHidden} 分鐘，檢查資料狀態...`);
                    
                    // 檢查是否有自動保存的資料
                    const savedData = localStorage.getItem('loanCalculatorAutoSave');
                    if (savedData) {
                        showToast('歡迎回來！您的計算資料已保存');
                    }
                }
                
                // 清除隱藏時間記錄
                localStorage.removeItem('pageHiddenTime');
            }
        }
    });
    
    // 監聽頁面即將關閉或重新整理的事件
    window.addEventListener('beforeunload', function(event) {
        // 在頁面即將關閉前，執行最後一次保存
        updateAllFields();
        console.log('頁面即將關閉，已執行自動保存');
        
        // 如果有未保存的重要資料，可以提示使用者
        const hasUnsavedData = document.getElementById('period').value || 
                              document.getElementById('rate').value || 
                              document.getElementById('principal').value || 
                              document.getElementById('payment').value;
        
        if (hasUnsavedData) {
            // 註：現代瀏覽器會顯示標準的離開提示，而不是自定義訊息
            event.preventDefault();
            event.returnValue = '';
        }
    });
    // ========== 頁面可見性檢測結束 ==========

    // ========== Service Worker 更新提示 ==========
    // 說明：當有新版本時，提示使用者是否要更新
    
    if ('serviceWorker' in navigator) {
        // 監聽 Service Worker 的更新
        navigator.serviceWorker.addEventListener('controllerchange', function() {
            // 如果控制器改變，表示有新的 Service Worker 接管了
            console.log('Service Worker 已更新');
            
            // 提示使用者頁面已更新
            if (!document.hidden) {
                // 只有在頁面可見時才提示
                showToast('網頁已更新到最新版本');
            }
        });
        
        // 定期檢查 Service Worker 更新（每30分鐘檢查一次）
        setInterval(function() {
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'CHECK_UPDATE'
                });
            }
        }, 1800000); // 30分鐘 = 1800000 毫秒
        
        // 監聽來自 Service Worker 的消息
        navigator.serviceWorker.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'SERVICE_WORKER_UPDATED') {
                // 有新版本可用，詢問使用者是否要更新
                console.log('檢測到新版本');
                
                // 使用您現有的確認對話框功能
                showConfirmModal(
                    '發現新版本',
                    '網頁有新版本可用，是否要立即更新？<br><br>更新後您的計算資料會自動恢復。',
                    function() {
                        // 使用者確認更新
                        if (navigator.serviceWorker.controller) {
                            // 先保存當前資料
                            updateAllFields();
                            
                            // 通知 Service Worker 可以更新
                            navigator.serviceWorker.controller.postMessage({
                                type: 'SKIP_WAITING'
                            });
                            
                            // 稍後重新載入頁面
                            setTimeout(function() {
                                window.location.reload();
                            }, 100);
                        }
                    }
                );
            }
        });
    }
    // ========== Service Worker 更新提示結束 ==========

    // 原始的JavaScript函數保持不變
    function PMT(rate, nper, pv) {
        // 參數驗證
        if (!nper || nper <= 0) {
            showToast('錯誤：期數必須為正數', true);
            return 0;
        }
        
        if (!pv || pv <= 0) {
            showToast('錯誤：本金必須為正數', true);
            return 0;
        }
        
        // 轉換利率為月利率
        rate = rate / 100 / 12;
        
        try {
            // 特殊情況：利率為0或接近0
            if (Math.abs(rate) < 1e-10) {
                return pv / nper; // 如果利率接近0，簡單地將本金除以期數
            }
            
            // 標準等額本息公式
            return (pv * rate * Math.pow(1 + rate, nper)) / (Math.pow(1 + rate, nper) - 1);
        } catch (error) {
            console.error('PMT 計算錯誤:', error);
            showToast('期繳金額計算出錯，請檢查輸入值', true);
            return 0;
        }
    }
        
    function RATE(nper, pmt, pv) {
        // 參數驗證
        if (!nper || nper <= 0) {
            showToast('錯誤：期數必須為正數', true);
            return 0;
        }
        
        if (!pmt || pmt <= 0) {
            showToast('錯誤：期繳金額必須為正數', true);
            return 0;
        }
        
        if (!pv || pv <= 0) {
            showToast('錯誤：本金必須為正數', true);
            return 0;
        }
        
        // 基本檢查：如果期繳總額小於本金，無法計算有效利率
        if (pmt * nper <= pv) {
            showToast('錯誤：期繳總額必須大於本金才能計算利率', true);
            return 0;
        }
        
        let rate = 0.1; // 初始猜測值，10%
        let step = 0.05;
        let tolerance = 0.0001;
        let maxIterations = 100;
        let iteration = 0;
        
        try {
            while (iteration < maxIterations) {
                let monthlyRate = rate / 12;
                
                // 避免除零錯誤
                let denominator = Math.pow(1 + monthlyRate, nper) - 1;
                if (Math.abs(denominator) < 1e-10) { // 接近零的情況
                    rate += step; // 調整並繼續迭代
                    step *= 0.5;
                    iteration++;
                    continue;
                }
                
                let calculated = pv * monthlyRate * Math.pow(1 + monthlyRate, nper) / denominator;
                
                if (Math.abs(calculated - pmt) < tolerance) {
                    return Math.max(0, rate * 100); // 確保不返回負利率
                }
                
                if (calculated > pmt) {
                    rate -= step;
                } else {
                    rate += step;
                }
                
                // 確保利率不會變為負數
                rate = Math.max(0.0001, rate);
                
                step *= 0.5;
                iteration++;
            }
            
            // 如果達到最大迭代次數仍未收斂
            console.warn('RATE 計算未收斂，返回最佳近似值');
            return Math.max(0, rate * 100);
        } catch (error) {
            console.error('RATE 計算錯誤:', error);
            showToast('利率計算出錯，請檢查輸入值', true);
            return 0;
        }
    }

    function calculateRate() {
        const period = parseFloat(document.getElementById('period').value);
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, ''));
        const payment = parseFloat(document.getElementById('payment').value.replace(/,/g, ''));
        
        // 只有當至少三個欄位已填寫時才顯示警告
        const filledFields = countFilledFields();
        const shouldWarn = filledFields >= 3;
        
        // 輸入驗證
        if (shouldWarn) {
            if (isNaN(period) || period <= 0) {
                showToast('請輸入有效的期數', true);
                return;
            }
            
            if (isNaN(principal) || principal <= 0) {
                showToast('請輸入有效的本金', true);
                return;
            }
            
            if (isNaN(payment) || payment <= 0) {
                showToast('請輸入有效的期繳金額', true);
                return;
            }
            
            // 基本財務檢查：總還款應超過本金
            if (payment * period <= principal) {
                showToast('期繳總額必須大於本金才能計算有效利率', true);
                return;
            }
        } else {
            // 如果欄位數不足，但輸入無效，直接返回
            if (isNaN(period) || isNaN(principal) || isNaN(payment) || 
                period <= 0 || principal <= 0 || payment <= 0 ||
                payment * period <= principal) {
                return;
            }
        }
        
        try {
            const rate = RATE(period, payment, principal);
            
            // 檢查計算結果是否有效
            if (isNaN(rate) || !isFinite(rate) || rate < 0) {
                if (shouldWarn) {
                    showToast('利率計算結果無效，請檢查輸入值', true);
                }
                return;
            }
            
            // 檢查利率是否超過20%
            if (rate > 20) {
                showToast('警告：計算結果顯示利率超過20%，可能不符合一般貸款條件', true);
            }
            
            // 限制利率顯示的小數位數並更新界面，不截斷超過20%的數值
            document.getElementById('rate').value = rate.toFixed(4);
            updateAllFields();
        } catch (error) {
            console.error('利率計算錯誤:', error);
            if (shouldWarn) {
                showToast('計算利率時出錯', true);
            }
        }
    }

    function calculatePayment() {
        const period = parseFloat(document.getElementById('period').value);
        const rate = parseFloat(document.getElementById('rate').value);
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, ''));
        
        // 只有當至少三個欄位已填寫時才顯示警告
        const filledFields = countFilledFields();
        const shouldWarn = filledFields >= 3;
        
        // 檢查所有輸入並提供具體錯誤訊息
        if (shouldWarn) {
            if (isNaN(period) || period <= 0) {
                showToast('請輸入有效的期數', true);
                return;
            }
            
            if (isNaN(rate) || rate <= 0) {
                showToast('請輸入有效的利率', true);
                return;
            }
            
            if (isNaN(principal) || principal <= 0) {
                showToast('請輸入有效的本金', true);
                return;
            }
        } else {
            // 如果欄位數不足，但輸入無效，直接返回
            if (isNaN(period) || isNaN(rate) || isNaN(principal) || 
                period <= 0 || rate <= 0 || principal <= 0) {
                return;
            }
        }
        
        try {
            // 限制極端值
            const safeRate = Math.min(Math.max(rate, 0.0001), 50); // 限制利率在合理範圍內
            const safePeriod = Math.min(Math.max(period, 1), 999); // 限制期數不超過999期
            
            const payment = PMT(safeRate, safePeriod, principal);
            
            // 檢查計算結果是否有效
            if (isNaN(payment) || !isFinite(payment) || payment <= 0) {
                if (shouldWarn) {
                    showToast('計算結果無效，請檢查輸入值', true);
                }
                return;
            }
            
            // 四捨五入為整數並格式化
            document.getElementById('payment').value = formatNumberWithCommas(Math.round(payment));
            updateAllFields();
        } catch (error) {
            console.error('期繳金額計算錯誤:', error);
            if (shouldWarn) {
                showToast('計算期繳金額時出錯', true);
            }
        }
    }


    function updateAllFields() {
        // 獲取基本值 - 需要先移除千位分隔符再轉換為數字
        const period = parseFloat(document.getElementById('period').value);
        const rate = parseFloat(document.getElementById('rate').value);
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, '')) || 0;
        const payment = parseFloat(document.getElementById('payment').value.replace(/,/g, '')) || 0;
        const monthlyCost = parseFloat(document.getElementById('monthlyCost').value);

        // 期數檢查
        const periodInput = document.getElementById('period');
        if (period <= 12) {
            periodInput.classList.add('warning-text');
        } else {
            periodInput.classList.remove('warning-text');
        }

        // 檢查四個基本輸入框是否都有值
        const hasAllRequiredValues = period && rate && principal && payment && 
                                    !isNaN(period) && !isNaN(rate) && !isNaN(principal) && !isNaN(payment);

        // 計算並顯示總繳款
        const totalPaymentField = document.getElementById('totalPayment');
        if (hasAllRequiredValues) {
            // 計算總繳款
            const totalPaymentValue = payment * period;
            // 總繳款格式化為整數帶千位分隔符
            totalPaymentField.value = formatNumberWithCommas(Math.round(totalPaymentValue));
        } else {
            // 如果缺少任何必要值，清空總繳款輸入框
            totalPaymentField.value = '';
        }

        // 計算並顯示總利息
        const totalInterestField = document.getElementById('totalInterest');
        if (hasAllRequiredValues) {
            // 計算總利息
            const totalInterest = (payment * period) - principal;
            // 總利息格式化為整數帶千位分隔符
            totalInterestField.value = formatNumberWithCommas(Math.round(totalInterest));
        } else {
            // 如果缺少任何必要值，清空總利息輸入框
            totalInterestField.value = '';
        }

        // 計算並顯示每年利息
        const yearlyInterestField = document.getElementById('yearlyInterest');
        if (hasAllRequiredValues) {
            // 計算每年利息 = 總利息 ÷ 期數 × 12
            const totalInterest = (payment * period) - principal;
            const yearlyInterest = (totalInterest / period) * 12;
            // 每年利息格式化為整數帶千位分隔符
            yearlyInterestField.value = formatNumberWithCommas(Math.round(yearlyInterest));
        } else {
            // 如果缺少任何必要值，清空每年利息輸入框
            yearlyInterestField.value = '';
        }

        // 計算並顯示每月利息
        const monthlyInterestField = document.getElementById('monthlyInterest');
        if (hasAllRequiredValues) {
            // 計算每月利息 = 每年利息 ÷ 12
            const totalInterest = (payment * period) - principal;
            const yearlyInterest = (totalInterest / period) * 12;
            const monthlyInterest = yearlyInterest / 12;
            // 每月利息格式化為整數帶千位分隔符
            monthlyInterestField.value = formatNumberWithCommas(Math.round(monthlyInterest));
        } else {
            // 如果缺少任何必要值，清空每月利息輸入框
            monthlyInterestField.value = '';
        }

        // 計算稅金 - 同樣需要檢查總利息是否已計算
        const taxField = document.getElementById('tax');
        if (hasAllRequiredValues) {
            const totalInterest = (payment * period) - principal;
            const tax = totalInterest / 21;
            taxField.value = formatNumberWithCommas(tax.toFixed(2));
        } else {
            taxField.value = '';
        }

        // 計算稅後利率 - 同樣需要檢查必要值
        const afterTaxRateInput = document.getElementById('afterTaxRate');
        if (hasAllRequiredValues) {
            const totalInterest = (payment * period) - principal;
            const tax = totalInterest / 21;
            const afterTaxRate = RATE(period, payment, principal + tax);
            afterTaxRateInput.value = afterTaxRate.toFixed(4);
            
            // 檢查稅後利率是否超過20%
            if (afterTaxRate > 20) {
                afterTaxRateInput.classList.add('warning-text');
                if (countFilledFields() >= 3) {
                    showToast('警告：稅後利率超過20%，可能不符合一般貸款條件', true);
                }
            } else if (afterTaxRate <= 2.5) {
                afterTaxRateInput.classList.add('warning-text');
            } else {
                afterTaxRateInput.classList.remove('warning-text');
            }
        } else {
            afterTaxRateInput.value = '';
            afterTaxRateInput.classList.remove('warning-text');
        }

        // 佣金格式化為整數並帶千位分隔符
        const commission = parseFloat(document.getElementById('commission').value.replace(/,/g, '')) || 0;
        document.getElementById('commission').value = formatNumberWithCommas(Math.round(commission));
        
        // 檢查佣金是否超過總利息的45%
        const commissionInput = document.getElementById('commission');
        if (hasAllRequiredValues) {
            const totalInterest = (payment * period) - principal;
            if (commission >= totalInterest * 0.45) {
                commissionInput.classList.add('warning-text');
                // 新增警告提示
                showToast('請注意推廣費與總利息比例！', true);
            } else {
                commissionInput.classList.remove('warning-text');
            }
        } else {
            commissionInput.classList.remove('warning-text');
        }

        // 計算並更新推廣費比例
        const commissionRatioInput = document.getElementById('commissionRatio');
        if (principal > 0 && commission > 0) {
            const commissionRatio = commission / principal * 100;
            commissionRatioInput.value = commissionRatio.toFixed(2);
            
            // 檢查推廣費比例是否超過5%
            if (commissionRatio > 5) {
                commissionRatioInput.classList.add('warning-text');
            } else {
                commissionRatioInput.classList.remove('warning-text');
            }
        } else {
            commissionRatioInput.value = '';
            commissionRatioInput.classList.remove('warning-text');
        }

        // 計算佣後利率
        const afterCommissionOnlyRateInput = document.getElementById('afterCommissionOnlyRate');
        if (hasAllRequiredValues) {
            try {
                // 計算佣後利率（只考慮佣金，不考慮稅金）
                const afterCommissionOnlyRate = RATE(period, payment, principal + commission);
                
                // 檢查結果是否有效
                if (isNaN(afterCommissionOnlyRate) || !isFinite(afterCommissionOnlyRate)) {
                    afterCommissionOnlyRateInput.value = "計算錯誤";
                    afterCommissionOnlyRateInput.classList.add('warning-text');
                } else {
                    // 佣後利率不需要千位分隔符
                    afterCommissionOnlyRateInput.value = afterCommissionOnlyRate.toFixed(4);
                    if (afterCommissionOnlyRate <= 2.5) {
                        afterCommissionOnlyRateInput.classList.add('warning-text');
                    } else {
                        afterCommissionOnlyRateInput.classList.remove('warning-text');
                    }
                }
            } catch (error) {
                console.error('佣後利率計算錯誤:', error);
                afterCommissionOnlyRateInput.value = "計算錯誤";
                afterCommissionOnlyRateInput.classList.add('warning-text');
            }
        } else {
            afterCommissionOnlyRateInput.value = '';
            afterCommissionOnlyRateInput.classList.remove('warning-text');
        }

        // 計算稅佣後利率
        // 計算稅佣後利率
        const afterCommissionRateInput = document.getElementById('afterCommissionRate');
        if (hasAllRequiredValues) {
            try {
                const totalInterest = (payment * period) - principal;
                const tax = totalInterest / 21;
                
                // 檢查計算是否合理
                const totalCost = principal + tax + commission;
                if (totalCost >= payment * period) {
                    // 如果成本超過總還款額，無法計算有效利率
                    afterCommissionRateInput.value = "N/A";
                    afterCommissionRateInput.classList.add('warning-text');
                    
                    // 同時更新 Spread
                    const spreadInput = document.getElementById('spread');
                    spreadInput.value = "N/A";
                    spreadInput.classList.add('warning-text');
                } else {
                    // 正常計算
                    const afterCommissionRate = RATE(period, payment, principal + tax + commission);
                    
                    // 檢查結果是否有效
                    if (isNaN(afterCommissionRate) || !isFinite(afterCommissionRate)) {
                        afterCommissionRateInput.value = "計算錯誤";
                        afterCommissionRateInput.classList.add('warning-text');
                    } else {
                        // 稅佣後利率不需要千位分隔符
                        afterCommissionRateInput.value = afterCommissionRate.toFixed(4);
                        if (afterCommissionRate <= 2.5) {
                            afterCommissionRateInput.classList.add('warning-text');
                        } else {
                            afterCommissionRateInput.classList.remove('warning-text');
                        }
                        
                        // 計算 Spread
                        const spread = afterCommissionRate - monthlyCost;
                        // Spread 不需要千位分隔符
                        const spreadInput = document.getElementById('spread');
                        spreadInput.value = spread.toFixed(4);
                        if (spread <= 0) {
                            spreadInput.classList.add('warning-text');
                        } else {
                            spreadInput.classList.remove('warning-text');
                        }
                    }
                }
            } catch (error) {
                console.error('稅佣後利率計算錯誤:', error);
                afterCommissionRateInput.value = "計算錯誤";
                afterCommissionRateInput.classList.add('warning-text');
                
                document.getElementById('spread').value = '';
                document.getElementById('spread').classList.remove('warning-text');
            }
        } else {
            afterCommissionRateInput.value = '';
            afterCommissionRateInput.classList.remove('warning-text');
            
            document.getElementById('spread').value = '';
            document.getElementById('spread').classList.remove('warning-text');
        }
        
        // 計算百萬利息相關
        if (rate > 0) {
            // 百萬利息計算
            const millionPayment = PMT(rate, 12, 1000000);
            const annualMillionInterest = (millionPayment * 12) - 1000000;
            
            // 百萬每年利息格式化為整數帶千位分隔符
            document.getElementById('annualMillionInterest').value = formatNumberWithCommas(Math.round(annualMillionInterest));
            // 百萬每月利息格式化為整數帶千位分隔符
            document.getElementById('monthlyMillionInterest').value = formatNumberWithCommas(Math.round(annualMillionInterest / 12));
            
            // 一萬利息
            const tenThousandPayment = PMT(rate, 12, 10000);
            const annualTenThousandInterest = (tenThousandPayment * 12) - 10000;
            
            // 一萬每年利息格式化為整數帶千位分隔符
            document.getElementById('annualTenThousandInterest').value = formatNumberWithCommas(Math.round(annualTenThousandInterest));
            // 一萬每月利息格式化為整數帶千位分隔符
            document.getElementById('monthlyTenThousandInterest').value = formatNumberWithCommas(Math.round(annualTenThousandInterest / 12));
        } else {
            document.getElementById('annualMillionInterest').value = '';
            document.getElementById('monthlyMillionInterest').value = '';
            document.getElementById('annualTenThousandInterest').value = '';
            document.getElementById('monthlyTenThousandInterest').value = '';
        }
        
        // 計算 NPV
        const npvValue = calculateNPV(
            payment,
            period,
            principal,
            monthlyCost
        );
        
        // 更新 NPV 顯示，帶千位分隔符
        const fundingCostInput = document.getElementById('fundingCost');
        if (hasAllRequiredValues) {
            fundingCostInput.value = formatNumberWithCommas(npvValue);
            
            // 更新警告樣式
            if (npvValue < 0) {
                fundingCostInput.classList.add('warning-text');
            } else {
                fundingCostInput.classList.remove('warning-text');
            }
        } else {
            fundingCostInput.value = '';
            fundingCostInput.classList.remove('warning-text');
        }

        // 新增：自動更新三個新欄位
        const principalValue = principal;
        const customerInvoiceField = document.getElementById('customerInvoice');
        const businessTaxField = document.getElementById('businessTax');
        const untaxedAmountField = document.getElementById('untaxedAmount');
        if (principalValue > 0) {
            // 客戶發票 = 本金
            customerInvoiceField.value = formatNumberWithCommas(Math.round(principalValue));
            // 營業稅 = 客戶發票 / 21，四捨五入至整數
            const businessTax = Math.round(principalValue / 21);
            businessTaxField.value = formatNumberWithCommas(businessTax);
            // 未稅金額 = 客戶發票 - 營業稅，顯示正整數
            const untaxedAmount = Math.max(0, Math.round(principalValue - businessTax));
            untaxedAmountField.value = formatNumberWithCommas(untaxedAmount);
        } else {
            customerInvoiceField.value = '';
            businessTaxField.value = '';
            untaxedAmountField.value = '';
        }

        // 新增：更新中文國字大寫欄位
        const chineseAmountField = document.getElementById('chineseAmount');
        if (principalValue > 0) {
            try {
                // 轉換客戶發票金額為中文國字大寫
                const chineseAmount = arabicToChineseNumber(principalValue, 'financial') + ' 圓整';
                chineseAmountField.innerHTML = chineseAmount; // 使用 innerHTML 以支持HTML標籤
            } catch (error) {
                console.error('中文轉換錯誤:', error);
                chineseAmountField.textContent = '轉換錯誤';
            }
        } else {
            chineseAmountField.innerHTML = ''; // 清空顯示
        }

        // 新增：更新總繳款中文國字大寫欄位
        const totalPaymentChineseField = document.getElementById('totalPaymentChinese');
        if (hasAllRequiredValues) {
            try {
                // 計算總繳款
                const totalPaymentValue = payment * period;
                const roundedTotalPayment = Math.round(totalPaymentValue);
                
                // 轉換總繳款為中文國字大寫
                const totalPaymentChinese = arabicToChineseNumber(roundedTotalPayment, 'financial') + ' 圓整';
                totalPaymentChineseField.innerHTML = totalPaymentChinese; // 使用 innerHTML 以支持HTML標籤
            } catch (error) {
                console.error('總繳款中文轉換錯誤:', error);
                totalPaymentChineseField.textContent = '轉換錯誤';
            }
        } else {
            totalPaymentChineseField.innerHTML = ''; // 清空顯示
        }

        // 在更新值之前保存舊值
        const oldValues = {};
        const fieldsToTrack = ['totalInterest', 'afterTaxRate', 'spread'];
        fieldsToTrack.forEach(field => {
            oldValues[field] = document.getElementById(field).value;
        });

        // 在更新後檢查變化
        fieldsToTrack.forEach(field => {
            const newValue = document.getElementById(field).value;
            if (oldValues[field] !== newValue) {
                animateValueChange(field);
            }
        });

        // 更新底部 footer 的利率顯示
        const footerAfterCommissionOnlyRate = document.getElementById('footerAfterCommissionOnlyRate');
        const footerAfterCommissionRate = document.getElementById('footerAfterCommissionRate');
        
        if (footerAfterCommissionOnlyRate) {
            // 從佣後利率輸入框取得值
            const afterCommissionOnlyValue = document.getElementById('afterCommissionOnlyRate').value;
            footerAfterCommissionOnlyRate.value = afterCommissionOnlyValue;
            
            // 如果有警告樣式，也套用到 footer
            if (document.getElementById('afterCommissionOnlyRate').classList.contains('warning-text')) {
                footerAfterCommissionOnlyRate.classList.add('warning-text');
            } else {
                footerAfterCommissionOnlyRate.classList.remove('warning-text');
            }
        }
        
        if (footerAfterCommissionRate) {
            // 從稅佣後利率輸入框取得值
            const afterCommissionValue = document.getElementById('afterCommissionRate').value;
            footerAfterCommissionRate.value = afterCommissionValue;
            
            // 如果有警告樣式，也套用到 footer
            if (document.getElementById('afterCommissionRate').classList.contains('warning-text')) {
                footerAfterCommissionRate.classList.add('warning-text');
            } else {
                footerAfterCommissionRate.classList.remove('warning-text');
            }
        }

        // ========== 自動保存當前計算數據 ==========
        // 說明：每次欄位更新時，自動將當前的計算數據保存到瀏覽器的本地儲存
        // 這樣即使頁面意外重新整理，數據也不會丟失
        try {
            // 收集需要保存的數據
            const autoSaveData = {
                period: document.getElementById('period').value,                    // 期數
                rate: document.getElementById('rate').value,                        // 稅前利率
                principal: document.getElementById('principal').value,              // 本金
                payment: document.getElementById('payment').value,                  // 期繳
                commission: document.getElementById('commission').value,            // 推廣費
                monthlyCost: document.getElementById('monthlyCost').value,          // 資金成本
                timestamp: new Date().toISOString(),                                // 保存時間戳記
                version: 'v1'                                                       // 版本號，方便未來升級
            };
            
            // 只有在有實際數據時才保存（避免保存空白數據）
            if (autoSaveData.period || autoSaveData.rate || autoSaveData.principal || autoSaveData.payment) {
                // 將數據保存到瀏覽器的本地儲存
                localStorage.setItem('loanCalculatorAutoSave', JSON.stringify(autoSaveData));
                
                // 在控制台記錄（方便除錯）
                console.log('自動保存計算數據:', autoSaveData);
            }
        } catch (error) {
            // 如果保存失敗，記錄錯誤但不影響正常功能
            console.error('自動保存失敗:', error);
        }
        // ========== 自動保存結束 ==========

    }

    // 在 clearField 函數之前添加這個新函數
    // 修改 validatePrincipalInput 函数
    function validatePrincipalInput(input) {
        // 移除负号，确保为正整数
        let value = Math.floor(Math.abs(parseFloat(input.value))) || 0;
        
        // 如果输入为0，设置为最小值1
        if (value <= 0) {
            value = 1;
        }
        
        // 更新输入框值并格式化
        input.value = formatNumberWithCommas(value);
        
        // 更新相关计算
        updateAllFields();
    }

    function clearField(fieldId) {
        vibrate();
        document.getElementById(fieldId).value = '';
    }

    function clearCommission() {
        vibrate();
        document.getElementById('commission').value = '';
        updateAllFields(); // 更新所有欄位
    }

    function adjustPeriod(delta) {
        vibrate();
        const periodField = document.getElementById('period');
        const currentValue = parseFloat(periodField.value) || 0;
        periodField.value = currentValue + delta;
        calculatePayment();
    }

    function setPeriod(value) {
        vibrate();
        document.getElementById('period').value = value;
        
        // 檢查其他必要輸入是否已有值
        const rate = parseFloat(document.getElementById('rate').value);
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, ''));
        
        if (!isNaN(rate) && !isNaN(principal) && rate > 0 && principal > 0) {
            calculatePayment(); // 只有當其他必要值都存在時才計算
        }
    }

    function adjustRate(delta) {
        vibrate();
        const rateField = document.getElementById('rate');
        const currentValue = parseFloat(rateField.value) || 0;
        const newRate = currentValue + delta;
        
        // 檢查新利率是否超過20%
        if (newRate > 20) {
            showToast('警告：利率超過20%，可能不符合一般貸款條件', true);
        }
        
        rateField.value = newRate.toFixed(4);
        calculatePayment();
    }

    function setRate(value) {
        vibrate();
        // 檢查新利率是否超過20%
        if (value > 20) {
            showToast('警告：利率超過20%，可能不符合一般貸款條件', true);
        }
        
        document.getElementById('rate').value = value;
        calculatePayment();
    }

    function validateCommissionInput(input) {
        // 移除小數點
        let value = parseInt(input.value) || 0;
        
        // 如果是負數，設為0
        if (value < 0) {
            value = 0;
        }
        
        // 更新輸入框的值為整數
        input.value = Math.floor(value);
        
        // 更新相關計算
        updateAllFields();
    }

    function adjustCommission(delta) {
        vibrate();
        const commissionField = document.getElementById('commission');
        
        // 獲取當前值，如果為空則預設為0，移除千位分隔符
        const currentValue = parseFloat(commissionField.value.replace(/,/g, '')) || 0;
        
        // 計算新值
        const newValue = Math.max(0, currentValue + delta);
        
        // 更新輸入框的值，使用 Math.floor 取整數並添加千位分隔符
        commissionField.value = formatNumberWithCommas(Math.floor(newValue));
        
        // 更新所有相關欄位的計算
        updateAllFields();
    }

    function setCommissionPercent(percent) {
        vibrate(); // 觸發震動
        
        // 獲取本金值（移除千位分隔符）
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, '')) || 0;
        
        if (principal <= 0) {
            showToast('請先輸入有效的本金金額', true);
            return;
        }
        
        // 計算對應百分比的金額，並無條件捨去至整數
        const commissionAmount = Math.floor(principal * (percent / 100));
        
        // 更新推廣輸入框的值，並添加千位分隔符
        document.getElementById('commission').value = formatNumberWithCommas(commissionAmount);
        
        // 更新相關欄位的計算
        updateAllFields();
    }

    // 修改 adjustPrincipal 函数
    function adjustPrincipal(delta) {
        vibrate();
        const principalField = document.getElementById('principal');
        // 移除千位分隔符后再转换为数字
        const currentValue = parseFloat(principalField.value.replace(/,/g, '')) || 0;
        // 计算新值，确保是正整数
        const newValue = Math.max(1, Math.floor(currentValue + delta)); // 确保最小值为1且为整数
        // 添加千位分隔符显示
        principalField.value = formatNumberWithCommas(newValue);
        calculatePayment();
        updateAllFields();
    }

    // 修改 roundPayment 函数以保持正数限制
    function roundPayment(direction, base) {
        vibrate();
        const paymentField = document.getElementById('payment');
        // 移除千位分隔符后再转换为数字
        let value = parseFloat(paymentField.value.replace(/,/g, '')) || 0;
        
        if (direction === 'down') {
            value = Math.floor(value / base) * base;
        } else {
            value = Math.ceil(value / base) * base;
        }
        
        // 确保值为正整数
        value = Math.max(1, Math.round(value));
        
        // 添加千位分隔符显示，不再保留小數位
        paymentField.value = formatNumberWithCommas(value);
        calculateRate(); // 确保这个调用能正确计算税前利率
    }

    // 修改 adjustPayment 函数
    function adjustPayment(delta) {
        vibrate();
        const paymentField = document.getElementById('payment');
        // 移除千位分隔符后再转换为数字
        const currentValue = parseFloat(paymentField.value.replace(/,/g, '')) || 0;
        // 计算新值，确保是正整数
        const newValue = Math.max(1, Math.round(currentValue + delta)); // 使用Math.round確保是整數
        // 添加千位分隔符显示，不再保留小數
        paymentField.value = formatNumberWithCommas(newValue);
        calculateRate(); // 确保这个调用能正确计算税前利率
    }

    function saveData() {
        const dataToSave = {
        period: document.getElementById('period').value,
        rate: document.getElementById('rate').value,
        principal: document.getElementById('principal').value,
        payment: document.getElementById('payment').value,
        commission: document.getElementById('commission').value
        };
        localStorage.setItem('loanCalculatorData', JSON.stringify(dataToSave));
        alert('資料已暫存！');
    }

    function generateQuote() {
        // 觸發振動反饋
        vibrate();
        
        // 檢查表單是否有必要數據
        const requiredFields = ['period', 'rate', 'principal', 'payment'];
        const missingFields = requiredFields.filter(fieldId => !document.getElementById(fieldId).value);
        
        if (missingFields.length > 0) {
            showToast('請先完成必要欄位（期數、利率、本金、期繳）的計算！');
            return;
        }
        
        // 顯示加載提示
        const loadingToast = document.createElement('div');
        loadingToast.id = 'screenshot-loading';
        loadingToast.innerHTML = '<div class="loading-content">正在生成報價卡片...</div>';
        document.body.appendChild(loadingToast);
        
        // 檢測是否為移動設備
        const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // 延遲一點時間以確保加載提示顯示
        setTimeout(() => {
            try {
                // 創建一個簡單的報價卡片 HTML
                const quoteHtml = generateQuoteCardHtml();
                
                // 創建一個用於顯示的報價卡片
                const shareQuoteCard = document.getElementById('shareQuoteCard');
                if (shareQuoteCard) {
                    shareQuoteCard.innerHTML = quoteHtml;
                }
                
                // 如果是移動設備，嘗試使用備用方法
                if (isMobileDevice) {
                    // 移動設備上使用備用方案：直接使用HTML版本
                    if (document.getElementById('screenshot-loading')) {
                        document.body.removeChild(document.getElementById('screenshot-loading'));
                    }
                    
                    document.getElementById('shareModalOverlay').style.display = 'flex';
                    
                    // 調整下載按鈕功能 - 在移動設備上提示用戶截圖
                    const downloadBtn = document.getElementById('downloadBtn');
                    if (downloadBtn) {
                        downloadBtn.textContent = '手動截圖';
                        downloadBtn.onclick = function() {
                            showToast('請使用系統截圖功能保存圖片', false, 3000);
                        };
                    }
                    
                    // 隱藏分享按鈕，因為沒有圖片
                    const shareBtn = document.getElementById('shareBtn');
                    if (shareBtn) {
                        shareBtn.style.display = 'none';
                    }
                    
                    const shareStatus = document.getElementById('shareStatus');
                    if (shareStatus) {
                        shareStatus.textContent = '請使用系統截圖功能保存此報價';
                        shareStatus.style.color = '#ff9c33';
                    }
                    
                    return;
                }
                
                // 以下是桌面版的處理邏輯
                // 創建一個臨時的容器來渲染報價卡片
                const tempContainer = document.createElement('div');
                tempContainer.id = 'tempQuoteContainer';
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.zIndex = '-1000';
                tempContainer.style.background = '#333333';
                tempContainer.style.width = '380px';
                tempContainer.style.padding = '10px';
                tempContainer.innerHTML = quoteHtml;
                document.body.appendChild(tempContainer);
                
                // 使用html2canvas將臨時容器轉為圖片
                html2canvas(tempContainer, {
                    backgroundColor: '#333333',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    width: 380,
                    height: 520
                }).then(canvas => {
                    // 生成圖片URL
                    const imageDataUrl = canvas.toDataURL('image/png');
                    
                    // 更新分享模態框中的內容為圖片
                    if (shareQuoteCard) {
                        shareQuoteCard.innerHTML = `<img src="${imageDataUrl}" style="width: 100%; max-width: 340px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">`;
                    }
                    
                    // 設置下載按鈕功能
                    const downloadBtn = document.getElementById('downloadBtn');
                    if (downloadBtn) {
                        downloadBtn.textContent = '💾 下載圖片';
                        downloadBtn.onclick = function() {
                            const link = document.createElement('a');
                            const dateTime = new Date().toISOString().replace(/[^0-9]/g, '').slice(0, 14);
                            link.download = `貸款計算報價_${dateTime}.png`;
                            link.href = imageDataUrl;
                            link.click();
                            showToast('圖片已保存至您的設備！');
                        };
                    }
                    
                    // 設置分享按鈕功能
                    const shareBtn = document.getElementById('shareBtn');
                    if (shareBtn) {
                        shareBtn.style.display = 'inline-block';
                        shareBtn.onclick = function() {
                            shareQuoteImage(imageDataUrl);
                        };
                    }
                    
                    // 移除加載提示並顯示分享模態框
                    if (document.getElementById('screenshot-loading')) {
                        document.body.removeChild(document.getElementById('screenshot-loading'));
                    }
                    
                    // 移除臨時容器
                    document.body.removeChild(tempContainer);
                    
                    // 顯示分享模態框
                    document.getElementById('shareModalOverlay').style.display = 'flex';
                    
                    // 重置狀態訊息
                    const shareStatus = document.getElementById('shareStatus');
                    if (shareStatus) {
                        shareStatus.textContent = '';
                    }
                    
                }).catch(error => {
                    console.error('生成報價卡片圖片時出錯:', error);
                    // 錯誤時的備用方案
                    handleGenerateError(shareQuoteCard, quoteHtml);
                });
            } catch (error) {
                console.error('準備報價卡片時出錯:', error);
                
                // 移除加載提示
                if (document.getElementById('screenshot-loading')) {
                    document.body.removeChild(document.getElementById('screenshot-loading'));
                }
                
                showToast('生成報價卡片時出錯，請稍後再試', true);
            }
        }, 100);
    }

    // 添加一個新的錯誤處理函數
    function handleGenerateError(shareQuoteCard, quoteHtml) {
        // 移除加載提示
        if (document.getElementById('screenshot-loading')) {
            document.body.removeChild(document.getElementById('screenshot-loading'));
        }
        
        // 回退到純HTML方式顯示
        if (shareQuoteCard) {
            shareQuoteCard.innerHTML = quoteHtml;
        }
        
        // 設置下載按鈕功能
        const downloadBtn = document.getElementById('downloadBtn');
        if (downloadBtn) {
            downloadBtn.textContent = '手動截圖';
            downloadBtn.onclick = function() {
                showToast('請使用系統截圖功能保存圖片', false, 3000);
            };
        }
        
        // 隱藏分享按鈕，因為沒有圖片
        const shareBtn = document.getElementById('shareBtn');
        if (shareBtn) {
            shareBtn.style.display = 'none';
        }
        
        // 顯示分享模態框
        document.getElementById('shareModalOverlay').style.display = 'flex';
        
        // 更新狀態訊息
        const shareStatus = document.getElementById('shareStatus');
        if (shareStatus) {
            shareStatus.textContent = '請使用系統截圖功能保存此報價';
            shareStatus.style.color = '#ff9c33';
        }
    }

    // 生成報價卡片 HTML
    function generateQuoteCardHtml() {
        // 獲取數據
        const period = document.getElementById('period').value;
        const rate = document.getElementById('rate').value;
        const principal = document.getElementById('principal').value;
        const payment = document.getElementById('payment').value;
        const totalInterest = document.getElementById('totalInterest').value;
        const afterTaxRate = document.getElementById('afterTaxRate').value;
        const commission = document.getElementById('commission').value;
        const afterCommissionRate = document.getElementById('afterCommissionRate').value;
        const currentTime = document.getElementById('currentTime').textContent;
        
        // 是否顯示推廣費用
        const showCommission = commission && commission !== "0";
        
        // 獲取當前主題的 CSS 變量
        const style = getComputedStyle(document.documentElement);
        const primaryColor = style.getPropertyValue('--primary-color').trim();
        const textColor = style.getPropertyValue('--text-color').trim();
        const accentColor = style.getPropertyValue('--accent-color').trim();
        const borderColor = style.getPropertyValue('--border-color').trim();
        const textMuted = style.getPropertyValue('--text-muted').trim();
        
        return `
            <div style="width: 90%; max-width: 340px; margin: 0 auto; background-color: ${primaryColor}; padding: 20px; border-radius: 15px; font-family: 'Microsoft JhengHei', Arial, sans-serif; color: ${textColor}; border: 2px solid ${accentColor}; box-sizing: border-box;">
                <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid ${accentColor}; padding-bottom: 10px;">
                    <div style="margin: 0; font-size: 22px; color: ${accentColor}; font-weight: bold;">貸款計算報價單</div>
                    <div style="font-size: 14px; margin-top: 8px;">${currentTime}</div>
                </div>
                
                <table style="width: 100%; border-collapse: separate; border-spacing: 0 10px; font-size: 16px;">
                    <tr>
                        <td style="width: 35%; text-align: right; padding-right: 15px; color: ${accentColor}; font-weight: bold; white-space: nowrap;">期數:</td>
                        <td style="text-align: left; font-weight: bold; width: 65%;">${period} 期</td>
                    </tr>
                    <tr>
                        <td style="width: 35%; text-align: right; padding-right: 15px; color: ${accentColor}; font-weight: bold; white-space: nowrap;">稅前利率:</td>
                        <td style="text-align: left; font-weight: bold; width: 65%;">${rate}%</td>
                    </tr>
                    <tr>
                        <td style="width: 35%; text-align: right; padding-right: 15px; color: ${accentColor}; font-weight: bold; white-space: nowrap;">本金:</td>
                        <td style="text-align: left; font-weight: bold; width: 65%;">${principal} 元</td>
                    </tr>
                    <tr>
                        <td style="width: 35%; text-align: right; padding-right: 15px; color: ${accentColor}; font-weight: bold; white-space: nowrap;">期繳:</td>
                        <td style="text-align: left; font-weight: bold; width: 65%;">${payment} 元/期</td>
                    </tr>
                    <tr>
                        <td style="width: 35%; text-align: right; padding-right: 15px; color: ${accentColor}; font-weight: bold; white-space: nowrap;">總利息:</td>
                        <td style="text-align: left; font-weight: bold; width: 65%;">${totalInterest} 元</td>
                    </tr>
                    <tr>
                        <td style="width: 35%; text-align: right; padding-right: 15px; color: ${accentColor}; font-weight: bold; white-space: nowrap;">稅後利率:</td>
                        <td style="text-align: left; font-weight: bold; width: 65%;">${afterTaxRate}%</td>
                    </tr>
                    ${showCommission ? `
                    <tr>
                        <td style="width: 35%; text-align: right; padding-right: 15px; color: ${accentColor}; font-weight: bold; white-space: nowrap;">推廣:</td>
                        <td style="text-align: left; font-weight: bold; width: 65%;">${commission} 元</td>
                    </tr>
                    ` : ''}
                    <tr>
                        <td style="width: 35%; text-align: right; padding-right: 15px; color: ${accentColor}; font-weight: bold; white-space: nowrap;">稅佣後利率:</td>
                        <td style="text-align: left; font-weight: bold; width: 65%;">${afterCommissionRate}%</td>
                    </tr>
                </table>
                
                <div style="text-align: center; margin-top: 15px; font-size: 14px; color: ${textMuted}; border-top: 1px dashed ${borderColor}; padding-top: 12px;">
                    報價後記得吃碗火雞肉飯唷！
                </div>
            </div>
        `;
    }

    // 隱藏分享模態框
    function hideShareModal() {
        const overlay = document.getElementById('shareModalOverlay');
        if (overlay) {
            overlay.style.display = 'none';
            
            // 重置內容，以便下次打開時重新生成
            const shareQuoteCard = document.getElementById('shareQuoteCard');
            if (shareQuoteCard) {
                shareQuoteCard.innerHTML = '';
            }
            
            // 重置狀態訊息
            const shareStatus = document.getElementById('shareStatus');
            if (shareStatus) {
                shareStatus.textContent = '';
            }
            
            // 重設按鈕文字
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
                downloadBtn.textContent = '💾 下載圖片';
            }
            
            // 重設分享按鈕顯示
            const shareBtn = document.getElementById('shareBtn');
            if (shareBtn) {
                shareBtn.style.display = 'inline-block';
            }
        }
    }

    // 分享報價圖片
    function shareQuoteImage(imageDataUrl) {
        const shareStatusElement = document.getElementById('shareStatus');
        
        // 檢查瀏覽器是否支持網頁分享API
        if (navigator.share) {
            try {
                // 首先嘗試分享URL
                navigator.share({
                    title: '貸款計算報價',
                    text: '這是我的貸款計算報價結果',
                    url: location.href
                })
                .then(() => {
                    shareStatusElement.textContent = '分享連結成功！';
                    setTimeout(() => {
                        shareStatusElement.textContent = '';
                    }, 2000);
                })
                .catch(err => {
                    console.error('分享連結失敗:', err);
                    
                    // 失敗後嘗試分享文件
                    shareQuoteImageAsFile(imageDataUrl, shareStatusElement);
                });
            } catch (error) {
                console.error('準備分享時出錯:', error);
                shareStatusElement.textContent = '分享過程中出錯，請使用下載選項。';
            }
        } else {
            // 如果瀏覽器不支持，顯示提示
            shareStatusElement.textContent = '您的設備不支持直接分享功能。請使用下載選項。';
        }
    }

    function shareQuoteImageAsFile(imageDataUrl, statusElement) {
        try {
            // 創建一個 Blob 對象
            fetch(imageDataUrl)
                .then(res => res.blob())
                .then(blob => {
                    // 創建文件對象
                    const dateTime = document.getElementById('currentTime').textContent.replace(/[^0-9]/g, '');
                    const fileName = `貸款計算報價_${dateTime}.png`;
                    const file = new File([blob], fileName, { type: 'image/png' });
                    
                    // 使用 Web Share API 分享文件
                    navigator.share({
                        title: '貸款計算報價',
                        files: [file]
                    })
                    .then(() => {
                        statusElement.textContent = '分享圖片成功！';
                        setTimeout(() => {
                            statusElement.textContent = '';
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('分享圖片失敗:', err);
                        statusElement.textContent = '分享圖片失敗，請使用下載選項。';
                    });
                })
                .catch(err => {
                    console.error('處理圖片失敗:', err);
                    statusElement.textContent = '處理圖片時出錯，請使用下載選項。';
                });
        } catch (error) {
            console.error('分享圖片出錯:', error);
            statusElement.textContent = '分享圖片失敗，請使用下載選項。';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 為相關輸入欄位添加事件監聽
        const inputIds = ['period', 'payment', 'principal', 'monthlyCost'];
        inputIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateAllFields);
                element.addEventListener('change', updateAllFields);
            }
        });
    });

    // 添加數值變化動畫
        function animateValueChange(elementId) {
        const element = document.getElementById(elementId);
        element.classList.remove('value-changed');
        void element.offsetWidth; // 觸發重繪
        element.classList.add('value-changed');
    }

    

    // 保存貸款計算結果
    // 保存貸款計算結果
    function saveLoanData() {
        const period = document.getElementById('period').value;
        const rate = document.getElementById('rate').value;
        const principal = document.getElementById('principal').value.replace(/,/g, '');
        const payment = document.getElementById('payment').value.replace(/,/g, '');
        const afterTaxRate = document.getElementById('afterTaxRate').value;
        const commission = document.getElementById('commission').value.replace(/,/g, '');
        const afterCommissionRate = document.getElementById('afterCommissionRate').value;
        
        // 檢查必要字段是否填寫
        if (!period || !rate || !principal || !payment) {
            showToast('請先完成必要欄位（期數、利率、本金、期繳）的計算！');
            return;
        }
        
        // 取得當前日期時間
        const loanDate = new Date();
        const year = loanDate.getFullYear();
        const month = String(loanDate.getMonth() + 1).padStart(2, '0');
        const date = String(loanDate.getDate()).padStart(2, '0');
        const hours = String(loanDate.getHours()).padStart(2, '0');     // 新增：小時（24小時制）
        const minutes = String(loanDate.getMinutes()).padStart(2, '0'); // 新增：分鐘
        const formattedDate = `${year}-${month}-${date} ${hours}:${minutes}`; // 修改：加入時間
        
        const loanData = {
            id: new Date().getTime(),
            date: formattedDate,
            period: period,
            rate: rate,
            principal: principal,
            payment: payment,
            afterTaxRate: afterTaxRate,
            commission: commission || '0',
            afterCommissionRate: afterCommissionRate,
            totalInterest: document.getElementById('totalInterest').value.replace(/,/g, ''),
            timestamp: new Date().toISOString(),
            note: ''
        };
        
        // 先儲存到本地
        let loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        loanHistory.push(loanData);
        localStorage.setItem('loanHistory', JSON.stringify(loanHistory));
        
        // 如果使用者已登入，同時儲存到雲端
        if (window.currentUser) {
            // 立即顯示儲存成功，背景進行雲端同步
            showToast('貸款計算結果已保存！');
            
            // 背景同步到雲端
            saveLoanToCloud(loanData)
                .then(() => {
                    console.log('已同步到雲端');
                    // 更新同步狀態
                    syncStatus.lastSyncTime = new Date();
                    updateSyncStatusUI();
                })
                .catch((error) => {
                    console.error('雲端儲存失敗:', error);
                    // 增加待同步計數
                    syncStatus.pendingChanges++;
                    updateSyncStatusUI();
                });
        } else {
            showToast('貸款計算結果已保存（本地）！');
        }
    }

    // 新增：儲存單筆資料到雲端
    function saveLoanToCloud(loanData) {
        if (!window.currentUser) return Promise.reject('使用者未登入');
        
        return db.collection('users')
            .doc(window.currentUser.uid)
            .collection('loanHistory')
            .doc(loanData.id.toString())
            .set(loanData);
    }

    // 從雲端同步貸款記錄
    function syncLoanHistory() {
        if (!window.currentUser) {
            console.log('使用者未登入，無法同步');
            return;
        }
        
        showToast('正在同步資料...');
        
        // 從雲端獲取資料
        db.collection('users')
            .doc(window.currentUser.uid)
            .collection('loanHistory')
            .get()
            .then((querySnapshot) => {
                const cloudData = [];
                querySnapshot.forEach((doc) => {
                    cloudData.push(doc.data());
                });
                
                // 獲取本地資料
                const localData = JSON.parse(localStorage.getItem('loanHistory') || '[]');
                
                // 合併資料（避免重複）
                const mergedData = mergeLoanHistory(localData, cloudData);
                
                // 更新本地儲存
                localStorage.setItem('loanHistory', JSON.stringify(mergedData));
                
                // 如果歷史記錄面板是開啟的，重新載入
                if (document.getElementById('historyPanel').style.display === 'block') {
                    loadHistoryData();
                }
                
                showToast(`同步完成！共 ${mergedData.length} 筆記錄`);
            })
            .catch((error) => {
                console.error('同步失敗:', error);
                showToast('同步失敗，請稍後再試', true);
            });
    }

    // 合併本地和雲端的貸款記錄
    function mergeLoanHistory(localData, cloudData) {
        const merged = [...localData];
        const existingIds = new Set(localData.map(item => item.id));
        
        cloudData.forEach(cloudItem => {
            if (!existingIds.has(cloudItem.id)) {
                merged.push(cloudItem);
            }
        });
        
        // 按時間戳排序
        merged.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        return merged;
    }

    // 自動同步功能
    function autoSync() {
        // 如果未登入或正在同步中，則跳過
        if (!window.currentUser || syncStatus.isSyncing) {
            return;
        }
        
        // 設定同步狀態
        syncStatus.isSyncing = true;
        updateSyncStatusUI();
        
        // 從雲端獲取最新資料
        db.collection('users')
            .doc(window.currentUser.uid)
            .collection('loanHistory')
            .get()
            .then((querySnapshot) => {
                const cloudData = [];
                const cloudDataMap = new Map();
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    cloudData.push(data);
                    cloudDataMap.set(data.id, data);
                });
                
                // 獲取本地資料
                const localData = JSON.parse(localStorage.getItem('loanHistory') || '[]');
                const localDataMap = new Map();
                localData.forEach(item => {
                    localDataMap.set(item.id, item);
                });
                
                // 智慧合併資料（以時間戳為準）
                const mergedData = smartMergeLoanHistory(localDataMap, cloudDataMap);
                
                // 更新本地儲存
                localStorage.setItem('loanHistory', JSON.stringify(mergedData));
                
                // 更新同步狀態
                syncStatus.isSyncing = false;
                syncStatus.lastSyncTime = new Date();
                syncStatus.pendingChanges = 0;
                updateSyncStatusUI();
                
                // 如果歷史記錄面板是開啟的，重新載入
                if (document.getElementById('historyPanel').style.display === 'block') {
                    loadHistoryData();
                }
                
                console.log(`自動同步完成，共 ${mergedData.length} 筆記錄`);
            })
            .catch((error) => {
                console.error('自動同步失敗:', error);
                syncStatus.isSyncing = false;
                updateSyncStatusUI();
            });
    }

    // 智慧合併貸款記錄（處理衝突）
    function smartMergeLoanHistory(localDataMap, cloudDataMap) {
        const merged = [];
        const processedIds = new Set();
        
        // 處理所有記錄
        const allIds = new Set([...localDataMap.keys(), ...cloudDataMap.keys()]);
        
        allIds.forEach(id => {
            const localItem = localDataMap.get(id);
            const cloudItem = cloudDataMap.get(id);
            
            if (localItem && cloudItem) {
                // 兩邊都有相同ID的記錄，比較時間戳
                const localTime = new Date(localItem.timestamp || 0).getTime();
                const cloudTime = new Date(cloudItem.timestamp || 0).getTime();
                
                if (localTime > cloudTime) {
                    // 本地較新，使用本地資料並更新雲端
                    merged.push(localItem);
                    updateCloudRecord(localItem);
                } else if (cloudTime > localTime) {
                    // 雲端較新，使用雲端資料
                    merged.push(cloudItem);
                } else {
                    // 時間相同，比較備註長度（假設較長的備註包含更多資訊）
                    if ((localItem.note || '').length >= (cloudItem.note || '').length) {
                        merged.push(localItem);
                    } else {
                        merged.push(cloudItem);
                    }
                }
            } else if (localItem) {
                // 只有本地有，上傳到雲端
                merged.push(localItem);
                updateCloudRecord(localItem);
            } else if (cloudItem) {
                // 只有雲端有，加入本地
                merged.push(cloudItem);
            }
        });
        
        // 按時間戳排序（最新的在前）
        merged.sort((a, b) => {
            const timeA = new Date(a.timestamp || 0).getTime();
            const timeB = new Date(b.timestamp || 0).getTime();
            return timeB - timeA;
        });
        
        return merged;
    }

    // 更新單筆雲端記錄
    function updateCloudRecord(record) {
        if (!window.currentUser) return;
        
        db.collection('users')
            .doc(window.currentUser.uid)
            .collection('loanHistory')
            .doc(record.id.toString())
            .set(record)
            .catch(error => {
                console.error('更新雲端記錄失敗:', error);
                syncStatus.pendingChanges++;
                updateSyncStatusUI();
            });
    }

    // 更新同步狀態UI
    function updateSyncStatusUI() {
        const syncIcon = document.getElementById('syncIcon');
        const syncStatusText = document.getElementById('syncStatusText');
        const syncTimeText = document.getElementById('syncTimeText');
        const syncContainer = document.getElementById('syncStatusContainer');
        const manualSyncBtn = document.getElementById('manualSyncBtn');
        
        if (!syncIcon || !syncStatusText || !syncTimeText || !syncContainer) return;
        
        // 根據狀態更新圖示和文字
        if (!syncStatus.isOnline) {
            // 離線狀態
            syncIcon.innerHTML = '<span style="font-size: 16px;">📵</span>';
            syncStatusText.textContent = '離線模式';
            syncTimeText.textContent = '等待網路連線';
            syncContainer.style.backgroundColor = 'rgba(var(--error-color-rgb), 0.1)';
            if (manualSyncBtn) manualSyncBtn.disabled = true;
        } else if (syncStatus.isSyncing) {
            // 同步中
            syncIcon.innerHTML = '<span style="font-size: 16px; animation: spin 1s linear infinite;">🔄</span>';
            syncStatusText.textContent = '同步中...';
            syncTimeText.textContent = '請稍候';
            syncContainer.style.backgroundColor = 'rgba(var(--info-color-rgb), 0.2)';
            if (manualSyncBtn) manualSyncBtn.disabled = true;
        } else if (syncStatus.pendingChanges > 0) {
            // 有待同步的變更
            syncIcon.innerHTML = '<span style="font-size: 16px;">⚠️</span>';
            syncStatusText.textContent = `有 ${syncStatus.pendingChanges} 項待同步`;
            syncTimeText.textContent = formatSyncTime();
            syncContainer.style.backgroundColor = 'rgba(var(--warning-color-rgb), 0.1)';
            if (manualSyncBtn) manualSyncBtn.disabled = false;
        } else {
            // 已同步
            syncIcon.innerHTML = '<span style="font-size: 16px;">✅</span>';
            syncStatusText.textContent = '已同步';
            syncTimeText.textContent = formatSyncTime();
            syncContainer.style.backgroundColor = 'rgba(var(--success-color-rgb), 0.1)';
            if (manualSyncBtn) manualSyncBtn.disabled = false;
        }
    }

    // 格式化同步時間顯示
    function formatSyncTime() {
        if (!syncStatus.lastSyncTime) {
            return '從未同步';
        }
        
        const now = new Date();
        const diff = now - syncStatus.lastSyncTime;
        const minutes = Math.floor(diff / 60000);
        
        if (minutes < 1) {
            return '剛剛同步';
        } else if (minutes < 60) {
            return `${minutes} 分鐘前同步`;
        } else {
            const hours = Math.floor(minutes / 60);
            return `${hours} 小時前同步`;
        }
    }

    // 手動同步
    function manualSync() {
        vibrate();
        autoSync();
    }

    // 定期更新同步時間顯示
    setInterval(() => {
        if (window.currentUser && document.getElementById('syncTimeText')) {
            document.getElementById('syncTimeText').textContent = formatSyncTime();
        }
    }, 60000); // 每分鐘更新一次

    // 將本地資料上傳到雲端
    function uploadLocalDataToCloud() {
        if (!window.currentUser) return;
        
        const localData = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        if (localData.length === 0) return;
        
        showToast('正在上傳本地資料到雲端...');
        
        // 批次寫入
        const batch = db.batch();
        
        localData.forEach(loan => {
            const docRef = db.collection('users')
                .doc(window.currentUser.uid)
                .collection('loanHistory')
                .doc(loan.id.toString());
            batch.set(docRef, loan);
        });
        
        batch.commit()
            .then(() => {
                showToast('本地資料已上傳到雲端！');
            })
            .catch((error) => {
                console.error('上傳失敗:', error);
                showToast('上傳失敗，請稍後再試', true);
            });
    }

    // 全局變量，用於存儲比較的貸款數據
    let compareLoanData = null;

    // 比較貸款函數
    function compareLoan() {
        // 檢查是否有足夠的數據進行比較
        const period = document.getElementById('period').value;
        const rate = document.getElementById('rate').value;
        const principal = document.getElementById('principal').value.replace(/,/g, '');
        const payment = document.getElementById('payment').value.replace(/,/g, '');
        
        if (!period || !rate || !principal || !payment) {
            showToast('請先完成必要欄位（期數、利率、本金、期繳）的計算！');
            return;
        }
        
        // 獲取當前貸款數據
        const currentLoan = {
            id: 'current',
            period: period,
            rate: rate,
            principal: principal,
            payment: payment,
            afterTaxRate: document.getElementById('afterTaxRate').value,
            commission: document.getElementById('commission').value.replace(/,/g, '') || '0',
            afterCommissionRate: document.getElementById('afterCommissionRate').value,
            totalInterest: document.getElementById('totalInterest').value.replace(/,/g, ''),
            date: '目前計算'
        };
        
        // 獲取歷史記錄
        const loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        
        if (loanHistory.length === 0) {
            showToast('尚無歷史記錄可比較，請先保存當前計算');
            return;
        }
        
        // 顯示貸款選擇對話框
        showLoanSelectionModal(currentLoan, loanHistory);
        
        // 觸發震動反饋
        vibrate();
    }

    // 顯示貸款選擇對話框
    function showLoanSelectionModal(currentLoan, loanHistory) {
        // 按日期排序，最新的在前面
        loanHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // 創建模態框 HTML
        const modalHTML = `
        <!-- 固定頂部區域 -->
        <div class="loan-selection-header">
            <!-- 頂部標題列 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin: 0; color: var(--text-color); font-size: 20px;">選擇比較方案</h3>
                <button class="close-btn" onclick="closeCustomModal('loanSelectionModal')" style="
                    background: none;
                    border: none;
                    color: var(--text-color);
                    font-size: 28px;
                    cursor: pointer;
                    padding: 0;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    transition: all 0.2s ease;
                " onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.1)';" 
                onmouseout="this.style.backgroundColor='transparent';">×</button>
            </div>
            
            <!-- 當前計算卡片 - 重新設計以顯示更多資訊 -->
            <div class="current-loan-card">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                    <span style="font-size: 20px;">📊</span>
                    <span style="font-size: 16px; font-weight: 500;">目前計算結果</span>
                </div>
                <!-- 使用3列網格佈局，優化手機顯示空間 -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <!-- 本金 -->
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px;
                        border-radius: 6px;
                        text-align: center;
                    ">
                        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 2px;">本金</div>
                        <div style="font-size: 14px; font-weight: bold; color: #fff;">${formatNumberWithCommas(currentLoan.principal)}</div>
                    </div>
                    <!-- 期數 -->
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px;
                        border-radius: 6px;
                        text-align: center;
                    ">
                        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 2px;">期數</div>
                        <div style="font-size: 14px; font-weight: bold; color: #fff;">${currentLoan.period} 期</div>
                    </div>
                    <!-- 稅前利率 -->
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px;
                        border-radius: 6px;
                        text-align: center;
                    ">
                        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 2px;">稅前利率</div>
                        <div style="font-size: 14px; font-weight: bold; color: #fff;">${currentLoan.rate}%</div>
                    </div>
                    <!-- 期繳 -->
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px;
                        border-radius: 6px;
                        text-align: center;
                    ">
                        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 2px;">期繳</div>
                        <div style="font-size: 14px; font-weight: bold; color: #fff;">${formatNumberWithCommas(currentLoan.payment)}</div>
                    </div>
                    <!-- 推廣 - 新增欄位 -->
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px;
                        border-radius: 6px;
                        text-align: center;
                    ">
                        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 2px;">推廣</div>
                        <div style="font-size: 14px; font-weight: bold; color: #fff;">${formatNumberWithCommas(currentLoan.commission)}</div>
                    </div>
                    <!-- 稅佣後利率 - 使用標準樣式，確保文字清晰可讀 -->
                    <div style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px;
                        border-radius: 6px;
                        text-align: center;
                    ">
                        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 2px;">稅佣後利率</div>
                        <div style="font-size: 14px; font-weight: bold; color: #fff;">${currentLoan.afterCommissionRate}%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 可滾動的歷史記錄區域 -->
        <div class="history-scroll-container">
            <!-- 調整頂部間距，避免被上方欄位遮擋 -->
            <div style="margin-top: 20px; margin-bottom: 16px; color: var(--text-muted); font-size: 14px;">
                請選擇要比較的歷史方案：
            </div>
            
            ${loanHistory.length === 0 ? 
                '<div style="text-align: center; padding: 40px; color: var(--text-muted);">尚無歷史記錄</div>' :
                loanHistory.map((loan, index) => `
                    <div class="loan-card" onclick="selectLoanForComparison(${loan.id})">
                        <div class="loan-card-header">
                            <div class="loan-card-date">
                                <span style="font-size: 16px;">📅</span>
                                <span>${formatDate(loan.date)}</span>
                            </div>
                            <!-- 改為顯示簡潔的方案標識 -->
                            <div class="loan-card-rate" style="
                                background: var(--secondary-color);
                                color: var(--text-color);
                                border: 1px solid var(--accent-color);
                            ">方案 ${index + 1}</div>
                        </div>
                        
                        <!-- 重新設計歷史卡片詳情，與目前計算結果保持一致 -->
                        <div style="
                            display: grid; 
                            grid-template-columns: repeat(3, 1fr); 
                            gap: 8px;
                            margin-top: 12px;
                        ">
                            <!-- 本金 -->
                            <div style="
                                background: rgba(255, 255, 255, 0.05);
                                padding: 6px;
                                border-radius: 4px;
                                text-align: center;
                            ">
                                <div style="font-size: 10px; opacity: 0.7; margin-bottom: 2px;">本金</div>
                                <div style="font-size: 13px; font-weight: 600;">${formatNumberWithCommas(loan.principal)}</div>
                            </div>
                            <!-- 期數 -->
                            <div style="
                                background: rgba(255, 255, 255, 0.05);
                                padding: 6px;
                                border-radius: 4px;
                                text-align: center;
                            ">
                                <div style="font-size: 10px; opacity: 0.7; margin-bottom: 2px;">期數</div>
                                <div style="font-size: 13px; font-weight: 600;">${loan.period} 期</div>
                            </div>
                            <!-- 稅前利率 -->
                            <div style="
                                background: rgba(255, 255, 255, 0.05);
                                padding: 6px;
                                border-radius: 4px;
                                text-align: center;
                            ">
                                <div style="font-size: 10px; opacity: 0.7; margin-bottom: 2px;">稅前利率</div>
                                <div style="font-size: 13px; font-weight: 600;">${loan.rate}%</div>
                            </div>
                            <!-- 期繳 -->
                            <div style="
                                background: rgba(255, 255, 255, 0.05);
                                padding: 6px;
                                border-radius: 4px;
                                text-align: center;
                            ">
                                <div style="font-size: 10px; opacity: 0.7; margin-bottom: 2px;">期繳</div>
                                <div style="font-size: 13px; font-weight: 600;">${formatNumberWithCommas(loan.payment)}</div>
                            </div>
                            <!-- 推廣 -->
                            <div style="
                                background: rgba(255, 255, 255, 0.05);
                                padding: 6px;
                                border-radius: 4px;
                                text-align: center;
                            ">
                                <div style="font-size: 10px; opacity: 0.7; margin-bottom: 2px;">推廣</div>
                                <div style="font-size: 13px; font-weight: 600;">${formatNumberWithCommas(loan.commission)}</div>
                            </div>
                            <!-- 稅佣後利率 - 使用標準樣式 -->
                            <div style="
                                background: rgba(255, 255, 255, 0.05);
                                padding: 6px;
                                border-radius: 4px;
                                text-align: center;
                            ">
                                <div style="font-size: 10px; opacity: 0.7; margin-bottom: 2px;">稅佣後利率</div>
                                <div style="font-size: 13px; font-weight: 600;">${loan.afterCommissionRate}%</div>
                            </div>
                        </div>
                        
                        ${loan.note ? `
                        <!-- 備註區域 - 改善文字可讀性 -->
                        <div style="
                            margin-top: 10px;
                            padding: 10px;
                            background: rgba(255, 255, 255, 0.08);
                            border-radius: 6px;
                            border-left: 3px solid var(--accent-color);
                        ">
                            <div style="
                                font-size: 14px;
                                color: var(--text-color);
                                font-style: normal;
                                line-height: 1.4;
                                opacity: 0.9;
                            ">
                                📝 ${loan.note}
                            </div>
                        </div>
                    ` : ''}
                        
                        <button class="select-loan-btn">選擇此方案</button>
                    </div>
                `).join('')
            }
        </div>
        `;
        
        // 將當前貸款數據保存在 localStorage 中
        localStorage.setItem('currentLoanForComparison', JSON.stringify(currentLoan));
        
        // 創建並顯示全螢幕模態框
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.id = 'loanSelectionModal';
        modalOverlay.style.cssText = `
            display: flex; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: var(--primary-color); 
            z-index: 9999;
            animation: fadeIn 0.3s ease-out;
        `;
        modalOverlay.innerHTML = `
            <div class="modal-container" style="
                width: 100%; 
                height: 100%; 
                max-width: 100%; 
                max-height: 100%; 
                margin: 0; 
                border-radius: 0; 
                display: flex; 
                flex-direction: column;
                background: var(--primary-color);
            ">${modalHTML}</div>
        `;

        // 添加到網頁
        document.body.appendChild(modalOverlay);
        
        // 觸發震動反饋
        vibrate();
    }

    // 選擇貸款進行比較
    function selectLoanForComparison(loanId) {
        // 獲取當前貸款數據
        const currentLoan = JSON.parse(localStorage.getItem('currentLoanForComparison'));
        
        // 獲取選中的歷史貸款數據
        const loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        const selectedLoan = loanHistory.find(loan => loan.id === loanId);
        
        if (!selectedLoan) {
            showToast('找不到選中的貸款記錄');
            return;
        }
        
        // 關閉選擇對話框
        closeCustomModal('loanSelectionModal');
        
        // 顯示比較視圖
        showMultiLoanComparison([currentLoan, selectedLoan]);
    }

    // 顯示多貸款比較視圖
    function showMultiLoanComparison(loans) {
        vibrate();
        
        // 確保至少有2個貸款方案
        if (loans.length < 2) {
            showToast('至少需要2個貸款方案進行比較');
            return;
        }
        
        // 關閉歷史記錄面板
        document.getElementById('historyPanel').style.display = 'none';
        
        // 計算比較結果
        const comparisonReport = generateComparisonReport(loans);
        
        // 生成表格HTML
        let tableHTML = `
        <div class="comparison-tabs">
            <button class="tab-btn active" onclick="switchComparisonTab('table')">表格比較</button>
            <button class="tab-btn" onclick="switchComparisonTab('report')">分析報告</button>
        </div>
        
        <div id="table-tab" class="comparison-tab-content">
            <table class="comparison-table">
                <tr>
                    <th>項目</th>
                    ${loans.map((loan, index) => `<th>${loan.id === 'current' ? '目前計算' : '方案 ' + (index + 1)}</th>`).join('')}
                </tr>
                <tr>
                    <td>日期</td>
                    ${loans.map(loan => `<td>${loan.id === 'current' ? '目前計算' : formatDate(loan.date)}</td>`).join('')}
                </tr>
                <tr>
                    <td>期數</td>
                    ${loans.map(loan => `<td>${loan.period}</td>`).join('')}
                </tr>
                <tr>
                    <td>稅前利率</td>
                    ${loans.map(loan => `<td>${loan.rate}%</td>`).join('')}
                </tr>
                <tr>
                    <td>本金</td>
                    ${loans.map(loan => `<td>${formatNumberWithCommas(loan.principal)}</td>`).join('')}
                </tr>
                <tr>
                    <td>期繳</td>
                    ${loans.map(loan => `<td>${formatNumberWithCommas(loan.payment)}</td>`).join('')}
                </tr>
                <tr>
                    <td>總利息</td>
                    ${loans.map(loan => `<td>${formatNumberWithCommas(loan.totalInterest)}</td>`).join('')}
                </tr>
                <tr>
                    <td>稅後利率</td>
                    ${loans.map(loan => `<td>${loan.afterTaxRate}%</td>`).join('')}
                </tr>
                <tr>
                    <td>推廣費</td>
                    ${loans.map(loan => `<td>${formatNumberWithCommas(loan.commission)}</td>`).join('')}
                </tr>
                <tr class="highlight-row">
                    <td>稅佣後利率</td>
                    ${loans.map(loan => `<td>${loan.afterCommissionRate}%</td>`).join('')}
                </tr>
                <tr class="highlight-row">
                    <td>總還款</td>
                    ${loans.map(loan => {
                        const totalPayment = parseFloat(loan.payment) * parseFloat(loan.period);
                        /* 修改為只顯示整數，不顯示小數 */
                        return `<td>${formatNumberWithCommas(Math.round(totalPayment))}</td>`;
                    }).join('')}
                </tr>

                <!-- 新增備註比較欄位 -->
                <tr>
                    <td style="vertical-align: top;">備註</td>
                    ${loans.map(loan => {
                        /* 顯示備註內容，如果沒有備註則顯示"無" */
                        const noteContent = loan.note || '無';
                        return `<td style="
                            font-size: 13px;
                            line-height: 1.4;
                            padding: 10px;
                            vertical-align: top;
                        ">${noteContent}</td>`;
                    }).join('')}
                </tr>

            </table>
        </div>
        
        <div id="report-tab" class="comparison-tab-content" style="display: none;">
            <div class="comparison-report">
                <h4>方案比較分析報告</h4>
                ${comparisonReport.map(item => `
                    <div class="report-item">
                        <div class="report-title">${item.title}</div>
                        <div class="report-content">${item.content}</div>
                    </div>
                `).join('')}
            </div>
        </div>
        `;
        
        // 創建模態框
        const modalHTML = `
        <!-- 貸款方案比較頁面標題區域 - 新增回上頁按鈕 -->
        <div class="modal-header" style="position: relative;">
            <!-- 左側：回上頁按鈕 -->
            <button onclick="backToLoanSelection()" style="
                position: absolute;
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: var(--text-color);
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 4px;
            " onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.2)'; this.style.borderColor='var(--accent-color)';" 
            onmouseout="this.style.backgroundColor='rgba(255, 255, 255, 0.1)'; this.style.borderColor='rgba(255, 255, 255, 0.2)';">
                <span style="font-size: 16px;">←</span>
                <span>回上頁</span>
            </button>
            
            <!-- 中間：標題 -->
            <h3 style="margin: 0; flex: 1; text-align: center;">貸款方案比較</h3>
            
            <!-- 右側：關閉按鈕 -->
            <button class="close-btn" onclick="closeCustomModal('multiLoanComparisonModal')">×</button>
        </div>
        <div class="modal-content" style="padding: 10px; flex: 1; overflow-y: auto; background-color: var(--primary-color);">
            ${tableHTML}
        </div>
        `;
        
        // 創建並顯示全螢幕模態框
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.id = 'multiLoanComparisonModal';
        modalOverlay.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--primary-color); z-index: 9999;';
        modalOverlay.innerHTML = `<div class="modal-container" style="width: 100%; height: 100%; max-width: 100%; max-height: 100%; margin: 0; border-radius: 0; display: flex; flex-direction: column;">${modalHTML}</div>`;

        // 添加到網頁
        document.body.appendChild(modalOverlay);

        // 點擊背景關閉（移除此功能以確保全螢幕）
        // modalOverlay.addEventListener('click', function(event) {
        //     if (event.target === this) {
        //         closeCustomModal('multiLoanComparisonModal');
        //     }
        // });

        vibrate();
        
        // 添加樣式
        const style = document.createElement('style');
        style.textContent = `
            .comparison-tabs {
                display: flex;
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 15px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-btn {
                background: none;
                border: none;
                padding: 10px 15px;
                color: var(--text-color);
                cursor: pointer;
                transition: all 0.3s ease;
                white-space: nowrap;
                border-bottom: 2px solid transparent;
            }
            
            .tab-btn.active {
                color: var(--accent-color);
                border-bottom: 2px solid var(--accent-color);
            }
            
            .comparison-tab-content {
                padding: 10px 0;
            }
            
            /* 比較表格樣式 - 與整體設計風格統一 */
            .comparison-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                font-size: 14px;
                background: var(--secondary-color);
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 4px 12px var(--shadow-color);
            }

            /* 表格標題和單元格樣式 */
            .comparison-table th, 
            .comparison-table td {
                padding: 12px 10px;
                text-align: center;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            /* 表格標題樣式 - 深色背景 */
            .comparison-table th {
                background: linear-gradient(135deg, 
                    rgba(var(--accent-color-rgb), 0.2) 0%, 
                    rgba(var(--accent-color-rgb), 0.1) 100%);
                color: var(--text-color);
                font-weight: 600;
                position: sticky;
                top: 0;
                z-index: 10;
                font-size: 15px;
            }

            /* 第一列（項目名稱）特殊樣式 */
            .comparison-table td:first-child {
                text-align: left;
                font-weight: 600;
                color: var(--accent-color);
                background: rgba(255, 255, 255, 0.03);
                padding-left: 15px;
            }

            /* 表格列懸停效果 */
            .comparison-table tr:hover td {
                background-color: rgba(255, 255, 255, 0.05);
                transition: background-color 0.2s ease;
            }

            /* 強調列樣式 - 用於重要數據 */
            .highlight-row td {
                background-color: rgba(var(--accent-color-rgb), 0.08);
                font-weight: 600;
            }

            /* 最後一列無底部邊框 */
            .comparison-table tr:last-child td {
                border-bottom: none;
            }
    
            /* 分析報告容器樣式 */
            .comparison-report {
                padding: 15px;
                background: var(--secondary-color);
                border-radius: 12px;
                margin-top: 10px;
            }

            /* 報告項目樣式 */
            .report-item {
                margin-bottom: 16px;
                padding: 12px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                border-left: 3px solid var(--accent-color);
            }

            /* 報告標題樣式 */
            .report-title {
                font-weight: 600;
                color: var(--accent-color);
                margin-bottom: 8px;
                font-size: 15px;
            }

            /* 報告內容樣式 */
            .report-content {
                line-height: 1.6;
                color: var(--text-color);
                opacity: 0.9;
                font-size: 14px;
            }

            /* 最後一個報告項目無底部間距 */
            .report-item:last-child {
                margin-bottom: 0;
            }
        `;
        document.head.appendChild(style);
    }

    // 切換比較標籤頁
    function switchComparisonTab(tabName) {
        vibrate();
        
        // 隱藏所有標籤內容
        const tabContents = document.querySelectorAll('.comparison-tab-content');
        tabContents.forEach(tab => {
            tab.style.display = 'none';
        });
        
        // 移除所有標籤按鈕的活動狀態
        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(btn => {
            btn.classList.remove('active');
        });
        
        // 顯示選中的標籤內容並激活對應按鈕
        document.getElementById(`${tabName}-tab`).style.display = 'block';
        document.querySelector(`.tab-btn[onclick="switchComparisonTab('${tabName}')"]`).classList.add('active');
    }

    function generateComparisonReport(loans) {
        // 初始化報告項目
        const report = [];
        
        // 1. 最低稅佣後利率
        const minRateIndex = loans.reduce((minIdx, loan, idx, arr) => 
            parseFloat(loan.afterCommissionRate) < parseFloat(arr[minIdx].afterCommissionRate) ? idx : minIdx, 0);
        
        report.push({
            title: '最低實際利率',
            content: `方案 ${loans[minRateIndex].id === 'current' ? '目前計算' : (loans.indexOf(loans[minRateIndex]) + 1)} 的稅佣後利率為 ${loans[minRateIndex].afterCommissionRate}%，是所有方案中最低的。`
        });
        
        // 2. 最低月付款
        const minPaymentIndex = loans.reduce((minIdx, loan, idx, arr) => 
            parseFloat(loan.payment) < parseFloat(arr[minIdx].payment) ? idx : minIdx, 0);
        
        report.push({
            title: '最低期繳金額',
            content: `方案 ${loans[minPaymentIndex].id === 'current' ? '目前計算' : (loans.indexOf(loans[minPaymentIndex]) + 1)} 的期繳金額為 ${formatNumberWithCommas(loans[minPaymentIndex].payment)} 元，是所有方案中最低的。`
        });
        
        // 3. 總利息比較
        const minInterestIndex = loans.reduce((minIdx, loan, idx, arr) => 
            parseFloat(loan.totalInterest) < parseFloat(arr[minIdx].totalInterest) ? idx : minIdx, 0);
        
        report.push({
            title: '最低總利息',
            content: `方案 ${loans[minInterestIndex].id === 'current' ? '目前計算' : (loans.indexOf(loans[minInterestIndex]) + 1)} 的總利息為 ${formatNumberWithCommas(loans[minInterestIndex].totalInterest)} 元，是所有方案中最低的。`
        });
        
        // 4. 總還款比較
        const totalPayments = loans.map(loan => parseFloat(loan.payment) * parseFloat(loan.period));
        const minTotalPaymentIndex = totalPayments.reduce((minIdx, total, idx, arr) => 
            total < arr[minIdx] ? idx : minIdx, 0);
        
        report.push({
            title: '最低總還款',
            content: `方案 ${loans[minTotalPaymentIndex].id === 'current' ? '目前計算' : (loans.indexOf(loans[minTotalPaymentIndex]) + 1)} 的總還款金額為 ${formatNumberWithCommas(totalPayments[minTotalPaymentIndex].toFixed(2))} 元，是所有方案中最低的。`
        });
        
        // 5. 本金差異
        if (loans.length === 2) {
            const principalDiff = Math.abs(parseFloat(loans[0].principal) - parseFloat(loans[1].principal));
            const principalPctDiff = (principalDiff / parseFloat(loans[0].principal) * 100).toFixed(2);
            
            report.push({
                title: '本金差異',
                content: `兩個方案的本金相差 ${formatNumberWithCommas(principalDiff)} 元（${principalPctDiff}%）。`
            });
        }
        
        // 6. 期數差異
        const periodRange = loans.map(loan => parseInt(loan.period));
        const minPeriod = Math.min(...periodRange);
        const maxPeriod = Math.max(...periodRange);
        
        if (minPeriod !== maxPeriod) {
            report.push({
                title: '期數差異',
                content: `方案中的期數從 ${minPeriod} 期到 ${maxPeriod} 期不等，差異為 ${maxPeriod - minPeriod} 期。`
            });
        }
        
        // 7. 綜合建議
        let recommendationText = '';
        
        // 基於利率、期繳、總利息綜合考量
        if (minRateIndex === minTotalPaymentIndex) {
            recommendationText = `方案 ${loans[minRateIndex].id === 'current' ? '目前計算' : (loans.indexOf(loans[minRateIndex]) + 1)} 同時具有最低的實際利率和最低的總還款金額，綜合來看是最優選擇。`;
        } else if (minRateIndex === minInterestIndex) {
            recommendationText = `方案 ${loans[minRateIndex].id === 'current' ? '目前計算' : (loans.indexOf(loans[minRateIndex]) + 1)} 具有最低的實際利率和最低的總利息，從長期成本考量是較佳選擇。`;
        } else if (minPaymentIndex === minTotalPaymentIndex) {
            recommendationText = `方案 ${loans[minPaymentIndex].id === 'current' ? '目前計算' : (loans.indexOf(loans[minPaymentIndex]) + 1)} 同時具有最低的期繳金額和最低的總還款金額，對於現金流敏感的情況是較佳選擇。`;
        } else {
            recommendationText = `各方案各有優劣：方案 ${loans[minRateIndex].id === 'current' ? '目前計算' : (loans.indexOf(loans[minRateIndex]) + 1)} 利率最低；方案 ${loans[minPaymentIndex].id === 'current' ? '目前計算' : (loans.indexOf(loans[minPaymentIndex]) + 1)} 期繳最低；方案 ${loans[minInterestIndex].id === 'current' ? '目前計算' : (loans.indexOf(loans[minInterestIndex]) + 1)} 總利息最低。建議根據個人財務狀況選擇最適合的方案。`;
        }
        
        report.push({
            title: '綜合建議',
            content: recommendationText
        });
        
        return report;
    }


    // 顯示貸款比較模態框
    function showLoanComparisonModal(loan1, loan2) {
        // 創建比較模態框的HTML
        const modalHTML = `
        <div class="modal-header">
            <h3>貸款方案比較</h3>
            <button class="close-btn" onclick="closeLoanComparisonModal()">×</button>
        </div>
        <div class="modal-content" style="flex: 1; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <th style="text-align: left; padding: 8px; border-bottom: 1px solid var(--border-color);">項目</th>
                    <th style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">方案1</th>
                    <th style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">方案2</th>
                    <th style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">差異</th>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid var(--border-color);">期數</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${loan1.period}</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${loan2.period}</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${loan2.period - loan1.period}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid var(--border-color);">稅前利率</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${loan1.rate}%</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${loan2.rate}%</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${(parseFloat(loan2.rate) - parseFloat(loan1.rate)).toFixed(4)}%</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid var(--border-color);">本金</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan1.principal)}</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan2.principal)}</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan2.principal - loan1.principal)}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid var(--border-color);">期繳</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan1.payment)}</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan2.payment)}</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan2.payment - loan1.payment)}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid var(--border-color);">總利息</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan1.totalInterest)}</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan2.totalInterest)}</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan2.totalInterest - loan1.totalInterest)}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid var(--border-color);">稅後利率</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${loan1.afterTaxRate}%</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${loan2.afterTaxRate}%</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${(parseFloat(loan2.afterTaxRate) - parseFloat(loan1.afterTaxRate)).toFixed(4)}%</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid var(--border-color);">推廣</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan1.commission)}</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan2.commission)}</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${formatNumberWithCommas(loan2.commission - loan1.commission)}</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid var(--border-color);">稅佣後利率</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${loan1.afterCommissionRate}%</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${loan2.afterCommissionRate}%</td>
                    <td style="text-align: right; padding: 8px; border-bottom: 1px solid var(--border-color);">${(parseFloat(loan2.afterCommissionRate) - parseFloat(loan1.afterCommissionRate)).toFixed(4)}%</td>
                </tr>
            </table>
            
            <div style="margin-top: 20px; padding: 15px; background-color: var(--secondary-color); border-radius: 8px;">
                <h4 style="margin-top: 0; color: var(--accent-color);">方案比較摘要</h4>
                <p>總成本差異: ${formatNumberWithCommas(Math.round((parseFloat(loan2.totalInterest) + parseFloat(loan2.commission)) - (parseFloat(loan1.totalInterest) + parseFloat(loan1.commission))))} 元</p>
                <p>月付款差異: ${formatNumberWithCommas(Math.round(loan2.payment - loan1.payment))} 元/月</p>
                <p>實際利率差異: ${(parseFloat(loan2.afterCommissionRate) - parseFloat(loan1.afterCommissionRate)).toFixed(4)}%</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-secondary" onclick="clearComparisonData()">清除比較</button>
            <button class="modal-btn modal-btn-primary" onclick="closeLoanComparisonModal()">關閉</button>
        </div>
        `;
        
        // 創建比較模態框
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.id = 'loanComparisonModal';
        modalOverlay.style.display = 'flex';
        modalOverlay.innerHTML = `<div class="modal-container">${modalHTML}</div>`;
        
        // 添加到網頁
        document.body.appendChild(modalOverlay);
        
        // 添加背景點擊關閉功能
        modalOverlay.addEventListener('click', function(event) {
            if (event.target === this) {
                closeLoanComparisonModal();
            }
        });
        
        // 添加震動反饋
        vibrate();
    }

    // 關閉貸款比較模態框
    function closeLoanComparisonModal() {
        const modal = document.getElementById('loanComparisonModal');
        if (modal) {
            document.body.removeChild(modal);
        }
        
        // 添加震動反饋
        vibrate();
    }

    // 清除比較數據
    function clearComparisonData() {
        compareLoanData = null;
        showToast('比較數據已清除');
        closeLoanComparisonModal();
        
        // 添加震動反饋
        vibrate();
    }

    // 顯示/隱藏歷史記錄面板
    function toggleHistoryPanel() {
        const panel = document.getElementById('historyPanel');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'block';
            loadHistoryData();
            
            // 添加一次性背景点击关闭事件
            panel.onclick = function(event) {
                if (event.target === this) {
                    this.style.display = 'none';
                }
            };
        }
    }

    // 載入歷史記錄
    // 修改 loadHistoryData 函数以使用新的设计
    function loadHistoryData() {
        const historyContent = document.getElementById('historyContent');
        const loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        
        if (loanHistory.length === 0) {
            historyContent.innerHTML = '<p class="no-data">尚無貸款計算記錄</p>';
            return;
        }
        
        // 按日期排序，最新的在前面
        loanHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        let html = '<div class="history-list">';
        loanHistory.forEach(loan => {
            // 确保数值正确显示，移除千位分隔符后再格式化
            const principalDisplay = formatNumber(loan.principal);
            const paymentDisplay = formatNumber(loan.payment);
            const commissionDisplay = formatNumber(loan.commission);
            
            html += `
                <div class="history-item" data-loan-id="${loan.id}">
                    <div class="history-item-header">
                        <div class="checkbox-date-container">
                            <input type="checkbox" class="history-item-checkbox" data-loan-id="${loan.id}" onchange="updateCompareButton()">
                            <div class="history-date">${formatDate(loan.date)}</div>
                        </div>
                        <div class="history-header-rate">稅佣後利率: ${parseFloat(loan.afterCommissionRate).toFixed(4)}%</div>
                    </div>
                    
                    <div class="history-details">
                        <div class="history-detail-item">
                            <span class="detail-label">期數</span>
                            <span class="detail-value">${loan.period}</span>
                        </div>
                        <div class="history-detail-item">
                            <span class="detail-label">推廣</span>
                            <span class="detail-value">${commissionDisplay}</span>
                        </div>
                        <div class="history-detail-item">
                            <span class="detail-label">本金</span>
                            <span class="detail-value">${principalDisplay}</span>
                        </div>
                        <div class="history-detail-item">
                            <span class="detail-label">期繳</span>
                            <span class="detail-value">${paymentDisplay}</span>
                        </div>
                    </div>

                    <div class="history-note-container">
                        <div class="history-item-footer">
                            <div class="history-note-preview ${loan.note ? '' : 'empty-note'}" onclick="openNoteEditor(${loan.id}, '${loan.note || ''}')">
                                ${loan.note ? loan.note : '點擊添加備註'}
                            </div>
                            <div class="history-actions">
                                <button class="detail-btn" onclick="loadLoanToForm(${loan.id})">載入計算</button>
                                <button class="delete-btn" onclick="deleteLoan(${loan.id})">刪除</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        historyContent.innerHTML = html;
    }

    // 更新比較按鈕狀態
    function updateCompareButton() {
        const checkboxes = document.querySelectorAll('.history-item-checkbox:checked');
        const compareButton = document.getElementById('compareSelectedBtn');
        
        // 如果有2個或以上選中的項目，啟用比較按鈕
        if (checkboxes.length >= 2) {
            compareButton.disabled = false;
        } else {
            compareButton.disabled = true;
        }
    }

    // 比較選中的貸款
    function compareSelectedLoans() {
        const checkboxes = document.querySelectorAll('.history-item-checkbox:checked');
        if (checkboxes.length < 2) {
            showToast('請至少選擇2個貸款方案進行比較');
            return;
        }
        
        // 獲取所有選中的貸款ID
        const selectedIds = Array.from(checkboxes).map(checkbox => 
            parseInt(checkbox.getAttribute('data-loan-id'))
        );
        
        // 從歷史記錄中獲取選中的貸款數據
        const loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        const selectedLoans = loanHistory.filter(loan => selectedIds.includes(loan.id));
        
        // 顯示比較視圖
        showMultiLoanComparison(selectedLoans);
    }

    function openNoteEditor(loanId, existingNote = '') {
        // 創建備註編輯器模態框
        const noteEditorModal = document.createElement('div');
        noteEditorModal.className = 'note-editor-modal';
        noteEditorModal.id = 'noteEditorModal';
        noteEditorModal.innerHTML = `
            <div class="note-editor-content">
                <h3>備註編輯</h3>
                <textarea id="noteEditorInput" class="note-editor-input" placeholder="請輸入備註內容...">${existingNote}</textarea>
                <div class="note-editor-buttons">
                    <button onclick="closeNoteEditor(false)" class="modal-btn modal-btn-secondary">取消</button>
                    <button onclick="saveNote(${loanId})" class="modal-btn modal-btn-primary">儲存</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(noteEditorModal);
        
        // 顯示模態框
        noteEditorModal.style.display = 'flex';
        
        // 自動聚焦到輸入框並調出鍵盤
        const noteInput = document.getElementById('noteEditorInput');
        noteInput.focus();
        
        // 添加點擊空白處關閉功能
        noteEditorModal.addEventListener('click', function(event) {
            if (event.target === this) {
                closeNoteEditor();
            }
        });
        
        // 監聽鍵盤彈出事件，進一步調整位置
        window.addEventListener('resize', adjustNoteEditorPosition);
        
        // 初始調整位置
        adjustNoteEditorPosition();
    }

    // 新增函數：調整備註編輯器位置
    function adjustNoteEditorPosition() {
        const modal = document.getElementById('noteEditorModal');
        if (!modal) return;
        
        // 偵測視窗高度變化來推測鍵盤是否彈出
        const windowHeight = window.innerHeight;
        const viewportHeight = window.visualViewport ? window.visualViewport.height : windowHeight;
        
        // 鍵盤彈出時會減少視口高度
        if (viewportHeight < windowHeight * 0.8) {
            // 鍵盤已彈出，將編輯器移至更靠頂部的位置
            modal.style.paddingTop = '180px';
            modal.style.justifyContent = 'center'; // 保持水平置中
        } else {
            // 鍵盤收起，恢復原本位置
            modal.style.paddingTop = '180px';
            modal.style.justifyContent = 'center'; // 保持水平置中
        }
    }

    function closeNoteEditor(isCancelled = true) {
        const noteEditorModal = document.getElementById('noteEditorModal');
        if (noteEditorModal) {
            document.body.removeChild(noteEditorModal);
        }
        
        // 移除事件監聽器
        window.removeEventListener('resize', adjustNoteEditorPosition);
    }

    function saveNote(loanId) {
        const noteInput = document.getElementById('noteEditorInput');
        const newNote = noteInput.value.trim();
        
        // 獲取當前的歷史記錄
        let loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        
        // 找到對應的貸款記錄並更新備註
        const updatedHistory = loanHistory.map(loan => {
            if (loan.id === loanId) {
                return { ...loan, note: newNote };
            }
            return loan;
        });
        
        // 儲存更新後的歷史記錄
        localStorage.setItem('loanHistory', JSON.stringify(updatedHistory));
        
        // 如果使用者已登入，同步到雲端
        if (window.currentUser) {
            db.collection('users')
                .doc(window.currentUser.uid)
                .collection('loanHistory')
                .doc(loanId.toString())
                .update({ note: newNote })
                .then(() => {
                    console.log('備註已同步到雲端');
                    syncStatus.lastSyncTime = new Date();
                    updateSyncStatusUI();
                })
                .catch((error) => {
                    console.error('備註同步失敗:', error);
                });
        }
        
        // 關閉備註編輯器
        closeNoteEditor();
        
        // 重新載入歷史記錄
        loadHistoryData();
        
        // 顯示成功提示
        showToast('備註已儲存');
    }

    // 格式化日期顯示（包含時間）
    function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');     // 小時（24小時制）
        const minutes = String(date.getMinutes()).padStart(2, '0'); // 分鐘
        
        // 返回格式：2024/03/15 14:30
        return `${year}/${month}/${day} ${hours}:${minutes}`;
    }

    // 修改 formatNumber 函数
    function formatNumber(num) {
        if (!num) return '0';
        
        // 如果是字符串且包含逗号，先去除千位分隔符
        if (typeof num === 'string') {
            num = num.replace(/,/g, '');
        }
        
        // 确保是数字，然后格式化
        return parseFloat(num).toLocaleString();
    }

    // 載入貸款記錄到表單
    function loadLoanToForm(id) {
        const loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        const loan = loanHistory.find(item => item.id === id);
        
        if (loan) {
            // 除了原有的載入邏輯外，不要重置備註
            document.getElementById('period').value = loan.period;
            document.getElementById('rate').value = loan.rate;
            
            document.getElementById('principal').value = formatNumberWithCommas(Math.round(parseFloat(loan.principal)));
            document.getElementById('payment').value = formatNumberWithCommas(Math.round(parseFloat(loan.payment)));
            document.getElementById('commission').value = formatNumberWithCommas(Math.round(parseFloat(loan.commission)));
            
            calculatePayment();
            updateAllFields();
            
            document.getElementById('historyPanel').style.display = 'none';
            
            showToast('已載入貸款計算資料');
            
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
    }

    // 刪除貸款記錄（增加確認步驟）
    function deleteLoan(id) {
        // 先顯示確認對話框
        showConfirmModal(
            '確認刪除', 
            '您確定要刪除這筆貸款記錄嗎？<br><br>此操作無法復原。', 
            function() {
                // 用戶確認後才執行刪除
                let loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
                loanHistory = loanHistory.filter(loan => loan.id !== id);
                localStorage.setItem('loanHistory', JSON.stringify(loanHistory));
                
                // 如果使用者已登入，同時從雲端刪除
                if (window.currentUser) {
                    db.collection('users')
                        .doc(window.currentUser.uid)
                        .collection('loanHistory')
                        .doc(id.toString())
                        .delete()
                        .then(() => {
                            console.log('雲端資料已刪除');
                            syncStatus.lastSyncTime = new Date();
                            updateSyncStatusUI();
                        })
                        .catch((error) => {
                            console.error('雲端刪除失敗:', error);
                        });
                }
                
                loadHistoryData(); // 重新載入歷史記錄
                showToast('貸款記錄已刪除！');
                
                // 觸覺反饋
                if (navigator.vibrate) {
                    navigator.vibrate([30, 20, 30]);
                }
            }
        );
    }

    // 確認是否刪除所有貸款記錄
    function confirmDeleteAll() {
        showConfirmModal('確認刪除', '確定要刪除所有貸款計算記錄嗎？此操作無法撤銷。', deleteAllLoans);
    }

    // 刪除所有貸款記錄
    function deleteAllLoans() {
        localStorage.removeItem('loanHistory');
        
        // 如果使用者已登入，同時清空雲端資料
        if (window.currentUser) {
            db.collection('users')
                .doc(window.currentUser.uid)
                .collection('loanHistory')
                .get()
                .then((querySnapshot) => {
                    const batch = db.batch();
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    console.log('雲端資料已全部刪除');
                })
                .catch((error) => {
                    console.error('雲端刪除失敗:', error);
                });
        }
        
        loadHistoryData(); // 重新載入歷史記錄（會顯示無記錄）
        showToast('所有貸款記錄已刪除！');
        
        // 觸覺反饋
        if (navigator.vibrate) {
            navigator.vibrate([50, 30, 50, 30, 50]);
        }
    }

    // 顯示一般模態框
    function showModal(title, content) {
        document.getElementById('modalTitle').textContent = title || '提示';
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modalOverlay').style.display = 'flex';
        
        // 添加背景點擊關閉功能
        document.getElementById('modalOverlay').onclick = function(event) {
            if (event.target === this) {
                hideModal();
            }
        };
    }

    // 隱藏一般模態框
    function hideModal() {
        document.getElementById('modalOverlay').style.display = 'none';
    }

    // 顯示確認模態框
    function showConfirmModal(title, content, confirmCallback) {
        document.getElementById('confirmModalTitle').textContent = title || '確認';
        document.getElementById('confirmModalContent').innerHTML = content;
        document.getElementById('confirmModalOverlay').style.display = 'flex';
        
        // 設定確認按鈕點擊事件
        const confirmButton = document.getElementById('confirmModalOk');
        
        // 移除舊的事件監聽器（如果有的話）
        const newConfirmButton = confirmButton.cloneNode(true);
        confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
        
        // 添加新的事件監聽器
        newConfirmButton.addEventListener('click', function() {
            hideConfirmModal();
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
        });
        
        // 添加背景點擊關閉功能
        document.getElementById('confirmModalOverlay').onclick = function(event) {
            if (event.target === this) {
                hideConfirmModal();
            }
        };
    }

    // 隱藏確認模態框
    function hideConfirmModal() {
        document.getElementById('confirmModalOverlay').style.display = 'none';
    }

    // 顯示輕量級的提示訊息
    function showToast(message, isError = false, duration = 2000) {
        // 檢查是否已有 toast 存在
        const existingToast = document.querySelector('.toast-message');
        if (existingToast) {
            document.body.removeChild(existingToast);
        }
        
        // 創建一個新的 toast 元素
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        if (isError) {
            toast.classList.add('toast-error');
        }
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // 指定時間後自動消失
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 500);
        }, duration);
    }

    // 重置資金成本為預設值的函數
    function resetMonthlyCost() {
        // 震動效果
        vibrate();
        
        // 將資金成本設為預設值 2.2165
        document.getElementById('monthlyCost').value = '2.2165';
        
        // 更新所有相關計算
        updateAllFields();
        
        // 顯示提示訊息
        showToast('已重置資金成本為預設值');
    }

    // 清空所有欄位除了資金成本
    function clearAllFieldsExceptMonthlyCost() {
        // 震動效果
        vibrate();
        
        // 要清空的欄位ID列表
        const fieldsToReset = [
            'period', 'rate', 'principal', 'payment', 
            'totalPayment', 'totalInterest', 'tax', 'afterTaxRate', 
            'commission', 'commissionRatio', 'afterCommissionRate',
            'afterCommissionOnlyRate',     // 佣後利率
            'annualMillionInterest', 'monthlyMillionInterest',
            'annualTenThousandInterest', 'monthlyTenThousandInterest',
            'spread', 'fundingCost', 'monthlyInterest', 'yearlyInterest',
            'customerInvoice',             // 客戶發票
            'businessTax',                 // 營業稅
            'untaxedAmount',               // 未稅金額
            'chineseAmount',               // 中文國字大寫
            'totalPaymentChinese'          // 總繳大寫 

        ];
        
        // 清空每個欄位
        fieldsToReset.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element) {  // 檢查元素是否存在，避免錯誤
                // 檢查是否為特殊的 div 元素（中文大寫欄位）
                if (fieldId === 'chineseAmount' || fieldId === 'totalPaymentChinese') {
                    // 對於 div 元素，使用 innerHTML 來清空內容
                    element.innerHTML = '';
                } else {
                    // 對於一般 input 元素，使用 value 來清空
                    element.value = '';
                }
                // 移除任何警告樣式
                element.classList.remove('warning-text');
            }
        });

        // 將資金成本重置為預設值，而不是清空
        const monthlyCostElement = document.getElementById('monthlyCost');
        if (monthlyCostElement) {
            monthlyCostElement.value = '2.2165';
        }
        
        // 顯示提示訊息
        showToast('已清空所有欄位');

        // 清空 footer 顯示
        const footerAfterCommissionOnlyRate = document.getElementById('footerAfterCommissionOnlyRate');
        const footerAfterCommissionRate = document.getElementById('footerAfterCommissionRate');
        
        if (footerAfterCommissionOnlyRate) {
            footerAfterCommissionOnlyRate.value = '';
            footerAfterCommissionOnlyRate.classList.remove('warning-text');
        }
        
        if (footerAfterCommissionRate) {
            footerAfterCommissionRate.value = '';
            footerAfterCommissionRate.classList.remove('warning-text');
        }

        // 清除自動保存的數據
        localStorage.removeItem('loanCalculatorAutoSave');
        console.log('已清除自動保存的數據');

    }

    // 全局變量
    let currentInputField = null;
    let calculatorValue = "0";
    let calculatorOperator = null;
    let calculatorFirstValue = null;
    let calculatorWaitingForSecondValue = false;
    let calculatorHistory = ""; // 新增：計算過程記錄

    // 開啟計算機輸入器
    function openCalculator(inputId, title) {
        currentInputField = inputId;
        document.getElementById('inputModalTitle').textContent = title;
        
        // 獲取當前輸入框的值
        const currentValue = document.getElementById(inputId).value;
        
        if (currentValue && currentValue !== '') {
            // 如果輸入框有值，使用該值初始化計算器
            calculatorValue = currentValue.replace(/,/g, ''); // 移除千位分隔符
            document.getElementById('calculatorDisplay').textContent = calculatorValue;
        } else {
            // 如果輸入框沒有值，使用 "0"
            calculatorValue = "0";
            document.getElementById('calculatorDisplay').textContent = calculatorValue;
        }
        
        calculatorOperator = null;
        calculatorFirstValue = null;
        calculatorWaitingForSecondValue = false;
        calculatorHistory = ""; // 清空計算歷史
        document.getElementById('calculatorHistory').textContent = ""; // 清空歷史顯示
        document.getElementById('historyScrollIndicator').style.opacity = '0'; // 隱藏滾動指示器
        
        document.getElementById('numberInputModal').style.display = 'flex';
        
        // 添加震動效果
        vibrate();
    }

    // 關閉模態框
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        
        // 添加震動效果
        vibrate();
    }

    // 計算機數字輸入
    function calculatorInput(num) {
        if (calculatorWaitingForSecondValue) {
            calculatorValue = num.toString();
            calculatorWaitingForSecondValue = false;
        } else {
            calculatorValue = calculatorValue === '0' ? num.toString() : calculatorValue + num.toString();
        }
        document.getElementById('calculatorDisplay').textContent = calculatorValue;
        
        // 添加震動效果
        vibrate();
    }

    // 計算機小數點輸入
    function calculatorDecimal() {
        // 如果正在等待第二個值，重置顯示
        if (calculatorWaitingForSecondValue) {
            calculatorValue = '0';
            calculatorWaitingForSecondValue = false;
        }
        
        // 如果當前值不包含小數點，則添加
        if (!calculatorValue.includes('.')) {
            calculatorValue += '.';
        }
        
        document.getElementById('calculatorDisplay').textContent = calculatorValue;
        
        // 添加震動效果
        vibrate();
    }

    // 計算機清除
    function calculatorClear() {
        calculatorValue = '0';
        calculatorOperator = null;
        calculatorFirstValue = null;
        calculatorWaitingForSecondValue = false;
        calculatorHistory = ""; // 清空計算歷史
        document.getElementById('calculatorDisplay').textContent = calculatorValue;
        document.getElementById('calculatorHistory').textContent = ""; // 清空歷史顯示
        document.getElementById('historyScrollIndicator').style.opacity = '0'; // 隱藏滾動指示器
        
        // 添加震動效果
        vibrate();
    }

    // 計算機退格
    function calculatorBackspace() {
        if (calculatorValue.length > 1) {
            calculatorValue = calculatorValue.slice(0, -1);
        } else {
            calculatorValue = '0';
        }
        document.getElementById('calculatorDisplay').textContent = calculatorValue;
        
        // 添加震動效果
        vibrate();
    }

    // 計算機運算符
    function calculatorOperation(op) {
        // 如果已經有運算符在等待，先進行計算
        if (calculatorFirstValue !== null && calculatorOperator !== null) {
            calculatorEquals();
        }
        
        calculatorFirstValue = parseFloat(calculatorValue);
        calculatorOperator = op;
        calculatorWaitingForSecondValue = true;
        
        // 更新計算歷史
        let opSymbol = op;
        switch(op) {
            case '+': opSymbol = ' + '; break;
            case '-': opSymbol = ' - '; break;
            case '*': opSymbol = ' × '; break;
            case '/': opSymbol = ' ÷ '; break;
        }
        
        // 添加當前數字和運算符到歷史記錄
        if (calculatorHistory === "") {
            calculatorHistory = calculatorValue + opSymbol;
        } else {
            // 檢查是否需要換行
            if (calculatorHistory.length > 20) {
                calculatorHistory += "\n" + calculatorValue + opSymbol;
            } else {
                calculatorHistory += calculatorValue + opSymbol;
            }
        }
        
        // 顯示計算歷史並檢查是否需要顯示滾動指示器
        updateCalculatorHistory();
        
        // 添加震動效果
        vibrate();
    }

    // 計算機等號
    function calculatorEquals() {
        if (calculatorFirstValue === null || calculatorOperator === null) return;
        
        const secondValue = parseFloat(calculatorValue);
        let result;
        
        // 完成歷史記錄的運算式
        let completeExpression = calculatorHistory + calculatorValue + " = ";
        
        switch (calculatorOperator) {
            case '+':
                result = calculatorFirstValue + secondValue;
                break;
            case '-':
                result = calculatorFirstValue - secondValue;
                break;
            case '*':
                result = calculatorFirstValue * secondValue;
                break;
            case '/':
                // 增加除零檢查
                if (secondValue === 0) {
                    showToast('錯誤：不能除以零', true);
                    calculatorClear();
                    return;
                }
                result = calculatorFirstValue / secondValue;
                break;
            default:
                return;
        }
        
        // 限制小數點位數，但保留有意義的數字
        calculatorValue = result.toString();
        if (calculatorValue.includes('.')) {
            // 如果是小數，限制最多顯示8位，但去除尾部無意義的零
            calculatorValue = parseFloat(result.toFixed(8)).toString();
        }
        
        // 更新顯示
        document.getElementById('calculatorDisplay').textContent = calculatorValue;
        
        // 更新歷史記錄，保持較短的顯示
        if (completeExpression.length > 30) {
            // 如果表達式太長，只顯示最後的等號部分
            calculatorHistory = calculatorValue;
        } else {
            // 如果表達式不太長，顯示完整表達式
            calculatorHistory = completeExpression;
        }
        
        // 顯示計算歷史並檢查是否需要顯示滾動指示器
        updateCalculatorHistory();
        
        // 為下一次計算準備
        calculatorOperator = null;
        calculatorFirstValue = parseFloat(calculatorValue);
        calculatorWaitingForSecondValue = true;
        
        // 添加震動效果
        vibrate();
    }

    // 修改 submitCalculatorValue 函数
    function submitCalculatorValue() {
        if (!currentInputField) return;
        
        let value = parseFloat(calculatorValue);
        if (isNaN(value)) value = 0;
        
        // 根据不同输入框进行验证
        switch (currentInputField) {
            case 'period':
                // 期数不需要千位分隔符
                value = Math.floor(value);
                if (value < 0) {
                    showToast('錯誤：期數不能為負數', true);
                    return;
                }
                if (value > 999) {
                    showToast('錯誤：期數不能超過3位數', true);
                    return;
                }
                document.getElementById(currentInputField).value = value;
                break;
                
                case 'rate':
                    // 利率不需要千位分隔符
                    if (value < 0) {
                        showToast('錯誤：利率不能為負數', true);
                        return;
                    }
                    if (value > 20) {
                        showToast('警告：利率超過20%，可能不符合一般貸款條件', true);
                        // 允許超過20%的利率，但顯示警告
                    }
                    document.getElementById(currentInputField).value = value.toFixed(4);
                    break;
                
            case 'principal':
                // 本金需要千位分隔符并且只能是正整数
                value = Math.floor(value); // 确保是整数
                if (value <= 0) {
                    showToast('錯誤：本金必須是正整數', true);
                    return;
                }
                if (value > 999999999) {
                    showToast('錯誤：本金不能超過9位數', true);
                    return;
                }
                document.getElementById(currentInputField).value = formatNumberWithCommas(value);
                break;
                
            case 'payment':
                // 期繳必须是正整数
                value = Math.max(1, Math.round(value)); // 改為取整數
                if (value > 999999) {
                    showToast('錯誤：期繳款金額不能超過6位數', true);
                    return;
                }
                document.getElementById(currentInputField).value = formatNumberWithCommas(value);
                break;
                
            case 'commission':
                // 推廣需要千位分隔符
                value = Math.floor(value);
                if (value < 0) {
                    showToast('錯誤：推廣費必須為正整數', true);
                    return;
                }
                if (value > 999999) {
                    showToast('錯誤：推廣費不能超過6位數', true);
                    return;
                }
                document.getElementById(currentInputField).value = formatNumberWithCommas(value);
                break;

            case 'monthlyCost':
                // 資金成本不需要千位分隔符，保留4位小數
                if (value < 0) {
                    showToast('錯誤：資金成本不能為負數', true);
                    return;
                }
                if (value > 20) {
                    showToast('錯誤：資金成本不能超過20', true);
                    return;
                }
                // 限制在0.0000到20.0000之間，並保留4位小數
                value = Math.max(0, Math.min(20, value));
                document.getElementById(currentInputField).value = value.toFixed(4);
                break;
        }
        
        // 触发 change 事件以更新相关计算
        const event = new Event('change');
        document.getElementById(currentInputField).dispatchEvent(event);
        
        // 关闭模态框
        closeModal('numberInputModal');
        
        // 根據欄位執行相應的計算函數
        if (currentInputField === 'period' || currentInputField === 'rate' || currentInputField === 'principal') {
            calculatePayment();
        } else if (currentInputField === 'payment') {
            calculateRate();
        } else if (currentInputField === 'commission' || currentInputField === 'monthlyCost') {
            // 推廣費或資金成本改變時，更新所有相關計算
            updateAllFields();
        }
        
        // 添加震动效果
        vibrate();
    }

    // 显示提示信息（可重用现有的 showToast 函数，如果没有的话添加这个）
    function showToast(message, isError = false) {
        // 检查是否已有 toast
        const existingToast = document.querySelector('.toast-message');
        if (existingToast) {
            document.body.removeChild(existingToast);
        }
        
        // 创建新的 toast
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        if (isError) {
            toast.classList.add('toast-error');
        }
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // 2秒后自动消失
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 500);
        }, 2000);
    }

    // 格式化数字 - 添加千位分隔符
    function formatNumberWithCommas(num) {
        if (!num && num !== 0) return '';
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // 更新计算历史显示，并检查是否需要显示滚动指示器
    function updateCalculatorHistory() {
        const historyElement = document.getElementById('calculatorHistory');
        const indicatorElement = document.getElementById('historyScrollIndicator');
        
        // 更新历史内容
        historyElement.textContent = calculatorHistory;
        
        // 检查是否内容溢出需要显示滚动指示器
        const isOverflowing = historyElement.scrollWidth > historyElement.clientWidth || 
                            historyElement.scrollHeight > historyElement.clientHeight;
        
        if (isOverflowing) {
            historyElement.classList.add('has-overflow');
        } else {
            historyElement.classList.remove('has-overflow');
        }
    }

    function countFilledFields() {
        const period = document.getElementById('period').value;
        const rate = document.getElementById('rate').value;
        const principal = document.getElementById('principal').value;
        const payment = document.getElementById('payment').value;
        
        let count = 0;
        if (period && period !== '0') count++;
        if (rate && rate !== '0') count++;
        if (principal && principal !== '0') count++;
        if (payment && payment !== '0') count++;
        
        return count;
    }

    // 期數方案對比功能
    function showPaymentComparison() {
        // 獲取當前的計算數據
        const rate = parseFloat(document.getElementById('rate').value);
        const principal = parseFloat(document.getElementById('principal').value.replace(/,/g, ''));
        const commission = parseFloat(document.getElementById('commission').value.replace(/,/g, '')) || 0;
        const afterCommissionRate = document.getElementById('afterCommissionRate').value;
        
        // 檢查是否有足夠的數據
        if (isNaN(rate) || isNaN(principal) || rate <= 0 || principal <= 0) {
            showToast('請先輸入有效的利率和本金', true);
            return;
        }
        
        // 生成不同期數的還款方案
        const periods = [12, 18, 24, 30, 36, 48, 60, 72, 84, 96, 120]; // 常見期數選項
        const plans = [];
        
        // 計算每個期數方案的詳細數據
        for (const period of periods) {
            const payment = PMT(rate, period, principal);
            const totalPayment = payment * period;
            const totalInterest = totalPayment - principal;
            
            // 計算稅金（總利息 / 21）
            const tax = totalInterest / 21;
            
            // 計算稅佣後利率
            const afterTaxCommissionRate = RATE(period, payment, principal + tax + commission);
            
            plans.push({
                period: period,
                payment: payment,
                totalPayment: totalPayment,
                totalInterest: totalInterest,
                monthlyInterest: totalInterest / period, // 每月利息
                afterTaxCommissionRate: afterTaxCommissionRate
            });
        }
        
        // 創建現代化的表格 HTML
        let tableHTML = `
        <!-- 方案對比主容器 -->
        <div style="
            background: var(--primary-color);
            padding: 15px;
            border-radius: 12px;
        ">
            <!-- 當前條件卡片 - 改進的設計 -->
            <div style="
                background: linear-gradient(135deg, var(--secondary-color) 0%, rgba(var(--secondary-color-rgb), 0.8) 100%);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 20px;
                box-shadow: 0 4px 12px var(--shadow-color);
                border: 1px solid rgba(var(--accent-color-rgb), 0.3);
            ">
                <!-- 標題區 -->
                <div style="
                    display: flex;
                    align-items: center;
                    margin-bottom: 12px;
                    padding-bottom: 10px;
                    border-bottom: 1px solid rgba(var(--accent-color-rgb), 0.2);
                ">
                    <span style="font-size: 18px; margin-right: 8px;">📊</span>
                    <h4 style="
                        margin: 0;
                        color: var(--accent-color);
                        font-size: 16px;
                        font-weight: 600;
                    ">計算條件</h4>
                </div>
                
                <!-- 條件數據網格 - 使用2x2佈局 -->
                <div style="
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 12px;
                ">
                    <!-- 本金 -->
                    <div style="
                        background: rgba(var(--primary-color-rgb), 0.3);
                        padding: 10px;
                        border-radius: 8px;
                        text-align: center;
                    ">
                        <div style="
                            font-size: 12px;
                            color: var(--text-muted);
                            margin-bottom: 4px;
                        ">本金</div>
                        <div style="
                            font-size: 16px;
                            font-weight: bold;
                            color: var(--text-color);
                        ">${formatNumberWithCommas(principal)}</div>
                    </div>
                    
                    <!-- 利率 -->
                    <div style="
                        background: rgba(var(--primary-color-rgb), 0.3);
                        padding: 10px;
                        border-radius: 8px;
                        text-align: center;
                    ">
                        <div style="
                            font-size: 12px;
                            color: var(--text-muted);
                            margin-bottom: 4px;
                        ">稅前利率</div>
                        <div style="
                            font-size: 16px;
                            font-weight: bold;
                            color: var(--text-color);
                        ">${rate}%</div>
                    </div>
                    
                    <!-- 推廣 -->
                    <div style="
                        background: rgba(var(--primary-color-rgb), 0.3);
                        padding: 10px;
                        border-radius: 8px;
                        text-align: center;
                    ">
                        <div style="
                            font-size: 12px;
                            color: var(--text-muted);
                            margin-bottom: 4px;
                        ">推廣</div>
                        <div style="
                            font-size: 16px;
                            font-weight: bold;
                            color: var(--text-color);
                        ">${formatNumberWithCommas(commission)}</div>
                    </div>
                    
                    <!-- 稅佣後利率 -->
                    <div style="
                        background: rgba(var(--primary-color-rgb), 0.3);
                        padding: 10px;
                        border-radius: 8px;
                        text-align: center;
                    ">
                        <div style="
                            font-size: 12px;
                            color: var(--text-muted);
                            margin-bottom: 4px;
                        ">稅佣後利率</div>
                        <div style="
                            font-size: 16px;
                            font-weight: bold;
                            color: var(--accent-color);
                        ">${afterCommissionRate || '計算中...'}%</div>
                    </div>
                </div>
            </div>
            
            <!-- 說明文字 -->
            <div style="
                text-align: center;
                color: var(--text-muted);
                font-size: 14px;
                margin-bottom: 15px;
            ">
                以下是不同期數的還款方案對比
            </div>
            
            <!-- 方案列表容器 -->
            <div style="
                display: flex;
                flex-direction: column;
                gap: 10px;
            ">
        `;
        
        // 為每個方案創建卡片式設計
        plans.forEach((plan, index) => {
            // 判斷是否為推薦方案（例如：總利息最低或月付最適中）
            const isRecommended = index === 3 || index === 4; // 30期和36期通常較受歡迎
            
            tableHTML += `
            <!-- 期數方案卡片 -->
            <div style="
                background: ${isRecommended ? 
                    'linear-gradient(135deg, rgba(var(--accent-color-rgb), 0.1) 0%, rgba(var(--accent-color-rgb), 0.05) 100%)' : 
                    'var(--secondary-color)'};
                border-radius: 10px;
                padding: 12px;
                border: 1px solid ${isRecommended ? 'var(--accent-color)' : 'var(--border-color)'};
                box-shadow: 0 2px 6px var(--shadow-color);
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            " 
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px var(--shadow-color)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px var(--shadow-color)';">
                
                ${isRecommended ? `
                <!-- 推薦標籤 -->
                <div style="
                    position: absolute;
                    top: 0;
                    right: 0;
                    background: var(--accent-color);
                    color: white;
                    padding: 2px 8px;
                    font-size: 11px;
                    border-bottom-left-radius: 8px;
                    font-weight: bold;
                ">推薦</div>
                ` : ''}
                
                <!-- 期數和基本資訊 -->
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                ">
                    <!-- 期數 -->
                    <div style="
                        display: flex;
                        align-items: baseline;
                        gap: 4px;
                    ">
                        <span style="
                            font-size: 24px;
                            font-weight: bold;
                            color: var(--accent-color);
                        ">${plan.period}</span>
                        <span style="
                            font-size: 14px;
                            color: var(--text-muted);
                        ">期</span>
                    </div>
                    
                    <!-- 選擇按鈕 -->
                    <button onclick="selectPlan(${plan.period}, ${rate}, ${principal}, ${plan.payment})" 
                        style="
                            background: var(--accent-color);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            padding: 6px 16px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                        "
                        onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 3px 6px rgba(0, 0, 0, 0.3)';"
                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.2)';">
                        選擇此方案
                    </button>
                </div>
                
                <!-- 詳細數據網格 -->
                <div style="
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 8px;
                ">
                    <!-- 期繳金額 -->
                    <div style="
                        background: rgba(var(--primary-color-rgb), 0.5);
                        padding: 8px;
                        border-radius: 6px;
                        text-align: center;
                    ">
                        <div style="
                            font-size: 11px;
                            color: var(--text-muted);
                            margin-bottom: 2px;
                        ">期繳金額</div>
                        <div style="
                            font-size: 15px;
                            font-weight: 600;
                            color: var(--text-color);
                        ">${formatNumberWithCommas(Math.round(plan.payment))}</div>
                    </div>
                    
                    <!-- 總還款 -->
                    <div style="
                        background: rgba(var(--primary-color-rgb), 0.5);
                        padding: 8px;
                        border-radius: 6px;
                        text-align: center;
                    ">
                        <div style="
                            font-size: 11px;
                            color: var(--text-muted);
                            margin-bottom: 2px;
                        ">總還款</div>
                        <div style="
                            font-size: 15px;
                            font-weight: 600;
                            color: var(--text-color);
                        ">${formatNumberWithCommas(Math.round(plan.totalPayment))}</div>
                    </div>
                    
                    <!-- 總利息 -->
                    <div style="
                        background: rgba(var(--primary-color-rgb), 0.5);
                        padding: 8px;
                        border-radius: 6px;
                        text-align: center;
                    ">
                        <div style="
                            font-size: 11px;
                            color: var(--text-muted);
                            margin-bottom: 2px;
                        ">總利息</div>
                        <div style="
                            font-size: 15px;
                            font-weight: 600;
                            color: var(--text-color);
                        ">${formatNumberWithCommas(Math.round(plan.totalInterest))}</div>
                    </div>
                    
                    <!-- 稅佣後利率 -->
                    <div style="
                        background: rgba(var(--primary-color-rgb), 0.5);
                        padding: 8px;
                        border-radius: 6px;
                        text-align: center;
                    ">
                        <div style="
                            font-size: 11px;
                            color: var(--text-muted);
                            margin-bottom: 2px;
                        ">稅佣後利率</div>
                        <div style="
                            font-size: 15px;
                            font-weight: 600;
                            color: var(--accent-color);
                        ">${plan.afterTaxCommissionRate.toFixed(4)}%</div>
                    </div>
                </div>
                
                <!-- 每月利息提示 -->
                <div style="
                    margin-top: 8px;
                    padding-top: 8px;
                    border-top: 1px solid rgba(var(--border-color-rgb), 0.3);
                    text-align: center;
                    font-size: 12px;
                    color: var(--text-muted);
                ">
                    每月利息約 ${formatNumberWithCommas(Math.round(plan.monthlyInterest))} 元
                </div>
            </div>
            `;
        });
        
        tableHTML += `
            </div>
        </div>
        `;
        
        // 創建模態框
        const modalHTML = `
        <div class="modal-header">
            <h3>期數方案對比</h3>
            <button class="close-btn" onclick="closeCustomModal('paymentComparisonModal')">×</button>
        </div>
        <div class="modal-content" style="flex: 1; overflow-y: auto; padding: 10px;">
            ${tableHTML}
        </div>
        `;
        
        // 創建並顯示全螢幕模態框
        showCustomModal('paymentComparisonModal', modalHTML);
    }

    // 选择特定方案
    function selectPlan(period, rate, principal, payment) {
        // 更新计算器中的值
        document.getElementById('period').value = period;
        document.getElementById('rate').value = rate;
        document.getElementById('principal').value = formatNumberWithCommas(principal);
        document.getElementById('payment').value = formatNumberWithCommas(Math.round(payment));
        
        // 更新所有相关计算
        updateAllFields();
        
        // 关闭模态框
        closeCustomModal('paymentComparisonModal');
        
        // 显示提示
        showToast(`已選擇 ${period} 期方案`);
        
        // 触发震动反馈
        vibrate();
    }

    // 通用的模態框顯示函數
    function showCustomModal(id, html) {
        // 創建模態框
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.id = id;
        modalOverlay.style.display = 'flex';
        
        // 如果是期數方案對比，使用全螢幕樣式
        if (id === 'paymentComparisonModal') {
            modalOverlay.style.position = 'fixed';
            modalOverlay.style.top = '0';
            modalOverlay.style.left = '0';
            modalOverlay.style.width = '100%';
            modalOverlay.style.height = '100%';
            modalOverlay.style.backgroundColor = 'var(--primary-color)';
            modalOverlay.style.zIndex = '9999';
            modalOverlay.style.overflow = 'auto';
            modalOverlay.innerHTML = `<div class="modal-container" style="width: 100%; height: 100%; max-width: 100%; max-height: 100%; margin: 0; border-radius: 0;">${html}</div>`;
        } else {
            modalOverlay.innerHTML = `<div class="modal-container">${html}</div>`;
        }
        
        // 添加到网页
        document.body.appendChild(modalOverlay);
        
        // 点击背景关闭
        modalOverlay.addEventListener('click', function(event) {
            if (event.target === this) {
                closeCustomModal(id);
            }
        });
        
        vibrate();
    }

    // 通用的模態框關閉函數
    function closeCustomModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            document.body.removeChild(modal);
        }
        vibrate();
    }

    // 從貸款方案比較頁面返回選擇比較方案頁面
    function backToLoanSelection() {
        // 觸發震動反饋
        vibrate();
        
        // 關閉當前的比較頁面
        closeCustomModal('multiLoanComparisonModal');
        
        // 延遲一點時間後重新開啟選擇頁面，確保動畫流暢
        setTimeout(() => {
            // 獲取當前貸款數據（之前已經保存在 localStorage 中）
            const currentLoan = JSON.parse(localStorage.getItem('currentLoanForComparison'));
            
            // 獲取歷史記錄
            const loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
            
            // 重新顯示選擇貸款的模態框
            if (currentLoan && loanHistory.length > 0) {
                showLoanSelectionModal(currentLoan, loanHistory);
            } else {
                // 如果沒有數據，顯示提示
                showToast('無法返回選擇頁面，請重新操作');
            }
        }, 300); // 300毫秒的延遲，確保關閉動畫完成
    }

    // 关闭子选单
    function closeSubmenu(submenuId) {
        const submenu = document.getElementById(submenuId);
        if (submenu) {
            const submenuContent = submenu.querySelector('.submenu-content');
            
            // 添加关闭动画
            submenuContent.classList.add('submenu-closing');
            
            // 动画结束后隐藏子选单
            setTimeout(function() {
                submenu.style.display = 'none';
                submenuContent.classList.remove('submenu-closing');
            }, 200); // 与动画时长相匹配
            
            vibrate(); // 使用现有的震动函数
        }
    }

    // 通用的模態框顯示函數
    function showCustomModal(id, html) {
        // 創建模態框
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.id = id;
        modalOverlay.style.display = 'flex';
        modalOverlay.innerHTML = `<div class="modal-container">${html}</div>`;
        
        // 添加到網頁
        document.body.appendChild(modalOverlay);
        
        // 點擊背景關閉
        modalOverlay.addEventListener('click', function(event) {
            if (event.target === this) {
                closeCustomModal(id);
            }
        });
        
        vibrate();
    }

    // 通用的模態框關閉函數
    function closeCustomModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            document.body.removeChild(modal);
        }
        vibrate();
    }

    // 阿拉伯數字轉中文國字大寫函數
    function arabicToChineseNumber(num, format) {
        if (!num || num === '0' || num === 0) {
            return format === 'financial' ? '<span class="financial-digit">零</span>' : '零';
        }
        
        // 分割整數和小數部分
        const parts = num.toString().split('.');
        const integerPart = parts[0];
        const decimalPart = parts.length > 1 ? parts[1] : '';
        
        // 根據格式選擇對應的字符
        let digits, units;
        if (format === 'traditional') {
            digits = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
            units = ['', '十', '百', '千', '萬', '十', '百', '千', '億', '十', '百', '千', '兆'];
        } else if (format === 'financial') {
            digits = ['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'];
            units = ['', '拾', '佰', '仟', '萬', '拾', '佰', '仟', '億', '拾', '佰', '仟', '兆'];
        }
        
        // 處理整數部分
        let intResult = '';
        if (integerPart === '0') {
            intResult = format === 'financial' ? '<span class="financial-digit">零</span>' : digits[0];
        } else {
            const len = integerPart.length;
            
            // 特殊處理10-19的數字
            if (format !== 'financial' && len === 2 && integerPart.charAt(0) === '1') {
                intResult = units[1];
                if (integerPart.charAt(1) !== '0') {
                    intResult += digits[parseInt(integerPart.charAt(1))];
                }
            } else {
                // 新增變量來追蹤上一個處理過的字符是否為零，以及是否已經添加了單位
                let lastWasZero = false;
                let hasAddedUnit = false;
                
                for (let i = 0; i < len; i++) {
                    const digit = parseInt(integerPart.charAt(i));
                    const pos = len - i - 1;
                    
                    if (digit !== 0) {
                        // 非零數字直接轉換並加上單位
                        lastWasZero = false;
                        hasAddedUnit = false;
                        
                        // 在 financial 格式中為數字添加特殊標籤
                        if (format === 'financial') {
                            intResult += `<span class="financial-digit">${digits[digit]}</span>${units[pos]}`;
                        } else {
                            intResult += digits[digit] + units[pos];
                        }
                    } else {
                        // 處理零的特殊規則
                        if (pos === 4 || pos === 8) {
                            // 萬位或億位的零，需要加上對應的單位，但不需要加上"零"字
                            if (intResult.length > 0) {
                                // 確保沒有連續加入同一單位
                                if (!intResult.endsWith(units[4]) && !intResult.endsWith(units[8])) {
                                    intResult += units[pos];
                                    hasAddedUnit = true;
                                }
                            }
                        } else if (i < len - 1 && integerPart.charAt(i + 1) !== '0' && !lastWasZero) {
                            // 當前數字是0，下一個不是0，且上一個不是0，加上零
                            if (format === 'financial') {
                                intResult += `<span class="financial-digit">${digits[0]}</span>`;
                            } else {
                                intResult += digits[0];
                            }
                            lastWasZero = true;
                        }
                    }
                }
            }
        }
        
        // 處理小數部分
        let decResult = '';
        if (decimalPart) {
            decResult = '點';
            for (let i = 0; i < decimalPart.length; i++) {
                if (format === 'financial') {
                    decResult += `<span class="financial-digit">${digits[parseInt(decimalPart.charAt(i))]}</span>`;
                } else {
                    decResult += digits[parseInt(decimalPart.charAt(i))];
                }
            }
        }
        
        // 組合結果
        return intResult + decResult;
    }

    // 顯示加油卡計算器
    function showGasCardCalculator() {
        // 不需要關閉進階選單了，因為已經移除
        
        // 生成加油卡計算器的 HTML
        const gasCardHTML = generateGasCardHTML();
        
        // 插入內容
        document.getElementById('gasCardContent').innerHTML = gasCardHTML;
        
        // 顯示模態框
        document.getElementById('gasCardModal').style.display = 'flex';
        
        // 初始化加油卡計算器
        initializeGasCardCalculator();
        
        // 震動反饋
        vibrate();
    }

    // 關閉加油卡計算器
    function closeGasCardCalculator() {
        document.getElementById('gasCardModal').style.display = 'none';
        vibrate();
    }

    // 生成加油卡計算器 HTML（使用主題變量）
    function generateGasCardHTML() {
        return `
            <div style="width: 100%; max-width: 380px; margin: 0 auto;">
                <!-- 超級柴油價格輸入欄位 -->
                <div class="row">
                    <span class="label">超級柴油</span>
                    <input type="text" 
                        id="dieselPrice" 
                        placeholder="0.0"
                        value="26.0"
                        readonly
                        style="width: 95px; text-align: right;">
                    <span style="margin-left: 10px; color: var(--text-color);">元/公升</span>
                </div>
                
                <!-- 每月油錢輸入欄位 -->
                <div class="row">
                    <span class="label">每月油錢</span>
                    <input type="text" 
                        id="monthlyExpense" 
                        placeholder="0"
                        readonly
                        style="width: 95px; text-align: right;">
                    <span style="margin-left: 10px; color: var(--text-color);">元</span>
                </div>
                
                <!-- 每月油量輸入欄位 -->
                <div class="row">
                    <span class="label">每月油量</span>
                    <input type="text" 
                        id="monthlyVolume" 
                        placeholder="0"
                        readonly
                        style="width: 95px; text-align: right;">
                    <span style="margin-left: 10px; color: var(--text-color);">公升</span>
                </div>
                
                <!-- 折扣金額輸入欄位 -->
                <div class="row">
                    <span class="label">折扣金額</span>
                    <input type="text" 
                        id="discountAmount" 
                        placeholder="0.0"
                        readonly
                        style="width: 95px; text-align: right;">
                    <span style="margin-left: 10px; color: var(--text-color);">元/公升</span>
                </div>
                
                <!-- 折後油錢顯示欄位 -->
                <div class="row emphasized-row">
                    <span class="label">折後油錢</span>
                    <input type="text" 
                        id="discountedExpense" 
                        class="readonly"
                        placeholder="0"
                        readonly
                        style="width: 95px; text-align: right;">
                    <span style="margin-left: 10px; color: var(--text-color);">元</span>
                </div>
                
                <!-- 每月節省顯示欄位 -->
                <div class="row emphasized-row">
                    <span class="label">每月節省</span>
                    <input type="text" 
                        id="monthlySaving" 
                        class="readonly"
                        placeholder="0"
                        readonly
                        style="width: 95px; text-align: right;">
                    <span style="margin-left: 10px; color: var(--text-color);">元</span>
                </div>
                
                <!-- 每年節省顯示欄位 -->
                <div class="row emphasized-row">
                    <span class="label">每年節省</span>
                    <input type="text" 
                        id="yearlySaving" 
                        class="readonly"
                        placeholder="0"
                        readonly
                        style="width: 95px; text-align: right;">
                    <span style="margin-left: 10px; color: var(--text-color);">元</span>
                </div>
                
                <!-- 清除按鈕 -->
                <div class="function-buttons" style="margin-top: 10px;">
                    <div class="button-row">
                        <button onclick="clearGasCalculation()" class="main-action-btn">清除</button>
                    </div>
                </div>

                <!-- 即時油價資訊框架 -->
                <div style="
                    margin-top: 15px;
                    padding: 10px;
                    background: var(--secondary-color);
                    border-radius: 8px;
                    box-shadow: 0 2px 4px var(--shadow-color);
                ">
                    <!-- 框架標題 -->
                    <div style="
                        text-align: center;
                        color: var(--accent-color);
                        font-size: 16px;
                        font-weight: bold;
                        margin-bottom: 10px;
                        padding-bottom: 8px;
                        border-bottom: 1px solid var(--border-color);
                    ">
                        📊 即時油價資訊
                    </div>
                    
                    <!-- iframe 容器 -->
                    <div style="
                        position: relative;
                        width: 100%;
                        height: 400px;
                        border-radius: 6px;
                        overflow: hidden;
                        border: 1px solid var(--border-color);
                        background-color: #ffffff;
                    ">
                        <!-- 載入提示 -->
                        <div id="gasIframeLoader" style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            color: var(--text-muted);
                            font-size: 14px;
                            text-align: center;
                            z-index: 1;
                        ">
                            <div style="margin-bottom: 10px;">⏳ 正在載入油價資訊...</div>
                            <div style="font-size: 12px; opacity: 0.7;">請稍候</div>
                        </div>
                        
                        <!-- 油價資訊 iframe -->
                        <iframe 
                            id="gasPriceIframe"
                            src="https://m.gas.goodlife.tw/" 
                            style="
                                width: 100%;
                                height: 100%;
                                border: none;
                                background-color: #ffffff;
                            "
                            onload="document.getElementById('gasIframeLoader').style.display='none';"
                            onerror="handleIframeError()"
                            title="即時油價資訊"
                            sandbox="allow-scripts allow-same-origin"
                        ></iframe>
                    </div>
                    
                    <!-- 提示文字 -->
                    <div style="
                        margin-top: 8px;
                        font-size: 12px;
                        color: var(--text-muted);
                        text-align: center;
                    ">
                        資料來源：gas.goodlife.tw
                    </div>
                </div>
            </div>
            
            <!-- 加油卡計算機彈出視窗 -->
            <div id="gasCalculatorModal" class="modal-overlay">
                <div class="number-input-modal">
                    <div class="modal-header">
                        <h3 id="gasInputModalTitle">數字輸入器</h3>
                        <button class="close-btn" onclick="closeGasCalculator()">×</button>
                    </div>

                    <div class="calculator-display-container">
                        <div class="calculator-display" id="gasCalcDisplay">0</div>
                    </div>

                    <div class="calculator-buttons">
                        <!-- 第一行：功能鍵 -->
                        <button onclick="gasCalcClear()" class="clear">C</button>
                        <button onclick="gasCalcBackspace()" class="function">⌫</button>
                        <button onclick="gasCalcOperation('/')" class="operator">÷</button>
                        <button onclick="gasCalcOperation('*')" class="operator">×</button>
                        
                        <!-- 第二行：數字和減號 -->
                        <button onclick="gasCalcInput(7)" class="number-btn">
                            <div class="arabic-number">7</div>
                            <div class="financial-char">柒</div>
                        </button>
                        <button onclick="gasCalcInput(8)" class="number-btn">
                            <div class="arabic-number">8</div>
                            <div class="financial-char">捌</div>
                        </button>
                        <button onclick="gasCalcInput(9)" class="number-btn">
                            <div class="arabic-number">9</div>
                            <div class="financial-char">玖</div>
                        </button>
                        <button onclick="gasCalcOperation('-')" class="operator">−</button>
                        
                        <!-- 第三行：數字和加號 -->
                        <button onclick="gasCalcInput(4)" class="number-btn">
                            <div class="arabic-number">4</div>
                            <div class="financial-char">肆</div>
                        </button>
                        <button onclick="gasCalcInput(5)" class="number-btn">
                            <div class="arabic-number">5</div>
                            <div class="financial-char">伍</div>
                        </button>
                        <button onclick="gasCalcInput(6)" class="number-btn">
                            <div class="arabic-number">6</div>
                            <div class="financial-char">陸</div>
                        </button>
                        <button onclick="gasCalcOperation('+')" class="operator">+</button>
                        
                        <!-- 第四行：底部數字和等號 -->
                        <button onclick="gasCalcInput(1)" class="number-btn">
                            <div class="arabic-number">1</div>
                            <div class="financial-char">壹</div>
                        </button>
                        <button onclick="gasCalcInput(2)" class="number-btn">
                            <div class="arabic-number">2</div>
                            <div class="financial-char">貳</div>
                        </button>
                        <button onclick="gasCalcInput(3)" class="number-btn">
                            <div class="arabic-number">3</div>
                            <div class="financial-char">參</div>
                        </button>
                        <button onclick="gasCalcEquals()" class="equals">=</button>
                        
                        <!-- 第五行：零、小數點和確認鍵 -->
                        <button onclick="gasCalcInput(0)" class="number-btn">
                            <div class="arabic-number">0</div>
                            <div class="financial-char">零</div>
                        </button>
                        <button onclick="gasCalcDecimal()" class="function">.</button>
                        <button onclick="confirmGasCalculation()" class="submit">確認輸入</button>
                    </div>
                </div>
            </div>
        `;
    }

    // 初始化加油卡計算器
    function initializeGasCardCalculator() {
        // 設定超級柴油的預設值
        const dieselPriceField = document.getElementById('dieselPrice');
        if (dieselPriceField && !dieselPriceField.value) {
            dieselPriceField.value = '26.0';
        }
        // 為可編輯的輸入框添加點擊事件
        const editableFields = ['dieselPrice', 'monthlyExpense', 'monthlyVolume', 'discountAmount'];
        editableFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('click', function() {
                    openGasCalculator(fieldId);
                });
            }
        });
        
        // 點擊計算機外部區域關閉計算機
        const gasCalcModal = document.getElementById('gasCalculatorModal');
        if (gasCalcModal) {
            gasCalcModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeGasCalculator();
                }
            });
        }
    }

    // 加油卡計算器的全局變量
    let gasCurrentInput = '';
    let gasCalcExpression = '';
    let gasLastResult = '0';
    let gasLastModifiedField = '';
    let gasFirstValue = null;
    let gasOperator = null;
    let gasWaitingForSecondValue = false;

    // 開啟加油卡計算機
    function openGasCalculator(inputId) {
        vibrate();
        gasCurrentInput = inputId;
        
        // 設定標題
        const titles = {
            'dieselPrice': '請輸入【超級柴油價格】',
            'monthlyExpense': '請輸入【每月油錢】',
            'monthlyVolume': '請輸入【每月油量】',
            'discountAmount': '請輸入【折扣金額】'
        };
        document.getElementById('gasInputModalTitle').textContent = titles[inputId] || '數字輸入器';
        
        const modal = document.getElementById('gasCalculatorModal');
        const display = document.getElementById('gasCalcDisplay');
        
        const fieldValue = document.getElementById(inputId).value;
        let currentValue = fieldValue.replace(/,/g, '');
        
        if (!currentValue || currentValue === '0') {
            gasCalcExpression = '0';
        } else {
            if (inputId === 'dieselPrice' || inputId === 'discountAmount') {
                gasCalcExpression = parseFloat(currentValue).toString();
            } else {
                gasCalcExpression = parseInt(currentValue).toString();
            }
        }
        
        display.textContent = gasCalcExpression;
        gasOperator = null;
        gasFirstValue = null;
        gasWaitingForSecondValue = false;
        
        modal.style.display = 'flex';
    }

    // 關閉加油卡計算機
    function closeGasCalculator() {
        vibrate();
        const modal = document.getElementById('gasCalculatorModal');
        modal.style.display = 'none';
        gasCalcExpression = '';
        gasCurrentInput = '';
    }

    // 加油卡計算機運算符
    function gasCalcOperation(op) {
        vibrate();
        
        // 如果已經有運算符在等待，先進行計算
        if (gasFirstValue !== null && gasOperator !== null) {
            gasCalcEquals();
        }
        
        gasFirstValue = parseFloat(gasCalcExpression);
        gasOperator = op;
        gasWaitingForSecondValue = true;
        
        document.getElementById('gasCalcDisplay').textContent = gasCalcExpression;
    }

    // 加油卡計算機輸入
    function gasCalcInput(value) {
        vibrate();
        
        if (gasWaitingForSecondValue) {
            gasCalcExpression = value.toString();
            gasWaitingForSecondValue = false;
        } else {
            gasCalcExpression = gasCalcExpression === '0' ? value.toString() : gasCalcExpression + value.toString();
        }
        
        document.getElementById('gasCalcDisplay').textContent = gasCalcExpression;
    }

    // 加油卡計算機小數點輸入
    function gasCalcDecimal() {
        vibrate();
        
        if (gasWaitingForSecondValue) {
            gasCalcExpression = '0';
            gasWaitingForSecondValue = false;
        }
        
        if (!gasCalcExpression.includes('.')) {
            gasCalcExpression += '.';
        }
        
        document.getElementById('gasCalcDisplay').textContent = gasCalcExpression;
    }

    // 加油卡計算機清除
    function gasCalcClear() {
        vibrate();
        gasCalcExpression = '0';
        gasOperator = null;
        gasFirstValue = null;
        gasWaitingForSecondValue = false;
        document.getElementById('gasCalcDisplay').textContent = '0';
    }

    // 加油卡計算機退格
    function gasCalcBackspace() {
        vibrate();
        if (gasCalcExpression.length > 1) {
            gasCalcExpression = gasCalcExpression.slice(0, -1);
        } else {
            gasCalcExpression = '0';
        }
        document.getElementById('gasCalcDisplay').textContent = gasCalcExpression;
    }

    // 加油卡計算機等號
    function gasCalcEquals() {
        vibrate();
        
        if (gasFirstValue === null || gasOperator === null) return;
        
        const secondValue = parseFloat(gasCalcExpression);
        let result;
        
        switch (gasOperator) {
            case '+':
                result = gasFirstValue + secondValue;
                break;
            case '-':
                result = gasFirstValue - secondValue;
                break;
            case '*':
                result = gasFirstValue * secondValue;
                break;
            case '/':
                if (secondValue === 0) {
                    showToast('錯誤：不能除以零', true);
                    gasCalcClear();
                    return;
                }
                result = gasFirstValue / secondValue;
                break;
            default:
                return;
        }
        
        gasCalcExpression = result.toString();
        document.getElementById('gasCalcDisplay').textContent = gasCalcExpression;
        
        gasOperator = null;
        gasFirstValue = parseFloat(gasCalcExpression);
        gasWaitingForSecondValue = true;
    }

    // 確認加油卡計算結果
    function confirmGasCalculation() {
        vibrate();
        try {
            if (!gasCalcExpression || gasCalcExpression === '') {
                gasCalcExpression = '0';
            }
            
            let result;
            try {
                result = new Function('return ' + gasCalcExpression)();
            } catch (e) {
                result = parseFloat(gasCalcExpression) || 0;
            }
            
            const field = document.getElementById(gasCurrentInput);
            
            if (gasCurrentInput === 'dieselPrice') {
                result = Math.max(0, result);
                result = Math.round(result * 10) / 10;
                field.value = result.toFixed(1);
            } else if (gasCurrentInput === 'discountAmount') {
                result = Math.max(0, Math.min(5, result));
                result = Math.round(result * 10) / 10;
                field.value = result.toFixed(1);
            } else if (gasCurrentInput === 'monthlyExpense' || gasCurrentInput === 'monthlyVolume') {
                result = Math.max(0, Math.round(result));
                field.value = addGasThousandsSeparator(result);
            }
            
            gasLastModifiedField = gasCurrentInput;
            closeGasCalculator();
            updateGasCalculations();
        } catch (e) {
            showToast('計算錯誤，請重新輸入', true);
            console.error('計算錯誤:', e);
        }
    }

    // 更新加油卡所有計算
    function updateGasCalculations() {
        const dieselPrice = parseFloat(document.getElementById('dieselPrice').value) || 0;
        let monthlyExpense = parseInt(document.getElementById('monthlyExpense').value.replace(/,/g, '')) || 0;
        let monthlyVolume = parseInt(document.getElementById('monthlyVolume').value.replace(/,/g, '')) || 0;
        const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
        
        if (dieselPrice > 0) {
            if (gasLastModifiedField === 'monthlyVolume' && monthlyVolume > 0) {
                monthlyExpense = Math.round(dieselPrice * monthlyVolume);
                document.getElementById('monthlyExpense').value = addGasThousandsSeparator(monthlyExpense);
            } else if ((gasLastModifiedField === 'monthlyExpense' || gasLastModifiedField === 'dieselPrice') && monthlyExpense > 0) {
                monthlyVolume = Math.round(monthlyExpense / dieselPrice);
                document.getElementById('monthlyVolume').value = addGasThousandsSeparator(monthlyVolume);
            }
        }
        
        if (dieselPrice > 0 && monthlyVolume > 0 && discountAmount > 0) {
            const discountedPrice = Math.max(0, dieselPrice - discountAmount);
            const discountedExpense = Math.round(discountedPrice * monthlyVolume);
            document.getElementById('discountedExpense').value = addGasThousandsSeparator(discountedExpense);
            
            const currentMonthlyExpense = Math.round(dieselPrice * monthlyVolume);
            const monthlySaving = Math.max(0, currentMonthlyExpense - discountedExpense);
            document.getElementById('monthlySaving').value = addGasThousandsSeparator(monthlySaving);
            
            const yearlySaving = monthlySaving * 12;
            document.getElementById('yearlySaving').value = addGasThousandsSeparator(yearlySaving);
        } else {
            document.getElementById('discountedExpense').value = '';
            document.getElementById('monthlySaving').value = '';
            document.getElementById('yearlySaving').value = '';
        }
    }

    // 清除加油卡計算
    function clearGasCalculation() {
        vibrate();
        
        const fieldsToClear = ['monthlyExpense', 'monthlyVolume', 'discountAmount', 'discountedExpense', 'monthlySaving', 'yearlySaving'];
        
        fieldsToClear.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            field.value = '';
        });
        
        gasLastModifiedField = '';
    }

    // 處理 iframe 載入錯誤
    function handleIframeError() {
        // 取得載入提示元素
        const loader = document.getElementById('gasIframeLoader');
        if (loader) {
            // 顯示錯誤訊息
            loader.innerHTML = `
                <div style="color: var(--error-color);">
                    <div style="font-size: 24px; margin-bottom: 10px;">⚠️</div>
                    <div style="margin-bottom: 8px;">無法載入油價資訊</div>
                    <div style="font-size: 12px; opacity: 0.8;">請檢查網路連線</div>
                </div>
            `;
            loader.style.display = 'block';
        }
        
        // 顯示錯誤提示
        showToast('無法載入即時油價資訊', true);
    }

    // 添加千分位符號（加油卡專用）
    function addGasThousandsSeparator(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }


</script>
	
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('loaded');
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const header = document.querySelector('.sticky-header');
    const h1Element = document.querySelector('h1');
    
    if (!header || !h1Element) return; // 添加检查

    window.addEventListener('scroll', function() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const headerRect = header.getBoundingClientRect();
        const h1Rect = h1Element.getBoundingClientRect();
        
        // 使用更精确的条件判断
        if (scrollTop > header.offsetTop) {
            header.classList.add('is-sticky');
            if (h1Rect.bottom > 0) {
                header.classList.remove('is-sticky');
            }
        } else {
            header.classList.remove('is-sticky');
        }
    });
    });
</script>

<script>
        if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
            .then(registration => {
                console.log('ServiceWorker registration successful');
            })
            .catch(err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
        }

        // 在所有 JavaScript 函數定義之後添加
        document.addEventListener('DOMContentLoaded', function() {
            // 設置輸入框點擊事件
            document.getElementById('period').addEventListener('click', function() {
                openCalculator('period', '請輸入【期數】');
            });
            
            document.getElementById('rate').addEventListener('click', function() {
                openCalculator('rate', '請輸入【稅前利率】');
            });
            
            document.getElementById('principal').addEventListener('click', function() {
                openCalculator('principal', '請輸入【本金】');
            });
            
            document.getElementById('payment').addEventListener('click', function() {
                openCalculator('payment', '請輸入【期繳】');
            });
            
            document.getElementById('commission').addEventListener('click', function() {
                openCalculator('commission', '請輸入【推廣】');
            });

            // 為資金成本輸入框添加點擊事件
            document.getElementById('monthlyCost').addEventListener('click', function() {
                openCalculator('monthlyCost', '請輸入【資金成本】');
            });
            
            // 點擊模態框背景關閉模態框
            document.getElementById('numberInputModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeModal('numberInputModal');
                }
            });

            // 在这里添加历史记录面板背景点击关闭功能
            document.getElementById('historyPanel').addEventListener('click', function(event) {
                if (event.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // 添加計算歷史的滾動功能
            const historyElement = document.getElementById('calculatorHistory');
            let isScrolling = false;
            let startX;
            let scrollLeft;

            historyElement.addEventListener('mousedown', (e) => {
                isScrolling = true;
                startX = e.pageX - historyElement.offsetLeft;
                scrollLeft = historyElement.scrollLeft;
            });

            historyElement.addEventListener('mouseleave', () => {
                isScrolling = false;
            });

            historyElement.addEventListener('mouseup', () => {
                isScrolling = false;
            });

            historyElement.addEventListener('mousemove', (e) => {
                if (!isScrolling) return;
                e.preventDefault();
                const x = e.pageX - historyElement.offsetLeft;
                const walk = (x - startX) * 2; // 滾動速度
                historyElement.scrollLeft = scrollLeft - walk;
            });

            // 添加觸摸事件支持
            historyElement.addEventListener('touchstart', (e) => {
                isScrolling = true;
                startX = e.touches[0].pageX - historyElement.offsetLeft;
                scrollLeft = historyElement.scrollLeft;
            });

            historyElement.addEventListener('touchend', () => {
                isScrolling = false;
            });

            historyElement.addEventListener('touchmove', (e) => {
                if (!isScrolling) return;
                const x = e.touches[0].pageX - historyElement.offsetLeft;
                const walk = (x - startX) * 2;
                historyElement.scrollLeft = scrollLeft - walk;
            });

        });
    </script>

    <!-- 數字輸入器模態框 -->
    <div id="numberInputModal" class="modal-overlay">
        <div class="number-input-modal">
            <div class="modal-header">
                <h3 id="inputModalTitle">數字輸入器</h3>
                <button class="close-btn" onclick="closeModal('numberInputModal')">×</button>
            </div>

            <div class="calculator-display-container">
                <div class="calculator-scroll-indicator" id="historyScrollIndicator"></div>
                <div class="calculator-history" id="calculatorHistory"></div>
                <div class="calculator-display" id="calculatorDisplay">0</div>
            </div>

            <div class="calculator-buttons">
                <!-- 第一行：功能鍵 -->
                <button onclick="calculatorClear()" class="clear">C</button>
                <button onclick="calculatorBackspace()" class="function">⌫</button>
                <button onclick="calculatorOperation('/')" class="operator">÷</button>
                <button onclick="calculatorOperation('*')" class="operator">×</button>
                
                <!-- 第二行：數字和減號 -->
                <button onclick="calculatorInput(7)" class="number-btn">
                    <div class="arabic-number">7</div>
                    <div class="financial-char">柒</div>
                </button>
                <button onclick="calculatorInput(8)" class="number-btn">
                    <div class="arabic-number">8</div>
                    <div class="financial-char">捌</div>
                </button>
                <button onclick="calculatorInput(9)" class="number-btn">
                    <div class="arabic-number">9</div>
                    <div class="financial-char">玖</div>
                </button>
                <button onclick="calculatorOperation('-')" class="operator">−</button>
                
                <!-- 第三行：數字和加號 -->
                <button onclick="calculatorInput(4)" class="number-btn">
                    <div class="arabic-number">4</div>
                    <div class="financial-char">肆</div>
                </button>
                <button onclick="calculatorInput(5)" class="number-btn">
                    <div class="arabic-number">5</div>
                    <div class="financial-char">伍</div>
                </button>
                <button onclick="calculatorInput(6)" class="number-btn">
                    <div class="arabic-number">6</div>
                    <div class="financial-char">陸</div>
                </button>
                <button onclick="calculatorOperation('+')" class="operator">+</button>
                
                <!-- 第四行：底部數字和等號 -->
                <button onclick="calculatorInput(1)" class="number-btn">
                    <div class="arabic-number">1</div>
                    <div class="financial-char">壹</div>
                </button>
                <button onclick="calculatorInput(2)" class="number-btn">
                    <div class="arabic-number">2</div>
                    <div class="financial-char">貳</div>
                </button>
                <button onclick="calculatorInput(3)" class="number-btn">
                    <div class="arabic-number">3</div>
                    <div class="financial-char">參</div>
                </button>
                <button onclick="calculatorEquals()" class="equals">=</button>
                
                <!-- 第五行：零、小數點和確認鍵 -->
                <button onclick="calculatorInput(0)" class="number-btn">
                    <div class="arabic-number">0</div>
                    <div class="financial-char">零</div>
                </button>
                <button onclick="calculatorDecimal()" class="function">.</button>
                <button onclick="submitCalculatorValue()" class="submit">確認輸入</button>
            </div>
        </div>
    </div>

    <script>
        
        // ============================================
        // 顯示模式切換功能
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // 取得切換按鈕和圖標元素
            const toggleBtn = document.getElementById('toggleViewBtn');
            const toggleIcon = document.getElementById('toggleIcon');
            
            // 定義三種顯示模式
            let viewMode = 0; // 0: 完整模式, 1: 計算模式, 2: 精簡模式
            
            // 定義各模式需要隱藏的欄位
            const hideInCalcMode = [
                // 計算模式要隱藏的欄位
                'yearlyInterest',           // 每年利息
                'monthlyInterest',          // 每月利息
                'annualMillionInterest',    // 百萬每年利息
                'monthlyMillionInterest',   // 百萬每月利息
                'annualTenThousandInterest',// 一萬每年利息
                'monthlyTenThousandInterest'// 一萬每月利息
            ];
            
            const hideInSimpleMode = [
                // 精簡模式要隱藏的欄位（包含計算模式的所有欄位）
                'yearlyInterest',           // 每年利息
                'monthlyInterest',          // 每月利息
                'tax',                      // 稅金
                'afterTaxRate',             // 稅後利率
                'annualMillionInterest',    // 百萬每年利息
                'monthlyMillionInterest',   // 百萬每月利息
                'annualTenThousandInterest',// 一萬每年利息
                'monthlyTenThousandInterest',// 一萬每月利息
                'customerInvoice',          // 客戶發票
                'businessTax',              // 營業稅
                'untaxedAmount',            // 未稅金額
                'chineseAmount',            // 發票（中文大寫）
                'totalPaymentChinese'       // 總繳（中文大寫）
            ];
            
            // 根據欄位ID找到對應的行容器
            function getRowByFieldId(fieldId) {
                const field = document.getElementById(fieldId);
                if (!field) return null;
                return field.closest('.row, .chinese-amount-row, .total-payment-chinese-row');
            }
            
            // 更新顯示模式
            function updateViewMode() {
                // 先顯示所有元素
                document.querySelectorAll('.mode-hidden').forEach(el => {
                    el.classList.remove('mode-hidden');
                });
                
                // 根據當前模式更新圖標
                if (viewMode === 0) {
                    // 完整模式 - 圓形
                    toggleIcon.className = 'mode-icon mode-circle';
                    toggleIcon.textContent = '●';
                } else if (viewMode === 1) {
                    // 計算模式 - 正方形
                    toggleIcon.className = 'mode-icon mode-square';
                    toggleIcon.textContent = '■';
                    
                    // 隱藏計算模式的欄位
                    hideInCalcMode.forEach(fieldId => {
                        const row = getRowByFieldId(fieldId);
                        if (row) row.classList.add('mode-hidden');
                    });
                    
                    // 處理計算模式的分隔線
                    handleDividersForCalcMode();
                } else {
                    // 精簡模式 - 三角形
                    toggleIcon.className = 'mode-icon mode-triangle';
                    toggleIcon.textContent = '▲';
                    
                    // 隱藏精簡模式的欄位
                    hideInSimpleMode.forEach(fieldId => {
                        const row = getRowByFieldId(fieldId);
                        if (row) row.classList.add('mode-hidden');
                    });
                    
                    // 處理精簡模式的分隔線
                    handleDividersForSimpleMode();
                }
                
                // 顯示當前模式提示
                const modeNames = ['完整模式', '計算模式', '精簡模式'];
                showToast(`切換至${modeNames[viewMode]}`);
            }

            // 處理計算模式的分隔線
            function handleDividersForCalcMode() {
                // 取得所有分隔線
                const dividers = document.querySelectorAll('.divider-flow');
                
                // 在計算模式下，隱藏第3條分隔線（稅佣後利率上方的分隔線）
                // 這樣可以避免稅佣後利率和資金成本之間出現2條分隔線
                if (dividers[2]) dividers[2].classList.add('mode-hidden');
            }

            // 處理精簡模式的分隔線
            function handleDividersForSimpleMode() {
                // 取得所有分隔線
                const dividers = document.querySelectorAll('.divider-flow');
                
                // 在精簡模式下隱藏特定分隔線
                // 隱藏第1條分隔線（每月利息下方）
                if (dividers[0]) dividers[0].classList.add('mode-hidden');
                
                // 隱藏第2條分隔線（稅後利率下方）
                if (dividers[1]) dividers[1].classList.add('mode-hidden');
                
                // 隱藏第3條分隔線（推廣比例下方）
                if (dividers[2]) dividers[2].classList.add('mode-hidden');
                
                // 隱藏第4條分隔線（一萬利息下方）
                if (dividers[3]) dividers[3].classList.add('mode-hidden');
                
                // 隱藏第5條分隔線（NPV下方的第一條）
                if (dividers[4]) dividers[4].classList.add('mode-hidden');
            }
            
            // 綁定按鈕點擊事件
            toggleBtn.addEventListener('click', function() {
                // 切換到下一個模式（循環）
                viewMode = (viewMode + 1) % 3;
                
                // 更新顯示
                updateViewMode();
                
                // 觸發震動效果
                vibrate();
            });
            
            // 初始化顯示（完整模式）
            updateViewMode();
        });
    </script>

    <script>
        // 選單功能控制
        document.addEventListener('DOMContentLoaded', function() {
            // 綁定選單按鈕事件
            const menuBtn = document.getElementById('menuBtn');
            menuBtn.addEventListener('click', function() {
                // 移除任何影響按鈕位置的代碼
                openMainMenu();
                vibrate();
            });
            
            // 點擊背景關閉選單
            const mainMenuContainer = document.getElementById('mainMenuContainer');
            mainMenuContainer.addEventListener('click', function(event) {
                if (event.target === this) {
                    closeMainMenu();
                }
            });
            
            // 點擊背景關閉子選單
            const submenus = document.querySelectorAll('.submenu-container');
            submenus.forEach(function(submenu) {
                submenu.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeSubmenu(this.id);
                    }
                });
            });
        });
        
        // 打開主選單
        function openMainMenu() {
            const mainMenuContainer = document.getElementById('mainMenuContainer');
            mainMenuContainer.style.display = 'flex';
            // 添加延遲以觸發動畫
            setTimeout(() => {
                mainMenuContainer.classList.add('show');
            }, 10);
        }
        
        // 關閉主選單
        function closeMainMenu() {
            const mainMenuContainer = document.getElementById('mainMenuContainer');
            mainMenuContainer.classList.remove('show');
            
            // 等待動畫結束後隱藏
            setTimeout(function() {
                mainMenuContainer.style.display = 'none';
                
                // 同時確保所有子選單也關閉
                const submenus = document.querySelectorAll('.submenu-container');
                submenus.forEach(function(submenu) {
                    submenu.style.display = 'none';
                });
            }, 400); // 與CSS過渡時間相匹配
            
            vibrate(); // 使用現有的震動函數
        }

        // 打開子選單
        function openSubmenu(submenuId) {
            // 先關閉主選單
            const mainMenuContainer = document.getElementById('mainMenuContainer');
            mainMenuContainer.classList.remove('show');
            
            setTimeout(() => {
                mainMenuContainer.style.display = 'none';
                
                // 打開指定的子選單
                const submenu = document.getElementById(submenuId);
                submenu.style.display = 'flex';
                
                // 添加延遲以觸發動畫
                setTimeout(() => {
                    submenu.classList.add('show');
                }, 10);
            }, 300);
            
            vibrate(); // 使用現有的震動函數
        }

        // 返回主選單
        function backToMainMenu(submenuId) {
            // 關閉當前子選單
            const submenu = document.getElementById(submenuId);
            submenu.classList.remove('show');
            
            // 等待動畫結束
            setTimeout(function() {
                submenu.style.display = 'none';
                
                // 顯示主選單
                const mainMenuContainer = document.getElementById('mainMenuContainer');
                mainMenuContainer.style.display = 'flex';
                
                setTimeout(() => {
                    mainMenuContainer.classList.add('show');
                }, 10);
            }, 300);
            
            vibrate(); // 使用現有的震動函數
        }

        // 關閉子選單
        function closeSubmenu(submenuId) {
            const submenu = document.getElementById(submenuId);
            const submenuContent = submenu.querySelector('.submenu-content');
            
            // 添加關閉動畫
            submenuContent.classList.add('submenu-closing');
            
            // 動畫結束後隱藏子選單
            setTimeout(function() {
                submenu.style.display = 'none';
                submenuContent.classList.remove('submenu-closing');
            }, 200); // 與動畫時長相匹配
            
            vibrate(); // 使用現有的震動函數
        }

        // 顯示功能開發中提示
        function showDevelopingToast() {
            // 使用現有的 showToast 函數
            showToast('功能開發中');
            vibrate(); // 觸發震動
        }

        function switchTheme(themeName) {
            // 先移除舊有任何主題數據
            document.documentElement.removeAttribute('data-theme');
            
            // 如果選擇的不是預設主題，則設定新主題
            if (themeName !== 'default') {
                document.documentElement.setAttribute('data-theme', themeName);
            }
            
            // 保存主題設置到localStorage
            localStorage.setItem('selectedTheme', themeName);
            
            // 如果有可見的報價卡片，根據新主題更新它
            const shareQuoteCard = document.getElementById('shareQuoteCard');
            if (shareQuoteCard && shareQuoteCard.innerHTML.trim() !== '') {
                // 延遲一點時間以確保CSS變量已更新
                setTimeout(() => {
                    const updatedQuoteHtml = generateQuoteCardHtml();
                    shareQuoteCard.innerHTML = updatedQuoteHtml;
                }, 100);
            }
            
            // 觸發震動反饋
            vibrate();
        }

        function getThemeName(themeCode) {
            switch(themeCode) {
                case 'default': return '暗夜橘焰';
                case 'white': return '極簡黑白';
                case 'pink': return '櫻花雪';
                case 'red': return '暗夜烈焰';
                case 'blue-purple': return '暮光星塵';
                case 'green': return '翠玉清風';
                case 'blue': return '科技藍調';
                case 'royal': return '皇家紫韻';
                default: return themeCode;
            }
        }

        // 根據主題代碼返回顯示名稱
        function getThemeName(themeCode) {
            switch(themeCode) {
                case 'default': return '暗夜橘焰';
                case 'white': return '極簡黑白';
                case 'pink': return '櫻花雪';
                case 'red': return '暗夜烈焰';
                case 'blue-purple': return '暮光星塵';
                case 'green': return '翠玉清風';
                case 'blue': return '科技藍調';
                case 'royal': return '皇家紫韻';
                default: return themeCode;
            }
        }

        // 頁面加載時恢復保存的主題
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme) {
                switchTheme(savedTheme);
            }
        });

    </script>

    <!-- 報價卡片模板 -->
    <div id="quoteCardTemplate" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; background-color: var(--primary-color); padding: 20px; box-sizing: border-box;">
        <div id="quoteCard" style="width: 100%; max-width: 380px; margin: 0 auto; background-color: var(--primary-color); padding: 20px; border-radius: 15px; font-family: 'Microsoft JhengHei', Arial, sans-serif; color: var(--text-color); box-shadow: 0 10px 25px var(--shadow-color); border: 2px solid var(--accent-color);">
            <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid var(--accent-color); padding-bottom: 10px;">
                <h2 style="margin: 0; font-size: 20px; color: var(--accent-color);">貸款計算報價單</h2>
                <div style="font-size: 14px; margin-top: 5px;" id="quoteDate"></div>
            </div>
            
            <table style="width: 100%; border-collapse: separate; border-spacing: 0 8px;">
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: var(--accent-color); font-weight: bold;">期數:</td>
                    <td style="text-align: left; font-weight: bold;" id="quotePeriod"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: var(--accent-color); font-weight: bold;">稅前利率:</td>
                    <td style="text-align: left; font-weight: bold;" id="quoteRate"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: var(--accent-color); font-weight: bold;">本金:</td>
                    <td style="text-align: left; font-weight: bold;" id="quotePrincipal"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: var(--accent-color); font-weight: bold;">期繳:</td>
                    <td style="text-align: left; font-weight: bold;" id="quotePayment"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: var(--accent-color); font-weight: bold;">總利息:</td>
                    <td style="text-align: left; font-weight: bold;" id="quoteTotalInterest"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: var(--accent-color); font-weight: bold;">稅後利率:</td>
                    <td style="text-align: left; font-weight: bold;" id="quoteAfterTaxRate"></td>
                </tr>
                <tr id="quoteCommissionRow">
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: var(--accent-color); font-weight: bold;">推廣:</td>
                    <td style="text-align: left; font-weight: bold;" id="quoteCommission"></td>
                </tr>
                <tr>
                    <td style="width: 40%; text-align: right; padding-right: 15px; color: var(--accent-color); font-weight: bold;">稅佣後利率:</td>
                    <td style="text-align: left; font-weight: bold;" id="quoteAfterCommissionRate"></td>
                </tr>
            </table>
            
            <div style="text-align: center; margin-top: 15px; font-size: 14px; color: var(--text-muted); border-top: 1px dashed var(--border-color); padding-top: 10px;">
                報價後記得吃碗火雞肉飯唷！
            </div>
        </div>
    </div>

    <!-- 分享模態框 -->
    <div id="shareModalOverlay" class="modal-overlay">
        <div class="modal-container" style="max-width: 400px;">
            <div class="modal-header">
                <h3>分享貸款計算結果</h3>
                <button class="close-btn" onclick="hideShareModal()">×</button>
            </div>
            <div class="modal-content" style="text-align: center; padding: 10px;">
                <div id="shareQuoteCard" style="margin: 0 auto; max-width: 380px; padding: 0;"></div>
                <div style="margin: 15px 0;">
                    <div id="shareOptions" style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">
                        <button id="downloadBtn" class="modal-btn modal-btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <span style="font-size: 18px;">💾</span> 下載圖片
                        </button>
                        <button id="shareBtn" class="modal-btn modal-btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <span style="font-size: 18px;">🔗</span> 直接分享
                        </button>
                    </div>
                    <div id="shareStatus" style="margin-top: 15px; color: #ff9c33; font-size: 14px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主選單 -->
    <div id="mainMenuContainer" class="menu-container">
        <div class="menu-content">
            <div class="menu-header">
                <h3>主選單</h3>
                <button class="menu-close-btn" onclick="closeMainMenu()">×</button>
            </div>

            <ul class="menu-list" style="flex: 1; overflow-y: auto;">
                <!-- 登入/使用者資訊整合區塊 -->
                <li id="authSection" style="
                    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
                    border-radius: 12px;
                    margin: 8px;
                    padding: 0;
                    overflow: hidden;
                    transition: all 0.3s ease;
                ">
                    <!-- 未登入狀態 -->
                    <div id="loginPrompt" class="menu-item" style="
                        border-bottom: none;
                        padding: 20px;
                        text-align: center;
                    ">
                        <div style="font-size: 40px; margin-bottom: 12px;">🔐</div>
                        <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">登入以同步您的資料</div>
                        <button onclick="signInWithGoogle()" style="
                            background: var(--accent-color);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 10px 24px;
                            font-size: 15px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.3)';" 
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.2)';">
                            <span style="margin-right: 8px;">G</span>使用 Google 登入
                        </button>
                    </div>
                    
                    <!-- 已登入狀態（預設隱藏） -->
                    <div id="userInfoSection" style="display: none;">
                        <!-- 使用者資訊會動態插入這裡 -->
                    </div>
                </li>
                <li class="menu-item" onclick="showPaymentComparison(); closeMainMenu();">
                    <span>📊 期數方案對比</span>
                </li>
                <li class="menu-item" onclick="showGasCardCalculator(); closeMainMenu();">
                    <span>⛽ 加油卡優惠計算</span>
                </li>
                <li class="menu-item" onclick="openSubmenu('themeSubmenu')">
                    <span>🎨 外觀</span> <span class="menu-item-arrow">▶</span>
                </li>
                <li class="menu-item" onclick="openSubmenu('languageSubmenu')">
                    <span>🌐 語言</span> <span class="menu-item-arrow">▶</span>
                </li>
            </ul>
            <div class="version-info">v3.88</div>
        </div>
    </div>

    <!-- 外觀子選單 -->
    <div id="themeSubmenu" class="submenu-container">
        <div class="submenu-content">
            <div class="submenu-header">
                <button class="submenu-back-btn" onclick="backToMainMenu('themeSubmenu')">
                    ◀ 返回
                </button>
                <h3>外觀</h3>
            </div>
            <ul class="submenu-list" style="flex: 1; overflow-y: auto;">
                <li class="submenu-item" onclick="switchTheme('default')">🔥 暗夜橘焰</li>
                <li class="submenu-item" onclick="switchTheme('white')">⚪ 極簡黑白</li> 
                <li class="submenu-item" onclick="switchTheme('pink')">🌸 櫻花雪</li>
                <li class="submenu-item" onclick="switchTheme('red')">🔴 暗夜烈焰</li>
                <li class="submenu-item" onclick="switchTheme('blue-purple')">🌌 暮光星塵</li>
                <li class="submenu-item" onclick="switchTheme('green')">🍃 翠玉清風</li>
                <li class="submenu-item" onclick="switchTheme('blue')">💙 科技藍調</li>
                <li class="submenu-item" onclick="switchTheme('royal')">👑 皇家紫韻</li>
            </ul>
        </div>
    </div>

    <!-- 語言子選單 -->
    <div id="languageSubmenu" class="submenu-container">
        <div class="submenu-content">
            <div class="submenu-header">
                <button class="submenu-back-btn" onclick="backToMainMenu('languageSubmenu')">
                    ◀ 返回
                </button>
                <h3>語言</h3>
            </div>
            <ul class="submenu-list" style="flex: 1; overflow-y: auto;">
                <li class="submenu-item" onclick="showDevelopingToast()">🇹🇼 中文</li>
                <li class="submenu-item" onclick="showDevelopingToast()">🇺🇸 英文</li>
                <li class="submenu-item" onclick="showDevelopingToast()">🇵🇭 菲律賓</li>
                <li class="submenu-item" onclick="showDevelopingToast()">🇯🇵 日文</li>
            </ul>
        </div>
    </div>

    <!-- 年齡提示視窗 -->
    <div id="ageModal" class="install-modal-overlay" style="display: none;">
        <div class="install-modal">
            <!-- 修改：將標題改為可點擊的隱藏按鈕，點擊後可關閉提示框 -->
            <h2 class="install-modal-title" 
                style="cursor: pointer; user-select: none;" 
                onclick="handleTitleClick();"
                title="連續點擊3次可以關閉提示框">18+ **Warning!**</h2>
            <div class="install-modal-content">
                This is a specialized calculator meticulously engineered for children who exhibit difficulties with mathematics and demonstrate notably sluggish computational speed. Should you be an adult possessing proficient arithmetic capabilities, it is strongly advised that you refrain from accessing this website without necessity. However, if you, too, are an enthusiast of turkey rice, your utilization of this platform's features is most heartily welcomed.
            </div>
            <div class="install-modal-buttons">
                <button id="notAdultBtn" class="install-modal-btn install-btn-cancel">Not 18 yet</button>
                <button id="adultBtn" class="install-modal-btn install-btn-confirm">Already 18+</button>
            </div>
        </div>
    </div>

    <!-- 安裝橫幅提示 -->
    <div id="installBanner" class="install-banner" style="display: none;">
        <div class="install-banner-text">將小朋友專用計算機安裝到桌面</div>
        <button id="installBtn" class="install-banner-btn">安裝</button>
        <button id="closeBannerBtn" class="install-banner-close">×</button>
    </div>

    <!-- 加油卡優惠計算模態框 -->
    <div id="gasCardModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--primary-color); z-index: 2000;">
        <div style="width: 100%; height: 100%; display: flex; flex-direction: column; background-color: var(--primary-color);">
            <div class="modal-header" style="background-color: var(--secondary-color); border-bottom: 2px solid var(--accent-color); padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: var(--accent-color); font-size: 20px;">加油卡優惠計算</h3>
                <button class="close-btn" onclick="closeGasCardCalculator()" style="background: none; border: none; color: var(--text-color); font-size: 24px; cursor: pointer; padding: 5px 10px;">×</button>
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 10px; background-color: var(--primary-color);">
                <div id="gasCardContent">
                    <!-- 加油卡計算器內容將動態插入這裡 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let deferredPrompt;
    
        // 顯示年齡提示視窗和安裝提示
        function showInstallPrompt() {
            // 修改說明：這個函數用於顯示年齡警告視窗
            // 標題可以點擊關閉，Not 18 yet 按鈕會導向 Baby Shark 影片
            // Already 18+ 按鈕會導向 Rick Roll 影片
            
            document.getElementById('ageModal').style.display = 'flex';
            
            // 當用戶點擊「Not 18 yet」按鈕時（修改：改為連結到 Baby Shark 影片）
            document.getElementById('notAdultBtn').addEventListener('click', function() {
                // 將使用者導向到 Baby Shark 的 YouTube 影片
                window.location.href = 'https://www.youtube.com/watch?v=4bMOTTJqGgM&list=RD4bMOTTJqGgM&start_radio=1&ab_channel=BabySharkOfficial';
            });
            
            // 當用戶點擊「Already 18+」按鈕時
            document.getElementById('adultBtn').addEventListener('click', function() {
                // 跳轉到Rick Roll視頻
                window.location.href = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ&ab_channel=RickAstley';
            });
        }
    
        // 檢查是否可以安裝PWA
        function checkInstallAvailable() {
            const installBanner = document.getElementById('installBanner');
            const installBtn = document.getElementById('installBtn');
            const closeBannerBtn = document.getElementById('closeBannerBtn');
            
            // 監聽beforeinstallprompt事件
            window.addEventListener('beforeinstallprompt', (e) => {
                // 阻止Chrome 67及更早版本自動顯示的安裝提示
                e.preventDefault();
                // 保存事件，以便稍後觸發
                deferredPrompt = e;
                // 顯示安裝橫幅
                installBanner.style.display = 'flex';
            });
            
            // 安裝按鈕點擊事件
            installBtn.addEventListener('click', () => {
                if (deferredPrompt) {
                    // 顯示安裝提示
                    deferredPrompt.prompt();
                    // 等待用戶回應提示
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('用戶接受安裝');
                            // 隱藏安裝橫幅
                            installBanner.style.display = 'none';
                        }
                        deferredPrompt = null;
                    });
                }
            });
            
            // 關閉按鈕點擊事件
            closeBannerBtn.addEventListener('click', () => {
                installBanner.style.display = 'none';
            });
            
            // 監聽appinstalled事件
            window.addEventListener('appinstalled', (evt) => {
                console.log('應用已安裝');
                // 隱藏安裝橫幅
                installBanner.style.display = 'none';
            });
        }
    </script>

    <script>
        // Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyBvaz4vcGzVFSQU52abK5YLk2Ii1sEOoM8",
            authDomain: "loan-calculator-app-76a7d.firebaseapp.com",
            projectId: "loan-calculator-app-76a7d",
            storageBucket: "loan-calculator-app-76a7d.firebasestorage.app",
            messagingSenderId: "939791472492",
            appId: "1:939791472492:web:0685760b3eb4faaac68549",
            measurementId: "G-3N3S9DKLPN"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);

        // 初始化 Firebase Auth
        const auth = firebase.auth();
        auth.languageCode = 'zh-TW';

        // 初始化 Firestore
        const db = firebase.firestore();

        // 同步狀態管理
        let syncStatus = {
            isSyncing: false,          // 是否正在同步
            lastSyncTime: null,        // 最後同步時間
            pendingChanges: 0,         // 待同步的變更數量
            isOnline: navigator.onLine  // 是否在線
        };

        // 監聽網路連線狀態
        window.addEventListener('online', () => {
            syncStatus.isOnline = true;
            updateSyncStatusUI();
            // 網路恢復時自動同步
            if (window.currentUser) {
                autoSync();
            }
        });

        window.addEventListener('offline', () => {
            syncStatus.isOnline = false;
            updateSyncStatusUI();
        });

        // 全域變數儲存使用者資訊
        window.currentUser = null;

        // 登入函數
        function signInWithGoogle() {
            console.log('開始 Google 登入...');
            const provider = new firebase.auth.GoogleAuthProvider();
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('登入成功:', result.user);
                    showToast('登入成功！歡迎 ' + result.user.displayName);
                    vibrate();
                })
                .catch((error) => {
                    console.error('登入錯誤:', error);
                    if (error.code === 'auth/popup-blocked') {
                        showToast('請允許彈出視窗以完成登入', true);
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        showToast('登入已取消', true);
                    } else {
                        showToast('登入失敗：' + error.message, true);
                    }
                });
        }

        // 登出函數
        function signOut() {
            auth.signOut()
                .then(() => {
                    showToast('已成功登出');
                    vibrate();
                })
                .catch((error) => {
                    console.error('登出錯誤:', error);
                    showToast('登出失敗：' + error.message, true);
                });
        }

        // 更新介面以反映登入狀態
        function updateUIForAuth(user) {
            const loginPrompt = document.getElementById('loginPrompt');
            const userInfoSection = document.getElementById('userInfoSection');
            
            if (user) {
                // 使用者已登入
                if (loginPrompt) loginPrompt.style.display = 'none';
                if (userInfoSection) {
                    userInfoSection.style.display = 'block';
                    userInfoSection.innerHTML = `
                        <!-- 使用者基本資訊 -->
                        <div style="
                            padding: 16px;
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                        ">
                            <!-- 使用者頭像 -->
                            <div style="position: relative;">
                                ${user.photoURL ? 
                                    `<img src="${user.photoURL}" style="
                                        width: 48px; 
                                        height: 48px; 
                                        border-radius: 50%;
                                        border: 2px solid var(--accent-color);
                                    ">` : 
                                    `<div style="
                                        width: 48px; 
                                        height: 48px; 
                                        border-radius: 50%;
                                        background: var(--accent-color);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                        font-weight: bold;
                                    ">${(user.displayName || user.email || '使用者')[0].toUpperCase()}</div>`
                                }
                                <!-- 線上狀態指示器 -->
                                <div style="
                                    position: absolute;
                                    bottom: 0;
                                    right: 0;
                                    width: 14px;
                                    height: 14px;
                                    background: #4CAF50;
                                    border-radius: 50%;
                                    border: 2px solid var(--primary-color);
                                "></div>
                            </div>
                            
                            <!-- 使用者名稱和信箱 -->
                            <div style="flex: 1;">
                                <div style="font-weight: 500; font-size: 15px;">${user.displayName || '使用者'}</div>
                                <div style="color: var(--text-muted); font-size: 12px; margin-top: 2px;">${user.email}</div>
                            </div>
                            
                            <!-- 登出按鈕（優雅的小按鈕） -->
                            <button onclick="signOut()" style="
                                background: rgba(var(--error-color-rgb), 0.1);
                                color: var(--error-color);
                                border: 1px solid rgba(var(--error-color-rgb), 0.3);
                                border-radius: 6px;
                                padding: 6px 12px;
                                font-size: 12px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                                white-space: nowrap;
                            " onmouseover="this.style.backgroundColor='var(--error-color)'; this.style.color='white'; this.style.transform='scale(1.05)';" 
                            onmouseout="this.style.backgroundColor='rgba(var(--error-color-rgb), 0.1)'; this.style.color='var(--error-color)'; this.style.transform='scale(1)';">
                                登出
                            </button>
                        </div>
                        
                        <!-- 同步狀態區塊（保持原有設計） -->
                        <div id="syncStatusContainer" style="
                            margin: 8px;
                            background-color: rgba(var(--info-color-rgb), 0.1);
                            border-radius: 8px;
                            padding: 12px;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            font-size: 13px;
                            transition: all 0.3s ease;
                        ">
                            <!-- 同步圖示 -->
                            <div id="syncIcon" style="
                                width: 20px;
                                height: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <span style="font-size: 16px;">☁️</span>
                            </div>
                            
                            <!-- 同步文字 -->
                            <div style="flex: 1;">
                                <div id="syncStatusText" style="font-weight: 500;">已同步</div>
                                <div id="syncTimeText" style="color: var(--text-muted); font-size: 11px;">從未同步</div>
                            </div>
                            
                            <!-- 手動同步按鈕 -->
                            <button id="manualSyncBtn" onclick="manualSync()" style="
                                background: none;
                                border: 1px solid var(--info-color);
                                color: var(--info-color);
                                border-radius: 4px;
                                padding: 4px 8px;
                                font-size: 12px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.backgroundColor='var(--info-color)'; this.style.color='white';" 
                            onmouseout="this.style.backgroundColor='transparent'; this.style.color='var(--info-color)';">
                                同步
                            </button>
                        </div>
                    `;
                }
            } else {
                // 使用者未登入
                if (loginPrompt) loginPrompt.style.display = 'block';
                if (userInfoSection) {
                    userInfoSection.style.display = 'none';
                    userInfoSection.innerHTML = '';
                }
            }
        }

        // 等待 DOM 載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 監聽使用者登入狀態
            auth.onAuthStateChanged((user) => {
                window.currentUser = user;
                updateUIForAuth(user);
                
                if (user) {
                    // 儲存使用者資訊到 localStorage
                    const userInfo = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        lastLogin: new Date().toISOString()
                    };
                    localStorage.setItem('userInfo', JSON.stringify(userInfo));
                    
                    // 登入後自動同步資料
                    setTimeout(() => {
                        // 顯示同步開始提示
                        showToast('正在同步您的資料...');
                        
                        // 執行自動同步
                        autoSync();
                        
                        // 設定定期同步（每5分鐘）
                        if (window.syncInterval) {
                            clearInterval(window.syncInterval);
                        }
                        window.syncInterval = setInterval(() => {
                            if (window.currentUser && syncStatus.isOnline) {
                                autoSync();
                            }
                        }, 300000); // 5分鐘 = 300000毫秒
                    }, 1000);
                } else {
                // 清除本地儲存的使用者資訊
                localStorage.removeItem('userInfo');
                
                // 清除同步定時器
                if (window.syncInterval) {
                    clearInterval(window.syncInterval);
                    window.syncInterval = null;
                }
                
                // 重置同步狀態
                syncStatus = {
                    isSyncing: false,
                    lastSyncTime: null,
                    pendingChanges: 0,
                    isOnline: navigator.onLine
                };
            }
            });
        });
    </script>

</body>
</html>
