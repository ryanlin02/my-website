<!DOCTYPE html>
<html lang="zh-TW">
<head>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XE5XMQR0Z1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XE5XMQR0Z1');
    </script>

    <!-- 在 <head> 標籤內添加以下內容 -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#333333">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="雞肉飯">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <meta charset="UTF-8">
	<meta name="viewport" content="width=400, user-scalable=no">

    <!-- 在現有的 meta 標籤下方添加 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>雞肉飯天天吃</title>
    <style>

    :root {
        --primary-color: #333333;
        --secondary-color: #4a4a4a;
        --text-color: #ffffff;
        --border-color: #555555;
        --hover-color: #666666;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --button-orange: #ff9c33;
        --button-blue: #33b5e5;
		--button-grey: #333333;
    }

    .login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #333333 0%, #222222 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.5s ease-out;
    }

    .login-container {
        background-color: var(--secondary-color);
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
        transform: translateY(0);
        animation: slideUp 0.5s ease-out;
        border: 1px solid rgba(255, 156, 51, 0.2);
        position: relative;
        overflow: hidden;
    }

    .login-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--button-orange), transparent);
        animation: loading 3s linear infinite;
    }

    .login-container h2 {
        color: var(--text-color);
        margin-bottom: 30px;
        font-size: 24px;
        font-weight: bold;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        position: relative;
        display: inline-block;
    }

    .login-container h2::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--button-orange);
        transform: scaleX(0);
        transform-origin: right;
        transition: transform 0.6s ease-out;
    }

    .login-container:hover h2::after {
        transform: scaleX(1);
        transform-origin: left;
    }

    .google-signin {
        margin-top: 20px;
        transform: scale(1);
        transition: transform 0.3s ease;
        will-change: transform;
    }

    .google-signin:hover {
        transform: scale(1.02);
    }

    @keyframes loading {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .sign-out-btn {
        background-color: var(--secondary-color);
        color: var(--button-orange);
        border: 1px solid var(--button-orange);
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .sign-out-btn:hover {
        background-color: var(--button-orange);
        color: var(--text-color);
        transform: translateY(-2px);
    }

    /* 添加響應動畫效果 */
    .login-container:hover {
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        transform: translateY(-2px);
        transition: all 0.3s ease;
    }

    /* 為登入按鈕添加動畫效果 */
    .g_id_signin {
        transition: all 0.3s ease;
    }

    .g_id_signin:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* 在登入容器周圍添加裝飾元素 */
    .login-container::after {
        content: '🍚';
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        opacity: 0.5;
        animation: rotate 3s linear infinite;
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* 更新用戶配置區域的樣式 */
    #userProfile {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 15px;    /* 調整上下內邊距從 12px 改為 8px */
        margin: 8px auto;     /* 調整上下外邊距從 15px 改為 8px */
        border-radius: 8px;
        background: var(--secondary-color);
        max-width: calc(100% - 30px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    /* 調整使用者圖片大小和樣式 */
    #userProfile img {
        width: 20px;         /* 調整圖片大小從 22px 改為 20px */
        height: 20px;
        border-radius: 50%;
        border: 2px solid var(--button-orange);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        margin-right: 8px;   /* 調整右邊距從 12px 改為 8px */
        cursor: pointer;
    }

    #userImage:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    #userName {
        color: var(--text-color);
        font-weight: bold;
        font-size: 13px;     /* 改為 13px 更協調 */
        margin-right: 10px;
        display: block;
        white-space: nowrap; /* 防止名稱換行 */
        max-width: 120px;    /* 限制最大寬度 */
        overflow: hidden;    /* 超出部分隱藏 */
        text-overflow: ellipsis; /* 顯示省略號 */
    }

    /* 優化登出按鈕樣式 */
    .sign-out-btn {
        background-color: var(--secondary-color);
        color: var(--button-orange);
        border: 1px solid var(--button-orange);
        padding: 4px 10px;   /* 調整內邊距 */
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;     /* 調整字體大小 */
        white-space: nowrap;
    }

    .sign-out-btn:hover {
        background-color: var(--button-orange);
        color: var(--text-color);
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }


    .login-container.loading::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1;
    }

    .error-message {
        color: #ff4444;
        font-size: 14px;
        margin-top: 10px;
        animation: shake 0.5s ease-in-out;
    }

		 /* 添加新的動畫關鍵幀 */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes slideIn {
        from { transform: translateX(-20px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes glowBorder {
        0% { box-shadow: 0 0 5px var(--button-orange); }
        50% { box-shadow: 0 0 15px var(--button-orange); }
        100% { box-shadow: 0 0 5px var(--button-orange); }
    }

    /* 修改現有的基礎樣式，添加動畫效果 */

    html, body {
    	width: 100%;           /* 改為100%寬度 */
    	max-width: 400px;      /* 設定最大寬度 */
    	margin: 0 auto;
        position: relative; /* 添加这行 */
    	overflow-x: hidden;
    	-webkit-text-size-adjust: 100%;
    	padding: 0 3px;       /* 增加左右padding */
    	background-color: #333333;
    	color: var(--text-color);
    	font-family: "Microsoft JhengHei", Arial, sans-serif;
    	box-sizing: border-box; /* 添加這行 */
	}

    h1 {
        color: var(--text-color);
        font-size: 22px;
        margin-bottom: 0px;
        border-bottom: 2px solid var(--button-orange);
        padding-bottom: 5px;
		position: relative;
		transition: all 0.3s ease;
    }
    h1:hover {
        transform: translateY(-2px);
        text-shadow: 0 2px 4px rgba(255, 156, 51, 0.3);
    }
    h1::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--button-orange);
        transform: scaleX(0);
        transform-origin: right;
        transition: transform 0.6s ease-out;
    }

    h1:hover::after {
        transform: scaleX(1);
        transform-origin: left;
    }
		

    .row {
        margin: 4px 0;
        display: flex;
        align-items: center;
        background: var(--secondary-color);
        padding: 3px;
        border-radius: 4px;
        box-shadow: 0 4px 8px var(--shadow-color);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        transform-origin: left;
        will-change: transform; 
    }

	.row:hover {
        transform: translateX(5px);
        box-shadow: 0 6px 12px var(--shadow-color);
    }

    .row:hover::before {
        content: '';
        position: absolute;
        left: -5px;
        top: 50%;
        width: 3px;
        height: 0;
        background: var(--button-orange);
        animation: expandHeight 0.3s forwards;
    }

    /* 創建輸入框與按鍵的視覺分組 */
    .input-button-group {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin: 4px 0;
        padding: 1px; /* 減少整體內邊距 */
        background: var(--secondary-color);
        box-shadow: 0 4px 8px var(--shadow-color);
        position: relative;
        overflow: hidden;
    }

    .input-button-group .row {
        background: transparent;
        box-shadow: none;
        margin: 2px 0;  /* 減少上下間距 */
        padding-top: 1px; /* 減少上部內邊距 */
        padding-bottom: 1px; /* 減少下部內邊距 */
    }

    .input-button-group .row:hover {
        transform: translateX(2px);
        box-shadow: none;
    }

    .input-button-group .row:hover::before {
        display: none;
    }

    /* 按鍵容器樣式調整 */
    .input-button-group div[id$="Buttons"] {
        margin: 0;
        padding-top: 0;
        padding-bottom: 2px; /* 減少下部內邊距 */
        border-top: none; /* 移除虛線邊框 */
    }

    @keyframes expandHeight {
        to {
            height: 100%;
            top: 0;
        }
    }

    .label {
        width: 120px;
        margin-right: 15px;
        text-align: right;
        font-weight: 600;
        color: var(--text-color);
        position: relative;
        overflow: hidden;
    }

    input {
        width: 95px;
        padding: 5px 12px;
        margin-right: 10px;
        background-color: #222222;
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 16px;
        transition: all 0.3s ease;
    }

    input:focus {
		outline: none;
		border-color: var(--button-orange);
		box-shadow: 0 0 0 3px rgba(255, 156, 51, 0.2);
		transform: scale(1.07);
	}

    .value-changed {
        animation: valueChange 0.5s ease-out;
        will-change: background-color;
    }

    @keyframes valueChange {
        0% { 
            background-color: rgba(255, 156, 51, 0.2);
            transform: scale(1.02);
        }
        100% { 
            background-color: transparent;
            transform: scale(1);
        }
    }


    button {
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 3px 8px;
        margin: 0 5px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 16px;
    }

    button:hover {
        background-color: var(--hover-color);
		transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
	button:active {
        transform: scale(0.95) translateY(1px);
    	transition: transform 0.1s;
    }
	
	.row button {
        background-color: var(--secondary-color);
        color: #888888; /* 降低文字亮度 */
        border: 1px solid #444444; /* 更深的邊框顏色 */
        padding: 3px 8px;
        margin: 0 5px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 15px;
        opacity: 0.8;
    }

    /* 統一按鈕區域中的按鈕樣式 */
    #periodButtons button, 
    #rateButtons button, 
    #principalButtons button, 
    #commissionButtons button, 
    #PaymentduringButtons button {
        min-width: 50px;       /* 設置最小寬度 */
        text-align: center;    /* 文字居中 */
        flex: 1;               /* 平均分配空間 */
        max-width: 80px;       /* 限制最大寬度 */
        margin: 0 2px;         /* 調整邊距 */
        height: 28px;          /* 統一高度 */
        padding: 0 5px;        /* 調整內距 */
        display: flex;         /* 使用flex佈局 */
        align-items: center;   /* 垂直居中 */
        justify-content: center; /* 水平居中 */
        white-space: nowrap;   /* 防止文字換行 */
        overflow: hidden;      /* 隱藏溢出內容 */
        text-overflow: ellipsis; /* 超出部分使用省略號 */
    }

    /* 針對按鈕數量多的兩個組別進行特殊調整 */
    #periodButtons button, 
    #rateButtons button {
        min-width: 35px;      /* 減小最小寬度 */
        max-width: 50px;      /* 減小最大寬度 */
        padding: 0 3px;       /* 減小內部間距 */
        font-size: 15px;      /* 稍微減小字體大小 */
    }

    /* 減小這兩個按鈕組的按鈕間距 */
    #periodButtons, 
    #rateButtons {
        gap: 2px;             /* 減小按鈕之間的間距 */
    }

    .row button:hover {
        background-color: #4a4a4a; /* 稍微亮一點的灰色 */
        color: #cccccc; /* 亮一點的文字，但不是純白 */
        border-color: #555555;
        opacity: 0.9;
    }

    .row button:active {
        background-color: var(--secondary-color);  /* 點擊時恢復原本顏色 */
        color: var(--text-color);
        border-color: var(--button-grey);
    }
	.row button::after {
		content: '';
		position: absolute;
		top: 50%;
		left: 50%;
		width: 0;
		height: 0;
		background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
		transition: width 0.3s ease-out, height 0.3s ease-out;
		transform: translate(-50%, -50%);
		border-radius: 50%;
	}

	.row button:active::after {
		width: 150px;
		height: 150px;
	}

    /* 當滑鼠懸停在按鍵組上時的效果 */
    .input-button-group div[id$="Buttons"]:hover {
        background-color: rgba(255, 156, 51, 0.05);
        border-radius: 4px;
    }

    /* 將組內的按鍵輕微突出顯示 */
    .input-button-group div[id$="Buttons"] button {
        position: relative;
        z-index: 2;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    /* 改進按鍵點擊反饋 */
    .input-button-group div[id$="Buttons"] button:active {
        transform: scale(0.95);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        transition: transform 0.1s, box-shadow 0.1s;
    }

    /* 添加輕微的懸停效果 */
    .input-button-group div[id$="Buttons"] button:hover {
        border-color: var(--button-orange);
    }

    div[id$="Buttons"] button {
        background-color: var(--secondary-color);
        color: #bcbcbc; /* 提高文字明度 */
        border: 1px solid var(--button-orange); /* 使用橘色外框 */
        padding: 4px 9px;
        margin: 0 4px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 15px;
        opacity: 0.95; /* 提高不透明度 */
    }

    div[id$="Buttons"] button:hover {
        background-color: rgba(255, 156, 51, 0.15); /* 淡橘色背景 */
        color: #ffffff;
        border-color: var(--button-orange);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(255, 156, 51, 0.2);
    }

	div[id$="Buttons"] button:active {
        transform: translateY(1px);
        background-color: rgba(255, 156, 51, 0.3); /* 點擊時只改變當前按鈕的背景 */
        box-shadow: 0 0 5px rgba(255, 156, 51, 0.5) inset; /* 內陰影效果 */
        transition: all 0.1s ease;
    }

    .readonly {
        background-color: #222222;
        animation: breathe 4s ease-in-out infinite;
    }

    @keyframes breathe {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    /* 包装容器样式 */
    /* 修改 wrapper 样式 */
    .time-display-wrapper {
        position: relative;
        height: auto;
        margin: 3px 0;
        z-index: 1000; /* 提高 z-index */
    }

    /* 修改原有的timeDisplay样式 */
    .sticky-header {
        position: -webkit-sticky !important; /* 添加 !important */ /* Safari支持 */
        position: sticky!important;         /* 添加 !important */
        top: 0;
        background: var(--secondary-color);
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 4px var(--shadow-color);
        animation: fadeIn 0.8s ease-out;
        transition: all 0.3s ease;
        z-index: 999;
        width: calc(100% - 16px); /* 考虑内边距 */
        margin: 0 auto;
    }

    /* 添加固定状态的样式 */
    .sticky-header.is-sticky {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        border-radius: 0 0 4px 4px;
    }

    #timeDisplay {
        margin: 3px 0;
        font-size: 15px;
        background: var(--secondary-color);
        color: var(--text-color);
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 4px var(--shadow-color);
		animation: fadeIn 0.8s ease-out;
        transition: all 0.3s ease;
		position: relative;
    	overflow: hidden;
    }

	#timeDisplay:hover {
        transform: scale(1.02);
        box-shadow: 0 6px 12px var(--shadow-color);
    }

	#timeDisplay::before {
		content: '';
		position: absolute;
		top: 0;
		left: -100%;
		width: 100%;
		height: 2px;
		background: linear-gradient(90deg, transparent, var(--button-orange), transparent);
		animation: timelineSlide 3s linear infinite;
	}
	@keyframes timelineSlide {
		0% { left: -100%; }
		100% { left: 100%; }
    }

    .time-label {
        font-weight: bold;
        margin-right: 10px;
        color: var(--button-orange);
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* 添加滚动时的效果 */
    .sticky-header.is-sticky {
        border-radius: 0 0 4px 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transform: translateY(0);
    }

    #periodButtons, #rateButtons, #principalButtons, #commissionButtons, #PaymentduringButtons {
        margin: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 3px;
        width: 100%;
        justify-content: center;
        padding: 0 5px;
        box-sizing: border-box;
        min-height: 32px;
        align-items: center;
    }

    button {
        flex-shrink: 0;
    }

    /* 新的按鈕組樣式 */
    .function-buttons {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin: 4px 0;
        padding: 0 5px;
    }

    .function-buttons .button-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        width: 100%;
    }

    /* 調整頂部按鈕組 */
    .top-buttons .button-row button {
        flex: 1;
        min-width: 0;
    }

    /* 調整底部按鈕組 */
    .bottom-buttons .button-row button {
        flex: 1;
        min-width: 0;
    }

    .function-buttons .top-row,
    .function-buttons .bottom-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    .function-buttons .top-row button {
        flex: 1;
    }

    .function-buttons .bottom-row button {
        flex: 1;
    }

    /* 統一所有功能按鈕的基礎樣式 */
    .function-buttons button {
        background-color: var(--secondary-color);
        color: #ffffff; /* 使用白色文字而非橙色 */
        border: 1px solid var(--button-orange);
        border-radius: 6px; /* 統一圓角 */
        padding: 8px 0;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .function-buttons button::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to right, rgba(255, 156, 51, 0.1), transparent);
        z-index: -1;
        transform: translateX(-100%);
        transition: transform 0.6s ease;
    }

    /* 統一所有按鈕的懸停效果 */
    .function-buttons button:hover {
        background-color: var(--button-orange);
        color: #ffffff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .function-buttons button:hover::before {
        transform: translateX(0);
    }

    /* 統一所有按鈕的點擊效果 */
    .function-buttons button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        transition: all 0.1s;
    }

    /* 主要操作按鈕樣式 */
    /* 移除main-action-btn特殊樣式，保持統一 */
    .function-buttons .main-action-btn {
        /* 移除差異化樣式，保持與其他按鈕一致 */
        background-color: var(--secondary-color);
        color: #ffffff;
        padding: 8px 0;
        border: 1px solid var(--button-orange);
    }

    .function-buttons .main-action-btn::before {
        background: linear-gradient(to right, rgba(255, 255, 255, 0.05), transparent);  /* 降低漸變亮度 */
    }

    .function-buttons .main-action-btn:hover {
        background-color: var(--button-orange);  /* 懸停時改為橙色 */
        box-shadow: 0 7px 14px rgba(255, 156, 51, 0.4);
        transform: translateY(-3px);
    }

    .function-buttons .main-action-btn:active {
        transform: translateY(1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* 在 style 標籤中修改或新增以下 CSS */
	.quote-table {
		width: 100%;
		border-collapse: separate;
		border-spacing: 0;
		margin: 10px 0;
		background: var(--primary-color);
		border-radius: 12px;
		overflow: hidden;
		box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
	}

	.quote-table tr {
		background: var(--secondary-color);
		transition: background-color 0.3s ease;
	}

	.quote-table tr:hover {
		background: var(--hover-color);
	}

	.quote-table td {
		padding: 10px 10px; /* 增加內邊距 */
		border-bottom: 1px solid var(--border-color);
		color: var(--text-color);
		font-size: 16px; /* 增加字體大小 */
		line-height: 1.2; /* 增加行高 */
	}

	.quote-table td:first-child {
		width: 140px; /* 增加標籤欄寬度 */
		white-space: nowrap;
		color: var(--button-orange);
		font-weight: 700; /* 加粗 */
		text-align: right;
		padding-right: 10px;
		font-size: 16px; /* 標籤文字更大 */
	}

	.quote-table td:last-child {
		text-align: right;
		font-family: monospace;
		font-size: 16px; /* 數值更大 */
		letter-spacing: 0px; /* 增加字距 */
	}

	/* 新增容器樣式 */

	#quoteContainer {
		padding: 24px;
		background: #333333;
		border-radius: 16px;
		box-shadow: 0 12px 24px rgba(0, 0, 0, 0.5);
		margin: 20px;
	}

    .function-buttons button::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: var(--button-orange);
        z-index: -1;
        border-radius: 6px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .function-buttons button:hover::before {
        opacity: 0.2;
        animation: pulseGlow 1.5s infinite;
    }

    @keyframes pulseGlow {
        0% { transform: scale(1); opacity: 0.2; }
        50% { transform: scale(1.05); opacity: 0.3; }
        100% { transform: scale(1); opacity: 0.2; }
    }
    
	.function-buttons button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.1);
        transform: translate(-50%, -50%) scale(0);
        border-radius: 50%;
        transition: transform 0.5s;
    }

	.function-buttons button:hover {
		background-color: var(--button-orange);
		color: var(--text-color);
		border-color: var(--button-orange);
	}
	.function-buttons button:hover::after {
        transform: translate(-50%, -50%) scale(2);
    }

	.function-buttons button:active {
		background-color: var(--secondary-color);
		color: var(--button-orange);
		border-color: var(--button-orange);
	}
	.footer-message {
		background-color: #333333;
		color: var(--text-color);
		padding: 15px;
		text-align: center;
		margin-top: 15px;
		border-radius: 4px;
		transform: scale(1.05);
        text-shadow: 0 0 10px var(--button-orange);
		transition: all 0.3s ease;
    	position: relative;
	}

	.footer-spacing {
		background-color: #333333;
		height: 50px;
		margin-top: 0px;
	}

	.footer-message::before {
		content: '🍚';
		margin-right: 8px;
		display: inline-block;
		transition: transform 0.3s ease;
	}

	.footer-message:hover::before {
		transform: rotate(360deg);
	}

	@keyframes glowBorder {
		0%, 100% { box-shadow: 0 0 5px var(--button-orange); }
		50% { box-shadow: 0 0 15px var(--button-orange), 0 0 30px rgba(255, 156, 51, 0.3); }
    }
	.warning-text {
		color: #ff0000 !important;
		font-weight: bold !important;
		animation: pulse 1s infinite, shake 0.5s ease-in-out; 
        will-change: transform; 
	}

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-1px); }
        40%, 80% { transform: translateX(1px); }
    }


    /* 1. 流光分隔線 */
    .divider-flow {
            position: relative;
            height: 2px;
            background: linear-gradient(90deg, 
                var(--secondary-color) 0%,
                var(--button-orange) 50%,
                var(--secondary-color) 100%);
            margin: 4px 0;
            overflow: hidden;
        }

        .divider-flow::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 156, 51, 0.8),
                transparent);
            animation: flowLight 3s ease-in-out infinite;
        }

        @keyframes flowLight {
            0% { transform: translateX(0); }
            100% { transform: translateX(200%); }
        }

    /* 分隔線淡入動畫 */
    @keyframes dividerFadeIn {
        from {
            opacity: 0;
            transform: scaleX(0.8);
        }
        to {
            opacity: 1;
            transform: scaleX(1);
        }
    }

    /* 發光效果動畫 */
    @keyframes dividerGlow {
        0% {
            left: -100%;
        }
        50% {
            left: 100%;
        }
        100% {
            left: 100%;
        }
    }

    /* 強調重要欄位 */
    .emphasized-row {
        border-left: 3px solid var(--button-orange);
        background: linear-gradient(90deg, rgba(255, 156, 51, 0.1), transparent);
        transform: scale(1.01);
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .emphasized-row .label {
        color: var(--button-orange);
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .emphasized-row input {
        font-weight: bold;
        color: #ffffff;
        font-size: 17px;
        border-color: var(--button-orange);
    }

    .emphasized-row:hover {
        transform: scale(1.02) translateX(5px);
        box-shadow: 0 7px 20px rgba(0, 0, 0, 0.25);
    }

    /* 歷史記錄面板樣式 */
    .history-panel {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        overflow-y: auto;
        animation: fadeIn 0.3s ease-out;
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background-color: var(--primary-color);
        position: sticky;
        top: 0;
        z-index: 1001;
        border-bottom: 2px solid var(--button-orange);
    }

    .header-left {
        flex: 1;
    }

    .header-right {
        margin-right: 20px;
    }

    .history-header h2 {
        margin: 0;
        color: var(--button-orange);
        font-size: 20px;
    }

    .close-btn {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 5px 10px;
        border-radius: 50%;
        margin-left: 10px;
        background-color: rgba(255, 255, 255, 0.1);
    }

    .close-btn:hover {
        color: var(--button-orange);
        transform: scale(1.1);
        background-color: rgba(255, 255, 255, 0.2);
    }

    .history-content {
        padding: 10px;
        max-width: 400px;
        margin: 0 auto;
    }

    .history-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .history-item {
        background-color: var(--secondary-color);
        padding: 8px 10px;
        border-radius: 8px;
        position: relative;
        transition: all 0.3s ease;
        border-left: 3px solid var(--button-orange);
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-areas: 
            "date actions"
            "rate rate"
            "details details";
        gap: 4px;
    }

    .history-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .history-date {
        font-weight: bold;
        color: var(--button-orange);
        font-size: 14px;
        margin-bottom: 2px;
        grid-area: date;
    }

    .history-rate {
        font-size: 16px;
        margin-bottom: 4px;
        grid-area: rate;
    }

    .history-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        font-size: 13px;
        color: #cccccc;
        margin-bottom: 4px;
        grid-area: details;
    }

    .history-actions {
        display: flex;
        justify-content: flex-end;
        gap: 6px;
        grid-area: actions;
        align-self: start;
    }

    .delete-btn, .detail-btn {
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 3px 8px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .delete-btn {
        border-color: #e74c3c;
        color: #e74c3c;
    }

    .delete-btn:hover {
        background-color: #e74c3c;
        color: white;
    }

    .detail-btn {
        border-color: var(--button-blue);
        color: var(--button-blue);
    }

    .detail-btn:hover {
        background-color: var(--button-blue);
        color: white;
    }

    .no-data {
        text-align: center;
        color: #cccccc;
        font-style: italic;
        padding: 20px 0;
    }

    .delete-all-btn {
        background: none;
        border: 1px solid #e74c3c;
        color: #e74c3c;
        font-size: 13px;
        padding: 4px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .delete-all-btn:hover {
        background-color: #e74c3c;
        color: white;
    }

    /* 模態框樣式 */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-out;
    }

    .modal-container {
        background-color: var(--primary-color);
        border-radius: 10px;
        width: 90%;
        max-width: 350px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        animation: modalSlideIn 0.3s ease-out;
        overflow: hidden;
    }

    @keyframes modalSlideIn {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--secondary-color);
    }

    .modal-header h3 {
        margin: 0;
        color: var(--button-orange);
        font-size: 18px;
    }

    .modal-content {
        padding: 20px 15px;
        color: var(--text-color);
        max-height: 70vh;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 10px 15px 15px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid var(--border-color);
        background-color: var(--secondary-color);
    }

    .modal-btn {
        padding: 8px 15px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 15px;
        transition: all 0.3s ease;
        border: none;
    }

    .modal-btn-primary {
        background-color: var(--button-orange);
        color: white;
    }

    .modal-btn-primary:hover {
        background-color: #e88a22;
        transform: translateY(-2px);
    }

    .modal-btn-secondary {
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }

    .modal-btn-secondary:hover {
        background-color: var(--hover-color);
        transform: translateY(-2px);
    }

    /* 提示框樣式 */
    .toast-message {
        position: fixed;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(51, 181, 229, 0.9);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 9999;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        opacity: 1;
        transition: opacity 0.5s ease;
    }

    /* 讓「稅佣後利率」輸入框更明顯但不突兀 */
    #afterCommissionRate {
        font-weight: bold;
        color: #ffffff;
        background-color: rgba(255, 156, 51, 0.08); /* 更淡的橘色背景 */
        border: 1px solid rgba(255, 156, 51, 0.6); /* 半透明橘色邊框 */
        box-shadow: 0 0 4px rgba(255, 156, 51, 0.15); /* 微弱的發光效果 */
    }

    #afterCommissionRate.value-changed {
        animation: afterRateChange 0.8s ease-out;
    }

    @keyframes afterRateChange {
        0% { 
            background-color: rgba(255, 156, 51, 0.3);
            transform: scale(1.02);
        }
        100% { 
            background-color: rgba(255, 156, 51, 0.08);
            transform: scale(1);
        }
    }

    /* 電流特效容器 */
    .electric-effect-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        pointer-events: none;
        overflow: hidden;
    }

    /* 電流特效 */
    .electric-effect {
        position: absolute;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, 
            rgba(33, 150, 243, 0) 0%,
            rgba(33, 150, 243, 0.5) 50%, 
            rgba(33, 150, 243, 0) 100%);
        opacity: 0;
        animation: electricEffect 0.4s ease-out;
    }

    .electric-flash {
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        opacity: 0;
        animation: flashEffect 0.4s ease-out;
    }

    .electric-line {
        position: absolute;
        background-color: #00BFFF;
        height: 2px;
        width: 100%;
        opacity: 0.7; /* 從0改為0.7 */
        filter: blur(2px);
        box-shadow: 0 0 10px #00BFFF, 0 0 20px #00BFFF, 0 0 30px #00BFFF;
    }

    @keyframes electricEffect {
        0% { opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { opacity: 0; }
    }

    @keyframes flashEffect {
        0% { opacity: 0; }
        5% { opacity: 0.8; }
        20% { opacity: 0; }
        60% { opacity: 0.4; }
        100% { opacity: 0; }
    }

    @keyframes electricLine {
        0% { transform: translateY(-200px); opacity: 0; }
        30% { opacity: 1; }
        70% { opacity: 1; }
        100% { transform: translateY(2000px); opacity: 0; }
    }

</style>

<script src="https://accounts.google.com/gsi/client" async defer></script>

</head>
<body>

	<div style="text-align: center;">
        <h1>小朋友專用計算機</h1>
    </div>
	
    <div class="time-display-wrapper">
        <div id="timeDisplay" class="sticky-header">
            <div style="display: flex; justify-content: center; width: 100%;">
                <span class="time-label">報價時間：</span>
                <span id="currentTime"></span>
            </div>
        </div>
    </div>
    
    <div class="input-button-group">
        <div class="row">
            <span class="label">期數</span>
            <input type="number" id="period" step="0.1">
            <button onclick="calculatePeriod()">算</button>
            <button onclick="clearField('period')">清</button>
        </div>
    
        <div id="periodButtons">
            <button onclick="adjustPeriod(-1)">-1</button>
            <button onclick="setPeriod(13)">底</button>
            <button onclick="setPeriod(24)">2</button>
            <button onclick="setPeriod(36)">3</button>
            <button onclick="setPeriod(48)">4</button>
            <button onclick="setPeriod(60)">5</button>
            <button onclick="setPeriod(72)">6</button>
            <button onclick="adjustPeriod(1)">+1</button>
        </div>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">稅前利率</span>
            <input type="number" id="rate" step="0.001">
            <button onclick="calculateRate()">算</button>
            <button onclick="clearField('rate')">清</button>
        </div>

        <div id="rateButtons">
            <button onclick="adjustRate(-0.2)">-0.2</button>
            <button onclick="setRate(4)">4</button>
            <button onclick="setRate(6)">6</button>
            <button onclick="setRate(8)">8</button>
            <button onclick="setRate(10)">10</button>
            <button onclick="setRate(13)">13</button>
            <button onclick="adjustRate(0.2)">+0.2</button>
        </div>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">本金</span>
            <input type="number" id="principal" min="0" oninput="validatePrincipalInput(this)">
            <button onclick="calculatePrincipal()">算</button>
            <button onclick="clearField('principal')">清</button>
        </div>

        <div id="principalButtons">
            <button onclick="adjustPrincipal(-1000000)">-100</button>
            <button onclick="adjustPrincipal(-100000)">-10</button>
            <button onclick="adjustPrincipal(-10000)">-1</button>
            <button onclick="adjustPrincipal(10000)">+1</button>
            <button onclick="adjustPrincipal(100000)">+10</button>
            <button onclick="adjustPrincipal(1000000)">+100</button>
        </div>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">期繳</span>
            <input type="number" id="payment" step="0.01">
            <button onclick="calculatePayment()">算</button>
            <button onclick="clearField('payment')">清</button>
        </div>

        <div id="PaymentduringButtons">
            <button onclick="adjustPayment(-100)">-100</button>
            <button onclick="adjustPayment(-50)">-50</button>
            <button onclick="roundPayment('down', 100)">捨百</button>
            <button onclick="roundPayment('up', 100)">進百</button>
            <button onclick="adjustPayment(50)">+50</button>
            <button onclick="adjustPayment(100)">+100</button>
        </div>
    </div>

	<div class="row">
        <span class="label">總利息</span>
        <input type="number" id="totalInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">稅金</span>
        <input type="number" id="tax" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">稅後利率</span>
        <input type="number" id="afterTaxRate" step="0.001" class="readonly" readonly>
    </div>

    <div class="input-button-group">
        <div class="row">
            <span class="label">推廣</span>
            <input type="number" id="commission" min="0" step="1" oninput="validateCommissionInput(this)">
            <button onclick="calculateAfterCommissionRate()">算</button>
            <button onclick="clearCommission()">清</button>
        </div>

        <div id="commissionButtons">
            <button onclick="adjustCommission(-10000)">-萬</button>
            <button onclick="adjustCommission(-1000)">-千</button>
            <button onclick="adjustCommission(-100)">-百</button>
            <button onclick="adjustCommission(100)">+百</button>
            <button onclick="adjustCommission(1000)">+千</button>
            <button onclick="adjustCommission(10000)">+萬</button>
        </div>
    </div>

    <div class="row">
        <span class="label">推廣比例</span>
        <input type="number" id="commissionRatio" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">稅佣後利率</span>
        <input type="number" id="afterCommissionRate" class="readonly" readonly>
    </div>

    <div class="divider-flow"></div>

    <div class="row">
        <span class="label">百萬每年利息</span>
        <input type="number" id="annualMillionInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">百萬每月利息</span>
        <input type="number" id="monthlyMillionInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">一萬每年利息</span>
        <input type="number" id="annualTenThousandInterest" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">一萬每月利息</span>
        <input type="number" id="monthlyTenThousandInterest" class="readonly" readonly>
    </div>

    <div class="divider-flow"></div>

    <div class="row">
        <span class="label">本月資金成本</span>
        <input type="number" id="monthlyCost" value="2.1106" class="readonly" readonly>
    </div>

    <div class="row">
        <span class="label">Spread</span>
        <input type="number" id="spread" class="readonly" readonly>
    </div>
	
    <div class="row">
        <span class="label">NPV</span>
        <input type="number" id="fundingCost" class="readonly" readonly>
        <span style="margin-left: 0px; color: var(--text-color);">修正中</span>
    </div>

	<!-- 按鈕區域重新組織 -->
    <div class="divider-flow"></div>

    <div class="function-buttons top-buttons">
        <div class="button-row">
            <button onclick="saveLoanData()" >保存計算</button>
            <button onclick="toggleHistoryPanel()" >歷史記錄</button>
        </div>
    </div>

    <div class="divider-flow"></div>

    <div class="function-buttons bottom-buttons">
        <div class="button-row">
            <button onclick="window.open('https://travel.chiayi.gov.tw/Folder/TurkeyRice', '_blank')">雞肉飯</button>
            <button onclick="location.reload()">清除</button>
            <button onclick="generateQuote()">截圖</button>
        </div>
    </div>

    <div class="footer-message">報價後記得吃碗火雞肉飯唷！</div>

    <div class="divider-flow"></div>
    
    <!-- 使用者資料區塊 -->
    <div id="userProfile" style="display: none;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
            <img id="userImage" src="" alt="User profile">
            <span id="userName"></span>
            <button onclick="signOut()" class="sign-out-btn">登出</button>
        </div>
    </div>

    <!-- 添加歷史記錄面板 -->
    <div id="historyPanel" class="history-panel">
        <div class="history-header">
            <div class="header-left">
                <h2>貸款計算歷史記錄</h2>
            </div>
            <div class="header-right">
                <button class="delete-all-btn" onclick="confirmDeleteAll()">全部刪除</button>
            </div>
            <button class="close-btn" onclick="toggleHistoryPanel()">×</button>
        </div>
        <div id="historyContent" class="history-content"></div>
    </div>

    <!-- 普通提示模態框 -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalTitle">提示</h3>
                <button class="close-btn" onclick="hideModal()">×</button>
            </div>
            <div id="modalContent" class="modal-content"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="hideModal()">確定</button>
            </div>
        </div>
    </div>

    <!-- 確認模態框 -->
    <div id="confirmModalOverlay" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="confirmModalTitle">確認</h3>
                <button class="close-btn" onclick="hideConfirmModal()">×</button>
            </div>
            <div id="confirmModalContent" class="modal-content"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="hideConfirmModal()">取消</button>
                <button id="confirmModalOk" class="modal-btn modal-btn-primary">確定</button>
            </div>
        </div>
    </div>

    <div class="footer-spacing"></div>

    <!-- 登入遮罩層保持在最後 -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-container">
            <h2>請先登入</h2>
            <div id="googleSignInContainer" class="google-signin">
                <div id="g_id_onload"
                    data-client_id="956050785639-m8f7ps3h62f2dukg9s0vd6dvafg22h89.apps.googleusercontent.com"
                    data-context="signin"
                    data-ux_mode="popup"
                    data-callback="handleCredentialResponse"
                    data-auto_prompt="false"
                    data-itp_support="true">
                </div>
                <div class="g_id_signin"
                    data-type="standard"
                    data-shape="rectangular"
                    data-theme="outline"
                    data-text="signin_with"
                    data-size="large"
                    data-logo_alignment="left">
                </div>
            </div>
        </div>
    </div>

<script>

    // 更新 handleCredentialResponse 函數
    function handleCredentialResponse(response) {
        const responsePayload = decodeJwtResponse(response.credential);
        
        // 發送登入事件到 GA4
        gtag('event', 'login', {
            'method': 'Google',
            'user_id': responsePayload.email,
            'user_name': responsePayload.name,
            'login_time': new Date().toISOString(),
            'device_type': getDeviceType(),  // 新增裝置類型
            'screen_resolution': `${window.screen.width}x${window.screen.height}`,  // 新增螢幕解析度
            'browser_info': getBrowserInfo()  // 新增瀏覽器資訊
        });

        // 保存用戶信息到 localStorage
        localStorage.setItem('googleUser', JSON.stringify({
            name: responsePayload.name,
            picture: responsePayload.picture,
            email: responsePayload.email,
            token: response.credential,
        }));
        
        // 隱藏登入遮罩
        hideLoginOverlay();
        // 更新用戶介面
        updateUserInterface(responsePayload);
    }

    // 獲取裝置類型
    function getDeviceType() {
        const ua = navigator.userAgent;
        if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
            return "tablet";
        }
        if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
            return "mobile";
        }
        return "desktop";
    }

    // 獲取瀏覽器資訊
    function getBrowserInfo() {
        const ua = navigator.userAgent;
        let browser = "Unknown";
        if (ua.indexOf("Chrome") > -1) browser = "Chrome";
        else if (ua.indexOf("Safari") > -1) browser = "Safari";
        else if (ua.indexOf("Firefox") > -1) browser = "Firefox";
        else if (ua.indexOf("Edge") > -1) browser = "Edge";
        else if (ua.indexOf("Opera") > -1) browser = "Opera";
        else if (ua.indexOf("MSIE") > -1 || ua.indexOf("Trident/") > -1) browser = "Internet Explorer";
        
        return `${browser} ${navigator.platform}`;
    }

    // 添加登出事件追蹤
    function signOut() {
        // 獲取當前用戶信息
        const user = JSON.parse(localStorage.getItem('googleUser'));
        
        // 發送登出事件到 GA4
        if (user && user.email) {
            gtag('event', 'logout', {
                'user_id': user.email,
                'user_name': user.name,
                'logout_time': new Date().toISOString(),
                'session_duration': user.lastLogin ? 
                    Math.round((new Date() - new Date(user.lastLogin)) / 1000) : 0
            });
        }

        google.accounts.id.disableAutoSelect();
        localStorage.removeItem('googleUser');
        showLoginOverlay();
        document.getElementById('userProfile').style.display = 'none';
    }

    // 新增隱藏登入遮罩的函數
    function hideLoginOverlay() {
        document.getElementById('loginOverlay').style.display = 'none';
    }

    // 新增顯示登入遮罩的函數
    function showLoginOverlay() {
        document.getElementById('loginOverlay').style.display = 'flex';
    }

    // 修改檢查登入狀態的函數
    window.onload = function() {
        try {
            // 1. 嘗試從 localStorage 讀取用戶資料
            const savedUser = localStorage.getItem('googleUser');
            
            if (savedUser) {
                // 2. 嘗試解析用戶資料
                const user = JSON.parse(savedUser);
                
                // 3. 檢查資料是否完整
                if (user && user.name && user.picture) {
                    // 資料完整，隱藏登入遮罩並更新界面
                    hideLoginOverlay();
                    updateUserInterface(user);
                } else {
                    // 資料不完整，顯示登入遮罩
                    console.log('Incomplete user data, requesting new login');
                    localStorage.removeItem('googleUser'); // 清除無效資料
                    showLoginOverlay();
                }
            } else {
                // 沒有儲存的用戶資料，顯示登入遮罩
                showLoginOverlay();
            }
        } catch (error) {
            // 4. 捕獲任何可能的錯誤
            console.error('Error while checking login status:', error);
            localStorage.removeItem('googleUser'); // 清除可能損壞的資料
            showLoginOverlay();
        }
    }

    // 添加這個函數
    function updateUserInterface(user) {
        const userProfile = document.getElementById('userProfile');
        const userImage = document.getElementById('userImage');
        const userName = document.getElementById('userName');
        
        userProfile.style.display = 'flex';
        userImage.src = user.picture;
        userName.textContent = user.name;

        setupUserProfileInteraction(); // 添加這行
    }

    // 添加這個函數
    function decodeJwtResponse(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }

    // 添加點擊頭像彈出登出選項的功能
    function setupUserProfileInteraction() {
        const userImage = document.getElementById('userImage');
        userImage.addEventListener('click', function(event) {
            const shouldLogout = confirm('確定要登出嗎？');
            if (shouldLogout) {
                signOut();
            }
        });
        
        // 添加懸停提示
        userImage.title = '點擊登出';
    }

	// 添加震動函數
	function vibrate() {
		if (navigator.vibrate) {
		navigator.vibrate(30); // 震動30毫秒
		}
	}

    // 添加這個新函數到第一個 script 標籤內，updateTime 函數之前
    function calculateNPV(payment, period, principal, monthlyCost) {
        try {
        // 檢查輸入值是否有效
        if (!payment || !period || !principal || !monthlyCost || 
            isNaN(payment) || isNaN(period) || isNaN(principal) || isNaN(monthlyCost)) {
            return 0;
        }

        // 將年利率轉換為月利率
        const monthlyRate = monthlyCost / 100 / 12;

        // 計算期望現值（使用期繳金額和期數反推）
        const expectedPresentValue = payment * (1 - Math.pow(1 + monthlyRate, -period)) / monthlyRate;

        // 計算與實際本金的差額
        return Math.round(expectedPresentValue - principal);
        } catch (error) {
        console.error('NPV 計算錯誤:', error);
        return 0;
        }
    }

    // 添加更新時間的函數
    function updateTime() {
        const now = new Date();
        const days = ['日', '一', '二', '三', '四', '五', '六'];
        
        // 調整為台北時間 (GMT+8)
        const taipeiTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
        
        const year = taipeiTime.getUTCFullYear();
        const month = String(taipeiTime.getUTCMonth() + 1).padStart(2, '0');
        const date = String(taipeiTime.getUTCDate()).padStart(2, '0');
        const day = days[taipeiTime.getUTCDay()];
        const hours = String(taipeiTime.getUTCHours()).padStart(2, '0');
        const minutes = String(taipeiTime.getUTCMinutes()).padStart(2, '0');
        const seconds = String(taipeiTime.getUTCSeconds()).padStart(2, '0');
        
        const timeString = `${year}年${month}月${date}日
            星期${day} ${hours}:${minutes}:${seconds}`;
        document.getElementById('currentTime').textContent = timeString;
    }

    // 每秒更新一次時間
    setInterval(updateTime, 1000);
    updateTime(); // 初始化顯示

    // 原始的JavaScript函數保持不變
    function PMT(rate, nper, pv) {
        rate = rate / 100 / 12;
        return (pv * rate * Math.pow(1 + rate, nper)) / (Math.pow(1 + rate, nper) - 1);
    }
        
    function RATE(nper, pmt, pv) {
        let rate = 0.1;
        let step = 0.05;
        let tolerance = 0.0001;
        let maxIterations = 100;
        let iteration = 0;

        while (iteration < maxIterations) {
            let monthlyRate = rate / 12;
            let calculated = pv * monthlyRate * Math.pow(1 + monthlyRate, nper) / 
                            (Math.pow(1 + monthlyRate, nper) - 1);
            
            if (Math.abs(calculated - pmt) < tolerance) {
                return rate * 100;
            }

            if (calculated > pmt) {
                rate -= step;
            } else {
                rate += step;
            }
            
            step *= 0.5;
            iteration++;
        }
        
        return rate * 100;
    }

    function calculatePeriod() {
        const rate = parseFloat(document.getElementById('rate').value);
        const principal = parseFloat(document.getElementById('principal').value);
        const payment = parseFloat(document.getElementById('payment').value);
        
        // TODO: Implement period calculation
        updateAllFields();
    }

    function calculateRate() {
        const period = parseFloat(document.getElementById('period').value);
        const principal = parseFloat(document.getElementById('principal').value);
        const payment = parseFloat(document.getElementById('payment').value);
        
        const rate = RATE(period, payment, principal);
        document.getElementById('rate').value = rate.toFixed(4);
        
        updateAllFields();
    }

    function calculatePrincipal() {
        const period = parseFloat(document.getElementById('period').value);
        const rate = parseFloat(document.getElementById('rate').value);
        const payment = parseFloat(document.getElementById('payment').value);
        
        // TODO: Implement principal calculation
        updateAllFields();
    }

    function calculatePayment() {
        const period = parseFloat(document.getElementById('period').value);
        const rate = parseFloat(document.getElementById('rate').value);
        const principal = parseFloat(document.getElementById('principal').value);
        
        const payment = PMT(rate, period, principal);
        document.getElementById('payment').value = payment.toFixed(2);
        
        updateAllFields();
    }


    function updateAllFields() {
        // 獲取基本值
        const period = parseFloat(document.getElementById('period').value);
        const rate = parseFloat(document.getElementById('rate').value);
        const principal = parseFloat(document.getElementById('principal').value);
        const payment = parseFloat(document.getElementById('payment').value);
        const monthlyCost = parseFloat(document.getElementById('monthlyCost').value);

        // 要求1: 期數檢查
        const periodInput = document.getElementById('period');
        if (period <= 12) {
            periodInput.classList.add('warning-text');
        } else {
            periodInput.classList.remove('warning-text');
        }

        // 計算總利息
        const totalInterest = (payment * period) - principal;
        // 要求2: 總利息格式化到小數點第3位
        document.getElementById('totalInterest').value = totalInterest.toFixed(2);

        // 計算稅金
        const tax = totalInterest / 21;
        document.getElementById('tax').value = tax.toFixed(2);

        // 計算稅後利率
        const afterTaxRate = RATE(period, payment, principal + tax);
        // 要求3: 稅後利率格式化和警告
        const afterTaxRateInput = document.getElementById('afterTaxRate');
        afterTaxRateInput.value = afterTaxRate.toFixed(4);
        if (afterTaxRate <= 2.5) {
            afterTaxRateInput.classList.add('warning-text');
        } else {
            afterTaxRateInput.classList.remove('warning-text');
        }

        // 要求2: 佣金格式化為整數
        const commission = parseFloat(document.getElementById('commission').value) || 0;
        document.getElementById('commission').value = Math.round(commission);
        
        // 檢查佣金是否超過總利息的95%
        const commissionInput = document.getElementById('commission');
        if (commission >= totalInterest * 0.95) {
            commissionInput.classList.add('warning-text');
        } else {
            commissionInput.classList.remove('warning-text');
        }

        // 計算並更新推廣費比例
        const commissionRatio = commission / principal * 100;
        const commissionRatioInput = document.getElementById('commissionRatio');
        commissionRatioInput.value = commissionRatio.toFixed(2);

        // 檢查推廣費比例是否超過5%
        if (commissionRatio > 5) {
            commissionRatioInput.classList.add('warning-text');
        } else {
            commissionRatioInput.classList.remove('warning-text');
        }

        // 計算稅佣後利率
        const afterCommissionRate = RATE(period, payment, principal + tax + commission);
        // 要求5: 稅佣後利率格式化和警告
        const afterCommissionRateInput = document.getElementById('afterCommissionRate');
        afterCommissionRateInput.value = afterCommissionRate.toFixed(4);
        if (afterCommissionRate <= 2.5) {
            afterCommissionRateInput.classList.add('warning-text');
        } else {
            afterCommissionRateInput.classList.remove('warning-text');
        }

        // 計算百萬利息
        const millionPayment = PMT(rate, 12, 1000000);
        const annualMillionInterest = (millionPayment * 12) - 1000000;
            // 要求3: 百萬每年利息格式化為整數
        document.getElementById('annualMillionInterest').value = Math.round(annualMillionInterest);
        // 要求4: 百萬每月利息格式化為整數
        document.getElementById('monthlyMillionInterest').value = Math.round(annualMillionInterest / 12);


        // 計算一萬利息
        const tenThousandPayment = PMT(rate, 12, 10000);
        const annualTenThousandInterest = (tenThousandPayment * 12) - 10000;
        // 要求5: 一萬每年利息格式化為整數
        document.getElementById('annualTenThousandInterest').value = Math.round(annualTenThousandInterest);
        // 要求6: 一萬每月利息格式化為整數
        document.getElementById('monthlyTenThousandInterest').value = Math.round(annualTenThousandInterest / 12);


        // 計算 Spread
        const spread = afterCommissionRate - monthlyCost;
        // 要求10: Spread 警告
        const spreadInput = document.getElementById('spread');
        spreadInput.value = spread.toFixed(4);
        if (spread <= 0) {
            spreadInput.classList.add('warning-text');
        } else {
            spreadInput.classList.remove('warning-text');
        }
        
        // 在計算 spread 之後添加新的計算邏輯
        // 在計算 spread 之後，替換原有的 NPV 計算代碼為：
        const npvValue = calculateNPV(
            parseFloat(document.getElementById('payment').value),
            parseFloat(document.getElementById('period').value),
            parseFloat(document.getElementById('principal').value),
            parseFloat(document.getElementById('monthlyCost').value)
        );
        
        // 更新 NPV 顯示
        const fundingCostInput = document.getElementById('fundingCost');
        fundingCostInput.value = npvValue;
        
        // 更新警告樣式
        if (npvValue < 0) {
            fundingCostInput.classList.add('warning-text');
        } else {
            fundingCostInput.classList.remove('warning-text');
        }

        // 在更新值之前保存舊值
        const oldValues = {};
        const fieldsToTrack = ['totalInterest', 'afterTaxRate', 'spread'];
        fieldsToTrack.forEach(field => {
            oldValues[field] = document.getElementById(field).value;
        });

        // 在更新後檢查變化
        fieldsToTrack.forEach(field => {
            const newValue = document.getElementById(field).value;
            if (oldValues[field] !== newValue) {
                animateValueChange(field);
            }
        });
    }

    // 在 clearField 函數之前添加這個新函數
    function validatePrincipalInput(input) {
        // 移除負號，轉換為絕對值
        let value = Math.abs(parseFloat(input.value)) || 0;
        
        // 如果輸入為0，設為空值
        if (value === 0) {
            input.value = '';
        } else {
            input.value = value;
        }
        
        // 更新相關計算
        updateAllFields();
    }

    function clearField(fieldId) {
        vibrate();
        document.getElementById(fieldId).value = '';
    }

    function clearCommission() {
        vibrate();
        document.getElementById('commission').value = '';
        updateAllFields(); // 更新所有欄位
    }

    function adjustPeriod(delta) {
        vibrate();
        const periodField = document.getElementById('period');
        const currentValue = parseFloat(periodField.value) || 0;
        periodField.value = currentValue + delta;
        calculatePayment();
    }

    function setPeriod(value) {
        vibrate();
        document.getElementById('period').value = value;
        calculatePayment();
    }

    function adjustRate(delta) {
        vibrate();
        const rateField = document.getElementById('rate');
        const currentValue = parseFloat(rateField.value) || 0;
        rateField.value = (currentValue + delta).toFixed(4);
        calculatePayment();
    }

    function setRate(value) {
        vibrate();
        document.getElementById('rate').value = value;
        calculatePayment();
    }

    function validateCommissionInput(input) {
        // 移除小數點
        let value = parseInt(input.value) || 0;
        
        // 如果是負數，設為0
        if (value < 0) {
            value = 0;
        }
        
        // 更新輸入框的值為整數
        input.value = Math.floor(value);
        
        // 更新相關計算
        updateAllFields();
    }

    function adjustCommission(delta) {
        // 添加震動效果
        vibrate();

        // 獲取佣金輸入框元素
        const commissionField = document.getElementById('commission');
        
        // 獲取當前值，如果為空則預設為0
        const currentValue = parseFloat(commissionField.value) || 0;
        
        // 計算新值（當前值加上變化量）
        const newValue = Math.max(0, currentValue + delta);
        
        // 更新輸入框的值，使用 Math.round 去除小數點
        commissionField.value = Math.floor(newValue);
        
        // 更新所有相關欄位的計算
        updateAllFields();
    }

    function adjustPrincipal(delta) {
        vibrate();
        const principalField = document.getElementById('principal');
        const currentValue = parseFloat(principalField.value) || 0;
        principalField.value = currentValue + delta;
        calculatePayment();
        updateAllFields(); // 添加這行
    }

    function calculateAfterCommissionRate() {
        const period = parseFloat(document.getElementById('period').value);
        const payment = parseFloat(document.getElementById('payment').value);
        const principal = parseFloat(document.getElementById('principal').value);
        const tax = parseFloat(document.getElementById('tax').value);
        const commission = parseFloat(document.getElementById('commission').value) || 0;

        updateAllFields(); // 更新所有欄位
    }
    function roundPayment(direction, base) {
        vibrate();
        const paymentField = document.getElementById('payment');
        let value = parseFloat(paymentField.value) || 0;
        
        if (direction === 'down') {
            value = Math.floor(value / base) * base;
        } else {
            value = Math.ceil(value / base) * base;
        }
        
        paymentField.value = value.toFixed(2);
        calculateRate(); // Recalculate the rate
    }
    function adjustPayment(delta) {
        vibrate();
        const paymentField = document.getElementById('payment');
        const currentValue = parseFloat(paymentField.value) || 0;
        paymentField.value = (currentValue + delta).toFixed(2);
        calculateRate(); // 重新計算利率
        }
    function saveData() {
        const dataToSave = {
        period: document.getElementById('period').value,
        rate: document.getElementById('rate').value,
        principal: document.getElementById('principal').value,
        payment: document.getElementById('payment').value,
        commission: document.getElementById('commission').value
        };
        localStorage.setItem('loanCalculatorData', JSON.stringify(dataToSave));
        alert('資料已暫存！');
    }

    function generateQuote() {
        vibrate();
        console.log('開始生成報價...'); // 新增偵錯訊息

        // 創建報價表格
        const table = document.createElement('table');
            table.className = 'quote-table';

        // 添加表格內容
        const rows = [
            ['報價時間', `${document.getElementById('currentTime').textContent.split('星期')[0]}<br>星期${document.getElementById('currentTime').textContent.split('星期')[1]}`],
            ['期數', document.getElementById('period').value || ''],
            ['稅前利率', (document.getElementById('rate').value || '') + '%'],  // 保留這裡的百分比符號
            ['本金', document.getElementById('principal').value || ''],
            ['期繳', document.getElementById('payment').value || ''],
            ['稅後利率', (document.getElementById('afterTaxRate').value || '') + '%'],  // 保留這裡的百分比符號
            ['佣金', document.getElementById('commission').value || ''],
            ['稅佣後利率', (document.getElementById('afterCommissionRate').value || '') + '%']  // 保留這裡的百分比符號
        ];

        // 建立表格內容
        rows.forEach(([label, value]) => {
            const tr = table.insertRow();
            const labelCell = tr.insertCell();
            const valueCell = tr.insertCell();
            labelCell.textContent = label;
            valueCell.innerHTML = value; // 改用 innerHTML 來支援換行標籤
            });

        // 創建臨時容器
        const container = document.createElement('div');
            container.style.padding = '24px';
            container.style.background = '#333333';
            container.style.borderRadius = '12px';
            container.appendChild(table);
            document.body.appendChild(container);

            console.log('準備進行截圖...'); // 新增偵錯訊息

        // 使用 html2canvas 轉換為圖片
        html2canvas(container).then(canvas => {
            console.log('Canvas 已生成'); // 新增偵錯訊息

        // 移除臨時容器
        document.body.removeChild(container);

        // 下載圖片
        const link = document.createElement('a');
            link.download = `報價_${document.getElementById('currentTime').textContent.replace(/[^0-9]/g, '')}.png`;
            link.href = canvas.toDataURL();
            console.log('準備下載...'); // 新增偵錯訊息
            link.click();
        }).catch(error => {
            console.error('截圖過程發生錯誤:', error); // 新增錯誤處理
            document.body.removeChild(container); // 確保清理臨時容器
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 為相關輸入欄位添加事件監聽
        const inputIds = ['period', 'payment', 'principal', 'monthlyCost'];
        inputIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateAllFields);
                element.addEventListener('change', updateAllFields);
            }
        });
    });

    // 添加數值變化動畫
        function animateValueChange(elementId) {
        const element = document.getElementById(elementId);
        element.classList.remove('value-changed');
        void element.offsetWidth; // 觸發重繪
        element.classList.add('value-changed');
    }

    // 保存貸款計算結果
    function saveLoanData() {
        const period = document.getElementById('period').value;
        const rate = document.getElementById('rate').value;
        const principal = document.getElementById('principal').value;
        const payment = document.getElementById('payment').value;
        const afterTaxRate = document.getElementById('afterTaxRate').value;
        const commission = document.getElementById('commission').value;
        const afterCommissionRate = document.getElementById('afterCommissionRate').value;
        
        // 檢查必要欄位是否填寫
        if (!period || !rate || !principal || !payment) {
            showToast('請先完成必要欄位（期數、利率、本金、期繳）的計算！');
            return;
        }

        // 電流特效
        showElectricEffect();
        
        const loanDate = new Date();
        const year = loanDate.getFullYear();
        const month = String(loanDate.getMonth() + 1).padStart(2, '0');
        const date = String(loanDate.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${date}`;
        
        const loanData = {
            id: new Date().getTime(),
            date: formattedDate,
            period: period,
            rate: rate,
            principal: principal,
            payment: payment,
            afterTaxRate: afterTaxRate,
            commission: commission || '0',
            afterCommissionRate: afterCommissionRate,
            totalInterest: document.getElementById('totalInterest').value,
            timestamp: new Date().toISOString()
        };
        
        // 獲取已存儲的貸款記錄
        let loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        loanHistory.push(loanData);
        
        // 保存到 localStorage
        localStorage.setItem('loanHistory', JSON.stringify(loanHistory));
        
        // 顯示成功提示
        showToast('貸款計算結果已保存！');
        
        // 觸覺反饋（如果設備支持）
        if (navigator.vibrate) {
            navigator.vibrate(70);
        }
    }

    // 顯示電流特效
    function showElectricEffect() {
        // 創建電流效果容器
        const effectContainer = document.createElement('div');
        effectContainer.className = 'electric-effect-container';
        effectContainer.style.display = 'block';
        
        // 創建電流背景
        const electricEffect = document.createElement('div');
        electricEffect.className = 'electric-effect';
        
        // 創建閃光效果
        const flashEffect = document.createElement('div');
        flashEffect.className = 'electric-flash';
        
        // 創建多條電流線
        const lineCount = 10;
        for (let i = 0; i < lineCount; i++) {
            const line = document.createElement('div');
            line.className = 'electric-line';
            
            // 隨機定位
            line.style.top = `${Math.random() * 100}%`;
            line.style.left = `${Math.random() * 20}%`;
            line.style.width = `${80 + Math.random() * 20}%`;
            
            // 隨機動畫延遲
            const delay = Math.random() * 0.3;
            line.style.animation = `electricLine ${0.3 + Math.random() * 0.2}s ease-out ${delay}s`;
            
            // 隨機亮度
            const intensity = 0.7 + Math.random() * 0.3;
            line.style.opacity = intensity;
            
            effectContainer.appendChild(line);
        }
        
        // 添加效果元素到容器
        effectContainer.appendChild(electricEffect);
        effectContainer.appendChild(flashEffect);
        
        // 添加到頁面
        document.body.appendChild(effectContainer);
        
        // 定時移除
        setTimeout(() => {
            effectContainer.style.display = 'none';
            document.body.removeChild(effectContainer);
        }, 500);
    }

    // 顯示/隱藏歷史記錄面板
    function toggleHistoryPanel() {
        const panel = document.getElementById('historyPanel');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'block';
            loadHistoryData();
        }
    }

    // 載入歷史記錄
    function loadHistoryData() {
        const historyContent = document.getElementById('historyContent');
        const loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        
        if (loanHistory.length === 0) {
            historyContent.innerHTML = '<p class="no-data">尚無貸款計算記錄</p>';
            return;
        }
        
        // 按日期排序，最新的在前面
        loanHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        let html = '<div class="history-list">';
        loanHistory.forEach(loan => {
            html += `
                <div class="history-item">
                    <div class="history-date">${formatDate(loan.date)}</div>
                    <div class="history-rate">稅佣後利率: ${loan.afterCommissionRate}%</div>
                    <div class="history-details">
                        <div>期數: ${loan.period}</div>
                        <div>本金: ${formatNumber(loan.principal)}</div>
                        <div>期繳: ${formatNumber(loan.payment)}</div>
                        <div>推廣: ${formatNumber(loan.commission)}</div>
                    </div>
                    <div class="history-actions">
                        <button class="detail-btn" onclick="loadLoanToForm(${loan.id})">載入</button>
                        <button class="delete-btn" onclick="deleteLoan(${loan.id})">刪除</button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        historyContent.innerHTML = html;
    }

    // 格式化日期顯示
    function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}/${month}/${day}`;
    }

    // 格式化數字顯示千位分隔符
    function formatNumber(num) {
        if (!num) return '0';
        return parseInt(num).toLocaleString();
    }

    // 載入貸款記錄到表單
    function loadLoanToForm(id) {
        const loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        const loan = loanHistory.find(item => item.id === id);
        
        if (loan) {
            // 填充表單欄位
            document.getElementById('period').value = loan.period;
            document.getElementById('rate').value = loan.rate;
            document.getElementById('principal').value = loan.principal;
            document.getElementById('payment').value = loan.payment;
            document.getElementById('commission').value = loan.commission;
            
            // 更新計算
            updateAllFields();
            
            // 隱藏歷史面板
            document.getElementById('historyPanel').style.display = 'none';
            
            // 顯示提示
            showToast('已載入貸款計算資料');
            
            // 觸覺反饋
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }
    }

    // 刪除貸款記錄
    function deleteLoan(id) {
        let loanHistory = JSON.parse(localStorage.getItem('loanHistory') || '[]');
        loanHistory = loanHistory.filter(loan => loan.id !== id);
        localStorage.setItem('loanHistory', JSON.stringify(loanHistory));
        loadHistoryData(); // 重新載入歷史記錄
        showToast('貸款記錄已刪除！');
        
        // 觸覺反饋
        if (navigator.vibrate) {
            navigator.vibrate([30, 20, 30]);
        }
    }

    // 確認是否刪除所有貸款記錄
    function confirmDeleteAll() {
        showConfirmModal('確認刪除', '確定要刪除所有貸款計算記錄嗎？此操作無法撤銷。', deleteAllLoans);
    }

    // 刪除所有貸款記錄
    function deleteAllLoans() {
        localStorage.removeItem('loanHistory');
        loadHistoryData(); // 重新載入歷史記錄（會顯示無記錄）
        showToast('所有貸款記錄已刪除！');
        
        // 觸覺反饋
        if (navigator.vibrate) {
            navigator.vibrate([50, 30, 50, 30, 50]);
        }
    }

    // 顯示一般模態框
    function showModal(title, content) {
        document.getElementById('modalTitle').textContent = title || '提示';
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modalOverlay').style.display = 'flex';
        
        // 添加背景點擊關閉功能
        document.getElementById('modalOverlay').onclick = function(event) {
            if (event.target === this) {
                hideModal();
            }
        };
    }

    // 隱藏一般模態框
    function hideModal() {
        document.getElementById('modalOverlay').style.display = 'none';
    }

    // 顯示確認模態框
    function showConfirmModal(title, content, confirmCallback) {
        document.getElementById('confirmModalTitle').textContent = title || '確認';
        document.getElementById('confirmModalContent').innerHTML = content;
        document.getElementById('confirmModalOverlay').style.display = 'flex';
        
        // 設定確認按鈕點擊事件
        const confirmButton = document.getElementById('confirmModalOk');
        
        // 移除舊的事件監聽器（如果有的話）
        const newConfirmButton = confirmButton.cloneNode(true);
        confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
        
        // 添加新的事件監聽器
        newConfirmButton.addEventListener('click', function() {
            hideConfirmModal();
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
        });
        
        // 添加背景點擊關閉功能
        document.getElementById('confirmModalOverlay').onclick = function(event) {
            if (event.target === this) {
                hideConfirmModal();
            }
        };
    }

    // 隱藏確認模態框
    function hideConfirmModal() {
        document.getElementById('confirmModalOverlay').style.display = 'none';
    }

    // 顯示輕量級的提示訊息
    function showToast(message) {
        // 檢查是否已有 toast 存在
        const existingToast = document.querySelector('.toast-message');
        if (existingToast) {
            document.body.removeChild(existingToast);
        }
        
        // 創建一個新的 toast 元素
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // 2秒後自動消失
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 500);
        }, 2000);
    }

    </script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('loaded');
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const header = document.querySelector('.sticky-header');
    const h1Element = document.querySelector('h1');
    
    if (!header || !h1Element) return; // 添加检查

    window.addEventListener('scroll', function() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const headerRect = header.getBoundingClientRect();
        const h1Rect = h1Element.getBoundingClientRect();
        
        // 使用更精确的条件判断
        if (scrollTop > header.offsetTop) {
            header.classList.add('is-sticky');
            if (h1Rect.bottom > 0) {
                header.classList.remove('is-sticky');
            }
        } else {
            header.classList.remove('is-sticky');
        }
    });
    });
    </script>

<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
</script>

<!-- 電流特效容器 -->
<div id="electricEffectContainer" class="electric-effect-container"></div>

</body>
</html>
